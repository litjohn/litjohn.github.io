[{"content":" 亲手实现一个正则引擎！\n众所周知，一类经典的自动机是有限状态自动机。它们识别的语言是正则语言，而正则表达式能够匹配的字符串的集合也是正则语言。\n（如果你之前没有了解过，询问 AI 或是使用搜索引擎都很适合快速了解）\n导数法 要匹配一个正则表达式，最经典的方法就是构造对应的 NFA，然后通过一些手法转化为 DFA。但这太复杂了。有没有更简单的方法呢？\n有一种被称为“导数法”的方法。\n思想非常简单：我们将构造出的 DFA 编码为一个正则。这样，转移之后相当于产生了一个新的自动机，也就是一个新的正则表达式。\n原始正则表达式是 $r$。那么，$r$“吃掉”一个字符 $c$ 之后产生的表达式 $r'$，能匹配的所有字符串就是所有满足 (match? (cat c s) r) 的字符串 $s$。\n读者可以自行思考一下导数公式。\n我想用代码表示是最清晰的。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 (define (derive re c) (match re [(Void) (Void)] [(Eps) (Void)] [(Dot) (Eps)] [(Chr ch) (if (char=? ch c) (Eps) (Void))] [(Alt e1 e2) (make-alt (derive e1 c) (derive e2 c))] [(Cat e1 e2) (if (nullable? e1) (make-alt (make-cat (derive e1 c) e2) (derive e2 c)) (make-cat (derive e1 c) e2))] [(Star e) (make-cat (derive e c) (Star e))])) 导数法将是我们使用的核心算法。\n特性与抽象语法 我们将实现支持连接（cat），选择（alt）与闭包（kleene star）三种特性的正则表达式。同时添加“任意字符”（Dot）这种有用的语法糖（为了辅助包含匹配）。\n使用 S-expression 以及 racket 结构体表达正则：\n1 2 3 4 5 6 7 regexp ::= (Void) | (Eps) | (Chr Char) | (Cat regexp regexp) | (Alt regexp regexp) | (Star regexp) | (Dot) 定义语法树节点：\n1 2 3 4 5 6 7 (struct Eps () #:transparent) ;; 空串 ε (struct Void () #:transparent) ;; 空集 φ (匹配失败) (struct Chr (c) #:transparent) ;; 字符 c (struct Cat (e1 e2) #:transparent) ;; 连接 e1 e2 (struct Alt (e1 e2) #:transparent) ;; 选择 e1 | e2 (struct Star (e) #:transparent) ;; 克林闭包 e* (struct Dot () #:transparent) ;; 语法糖：匹配任意字符 接下来我们要定义 Cat 和 Alt 的构造函数。这很重要，因为其中引入了一些简单的化简。这些化简是防止复杂度退化的重要工具。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 (define (make-cat a b) (match* (a b) [((Void) _) (Void)] [(_ (Void)) (Void)] [((Eps) r) r] [(r (Eps)) r] [(_ _) (Cat a b)])) (define (make-alt a b) (match* (a b) [((Void) _) b] [(_ (Void)) a] [(r r) r] [(_ _) (Alt a b)])) 流程设计 导数法是步进式的：给定一个正则和一个字符，返回一个新的正则。所以我们的匹配也是步进式的。\n我们将字符串转换为列表（相当于没有惰性求值的字符流）。然后一个一个吃字符，直到吃完为止。\n这时如何看匹不匹配呢？我们需要一个 nullable? 函数来判断一个正则能否匹配空串。如果字符串结束时的正则是 nullable? 的，则匹配（接受），否则不匹配（拒绝）。\n依然请读者自行思考实现。\n1 2 3 4 5 6 7 8 9 (define (nullable? re) (match re [(Eps) #t] [(Void) #f] [(Dot) #f] [(Chr _) #f] [(Star _) #t] [(Alt a b) (or (nullable? a) (nullable? b))] [(Cat a b) (and (nullable? a) (nullable? b))])) 缓存 有许多正则表达式，它们关于特定字符的后继会被多次计算。这是很大的开销，所以我们用哈希表把它们存起来。\n我们将使用一个二维哈希表，即 Hash\u0026lt;regexp -\u0026gt; Hash\u0026lt;char -\u0026gt; regexp\u0026gt;\u0026gt;。\n这样，判定给定字符串是否被给定正则接受就是简单的了。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 (define (make-matcher re) (define cache (make-hash)) (define (match-loop cur s) (cond [(null? s) (nullable? cur)] [else (let ([c (car s)]) (define next (hash-ref! (hash-ref! cache cur (lambda () (make-hash))) c (lambda () (derive cur c)))) (if (Void? next) #f (match-loop next (cdr s))))])) (lambda (str) (match-loop re (string-\u0026gt;list str)))) 至此，我们实现了一个基础的正则判定器。同时埋下伏笔。\n匹配 从头到尾扫描并对每个子串暴力判定显然是不好的，就像 brute-force 字符串模式匹配一样。\n要匹配正则在字符串的哪个地方出现了，我们有更精妙的做法。\n辅助正则 1 (define forward (Cat (Star (Dot)) regexp)) 用这个正则去匹配字符串（的前缀），我们就知道原始正则 regexp 在字符串中是否出现过了。\n通过对匹配过程的魔改，我们可以知道辅助正则匹配的第一个（或者最后一个，甚至中间任意一个）字符串前缀是什么。具体而言，对于所有 forward 满足 nullable? 的下标，我们记录其最小值或最大值。\n至于记录最小值还是最大值，决定了匹配行为。我的代码选择了最小值，也就是最左最短匹配。如果要实现贪婪匹配，需要记录最大值。\n我们记被我们记录的那个（能够被辅助正则匹配的）字符串前缀为 S，长度为 E。\n1 (define backward (re-reverse re)) 这是另一个辅助正则。其中，re-reverse 函数用来将一个正则表达式“反转”。即原始正则能匹配的任意字符串反转后都能被它返回的正则匹配，且它返回的正则不能匹配其他任何字符串。\n它的实现在这里：\n1 2 3 4 5 6 (define (re-reverse re) (match re [(Cat e1 e2) (make-cat (re-reverse e2) (re-reverse e1))] [(Alt e1 e2) (make-alt (re-reverse e1) (re-reverse e2))] [(Star e) (Star (re-reverse e))] [_ re])) 二遍扫描 将 S 反转。\n然后用 backward 匹配它（反转后的新字符串）的一个前缀。记长度为 T。\n那么原始正则 regexp 能够匹配的子串（的下标区间）就是 $[E - T, E)$.\n完整代码 精确判定和位置匹配都有一些测试用例。Gemini 写的。有比较好的注释。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 #lang racket (require srfi/13) ;; --------------------------------------------------------- ;; 1. 定义正则表达式的 AST (抽象语法树) ;; --------------------------------------------------------- (struct Eps () #:transparent) ;; 空串 ε (struct Void () #:transparent) ;; 空集 φ (匹配失败) (struct Chr (c) #:transparent) ;; 字符 c (struct Cat (e1 e2) #:transparent) ;; 连接 e1 e2 (struct Alt (e1 e2) #:transparent) ;; 选择 e1 | e2 (struct Star (e) #:transparent) ;; 克林闭包 e* (struct Dot () #:transparent) ;; 语法糖：匹配任意字符 (define (make-cat a b) (match* (a b) [((Void) _) (Void)] [(_ (Void)) (Void)] [((Eps) r) r] [(r (Eps)) r] [(_ _) (Cat a b)])) (define (make-alt a b) (match* (a b) [((Void) _) b] [(_ (Void)) a] [(r r) r] [(_ _) (Alt a b)])) (define (nullable? re) (match re [(Eps) #t] [(Void) #f] [(Dot) #f] [(Chr _) #f] [(Star _) #t] [(Alt a b) (or (nullable? a) (nullable? b))] [(Cat a b) (and (nullable? a) (nullable? b))])) (define (derive re c) (match re [(Void) (Void)] [(Eps) (Void)] [(Dot) (Eps)] [(Chr ch) (if (char=? ch c) (Eps) (Void))] [(Alt e1 e2) (make-alt (derive e1 c) (derive e2 c))] [(Cat e1 e2) (if (nullable? e1) (make-alt (make-cat (derive e1 c) e2) (derive e2 c)) (make-cat (derive e1 c) e2))] [(Star e) (make-cat (derive e c) (Star e))])) (define (make-matcher re) (define cache (make-hash)) (define (match-loop cur s) (cond [(null? s) (nullable? cur)] [else (let ([c (car s)]) (define next (hash-ref! (hash-ref! cache cur (lambda () (make-hash))) c (lambda () (derive cur c)))) (if (Void? next) #f (match-loop next (cdr s))))])) (lambda (str) (match-loop re (string-\u0026gt;list str)))) ;; --------------------------------------------------------- ;; 测试 ;; --------------------------------------------------------- ;; 正则: a(b|c)*d (define my-re (make-cat (Chr #\\a) (make-cat (Star (make-alt (Chr #\\b) (Chr #\\c))) (Chr #\\d)))) (define matches? (make-matcher my-re)) (displayln \u0026#34;Test Cases:\u0026#34;) (displayln (matches? \u0026#34;ad\u0026#34;)) ;; #t (displayln (matches? \u0026#34;abd\u0026#34;)) ;; #t (displayln (matches? \u0026#34;abccbd\u0026#34;)) ;; #t (displayln (matches? \u0026#34;add\u0026#34;)) ;; #f (displayln (matches? \u0026#34;a\u0026#34;)) ;; #f ;; 压力测试：状态缓存机制 ;; 第一次运行会构建缓存，第二次运行直接查表 (time (for ([i 10000]) (matches? \u0026#34;abcbcd\u0026#34;))) (define (re-reverse re) (match re [(Cat e1 e2) (make-cat (re-reverse e2) (re-reverse e1))] [(Alt e1 e2) (make-alt (re-reverse e1) (re-reverse e2))] [(Star e) (Star (re-reverse e))] [_ re])) (define (make-search re) (define forward (make-cat (Star (Dot)) re)) (define backward (re-reverse re)) (define cache (make-hash)) (define (match-loop cur s idx) (cond [(nullable? cur) idx] [(\u0026gt;= idx (string-length s)) #f] [else (let ([c (string-ref s idx)]) (define next (hash-ref! (hash-ref! cache cur (lambda () (make-hash))) c (lambda () (derive cur c)))) (if (Void? next) #f (match-loop next s (add1 idx))))])) (lambda (str) (define E (match-loop forward str 0)) (if E (begin (let ([T (match-loop backward (string-reverse str 0 E) 0)]) (cons (- E T) E))) #f))) ;; --------------------------------------------------------- ;; 4. 测试用例 ;; --------------------------------------------------------- (define search (make-search my-re)) (displayln \u0026#34;=== Standard Cases ===\u0026#34;) (displayln (search \u0026#34;ad\u0026#34;)) ;; \u0026#39;(0 . 2) (displayln (search \u0026#34;xxxad\u0026#34;)) ;; \u0026#39;(3 . 5) (displayln (search \u0026#34;adxxx\u0026#34;)) ;; \u0026#39;(0 . 2) -- 验证最左匹配 (displayln (search \u0026#34;xxxadxxx\u0026#34;)) ;; \u0026#39;(3 . 5) (displayln (search \u0026#34;abccbd\u0026#34;)) ;; \u0026#39;(0 . 6) (displayln (search \u0026#34;z\u0026#34;)) ;; #f (displayln \u0026#34;=== Edge Cases ===\u0026#34;) ;; 多个匹配，应该返回最左边的那个 (displayln (search \u0026#34;ad...ad\u0026#34;)) ;; \u0026#39;(0 . 2) ;; 贪婪/非贪婪行为测试 ;; 这里的实现是\u0026#34;最短匹配\u0026#34; (reluctant)，因为遇到 nullable 就立即返回了 ;; 对于 a(b|c)*d，如果输入 abdbd ;; forward 会在第一个 d 处 (index 3) 停止。 ;; backward 从 d 反向匹配到 a。 ;; 结果应该是 \u0026#39;(0 . 3) -\u0026gt; \u0026#34;abd\u0026#34; (displayln (search \u0026#34;abdbd\u0026#34;)) ;; \u0026#39;(0 . 3) ;; 复杂一点的 (displayln (search \u0026#34;zzzaaaaaaddddzzz\u0026#34;)) ;; \u0026#39;(8 . 10) -\u0026gt; 匹配了第一个 a..d 即 \u0026#34;ad\u0026#34; ;; 解释：因为 forward 匹配 .*a(b|c)*d。 ;; .* 吃了 \u0026#34;zzzaaaa\u0026#34;，然后 a 匹配 \u0026#34;a\u0026#34;，然后 d 匹配 \u0026#34;d\u0026#34;。 ;; 这里其实取决于 .* 的结合性，但在导数语义下，一旦 nullable 就停，这通常意味着匹配了\u0026#34;能匹配的最短前缀\u0026#34;。 复杂度问题 收回伏笔。\n1 2 3 4 5 6 7 8 9 10 (define (test-performance n) (printf \u0026#34;Testing n=~a... \u0026#34; n) (define part1 (for/fold ([acc (Eps]) ([i n]) (make-cat (make-alt (Eps) (make-chr #\\a)) acc))) (define part2 (for/fold ([acc (Eps]) ([i n]) (make-cat (make-chr #\\a) acc))) (define re (make-cat part1 part2)) (define matcher (make-matcher re)) (define input (make-string (* 2 n) #\\a)) (time (matcher input))) (test-performance 50) 这是一个经典的 hack。用类似下面的正则去匹配全 a 字符串：\n1 #(struct:Cat #(struct:Cat #(struct:Alt (#(struct:Chr a) #(struct:Eps))) #(struct:Alt (#(struct:Chr a) #(struct:Eps)))) #(struct:Cat #(struct:Chr a) #(struct:Chr a))) 即 a|Eps a|Eps a a。\n你会注意到数据规模达到 50 的时候卡死了。事实上，我们的简单引擎在这个 hack 下是指数复杂度（具体是 $O(2^n)$）的。\n问题的发掘，以及效率优化 问题在于缓存没有生效。具体而言，(Alt (Alt (Chr #\\a) (Chr #\\a)) (Chr #\\b)) 和 (Alt (Alt (Chr #\\a) (Chr #\\b)) (Chr #\\a)) 在语义上是相同的，但是结构上却不相等。这时两个状态都会被分别扔进缓存，复杂度就退化了。\n如何解决？我们需要把 Alt 节点拍平，并且按照一定顺序排序。\n“按照一定顺序排序”意味着我们需要给节点定义一个全序关系。这是难办的。\n直接递归比较会导致复杂度退化。\n经验丰富的读者们大概会想到给每个节点赋一个唯一的 uid。这是一个好主意，但是需要添加新的字段（表达式问题的一个侧面）。我比较懒，不想这么做。\n我们可以利用一种类似符号类型的驻留机制。使用哈希表存储所有出现过的表达式节点，来实现对于两个值相同的节点，保证它们是 eq? 的（即在内存中是同一个对象）。对于一个新构造的节点，如果它在哈希表中出现过，返回哈希表中记录的值，否则将这个节点构造出来扔进哈希表。\n这样，比较时就可以利用 eq-hash-code。虽然可能有冲突，但是概率很小（因为 eq-hash-code 的返回值是 61-62 位整数）。\n这份代码是 Gemini 帮忙写的。对于上面那个性能测试，大概在 n=100 时需要一秒多。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 #lang racket (require srfi/13) ;; 1. 定义 AST，通过 gen:equal+hash 强制 O(1) 比较 ;; 只要对象是驻留的，equal? 逻辑就等同于 eq? (struct Eps () #:transparent #:methods gen:equal+hash [(define (equal-proc a b recur) (eq? a b)) (define (hash-proc a recur) (eq-hash-code a)) (define (hash2-proc a recur) (eq-hash-code a))]) (struct Void () #:transparent #:methods gen:equal+hash [(define (equal-proc a b recur) (eq? a b)) (define (hash-proc a recur) (eq-hash-code a)) (define (hash2-proc a recur) (eq-hash-code a))]) (struct Chr (c) #:transparent #:methods gen:equal+hash [(define (equal-proc a b recur) (eq? a b)) (define (hash-proc a recur) (eq-hash-code a)) (define (hash2-proc a recur) (eq-hash-code a))]) (struct Cat (e1 e2) #:transparent #:methods gen:equal+hash [(define (equal-proc a b recur) (eq? a b)) (define (hash-proc a recur) (eq-hash-code a)) (define (hash2-proc a recur) (eq-hash-code a))]) (struct Alt (e-list) #:transparent #:methods gen:equal+hash [(define (equal-proc a b recur) (eq? a b)) (define (hash-proc a recur) (eq-hash-code a)) (define (hash2-proc a recur) (eq-hash-code a))]) (struct Star (e) #:transparent #:methods gen:equal+hash [(define (equal-proc a b recur) (eq? a b)) (define (hash-proc a recur) (eq-hash-code a)) (define (hash2-proc a recur) (eq-hash-code a))]) (struct Dot () #:transparent #:methods gen:equal+hash [(define (equal-proc a b recur) (eq? a b)) (define (hash-proc a recur) (eq-hash-code a)) (define (hash2-proc a recur) (eq-hash-code a))]) ;; 2. 驻留池 (Weak Hash Table) ;; 注意：池的 Key 必须使用 vector，因为 vector 的 equal? 会递归检查其内容 ;; 而内容（子节点）已经是驻留的，所以比较子节点是 O(1) 的 eq? (define pool (make-weak-hash)) (define (intern key constructor) (hash-ref! pool key constructor)) ;; 基础常量 (define phi (intern (vector \u0026#39;Void) (λ () (Void)))) (define eps (intern (vector \u0026#39;Eps) (λ () (Eps)))) (define dot (intern (vector \u0026#39;Dot) (λ () (Dot)))) ;; 3. 辅助排序函数：利用 eq-hash-code 实现常数时间全序 (define (re-type-rank r) (cond [(Void? r) 0] [(Eps? r) 1] [(Dot? r) 2] [(Chr? r) 3] [(Star? r) 4] [(Cat? r) 5] [(Alt? r) 6])) (define (re-compare r1 r2) (let ([t1 (re-type-rank r1)] [t2 (re-type-rank r2)]) (if (= t1 t2) (\u0026lt; (eq-hash-code r1) (eq-hash-code r2)) (\u0026lt; t1 t2)))) ;; 4. 智能构造函数 (define (make-chr c) (intern (vector \u0026#39;Chr c) (λ () (Chr c)))) (define (make-star e) (cond [(Void? e) eps] [(Eps? e) eps] [(Star? e) e] [else (intern (vector \u0026#39;Star e) (λ () (Star e)))])) (define (make-cat e1 e2) (cond [(or (Void? e1) (Void? e2)) phi] [(Eps? e1) e2] [(Eps? e2) e1] [else (intern (vector \u0026#39;Cat e1 e2) (λ () (Cat e1 e2)))])) (define (make-alt l) (define (flatten es) (append-map (λ (x) (if (Alt? x) (Alt-e-list x) (list x))) es)) (let* ([flat (flatten l)] [no-phi (filter-not Void? flat)] ;; 使用 eq-hash-code 排序，确保 ACI 规范化 [sorted (sort no-phi re-compare)] [unique (remove-duplicates sorted eq?)]) (cond [(null? unique) phi] [(null? (cdr unique)) (car unique)] [else (intern (vector \u0026#39;Alt unique) (λ () (Alt unique)))]))) ;; 5. 导数与判空 (define (nullable? re) (match re [(Eps) #t] [(Star _) #t] [(Alt es) (ormap nullable? es)] [(Cat e1 e2) (and (nullable? e1) (nullable? e2))] [_ #f])) (define (derive re c) (match re [(Void) phi] [(Eps) phi] [(Dot) eps] [(Chr ch) (if (char=? ch c) eps phi)] [(Alt es) (make-alt (map (λ (e) (derive e c)) es))] [(Cat e1 e2) (if (nullable? e1) (make-alt (list (make-cat (derive e1 c) e2) (derive e2 c))) (make-cat (derive e1 c) e2))] [(Star e) (make-cat (derive e c) re)])) ;; --------------------------------------------------------- ;; 1. 匹配器构造 (完全匹配) ;; --------------------------------------------------------- (define (make-matcher re) (define cache (make-hash)) ;; 状态转移缓存: cur -\u0026gt; char -\u0026gt; next (lambda (str) (let loop ([cur re] [s (string-\u0026gt;list str)]) (if (null? s) (nullable? cur) (let ([next (hash-ref! (hash-ref! cache cur (λ () (make-hash))) (car s) (λ () (derive cur (car s))))]) (if (Void? next) #f (loop next (cdr s)))))))) ;; --------------------------------------------------------- ;; 2. 正则表达式反转 ;; --------------------------------------------------------- (define (re-reverse re) (match re [(Cat e1 e2) (make-cat (re-reverse e2) (re-reverse e1))] [(Alt es) (make-alt (map re-reverse es))] [(Star e) (make-star (re-reverse e))] [_ re])) ;; --------------------------------------------------------- ;; 3. 搜索器构造 (子串匹配: 最左最短) ;; --------------------------------------------------------- (define (make-search re) ;; 前向搜索: 匹配 .*RE (define forward-re (make-cat (make-star dot) re)) ;; 后向搜索: 匹配 RE_reversed (define backward-re (re-reverse re)) (define f-cache (make-hash)) (define b-cache (make-hash)) (define (step cache cur c) (hash-ref! (hash-ref! cache cur (λ () (make-hash))) c (λ () (derive cur c)))) (lambda (str) (let* ([chars (string-\u0026gt;list str)]) ;; 1. 前向扫描：寻找第一个能让 (.*RE) 变成 nullable 的位置 E (define E (let f-loop ([cur forward-re] [s chars] [idx 0]) (cond [(nullable? cur) idx] ;; 找到匹配终点 [(null? s) #f] [else (let ([next (step f-cache cur (car s))]) (if (Void? next) #f (f-loop next (cdr s) (add1 idx))))]))) (if E ;; 2. 后向扫描：从 E 位置开始向左匹配 RE_rev，寻找最短的起点 ;; 提取前 E 个字符并反转 (let* ([prefix-rev (reverse (take chars E))] [T (let b-loop ([cur backward-re] [s prefix-rev] [idx 0]) (cond [(nullable? cur) idx] ;; 找到匹配起点（距离 E 的偏移） [(null? s) (if (nullable? cur) idx #f)] [else (let ([next (step b-cache cur (car s))]) (if (Void? next) #f (b-loop next (cdr s) (add1 idx))))]))]) (cons (- E T) E)) #f)))) ;; --------------------------------------------------------- ;; 测试脚本 ;; --------------------------------------------------------- (define (run-tests) (define a (make-chr #\\a)) (define b (make-chr #\\b)) (define c (make-chr #\\c)) (define d (make-chr #\\d)) ;; 正则: a(b|c)*d (define my-re (make-cat a (make-cat (make-star (make-alt (list b c))) d))) (printf \u0026#34;=== Testing Matcher ===\\n\u0026#34;) (define matches? (make-matcher my-re)) (displayln (list \u0026#39;ad (matches? \u0026#34;ad\u0026#34;))) ; #t (displayln (list \u0026#39;abd (matches? \u0026#34;abd\u0026#34;))) ; #t (displayln (list \u0026#39;abccbd (matches? \u0026#34;abccbd\u0026#34;))) ; #t (displayln (list \u0026#39;add (matches? \u0026#34;add\u0026#34;))) ; #f (displayln (list \u0026#39;a (matches? \u0026#34;a\u0026#34;))) ; #f (printf \u0026#34;\\n=== Testing Searcher ===\\n\u0026#34;) (define search (make-search my-re)) (displayln (list \u0026#39;search-ad (search \u0026#34;ad\u0026#34;))) ; \u0026#39;(0 . 2) (displayln (list \u0026#39;search-xxxad (search \u0026#34;xxxad\u0026#34;))) ; \u0026#39;(3 . 5) (displayln (list \u0026#39;search-adxxx (search \u0026#34;adxxx\u0026#34;))) ; \u0026#39;(0 . 2) (displayln (list \u0026#39;search-abccbd (search \u0026#34;abccbd\u0026#34;))) ; \u0026#39;(0 . 6) (displayln (list \u0026#39;search-none (search \u0026#34;xyz\u0026#34;))) ; #f (printf \u0026#34;\\n=== Testing Complex Search (Shortest-Left) ===\\n\u0026#34;) ;; 多个匹配，应该返回最左边的那个 (displayln (list \u0026#39;multi-ad (search \u0026#34;ad...ad\u0026#34;))) ; \u0026#39;(0 . 2) ;; 贪婪/非贪婪行为测试 ;; 在 \u0026#34;abdbd\u0026#34; 中，forward 会在第一个 d (index 3) 停止，然后 backward 找到 a。 (displayln (list \u0026#39;abdbd (search \u0026#34;abdbd\u0026#34;))) ; \u0026#39;(0 . 3) -\u0026gt; \u0026#34;abd\u0026#34; ;; 验证 a...d 在长字符串中的表现 (displayln (list \u0026#39;long-str (search \u0026#34;zzzaaaaaaddddzzz\u0026#34;))) ; \u0026#39;(8 . 10) -\u0026gt; \u0026#34;ad\u0026#34; (printf \u0026#34;\\n=== Testing Reverse Logic ===\\n\u0026#34;) ;; 测试反转后的匹配 (d (b|c)* a) (define rev-matches? (make-matcher (re-reverse my-re))) (displayln (list \u0026#39;rev-da (rev-matches? \u0026#34;da\u0026#34;))) ; #t (displayln (list \u0026#39;rev-dbca (rev-matches? \u0026#34;dbca\u0026#34;))) ; #t (displayln (list \u0026#39;rev-ad (rev-matches? \u0026#34;ad\u0026#34;))) ; #f (printf \u0026#34;\\nAll functional tests finished.\\n\u0026#34;)) (run-tests) ","permalink":"https://litjohn.github.io/posts/regular-engine/","summary":"\u003cblockquote\u003e\n\u003cp\u003e亲手实现一个正则引擎！\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e众所周知，一类经典的自动机是有限状态自动机。它们识别的语言是正则语言，而正则表达式能够匹配的字符串的集合也是正则语言。\u003c/p\u003e\n\u003cp\u003e（如果你之前没有了解过，询问 AI 或是使用搜索引擎都很适合快速了解）\u003c/p\u003e\n\u003ch2 id=\"导数法\"\u003e导数法\u003c/h2\u003e\n\u003cp\u003e要匹配一个正则表达式，最经典的方法就是构造对应的 NFA，然后通过一些手法转化为 DFA。但这太复杂了。有没有更简单的方法呢？\u003c/p\u003e\n\u003cp\u003e有一种被称为“导数法”的方法。\u003c/p\u003e\n\u003cp\u003e思想非常简单：我们将构造出的 DFA 编码为一个正则。这样，转移之后相当于产生了一个新的自动机，也就是一个新的正则表达式。\u003c/p\u003e\n\u003cp\u003e原始正则表达式是 $r$。那么，$r$“吃掉”一个字符 $c$ 之后产生的表达式 $r'$，能匹配的所有字符串就是所有满足 \u003ccode\u003e(match? (cat c s) r)\u003c/code\u003e 的字符串 $s$。\u003c/p\u003e\n\u003cp\u003e读者可以自行思考一下导数公式。\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e我想用代码表示是最清晰的。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-racket\" data-lang=\"racket\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ederive\u003c/span\u003e \u003cspan class=\"n\"\u003ere\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ematch\u003c/span\u003e \u003cspan class=\"n\"\u003ere\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"n\"\u003eVoid\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eVoid\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"n\"\u003eEps\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eVoid\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"n\"\u003eDot\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eEps\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"n\"\u003eChr\u003c/span\u003e \u003cspan class=\"n\"\u003ech\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003echar=?\u003c/span\u003e \u003cspan class=\"n\"\u003ech\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eEps\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eVoid\u003c/span\u003e\u003cspan class=\"p\"\u003e))]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"n\"\u003eAlt\u003c/span\u003e \u003cspan class=\"n\"\u003ee1\u003c/span\u003e \u003cspan class=\"n\"\u003ee2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e     \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emake-alt\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ederive\u003c/span\u003e \u003cspan class=\"n\"\u003ee1\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ederive\u003c/span\u003e \u003cspan class=\"n\"\u003ee2\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e))]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"n\"\u003eCat\u003c/span\u003e \u003cspan class=\"n\"\u003ee1\u003c/span\u003e \u003cspan class=\"n\"\u003ee2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e     \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enullable?\u003c/span\u003e \u003cspan class=\"n\"\u003ee1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e         \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emake-alt\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emake-cat\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ederive\u003c/span\u003e \u003cspan class=\"n\"\u003ee1\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003ee2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ederive\u003c/span\u003e \u003cspan class=\"n\"\u003ee2\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e         \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emake-cat\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ederive\u003c/span\u003e \u003cspan class=\"n\"\u003ee1\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003ee2\u003c/span\u003e\u003cspan class=\"p\"\u003e))]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"n\"\u003eStar\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e     \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emake-cat\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ederive\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eStar\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e))]))\u003c/span\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e导数法将是我们使用的核心算法。\u003c/p\u003e\n\u003ch2 id=\"特性与抽象语法\"\u003e特性与抽象语法\u003c/h2\u003e\n\u003cp\u003e我们将实现支持连接（cat），选择（alt）与闭包（kleene star）三种特性的正则表达式。同时添加“任意字符”（Dot）这种有用的语法糖（为了辅助包含匹配）。\u003c/p\u003e\n\u003cp\u003e使用 S-expression 以及 racket 结构体表达正则：\u003c/p\u003e","title":"Regular Engine"},{"content":"（这篇文章经过了我与 Gemini 3 的讨论之后对观点有所补充。现在的文本不再是我的原文，而是 Gemini 3 将我的新观点加入原文后的新版本）\n省流：\n“你总要知道自己要做些什么吧？”\n程序员到底在做什么？\n有时候我甚至觉得，这个行业里只有两种工作：一种是不怎么考验智力的“搬砖”，另一种是极其考验智力但往往被视为“无意义”的“造轮子”。\n大部分人都在做前者。每天处理具体的业务逻辑，写写 CRUD，修修边角料。这种工作与其说是在搞“技术”，不如说是在做“翻译”——把产品经理的人话，翻译成机器能跑的代码。\n于是有人不甘心，想去做后者。去研究底层，去造轮子，去搞基础架构。但这又陷入了另一个怪圈：所谓的“硬核技术”，如果没有人用，那就是孤芳自赏的抽象废话。基础研究如同攀登珠峰，那是极少数天才的游戏；而对于大多数想靠代码吃饭的人来说，如果不通过“应用”落地，技术本身甚至无法产生供你生存的价值。\n这就触及到了计算机科学（CS）一个让人尴尬的本质：CS 本身是空心的。\n想想看，程序员这一职业，最核心的“独占技能”是什么？是写程序。\n但这就像“会写字”一样。你会写字，不代表你是作家；你会写字，甚至不代表你能写好一份通知。\n如果你只会编程语言的语法，只会调库，那你充其量是一个精通语法的“语言学家”。\n但是，语言是为了表达而存在的。如果你脑子里没有“内容”，光有语言有什么用？\n很多程序员的迷茫正源于此：我们花了大量精力去学习“怎么说话”（学各种语言、框架、模式），却很少去想“我们要说什么”。\n所以你会发现，真正牛逼的成果，往往是“计算机 + X”。\n前端开发，本质是“程序员 + 设计师/心理学”；\n科学计算，本质是“程序员 + 数学/物理”；\n推荐算法，本质是“程序员 + 统计学/商业逻辑”；\n哪怕是做编译器、做云平台的那些大牛，他们的“X”是“系统工程”——他们的目标非常明确：我要让这一千万行代码跑得更快，让那一万台机器不至于因为一根网线断了就全盘崩溃。\n王垠以前说过，CS 的本质是 PLT（编程语言理论）。这话乍一听像自吹自擂，但细想有几分道理。剥离掉所有应用层的东西，CS 剩下的确实就只有关于“计算”本身的抽象逻辑。但这玩意儿太冷清了，就像纯数学一样，容不下这个世界上几千万的从业者。\n所以，别再被“计算机专业”这个名字骗了。\n我们可能真的不该把“计算机”视为一个独立的、封闭的堡垒。计算机不是目的，它是手段。它是赋能万物的工具，是新时代的“笔和纸”。\n这就能解释为什么很多科班出身的人最终活成了“码农”。因为他们真的只会计算机，只会摆弄这支笔，却不知道该用它画什么画，写什么书。\n这行没什么前途吗？\n如果你把自己定义为“写代码的人”，那确实没前途，因为 AI 写得比你快。\n但如果你把自己定义为“用计算机解决问题的人”，那前途才刚刚开始。\n我们要避免的窘境，是手里拿着锤子，却看不见钉子，最后只能在那研究锤子的金属成分。\n真正的程序员，心里装的不该只是代码，而应该是一个他想要构建的、运行在现实世界里的系统。\n不管这个系统是用来算核聚变的，还是用来送外卖的。 知道自己要“构建什么”，远比知道“怎么写代码”重要。\n","permalink":"https://litjohn.github.io/posts/%E5%90%8C%E5%AD%A6%E4%BD%A0%E6%98%AF%E5%81%9A%E4%BB%80%E4%B9%88%E5%B7%A5%E4%BD%9C%E7%9A%84/","summary":"\u003cp\u003e（这篇文章经过了我与 Gemini 3 的讨论之后对观点有所补充。现在的文本不再是我的原文，而是 Gemini 3 将我的新观点加入原文后的新版本）\u003c/p\u003e\n\u003cp\u003e省流：\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e“你总要知道自己要做些什么吧？”\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003chr\u003e\n\u003cp\u003e程序员到底在做什么？\u003c/p\u003e\n\u003cp\u003e有时候我甚至觉得，这个行业里只有两种工作：一种是不怎么考验智力的“搬砖”，另一种是极其考验智力但往往被视为“无意义”的“造轮子”。\u003c/p\u003e\n\u003cp\u003e大部分人都在做前者。每天处理具体的业务逻辑，写写 CRUD，修修边角料。这种工作与其说是在搞“技术”，不如说是在做“翻译”——把产品经理的人话，翻译成机器能跑的代码。\u003c/p\u003e\n\u003cp\u003e于是有人不甘心，想去做后者。去研究底层，去造轮子，去搞基础架构。但这又陷入了另一个怪圈：所谓的“硬核技术”，如果没有人用，那就是孤芳自赏的抽象废话。基础研究如同攀登珠峰，那是极少数天才的游戏；而对于大多数想靠代码吃饭的人来说，如果不通过“应用”落地，技术本身甚至无法产生供你生存的价值。\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e这就触及到了计算机科学（CS）一个让人尴尬的本质：\u003cstrong\u003eCS 本身是空心的。\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e想想看，程序员这一职业，最核心的“独占技能”是什么？是写程序。\u003cbr\u003e\n但这就像“会写字”一样。你会写字，不代表你是作家；你会写字，甚至不代表你能写好一份通知。\u003cbr\u003e\n如果你只会编程语言的语法，只会调库，那你充其量是一个精通语法的“语言学家”。\u003c/p\u003e\n\u003cp\u003e但是，语言是为了表达而存在的。如果你脑子里没有“内容”，光有语言有什么用？\u003cbr\u003e\n很多程序员的迷茫正源于此：我们花了大量精力去学习“怎么说话”（学各种语言、框架、模式），却很少去想“我们要说什么”。\u003c/p\u003e\n\u003cp\u003e所以你会发现，真正牛逼的成果，往往是“计算机 + X”。\u003cbr\u003e\n前端开发，本质是“程序员 + 设计师/心理学”；\u003cbr\u003e\n科学计算，本质是“程序员 + 数学/物理”；\u003cbr\u003e\n推荐算法，本质是“程序员 + 统计学/商业逻辑”；\u003cbr\u003e\n哪怕是做编译器、做云平台的那些大牛，他们的“X”是“系统工程”——他们的目标非常明确：我要让这一千万行代码跑得更快，让那一万台机器不至于因为一根网线断了就全盘崩溃。\u003c/p\u003e\n\u003cp\u003e王垠以前说过，CS 的本质是 PLT（编程语言理论）。这话乍一听像自吹自擂，但细想有几分道理。剥离掉所有应用层的东西，CS 剩下的确实就只有关于“计算”本身的抽象逻辑。但这玩意儿太冷清了，就像纯数学一样，容不下这个世界上几千万的从业者。\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e所以，别再被“计算机专业”这个名字骗了。\u003c/p\u003e\n\u003cp\u003e我们可能真的不该把“计算机”视为一个独立的、封闭的堡垒。计算机不是目的，它是手段。它是赋能万物的工具，是新时代的“笔和纸”。\u003c/p\u003e\n\u003cp\u003e这就能解释为什么很多科班出身的人最终活成了“码农”。因为他们真的只会计算机，只会摆弄这支笔，却不知道该用它画什么画，写什么书。\u003c/p\u003e\n\u003cp\u003e这行没什么前途吗？\u003cbr\u003e\n如果你把自己定义为“写代码的人”，那确实没前途，因为 AI 写得比你快。\u003cbr\u003e\n但如果你把自己定义为“用计算机解决问题的人”，那前途才刚刚开始。\u003c/p\u003e\n\u003cp\u003e我们要避免的窘境，是手里拿着锤子，却看不见钉子，最后只能在那研究锤子的金属成分。\u003cbr\u003e\n真正的程序员，心里装的不该只是代码，而应该是一个他想要构建的、运行在现实世界里的系统。\u003c/p\u003e\n\u003cp\u003e不管这个系统是用来算核聚变的，还是用来送外卖的。\n知道自己要“构建什么”，远比知道“怎么写代码”重要。\u003c/p\u003e","title":"同学你是做什么工作的"},{"content":"题目链接\n题外话：\n数竞党的防御性证明会用严谨的逻辑说明结论的正确性，而对“解题思路是如何想到的”一类的问题没有任何启发；oier/acmer 的题解则大多会提示我们从哪里入手，却不加严谨的证明。而本题解采取折中的方案：既对解题思路没有任何启发，也不加严谨的证明。\n考虑 gcd 的动机在于，对于这样的题，$k$ 巨大。\n于是考虑循环节。发现循环节是 $\\mathrm{lcm}(n, m)$。\n这时，我们考虑完整的循环节。\n发现在 $n$ 与 $m$ 不互素时这是麻烦的，而 $n$ 与 $m$ 互素时一个循环节内每对 $(a_i, b_j)$ 刚好出现且仅出现一次。\n这时考虑 $g = \\gcd(n, m)$。\n发现，对于任意 $r$，一个模 $g$ 余 $r$ 的 $i$ 只会和模 $g$ 余 $r$ 的 $j$ 配对。\n这样就能够把非互素情形转化为互素情形。\n对于互素情形，循环节是容易处理的。\n考虑多余的一部分。这时，考虑枚举 $i$，寻找能与 $i$ 配对的 $j$。\n记 $n' = n / g, m' = m / g$。\n这时，对于一个下标 $i$，能够与它配对的任意 $j$ 与 $kn'+i, k \\in \\N$ 在模 $m'$ 意义下同余。\n这样，我们对 $b$ 重排，将 $b_j$ 挪到 $b_{j \\times \\mathrm{inv}(n') \\bmod m'}$。\n发现所有 $i$ 对应的 $b$ 中元素是一个完整的区间。那么找出这个区间并计算它的贡献。\n区间是容易找到的。\n第一个索引是 $i \\times \\mathrm{inv}(n') \\bmod m'$。\n长度则是 $\\lfloor c/n' \\rfloor + [c \\bmod n' \\geq i]$。\n其中方括号是艾弗森括号，$c$ 是循环节之外的“剩余部分”的操作总数。\n下一步是利用数据结构维护区间的贡献。\n于是转化为给定若干询问 $(\\mathrm{range}, \\mathrm{lim})$，查询 $\\mathrm{range}$ 中小于 $\\mathrm{lim}$ 的元素的和与数量。\n这是一个二维数点问题。离线使用 BIT 维护值域上前缀计数与前缀和，扫描线即可。\nAC 代码：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 #include \u0026lt;bits/stdc++.h\u0026gt; using namespace std; constexpr int mod = 998244353; int n, m; long long k; array\u0026lt;int, 200005\u0026gt; a, b; pair\u0026lt;long long, long long\u0026gt; exgcd(long long a, long long b) { if (b == 0) { return {1, 0}; } else { auto [x, y] = exgcd(b, a % b); return {y, x - (a / b) * y}; } } struct question { int pos, lim; bool op; question(int pos, bool op, int lim) : pos(pos), op(op), lim(lim) {} friend bool operator\u0026lt;(const question \u0026amp;lhs, const question \u0026amp;rhs) { return lhs.pos \u0026lt; rhs.pos; } }; int64_t solve(vector\u0026lt;int\u0026gt; \u0026amp;a, vector\u0026lt;int\u0026gt; \u0026amp;b, const int n, const int m, long long cnt) { auto copy = b; ranges::sort(copy); auto prefix_sum = copy; for (int i = 0; i + 1 \u0026lt; m; ++i) { prefix_sum[i + 1] = (prefix_sum[i + 1] + prefix_sum[i]) % mod; } long long res = 0; const int64_t num = cnt / ((long long) n * m), rem = cnt - num * n * m; for (int v: a) { auto it = ranges::upper_bound(copy, v); int c = distance(copy.begin(), it); res = (res + (c \u0026gt; 0 ? prefix_sum[c - 1] : 0) + (long long) (m - c) * v) % mod; } res = (res * (num % mod)) % mod; // cerr \u0026lt;\u0026lt; res \u0026lt;\u0026lt; \u0026#34;\\n\u0026#34;; const int64_t inv = (exgcd(n, m).first % m + m) % m; // cerr \u0026lt;\u0026lt; inv \u0026lt;\u0026lt; \u0026#34;\\n\u0026#34;; for (int i = 0; i \u0026lt; m; ++i) { copy[i * inv % m] = b[i]; } vector\u0026lt;question\u0026gt; questions; for (int i = 0; i \u0026lt; n; ++i) { const int start = i * inv % m, len = rem / n + (rem % n \u0026gt; i); // cerr \u0026lt;\u0026lt; i \u0026lt;\u0026lt; \u0026#34; \u0026#34; \u0026lt;\u0026lt; start \u0026lt;\u0026lt; \u0026#34; \u0026#34; \u0026lt;\u0026lt; len \u0026lt;\u0026lt; \u0026#34;\\n\u0026#34;; if (start + len \u0026lt;= m) { questions.emplace_back(start - 1, false, a[i]); questions.emplace_back(start + len - 1, true, a[i]); } else { questions.emplace_back(start - 1, false, a[i]); questions.emplace_back(m - 1, true, a[i]); questions.emplace_back(len - (m - start) - 1, true, a[i]); } } vector\u0026lt;int\u0026gt; mapping; for (int i = 0; i \u0026lt; n; ++i) { mapping.push_back(a[i]); } for (int i = 0; i \u0026lt; m; ++i) { mapping.emplace_back(b[i]); } ranges::sort(mapping); mapping.erase(ranges::unique(mapping).begin(), mapping.end()); vector\u0026lt;int\u0026gt; bit_cnt(mapping.size() + 2, 0), bit_sum(mapping.size() + 2, 0); auto get_id = [\u0026amp;mapping](int x) { return distance(mapping.begin(), ranges::upper_bound(mapping, x)); }; auto low_bit = [](int x) { return x \u0026amp; (-x); }; auto query = [low_bit](int pos, auto \u0026amp;arr) { int res = 0; while (pos) { res = (res + arr[pos]) % mod; pos -= low_bit(pos); } return res; }; auto add = [low_bit](int pos, int val, auto \u0026amp;arr) { while (pos \u0026lt; arr.size()) { arr[pos] = (arr[pos] + val) % mod; pos += low_bit(pos); } }; sort(questions.begin(), questions.end()); int ptr = 0; for (const auto [pos, lim, op]: questions) { if (pos \u0026gt;= 0) { // cerr \u0026lt;\u0026lt; pos \u0026lt;\u0026lt; \u0026#34; \u0026#34; \u0026lt;\u0026lt; lim \u0026lt;\u0026lt; \u0026#34; \u0026#34; \u0026lt;\u0026lt; op \u0026lt;\u0026lt; \u0026#34;\\n\u0026#34;; const int f = (op ? 1 : -1); while (ptr \u0026lt;= pos) { add(get_id(copy[ptr]), 1, bit_cnt); add(get_id(copy[ptr]), copy[ptr], bit_sum); ptr++; } const int rank = get_id(lim); const int term1 = query(rank, bit_cnt), term2 = query(rank, bit_sum); const int64_t term3 = (term2 + (long long) (pos + 1 - term1) * lim) % mod; res += f * term3; res %= mod; if (res \u0026lt; 0) { res += mod; } } } return res; } int main() { ios_base::sync_with_stdio(false); cin.tie(nullptr); cin \u0026gt;\u0026gt; n \u0026gt;\u0026gt; m \u0026gt;\u0026gt; k; for (int i = 0; i \u0026lt; n; ++i) { cin \u0026gt;\u0026gt; a[i]; } for (int i = 0; i \u0026lt; m; ++i) { cin \u0026gt;\u0026gt; b[i]; } const int g = gcd(m, n); long long ans = 0; for (int i = 0; i \u0026lt; g; ++i) { vector\u0026lt;int\u0026gt; tmp1, tmp2; for (int j = i; j \u0026lt; n; j += g) { tmp1.push_back(a[j]); } for (int j = i; j \u0026lt; m; j += g) { tmp2.push_back(b[j]); } ans = (ans + solve(tmp1, tmp2, n / g, m / g, k / g + (k % g \u0026gt; i))) % mod; } cout \u0026lt;\u0026lt; ans; return 0; } ","permalink":"https://litjohn.github.io/posts/solution-of-abc438g/","summary":"\u003cp\u003e\u003ca href=\"https://atcoder.jp/contests/abc438/tasks/abc438_g\"\u003e题目链接\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e题外话：\u003c/p\u003e\n\u003cp\u003e数竞党的防御性证明会用严谨的逻辑说明结论的正确性，而对“解题思路是如何想到的”一类的问题没有任何启发；oier/acmer 的题解则大多会提示我们从哪里入手，却不加严谨的证明。而本题解采取折中的方案：既对解题思路没有任何启发，也不加严谨的证明。\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e考虑 gcd 的动机在于，对于这样的题，$k$ 巨大。\u003cbr\u003e\n于是考虑循环节。发现循环节是 $\\mathrm{lcm}(n, m)$。\u003c/p\u003e\n\u003cp\u003e这时，我们考虑完整的循环节。\u003cbr\u003e\n发现在 $n$ 与 $m$ 不互素时这是麻烦的，而 $n$ 与 $m$ 互素时一个循环节内每对 $(a_i, b_j)$ 刚好出现且仅出现一次。\u003c/p\u003e\n\u003cp\u003e这时考虑 $g = \\gcd(n, m)$。\u003cbr\u003e\n发现，对于任意 $r$，一个模 $g$ 余 $r$ 的 $i$ 只会和模 $g$ 余 $r$ 的 $j$ 配对。\u003cbr\u003e\n这样就能够把非互素情形转化为互素情形。\u003c/p\u003e\n\u003cp\u003e对于互素情形，循环节是容易处理的。\u003cbr\u003e\n考虑多余的一部分。这时，考虑枚举 $i$，寻找能与 $i$ 配对的 $j$。\u003c/p\u003e\n\u003cp\u003e记 $n' = n / g, m' = m / g$。\u003cbr\u003e\n这时，对于一个下标 $i$，能够与它配对的任意 $j$ 与 $kn'+i, k \\in \\N$ 在模 $m'$ 意义下同余。\u003c/p\u003e","title":"Solution of ABC438G"},{"content":"假设你刚刚看过这篇文章：浅谈valarray。\n现在我们需要模仿 valarray 写一个科学计算库。其中，我们需要支持形如 a + b 的写法，a 和 b 是两个向量，这个表达式的值是两个向量的和，即逐元素相加得到的新向量。\n没错。这是运算符重载板子。你也许会写出类似这样的代码：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 template\u0026lt;typename T\u0026gt; struct Vector { std::vector\u0026lt;T\u0026gt; data; // 构造函数，方便初始化 Vector(size_t n = 0) : data(n) {} Vector(std::initializer_list\u0026lt;T\u0026gt; l) : data(l) {} T operator[](size_t i) const { return data[i]; } T \u0026amp;operator[](size_t i) { return data[i]; } size_t size() const { return data.size(); } Vector operator+(const Vector \u0026amp;rhs) const { Vector res(size()); // 初始化大小 for (size_t i = 0; i \u0026lt; size(); ++i) { res[i] = data[i] + rhs[i]; } return res; // 依赖 NRVO } }; 题外话：\n注意加法中的 const\u0026amp; 参数类型。它是为了方便接受临时 Vector 对象（右值）：普通左值引用会 CE。\n而在 C++ 规范中，const 左值引用（const T\u0026amp;）是一个“万能引用”，它可以绑定到临时对象（右值）。\nC++ 标准规定：常量左值引用可以延长临时对象的生命周期，直到该引用本身被销毁。这使得 const T\u0026amp; 成了 C++ 历史上最通用的参数传递方式：它既能接左值（变量），也能接右值（临时对象），且保证不会修改它。\n看上去非常正确。然而，这个写法在嵌套的表达式（比如 a+b+c 三个向量相加）时，会多次循环遍历数组，并且生成和废弃大量的向量对象（res 的分配，以及右值在表达式中当加法调用完毕生命周期就结束，从而被释放）。\n这是不好的。如果手写，我们只需要 res[i] = a[i] + b[i] + c[i]; 就行了，根本不需要这么多中间变量的分配，循环遍历和缓存未命中开销也会更小。\n但是手写看上去丑陋和费事的多。能不能使用一些手法，使得我们能够兼顾优雅和高性能呢？\n有的，兄弟！有的。\n表达式模板 前人想到了一个非常天才的主意：利用模板系统的元编程能力，将表达式信息编码在类型中，自动展开为高效的计算过程。\n这样说比较抽象。具体的，a+b 这个表达式不会被立即求值，而是会生成一棵 addexp\u0026lt;Vector, Vector\u0026gt; 类型的表达式树。这个表达式树可以被随机访问，访问它的第 i 个位置时，编译器会自动从它的数据源计算出第 i 个位置的值。\n在上面的具体例子中，第 i 个位置的值就是 a[i]+b[i]。\n而这棵树可以赋值给普通的 Vector。赋值时，我们遍历 $i\\in [0, \\text{size})$，将目标 Vector 的第 $i$ 个位置赋值为表达式树的第 $i$ 个位置的值。\n这就是表达式模板技术。\n统一表示 在工程实现中，我们一般会实现一个基类 Exp，它有一个 operator[] 声明。而所有的表达式类，包括二元表达式以及 Vector 自己，都继承它，并实现 operator[] 作为随机访问的接口。\n这样做的优势是可扩展性强，表示统一简洁。\n奇异递归模板模式 你可能注意到了，这个思想其实要求我们实现多态。多态的一般写法是 virtual 声明虚函数，override 重写实现。然而，这里无法使用这种一般做法。\n因为虚函数需要查表和维护 RTTI（运行时类型信息），有内存和时间的双重开销。对于科学计算，这是不可容忍的。\n前人又有一种惊世骇俗的方法，专门用于实现零开销的静态多态。也就是“奇异递归模板模式”。\n看起来像是这样：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 template\u0026lt;typename T\u0026gt; struct Exp { auto operator[](size_t i) const { return static_cast\u0026lt;T\u0026gt;(*this)[i]; } }; template\u0026lt;typename T\u0026gt; struct Vector : public Exp\u0026lt;Vector\u0026lt;T\u0026gt;\u0026gt; { std::vector\u0026lt;T\u0026gt; data; // 构造函数，方便初始化 Vector(size_t n = 0) : data(n) {} Vector(std::initializer_list\u0026lt;T\u0026gt; l) : data(l) {} T operator[](size_t i) const { return data[i]; } T \u0026amp;operator[](size_t i) { return data[i]; } size_t size() const { return data.size(); } // 修正后的加法实现 Vector operator+(const Vector \u0026amp;rhs) const { Vector res(size()); // 初始化大小 for (size_t i = 0; i \u0026lt; size(); ++i) { res[i] = data[i] + rhs[i]; } return res; // 依赖 NRVO } }; 我想你应该能看懂。基类是一个模板类，子类则继承自基类，并将基类的模板参数填入自己。基类中的多态函数在被调用时，把基类强转为子类，并调用子类的实现。\n本来，从超类型到子类型的转换其实是不安全的（需要 dynamic_cast）。不过，这里我们可以确保强转的那个子类一定是数据的真实类型，不会出锅。\n某种意义上，其实是我们手动实现了一个 Union type，在模板参数中记录它的类型信息。\n原力闪电 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 template\u0026lt;typename T\u0026gt; struct Exp { auto operator[](size_t i) const { return static_cast\u0026lt;const T \u0026amp;\u0026gt;(*this)[i]; } size_t size() const { return static_cast\u0026lt;const T \u0026amp;\u0026gt;(*this).size(); } }; template\u0026lt;typename L, typename R\u0026gt; struct Add_exp : public Exp\u0026lt;Add_exp\u0026lt;L, R\u0026gt;\u0026gt; { const L \u0026amp;l; const R \u0026amp;r; size_t size() const { return l.size(); } Add_exp(const L \u0026amp;l, const R \u0026amp;r) : l(l), r(r) {} auto operator[](size_t i) const { return l[i] + r[i]; } }; template\u0026lt;typename T\u0026gt; struct Vector : public Exp\u0026lt;Vector\u0026lt;T\u0026gt;\u0026gt; { std::vector\u0026lt;T\u0026gt; data; // 构造函数，方便初始化 Vector(size_t n = 0) : data(n) {} Vector(std::initializer_list\u0026lt;T\u0026gt; l) : data(l) {} T operator[](size_t i) const { return data[i]; } T \u0026amp;operator[](size_t i) { return data[i]; } size_t size() const { return data.size(); } template\u0026lt;typename T2\u0026gt; void operator=(const Exp\u0026lt;T2\u0026gt; \u0026amp;rhs) { // clog \u0026lt;\u0026lt; rhs.size() \u0026lt;\u0026lt; \u0026#34;\\n\u0026#34;; data.resize(rhs.size()); // clog \u0026lt;\u0026lt; data.size() \u0026lt;\u0026lt; \u0026#34;\\n\u0026#34;; for (size_t i = 0; i \u0026lt; size(); ++i) { data[i] = rhs[i]; } } }; template\u0026lt;typename L, typename R\u0026gt; auto operator+(const Exp\u0026lt;L\u0026gt; \u0026amp;l, const Exp\u0026lt;R\u0026gt; \u0026amp;r) { return Add_exp\u0026lt;L, R\u0026gt;(static_cast\u0026lt;const L \u0026amp;\u0026gt;(l), static_cast\u0026lt;const R \u0026amp;\u0026gt;(r)); } 一个简陋的表达式模板。\n测试：\n1 2 3 4 5 6 7 8 int main() { Vector\u0026lt;int\u0026gt; res; res = (Vector{1, 2, 3} + Vector{4, 5, 6} + Vector{4, 2, 0}); for (int i = 0; i \u0026lt; res.size(); ++i) { cout \u0026lt;\u0026lt; res[i] \u0026lt;\u0026lt; \u0026#34; \u0026#34;; } return 0; } 输出 9 9 9。\n代码看上去非常简单，实际上也非常简单。但是你在复现的时候就会发现其中隐藏了大量的 C++ 语法和语义细节。这些偶发复杂性极其烦人。\n建议自己复现一下。遇到疑难杂症可以询问 AI。\n可扩展性的演示 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 template\u0026lt;typename T\u0026gt; struct Exp { auto operator[](size_t i) const { return static_cast\u0026lt;const T \u0026amp;\u0026gt;(*this)[i]; } size_t size() const { return static_cast\u0026lt;const T \u0026amp;\u0026gt;(*this).size(); } }; template\u0026lt;typename L, typename R, typename OP\u0026gt; struct Bin_exp : public Exp\u0026lt;Bin_exp\u0026lt;L, R, OP\u0026gt;\u0026gt; { const L \u0026amp;l; const R \u0026amp;r; OP op; size_t size() const { return l.size(); } Bin_exp(const L \u0026amp;l, const R \u0026amp;r) : l(l), r(r), op() {} auto operator[](size_t i) const { return op(l[i], r[i]); } }; struct Add { auto operator()(auto a, auto b) const { return a + b; } }; template\u0026lt;typename L, typename R\u0026gt; using Add_exp = Bin_exp\u0026lt;L, R, Add\u0026gt;; template\u0026lt;typename T\u0026gt; struct Vector : public Exp\u0026lt;Vector\u0026lt;T\u0026gt;\u0026gt; { std::vector\u0026lt;T\u0026gt; data; // 构造函数，方便初始化 Vector(size_t n = 0) : data(n) {} Vector(std::initializer_list\u0026lt;T\u0026gt; l) : data(l) {} T operator[](size_t i) const { return data[i]; } T \u0026amp;operator[](size_t i) { return data[i]; } size_t size() const { return data.size(); } template\u0026lt;typename T2\u0026gt; void operator=(const Exp\u0026lt;T2\u0026gt; \u0026amp;rhs) { // clog \u0026lt;\u0026lt; rhs.size() \u0026lt;\u0026lt; \u0026#34;\\n\u0026#34;; data.resize(rhs.size()); // clog \u0026lt;\u0026lt; data.size() \u0026lt;\u0026lt; \u0026#34;\\n\u0026#34;; for (size_t i = 0; i \u0026lt; size(); ++i) { data[i] = rhs[i]; } } }; template\u0026lt;typename L, typename R\u0026gt; auto operator+(const Exp\u0026lt;L\u0026gt; \u0026amp;l, const Exp\u0026lt;R\u0026gt; \u0026amp;r) { return Add_exp\u0026lt;L, R\u0026gt;(static_cast\u0026lt;const L \u0026amp;\u0026gt;(l), static_cast\u0026lt;const R \u0026amp;\u0026gt;(r)); } 注意到仿函数的使用。C++ 的函数式特性支持奇差无比，这种时候我竟然不能使用 lambda（或者考虑 std::function 包装一层，但是堆分配和类型擦除都有开销）。\n当然，想要用 lambda 也是可以的。可以考虑在构造函数中传入 lambda，或者使用更加高级的 TMP 黑魔法。\n然后你会惊讶地注意到，如果你写了\n1 2 3 4 5 6 7 8 9 int main() { Vector\u0026lt;int\u0026gt; res; auto tmp = (Vector{1, 2, 3} + Vector{4, 5, 6} + Vector{4, 2, 0}); res = tmp; for (int i = 0; i \u0026lt; res.size(); ++i) { cout \u0026lt;\u0026lt; res[i] \u0026lt;\u0026lt; \u0026#34; \u0026#34;; } return 0; } 程序会爆掉，并（可能，实际上此时是未定义的）抛出 std::bad_alloc 异常。\n为什么？因为极其不幸的，tmp 的声明那一行结束之后，几个 Vector 临时对象的生命周期就结束了。于是 tmp 中存储的引用变成了悬垂引用。然后 res = tmp; 就寄了。\n另一个坑：如果你以后增加了一些不是逐元素进行的操作，比如类似 bitset 的右移，v = (v \u0026lt;\u0026lt; 1); 之类的写法可能就会出锅。\n因为它会展开为一个 v[i] = v[i - 1] 的循环。这样，就会让原始数据被覆盖掉（类似于 01 背包的转移），于是得到错误的结果。\n这些都需要大量复杂的手法来解决（比如你可以试着使用 SFINAE 等手法对于左值和右值进行逻辑分派，分别存储原值和常量引用）。所以我暂时按下。\nThese are your father\u0026rsquo;s parens\u0026hellip; elegant weapons, belong to a more civilized era 考虑这段 racket 代码：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 #lang racket (define-syntax get-pos (lambda (stx) (syntax-case stx () [(_ (op a b) i) #\u0026#39;(op (get-pos a i) (get-pos b i))] [(_ a i) #\u0026#39;(vector-ref a i)]))) (define-syntax get-len (lambda (stx) (syntax-case stx () [(_ (op a b)) #\u0026#39;(get-len a)] [(_ a) #\u0026#39;(vector-length a)]))) (define-syntax vec-binexp (lambda (stx) (syntax-case stx () [(_ (op a b)) #\u0026#39;(for/vector ([i (in-range (get-len a))]) (get-pos (op a b) i))] [(_ a i) #\u0026#39;a]))) (define a #(1 2 3)) (define b #(4 5 6)) (displayln (vec-binexp (* (+ #(3 4 5) #(2 1 0)) (+ a b)))) 事实上，它做到了与上面的 C++ 黑魔法同样的事。\n当然，racket 有一些弱点。\n比如，如果你想要加入向量数乘，你就会惊讶地发现你不得不使用一个 if 做向量和数值的类型分派。racket 的宏难以利用类型信息，甚至在 typed/racket 中也一样：typed/racket 的实现是类型擦除的，它在普通 racket 上用宏构建了一层类型推导、检查与优化器。但真正运行时，typed/racket 已经被展开为了普通的 racket 代码。而宏展开阶段时 typed/racket 的类型推导和检查机制还没有开始介入，自己写的宏也就无法利用类型信息。\n怎么办？一种方法是利用前人的工作，比如 #lang turnstile。它是专门为类型化语言构建的，甚至可以用来实现 haskell（比如著名的 haskett）。但是机制极端复杂，还有 Unicode 字符代码比较超标。\n简单的 hack 就是手写类型标注。比如说数值 x 写成 (Number x)。然后宏中进行特判，消除类型分派。本质上是自己维护了类型系统。\n说到这里，有没有大神愿意教我实现一个 typed/racket 并且让宏能够利用类型信息啊？求带飞 /bx\n","permalink":"https://litjohn.github.io/posts/the-dark-side-of-the-force/","summary":"\u003cp\u003e假设你刚刚看过这篇文章：\u003ca href=\"https://www.luogu.com.cn/article/i4twa64m\"\u003e浅谈valarray\u003c/a\u003e。\u003c/p\u003e\n\u003cp\u003e现在我们需要模仿 valarray 写一个科学计算库。其中，我们需要支持形如 \u003ccode\u003ea + b\u003c/code\u003e 的写法，\u003ccode\u003ea\u003c/code\u003e 和 \u003ccode\u003eb\u003c/code\u003e 是两个向量，这个表达式的值是两个向量的和，即逐元素相加得到的新向量。\u003c/p\u003e\n\u003cp\u003e没错。这是运算符重载板子。你也许会写出类似这样的代码：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-cpp\" data-lang=\"cpp\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003etemplate\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"k\"\u003etypename\u003c/span\u003e \u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"nc\"\u003eVector\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003evector\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e// 构造函数，方便初始化\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003eVector\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esize_t\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003eVector\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003einitializer_list\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003eT\u003c/span\u003e \u003cspan class=\"k\"\u003eoperator\u003c/span\u003e\u003cspan class=\"p\"\u003e[](\u003c/span\u003e\u003cspan class=\"n\"\u003esize_t\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003eT\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"k\"\u003eoperator\u003c/span\u003e\u003cspan class=\"p\"\u003e[](\u003c/span\u003e\u003cspan class=\"n\"\u003esize_t\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003esize_t\u003c/span\u003e \u003cspan class=\"nf\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003eVector\u003c/span\u003e \u003cspan class=\"k\"\u003eoperator\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"n\"\u003eVector\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003erhs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"n\"\u003eVector\u003c/span\u003e \u003cspan class=\"nf\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 初始化大小\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esize_t\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003erhs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 依赖 NRVO\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e题外话：\u003cbr\u003e\n注意加法中的 const\u0026amp; 参数类型。它是为了方便接受临时 Vector 对象（右值）：普通左值引用会 CE。\u003c/p\u003e","title":"May the force be with you"},{"content":"You might assume that computers evaluate function arguments from left to right. However, that is not always the case.\nIn fact, many programming languages—such as C++ and RnRS Scheme—leave the evaluation order of arguments unspecified.\nAs shown in this post, ignoring this detail can trigger undefined behavior, leading to a Wrong Answer (WA) or Runtime Error (RE).\nThe Behavior in C++ and Scheme Consider the following C++ code:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 void foo(int x, int y) { cout \u0026lt;\u0026lt; x \u0026lt;\u0026lt; \u0026#34; \u0026#34; \u0026lt;\u0026lt; y \u0026lt;\u0026lt; \u0026#34;\\n\u0026#34;; } int counter() { static int x = 0; x++; return x; } int main() { foo(counter(), counter()); return 0; } If you compile and run this using GCC 15.2 with -O2, you might notice the output is 2 1. The compiler chose to evaluate the arguments from right to left.\nSimilarly, in Scheme:\n1 2 3 (let ([x (read)] [y (read)]) (display x) (display \u0026#34; \u0026#34;) (display y)) If you type A then B into the console, you might find y gets A and x gets B, because the order in which (read) is called for each binding is unspecified.\nWhy the Ambiguity? This is not a bug, but a deliberate trade-off. Standards leave the order unspecified to grant compilers freedom for optimization. By not forcing a strict left-to-right order, compilers can better leverage instruction reordering, register allocation, and parallelization.\nIn older x86 C environments, evaluating from right to left was also a matter of efficiency. Since the stack grows downwards, pushing arguments from right to left ensures the leftmost argument ends up at the \u0026ldquo;top\u0026rdquo; of the stack, simplifying how functions like printf locate their first fixed argument.\nPrecise Semantics: C++17 and Scheme In C++ (pre-C++17), these evaluations were unsequenced. Modifying the same object twice resulted in Undefined Behavior (UB). Since C++17, they are indeterminately sequenced—the result is unspecified, but the behavior is no longer \u0026ldquo;undefined\u0026rdquo; (no nasal demons).\nThe RnRS Scheme standard goes a step further, stating:\n\u0026ldquo;When a procedure call is evaluated, the operator and operand expressions are evaluated (in an unspecified order) and the resulting procedure is passed the resulting arguments.\u0026rdquo;\nThis means even the function itself (the operator) could be evaluated after its arguments.\nThe \u0026ldquo;Nesting\u0026rdquo; Escape Hatch: Why let* Still Works If the order is so chaotic, you might wonder: How can Scheme implement let* (which guarantees sequential binding) if it\u0026rsquo;s just \u0026ldquo;syntactic sugar\u0026rdquo; for nested lambdas?\nThe answer lies in the distinction between evaluation order within a call and the execution flow of a closure.\nA let* expression:\n1 (let* ([x 1] [y (+ x 1)]) body) expands into nested lambdas:\n1 2 3 ((lambda (x) ((lambda (y) body) (+ x 1))) 1) In this nested structure, the inner expression (+ x 1) is part of the body of the outer lambda. According to Scheme semantics, the body of a procedure can only begin execution after the procedure has been called and its arguments have been fully evaluated.\nEven if the compiler evaluates the outer operator (lambda (x)...) after the outer operand (1), the inner call cannot even be \u0026ldquo;seen\u0026rdquo; by the evaluator until the outer call happens. Nesting transforms a \u0026ldquo;horizontal\u0026rdquo; ordering problem (where order is unspecified) into a \u0026ldquo;vertical\u0026rdquo; dependency (where order is guaranteed by the flow of data).\nConclusion When writing code that relies on side effects (like read, set!, or counter++), never assume a left-to-right order unless the language explicitly guarantees it (like Java or Python). If you need a specific sequence in Scheme or C++, use explicit sequencing constructs like let*, begin, or separate statements to ensure your code remains portable and predictable.\n","permalink":"https://litjohn.github.io/posts/evaluation-order-of-function-arguments/","summary":"\u003cp\u003eYou might assume that computers evaluate function arguments from left to right. However, that is not always the case.\u003c/p\u003e\n\u003cp\u003eIn fact, many programming languages—such as C++ and RnRS Scheme—leave the evaluation order of arguments \u003cstrong\u003eunspecified\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eAs shown in \u003ca href=\"https://www.luogu.com.cn/discuss/1220027\"\u003ethis post\u003c/a\u003e, ignoring this detail can trigger undefined behavior, leading to a Wrong Answer (WA) or Runtime Error (RE).\u003c/p\u003e\n\u003ch3 id=\"the-behavior-in-c-and-scheme\"\u003eThe Behavior in C++ and Scheme\u003c/h3\u003e\n\u003cp\u003eConsider the following C++ code:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-cpp\" data-lang=\"cpp\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003efoo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003ecout\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34; \u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003ecounter\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003efoo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecounter\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003ecounter\u003c/span\u003e\u003cspan class=\"p\"\u003e());\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003eIf you compile and run this using GCC 15.2 with \u003ccode\u003e-O2\u003c/code\u003e, you might notice the output is \u003ccode\u003e2 1\u003c/code\u003e. The compiler chose to evaluate the arguments from right to left.\u003c/p\u003e","title":"Evaluation Order of Function Arguments"},{"content":"题目 拜谢 @CXiii 提供题目。\nNOIP 模拟赛签到题。我们有 $2^n$ 个点，编号 $0 \\cdots 2^n-1$。对于一个包含 $[0, 2^n)$ 中整数的集合 $S$，我们有图 $G_S$：\n当且仅当 $\\exist x \\in S \\text{ s.t. } i \\text{ xor } j = x$ 时，$i$ 与 $j$ 间有一条无向边。\n对所有满足 $G_S$ 连通，且元素数量（在使得图连通的集合中）最小的 $S$ 计数。模 998244353。\n初步分析与转化 使用异或的性质。$i \\text{ xor } j = k \\Leftrightarrow i \\text{ xor } k = j$，所以，可以视为我们从一个点 $i$ 出发，每一步异或上一个 $S$ 中元素走到另一个点，重复任意多次走动而抵达终点 $j$。\n考虑异或的结合律。所以这个过程整体等价于 $i$ 异或上一个常数 $k$。我们知道，$k$ 是 $S$ 中的一些元素的异或和，但又有 $k = i \\text{ xor } j$。\n注意到，由于 $i, j$ 可以任意取值，$k$ 也可以取任意值。这意味着，$\\forall k \\in [0, 2^n), \\exist s \\subseteq S \\text{ s.t. } \\bigoplus s = k$，也就是说 $S$ 是一个线性基。\n到这里，虽然不算显然，但确实是简单的。下面就是对线性基计数。\n我不会数数！ 这个数数把我击倒了。不过其实不难。\n先考虑将集合的计数转化为排列的计数（即区分顺序），这样我们可以考虑一个个依次选取向量（元素）的过程。\n假设我们已经选取了 $i$ 个向量。第 $i+1$ 个向量可以如何选取？\n根据线性基的定义，显然这个向量不能和之前的向量线性相关。那么容斥，算出前 $i$ 个向量的张成空间的大小，再用全集 $2^n$ 减去这个大小。\n前 $i$ 个向量的张成空间的大小……注意到它等于 $2^i$。为什么？因为向量分解的唯一性，反过来用就是不会有两种线性组合对应同一个向量，即随意从前 $i$ 个向量中选取两个子集，它们的异或和不等。那么张成空间大小等于子集数量，自然是 $2^i$。\n以上是一个必要条件。注意到它是充分的。\n那么这就成为智障题了。给出最终结论：\n$$ \\text{Ans} = \\prod_{i=0}^{n-1} (2^n - 2^i) \\pmod{998244353} $$当然这是对排列的计数。对集合的计数除以全排列即可。\n$$\\boxed{\\text{Final\\_ans} = \\frac{1}{n!} \\prod_{i=0}^{n-1} (2^n - 2^i)}$$","permalink":"https://litjohn.github.io/posts/an-interesting-counting-problem/","summary":"\u003ch2 id=\"题目\"\u003e题目\u003c/h2\u003e\n\u003cp\u003e拜谢 @CXiii 提供题目。\u003c/p\u003e\n\u003cp\u003eNOIP 模拟赛签到题。我们有 $2^n$ 个点，编号 $0 \\cdots 2^n-1$。对于一个包含 $[0, 2^n)$ 中整数的集合 $S$，我们有图 $G_S$：\u003c/p\u003e\n\u003cp\u003e当且仅当 $\\exist x \\in S \\text{ s.t. } i \\text{ xor } j = x$ 时，$i$ 与 $j$ 间有一条无向边。\u003c/p\u003e\n\u003cp\u003e对所有满足 $G_S$ 连通，且元素数量（在使得图连通的集合中）最小的 $S$ 计数。模 998244353。\u003c/p\u003e\n\u003ch2 id=\"初步分析与转化\"\u003e初步分析与转化\u003c/h2\u003e\n\u003cp\u003e使用异或的性质。$i \\text{ xor } j = k \\Leftrightarrow i \\text{ xor } k = j$，所以，可以视为我们从一个点 $i$ 出发，每一步异或上一个 $S$ 中元素走到另一个点，重复任意多次走动而抵达终点 $j$。\u003c/p\u003e\n\u003cp\u003e考虑异或的结合律。所以这个过程整体等价于 $i$ 异或上一个常数 $k$。我们知道，$k$ 是 $S$ 中的一些元素的异或和，但又有 $k = i \\text{ xor } j$。\u003c/p\u003e","title":"数数"},{"content":"我想诸位应该都用过结构化绑定（structure bindings）吧。或者听说过“模式匹配”这个工具（我之前的一些文章中就用过）。\n今天来聊聊这个有趣的语言特性。\n依然先放代码：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 #lang racket (define-syntax pmatch-if (lambda (stx) (syntax-case stx (quote any/p ?) [(_ val any/p t f) #\u0026#39;t] [(_ val x t f) (identifier? #\u0026#39;x) #\u0026#39;(let ([x val]) t)] [(_ val (? predicate pat) t f) #\u0026#39;(if (predicate val) (pmatch-if val pat t f) f)] [(_ val (quote x) t f) #\u0026#39;(if (equal? val \u0026#39;x) t f)] [(_ val x t f) (not (pair? (syntax-\u0026gt;datum #\u0026#39;x))) #\u0026#39;(if (equal? val \u0026#39;x) t f)] [(_ val (pat1 . pat2) t f) #\u0026#39;(if (pair? val) (let ([x (car val)] [y (cdr val)]) (pmatch-if x pat1 (pmatch-if y pat2 t f) f)) f)]))) (define-syntax pmatch-inner (syntax-rules () [(_ v) (error \u0026#34;pmatch: match failed:\u0026#34; v)] [(_ v [pat body ...] rest ...) (let* ([tmp v] [failure (lambda () (pmatch-inner tmp rest ...))]) (pmatch-if tmp pat (begin body ...) (failure)))])) (define-syntax-rule (pmatch v clauses ...) (let ([tmp v]) (pmatch-inner tmp clauses ...))) 什么是模式匹配 模式匹配并不是“字符串模式匹配”，它是一种语言特性。\n依然是从各位非常熟悉的结构化绑定说起。结构化绑定可以让你便捷的解构一个结构体的值，并绑定到不同的变量上。\n模式匹配则是它的升级版：我们可以使用描述化的写法判断一个值“是不是长这个样子”，如果是，就“将其中的对应部分绑定到给定变量上”，并执行对应的一段代码。\n简单来说，结合了结构化绑定的数据解构能力和 cond/if 的条件分支能力。我们写 (match x [(human head body arm leg) head]) 来描述 x 是不是一个有头、身体、胳膊和腿的人，如果是，就返回他的头。\n从 LOP（语言导向编程）的视角看，本质上是设计了一种 EDSL 来方便对数据形状的检查以及数据解构。\n它有什么应用 想想结构化绑定有什么应用。模式匹配的应用更丰富：在写解释器等等的时候你常常需要检查数据的形状并进行解构。\n更加常见的情形是处理 union type 等代数数据类型。你可能会遇到一个类型 Res\u0026lt;T, E\u0026gt; = Union\u0026lt;T, E\u0026gt;，它可以是返回值类型 T，也可能是函数执行出现问题时的异常类型 E。这时你就可以写\n1 2 3 (match res [(T v) (process-result v)] [(E e) (catch-exception e)]) 而不是一大堆麻烦的 if 和 let。\n如何实现 这个东西看上去比较神秘，其实大概可以想到是利用列表的特性递归匹配。但是直接做非常不好做，你可能会想到类似于编译出一个过程判断是否符合模式，另一个过程绑定数据。这样常数很大而且很不优雅。\n正确的方法是我们先不考虑完整的 match（更像 cond）而是考虑一个弱化版的 pmatch-if：接受一个值和一个模式，如果值符合模式就进行绑定并执行第一个分支，否则执行第二个分支。\n假设已经实现了这个，那么完整的 pmatch 就好实现了：只需要把一串 pmatch-if 串起来。\n1 2 3 4 5 6 7 8 9 10 11 (define-syntax pmatch-inner (syntax-rules () [(_ v) (error \u0026#34;pmatch: match failed:\u0026#34; v)] [(_ v [pat body ...] rest ...) (let* ([tmp v] [failure (lambda () (pmatch-inner tmp rest ...))]) (pmatch-if tmp pat (begin body ...) (failure)))])) (define-syntax-rule (pmatch v clauses ...) (let ([tmp v]) (pmatch-inner tmp clauses ...))) 也就是这堆东西的用处。不过注意一点：宏会将接受到的参数直接 copy 到它出现的位置。这可能导致重复求值，所以我用 pmatch 额外包了一层 let。\n接下来考虑 pmatch-if，这是逻辑的核心。\n我们要解构的东西是列表（scheme/racket 的核心语法骨架）。列表具备递归构造，这启示我们进行递归的模式匹配。\n那么先考虑几种基础情况：模式是一个标识符、模式是一个原子数据、模式是一个用 quote 包起来的 cons pair、模式是 any/p。\n这几种情况，标识符就直接绑定并匹配通过，any/p 无条件匹配（不过不绑定），原子数据或 quote 包装的就进行比较（equal?）。\n然后接下来就是难点：cons pair 怎么做？\n非常简单，递归匹配即可。我们的匹配条件相当于是数据是个 pair，且模式的 car 和 cdr 两个部分分别都能匹配数据的对应部分，然后模式的两部分的绑定合在一起。\n这里很容易联想到 church encoding 中实现 and 的方法：\n1 2 3 4 (define ((and b1) b2) (lambda (t) (lambda (f) ((b1 ((b2 t) f)) f)))) 也即两层 if 嵌套。那么就搞定了。\n如果你这么写了就会发生 () 惨案。因为 () 会进入对原子匹配的分支，然后就会生成 (if (equal? v ()) ...) 这样的代码，产生裸的 () 然后爆掉。正确的做法是多加一层 quote：\n1 2 3 #\u0026#39;(if (equal? val \u0026#39;x) ; 注意是 \u0026#39;x 不是 x t f) 这样，原子有自求值的特性，多加一层 quote 不影响（会被运行时的 eval 弄掉）而 null（空链表 '()）则能多一层 quote 而避免报错。\n那个 ? 的分支是一个小的扩展，类似于 racket 标准库的 ?。语法是 (? predicate pat)，意思是如果 v 满足 predicate 则匹配模式 pat，否则匹配失败。是 guard 的一种语法糖（不过这里没有实现 guard。留作习题 :P）。\n","permalink":"https://litjohn.github.io/posts/pattern-matching/","summary":"\u003cp\u003e我想诸位应该都用过结构化绑定（structure bindings）吧。或者听说过“模式匹配”这个工具（我之前的一些文章中就用过）。\u003c/p\u003e\n\u003cp\u003e今天来聊聊这个有趣的语言特性。\u003c/p\u003e\n\u003cp\u003e依然先放代码：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e28\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e29\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e30\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e31\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e32\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e33\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e34\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e35\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e36\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e37\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e38\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e39\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e40\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e41\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e42\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e43\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e44\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e45\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e46\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-racket\" data-lang=\"racket\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kn\"\u003e#lang \u003c/span\u003e\u003cspan class=\"nn\"\u003eracket\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine-syntax\u003c/span\u003e \u003cspan class=\"n\"\u003epmatch-if\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elambda\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estx\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003esyntax-case\u003c/span\u003e \u003cspan class=\"n\"\u003estx\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003equote\u003c/span\u003e \u003cspan class=\"ss\"\u003eany/p\u003c/span\u003e \u003cspan class=\"n\"\u003e?\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"k\"\u003e_\u003c/span\u003e \u003cspan class=\"n\"\u003eval\u003c/span\u003e \u003cspan class=\"n\"\u003eany/p\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e \u003cspan class=\"n\"\u003ef\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e#\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"k\"\u003e_\u003c/span\u003e \u003cspan class=\"n\"\u003eval\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e \u003cspan class=\"n\"\u003ef\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e       \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eidentifier?\u003c/span\u003e \u003cspan class=\"o\"\u003e#\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e       \u003cspan class=\"o\"\u003e#\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"n\"\u003eval\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e           \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"k\"\u003e_\u003c/span\u003e \u003cspan class=\"n\"\u003eval\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003e?\u003c/span\u003e \u003cspan class=\"n\"\u003epredicate\u003c/span\u003e \u003cspan class=\"n\"\u003epat\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e \u003cspan class=\"n\"\u003ef\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e       \u003cspan class=\"o\"\u003e#\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epredicate\u003c/span\u003e \u003cspan class=\"n\"\u003eval\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e             \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epmatch-if\u003c/span\u003e \u003cspan class=\"n\"\u003eval\u003c/span\u003e \u003cspan class=\"n\"\u003epat\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e \u003cspan class=\"n\"\u003ef\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e             \u003cspan class=\"n\"\u003ef\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"k\"\u003e_\u003c/span\u003e \u003cspan class=\"n\"\u003eval\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003equote\u003c/span\u003e \u003cspan class=\"ss\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e \u003cspan class=\"n\"\u003ef\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e       \u003cspan class=\"o\"\u003e#\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eequal?\u003c/span\u003e \u003cspan class=\"n\"\u003eval\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"ss\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e             \u003cspan class=\"n\"\u003et\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e             \u003cspan class=\"n\"\u003ef\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"k\"\u003e_\u003c/span\u003e \u003cspan class=\"n\"\u003eval\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e \u003cspan class=\"n\"\u003ef\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e       \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003enot\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003epair?\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003esyntax-\u0026gt;datum\u003c/span\u003e \u003cspan class=\"o\"\u003e#\u0026#39;\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e       \u003cspan class=\"o\"\u003e#\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eequal?\u003c/span\u003e \u003cspan class=\"n\"\u003eval\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"ss\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e             \u003cspan class=\"n\"\u003et\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e             \u003cspan class=\"n\"\u003ef\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"k\"\u003e_\u003c/span\u003e \u003cspan class=\"n\"\u003eval\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epat1\u003c/span\u003e \u003cspan class=\"o\"\u003e.\u003c/span\u003e \u003cspan class=\"n\"\u003epat2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e \u003cspan class=\"n\"\u003ef\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e       \u003cspan class=\"o\"\u003e#\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003epair?\u003c/span\u003e \u003cspan class=\"n\"\u003eval\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e             \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecar\u003c/span\u003e \u003cspan class=\"n\"\u003eval\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                   \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecdr\u003c/span\u003e \u003cspan class=\"n\"\u003eval\u003c/span\u003e\u003cspan class=\"p\"\u003e)])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e               \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epmatch-if\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"n\"\u003epat1\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epmatch-if\u003c/span\u003e \u003cspan class=\"n\"\u003ey\u003c/span\u003e \u003cspan class=\"n\"\u003epat2\u003c/span\u003e \u003cspan class=\"n\"\u003et\u003c/span\u003e \u003cspan class=\"n\"\u003ef\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003ef\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e             \u003cspan class=\"n\"\u003ef\u003c/span\u003e\u003cspan class=\"p\"\u003e)])))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine-syntax\u003c/span\u003e \u003cspan class=\"n\"\u003epmatch-inner\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003esyntax-rules\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"k\"\u003e_\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eerror\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;pmatch: match failed:\u0026#34;\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"k\"\u003e_\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003epat\u003c/span\u003e \u003cspan class=\"n\"\u003ebody\u003c/span\u003e \u003cspan class=\"k\"\u003e...\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"nb\"\u003erest\u003c/span\u003e \u003cspan class=\"k\"\u003e...\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e     \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet*\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003etmp\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003efailure\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elambda\u003c/span\u003e \u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epmatch-inner\u003c/span\u003e \u003cspan class=\"n\"\u003etmp\u003c/span\u003e \u003cspan class=\"nb\"\u003erest\u003c/span\u003e \u003cspan class=\"k\"\u003e...\u003c/span\u003e\u003cspan class=\"p\"\u003e))])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e       \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epmatch-if\u003c/span\u003e \u003cspan class=\"n\"\u003etmp\u003c/span\u003e \u003cspan class=\"n\"\u003epat\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ebegin\u003c/span\u003e \u003cspan class=\"n\"\u003ebody\u003c/span\u003e \u003cspan class=\"k\"\u003e...\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efailure\u003c/span\u003e\u003cspan class=\"p\"\u003e)))]))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine-syntax-rule\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epmatch\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e \u003cspan class=\"n\"\u003eclauses\u003c/span\u003e \u003cspan class=\"k\"\u003e...\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003etmp\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epmatch-inner\u003c/span\u003e \u003cspan class=\"n\"\u003etmp\u003c/span\u003e \u003cspan class=\"n\"\u003eclauses\u003c/span\u003e \u003cspan class=\"k\"\u003e...\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch2 id=\"什么是模式匹配\"\u003e什么是模式匹配\u003c/h2\u003e\n\u003cp\u003e模式匹配并不是“字符串模式匹配”，它是一种语言特性。\u003c/p\u003e","title":"Pattern Matching"},{"content":"光剑的后日谈 #3. 这次来聊聊什么是许愿机。\nIf bird born with no shackles 现在我们需要写一段代码，用矩阵快速幂求解一个递推数列：\n$$ \\begin{cases} f(0)=f(1)=f(2)=1 \\\\\\\\ f(n)=f(n-1)+2f(n-2)+5f(n-3), n \\geq 3 \\end{cases} $$我们知道我们将数列中的相邻几项写成一个向量 $(f(i), f(i+1), f(i+2))$，然后找到一个矩阵乘上它转移到下一个向量 $(f(i+1), f(i+2), f(i+3))$，那么这个矩阵怎么算呢？\n猜肯定是一个办法，但肯定不好。手动求解，待定系数也是一种方法。\n然而，我们还有更加优雅的做法。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 from z3 import * def solve_transition_matrix(): # 1. 创建求解器 s = Solver() # 2. 定义我们需要求解的 3x3 转移矩阵 M # 变量 m_r_c 代表矩阵第 r 行第 c 列的元素 (全是整数) M = [[Int(f\u0026#39;m_{r}_{c}\u0026#39;) for c in range(3)] for r in range(3)] # 3. 定义“任意”时刻的输入向量状态 # 设 f0, f1, f2 分别代表 f(i), f(i+1), f(i+2) # 我们使用 Ints 创建符号变量，这些将作为全称量词的变量 f0, f1, f2 = Ints(\u0026#39;f0 f1 f2\u0026#39;) # 构造当前向量 V_i v_current = [f0, f1, f2] # 4. 根据递推公式定义期望的输出向量 V_{i+1} # 题目递推式: f(n) = f(n-1) + 2f(n-2) + 5f(n-3) # 对应到我们的符号: 下一项 f3 = f2 + 2*f1 + 5*f0 f3 = f2 + 2 * f1 + 5 * f0 # 构造下一刻向量 V_{i+1} = [f(i+1), f(i+2), f(i+3)] v_next = [f1, f2, f3] # 5. 核心逻辑：构造约束 # 约束条件：M * v_current == v_next # 这个等式必须对“所有”的 f0, f1, f2 都成立 constraints = [] for r in range(3): # 矩阵乘法：第 r 行 点乘 输入向量 row_product = sum(M[r][c] * v_current[c] for c in range(3)) # 结果必须等于输出向量的对应项 constraints.append(row_product == v_next[r]) # 使用 ForAll (全称量词) # 读作：对于任意整数 f0, f1, f2，上述约束(And(constraints))都必须成立 s.add(ForAll([f0, f1, f2], And(constraints))) # 6. 求解并打印结果 if s.check() == sat: m = s.model() print(\u0026#34;成功找到转移矩阵 M：\u0026#34;) print(\u0026#34;-\u0026#34; * 15) # 将 z3 的解转换为 Python 整数并格式化输出 for r in range(3): row_vals = [m.evaluate(M[r][c]).as_long() for c in range(3)] print(f\u0026#34;| {row_vals[0]:^3} {row_vals[1]:^3} {row_vals[2]:^3} |\u0026#34;) print(\u0026#34;-\u0026#34; * 15) # 验证一下文章开头的直觉 # 第一行应该是 0 1 0 (输出 f1) # 第二行应该是 0 0 1 (输出 f2) # 第三行应该是 5 2 1 (输出 5f0 + 2f1 + 1f2) else: print(\u0026#34;未找到满足条件的矩阵。\u0026#34;) if __name__ == \u0026#34;__main__\u0026#34;: solve_transition_matrix() 用 Python 运行这段代码（当然你需要先使用 pip install z3-solver 来解决库的依赖），你会得到这样的输出：\n1 2 3 4 5 6 成功找到转移矩阵 M： --------------- | 0 1 0 | | 0 0 1 | | 5 2 1 | --------------- 看上去非常对。\n当然你可能还会说：“这不就是一个自动解线性方程组的机器吗？没什么特别的。”不过 Z3 的威力不止于此。假如我们要求转移矩阵中不能出现素数，高斯消元等线性代数方法就爆炸了。而求解器依然能够工作。\n或者看看下面这个场景：\n你正在写一段底层高性能代码，需要计算一个 32 位整数的绝对值 abs(x)。\n但是，CPU 的分支预测（Branch Prediction）失败代价很高，你不希望使用 if (x \u0026lt; 0) 这种跳转指令。\n你听说高手都用位运算骚操作（Bit Hacks）来实现无分支编程，但你不知道公式是什么。\n我们给出一个计算模板，让 Z3 帮我们要找到对应的位移常数，自动“写”出这段黑客代码。\n我们猜测公式大概长这样：(x + A) ^ A （这是一种常见的异或技巧）。\n我们要让 Z3 帮我们确定 A 到底应该等于多少（A 可能是 x 移位后的结果）。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 from z3 import * def synthesize_abs_hack(): # 1. 创建求解器 s = Solver() # 2. 定义输入 x 是一个 32 位的位向量 (BitVector) x = BitVec(\u0026#39;x\u0026#39;, 32) # 3. 定义我们的“目标规范” (Specification) # 即我们希望代码实现的功能：如果是负数取反，否则不变 # 注意：在位运算世界里，-x 等价于 (~x + 1) target = If(x \u0026lt; 0, -x, x) # 4. 定义我们的“实现模板” (Implementation Template) # 我们猜测无分支绝对值可以通过 (x + mask) ^ mask 来实现 # 其中 mask 是 x 向右移动 k 位得到的 # 我们不知道 k 是多少，让 Z3 去找这个 k k = BitVec(\u0026#39;k\u0026#39;, 32) # k 是我们要寻找的“魔法常数” # 算术右移 (x \u0026gt;\u0026gt; k) 生成掩码 mask = x \u0026gt;\u0026gt; k # 我们的猜想公式 implementation = (x + mask) ^ mask # 5. 核心约束：等价性验证 # 我们要求：对于“任意”一个 32 位整数 x，实现必须等于目标 # 注意：k 必须是一个固定的常数，不能随 x 变化，所以 k 在 ForAll 之外 s.add(ForAll([x], implementation == target)) # 6. 添加一些合理的范围约束，加速求解 # 移位位数 k 应该在 0 到 31 之间 s.add(k \u0026gt;= 0, k \u0026lt; 32) # 7. 求解 if s.check() == sat: m = s.model() print(\u0026#34;Z3 找到了魔法常数 k！\u0026#34;) k_val = m[k].as_long() print(f\u0026#34;k = {k_val}\u0026#34;) print(\u0026#34;-\u0026#34; * 30) print(\u0026#34;生成的无分支绝对值代码 (C/C++):\u0026#34;) print(f\u0026#34;int abs_hack(int x) {{\u0026#34;) print(f\u0026#34; int mask = x \u0026gt;\u0026gt; {k_val};\u0026#34;) print(f\u0026#34; return (x + mask) ^ mask;\u0026#34;) print(f\u0026#34;}}\u0026#34;) else: print(\u0026#34;也就是个猜想，看来这个模板行不通。\u0026#34;) if __name__ == \u0026#34;__main__\u0026#34;: synthesize_abs_hack() 很快，你就会得到这样的输出：\n1 2 3 4 5 6 7 8 Z3 找到了魔法常数 k！ k = 31 ------------------------------ 生成的无分支绝对值代码 (C/C++): int abs_hack(int x) { int mask = x \u0026gt;\u0026gt; 31; return (x + mask) ^ mask; } 于是我们就解决了这个问题。\nWhat is meant by miracle? 聊了这么久，你可能会发现我还没有讲 Z3 是什么？\n事实上，正如这篇文章的标题，Z3 是一个许愿机。\n它是一个 SMT（模理论可满足性）求解器。核心是一个 SAT（布尔可满足性，就是那个著名的 NPC）求解器，外部加上了许多理论的扩展。\n理论扩展使得 SMT 求解器远比 SAT 更强大。\nSAT 中变量是原子，求解器看不到里面，就像 0 阶逻辑（命题逻辑）。\n而 SMT 中，理论让求解器可以拆开一个公式子句，并获取不同子句间更深层的关系（比如 x\u0026gt;0 和 x\u0026lt;0 是矛盾的）。也让我们能够用更丰富的语言写给求解器的公式。\n我们用求解器支持的语言给它一个公式，它就自动判定这个公式是否是可满足的，如果可满足，就会给出一组解。而当不满足时，求解器会告诉我们“Unsat core”，即哪些约束矛盾了。在调试时，这是有用的。\n就像我们用公式向许愿机许下一个愿望，它就自动显灵。\nA word outside my days 强大的奇迹自然也有它的代价。众所周知，SAT 是一个 NPC 问题。也就是说，SMT 求解器在最坏情况下的复杂度是指数级（或至少超多项式）的。\n而 Z3 中的一些理论甚至比 SAT 还要困难，达到了 Pspace-complete 甚至 undecidable 边缘的程度。比如说 NRA（非线性实数算术），求解复杂度是双指数（$2^{2^n}$）。而 NIA（非线性整数算术）等一些理论，甚至是不可判定的（停机问题可以规约到 NIA）\nSMT 求解器之所以有用，是因为它使用了强大的启发式搜索算法（最重要的是 CDCL，冲突驱动子句学习），利用工业实例的特殊结构化特性达到了非常优秀的平均复杂度。\nSo now, I\u0026rsquo;ll make a dream unchained~ 上面已经展示了两个例子。不过这些还不够复杂。并且不是 racket 写的\n接下来我们将用求解器解决一些更复杂的问题。这里需要提到 Rosette，一个 racket 项目，也是一个杀手级应用。你可以用 raco pkg install rosette 下载它。\n2024 年提高组初赛有这么一道题：\n1 2 3 int logic(int x, int y) { return (x \u0026amp; y) ^ ((x ^ y) | (~x \u0026amp; y)); } 以上函数的功能是什么？\n硬分析当然可以，但是太吃操作。大部分人场上可能是代入具体值做的，然而这不能保证 100% 正确，并且场上的 D 选项还是“以上都不是”。\n让我们来向许愿机许下这个愿望。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 #lang rosette ; 1. 定义类型：模拟 C++ 的 int (32位有符号整数) (define int32? (bitvector 32)) ; --------------------------------------------------------- ; 2. 目标函数 (C++ 逻辑的精确翻译) ; --------------------------------------------------------- ; C++: (x \u0026amp; y) ^ ((x ^ y) | (~x \u0026amp; y)) ; ; Rosette 映射表: ; \u0026amp; -\u0026gt; bvand ; | -\u0026gt; bvor ; ^ -\u0026gt; bvxor ; ~ -\u0026gt; bvnot (define (target-logic x y) (bvxor (bvand x y) (bvor (bvxor x y) (bvand (bvnot x) y)))) ; --------------------------------------------------------- ; 3. 用户待验证的函数 (在这里填入你的实现) ; --------------------------------------------------------- (define (user-logic x y) ; 猜测：原逻辑推导后其实等价于 (x | y) ; 你可以试着把这里改成 (bvxor x y) 看看验证失败的效果 (bvor x y) ) ; --------------------------------------------------------- ; 4. 验证过程 ; --------------------------------------------------------- ; 定义两个符号变量，类型为 32位位向量 (define-symbolic x-sym int32?) (define-symbolic y-sym int32?) ; 验证查询：是否存在一组输入 (x, y)，使得两函数输出不相等？ ; verify 会尝试寻找反例 (counterexample) (define ce (verify (assert (equal? (target-logic x-sym y-sym) (user-logic x-sym y-sym))))) ; --------------------------------------------------------- ; 5. 输出结果处理 ; --------------------------------------------------------- (if (unsat? ce) (printf \u0026#34;验证成功：两个函数在 32 位整数范围内是完全等价的！\\n\u0026#34;) (begin (printf \u0026#34;验证失败：函数不等价。\\n\u0026#34;) (printf \u0026#34;找到反例 (Counterexample):\\n\u0026#34;) ; 从模型中提取具体的位向量值 (define ce-x (evaluate x-sym ce)) (define ce-y (evaluate y-sym ce)) ; 为了方便阅读，将位向量转换为普通整数显示 (printf \u0026#34;x = ~a (Hex: ~a)\\n\u0026#34; (bitvector-\u0026gt;integer ce-x) ce-x) (printf \u0026#34;y = ~a (Hex: ~a)\\n\u0026#34; (bitvector-\u0026gt;integer ce-y) ce-y) (printf \u0026#34;------------------------\\n\u0026#34;) (printf \u0026#34;Target 输出: ~a\\n\u0026#34; (target-logic ce-x ce-y)) (printf \u0026#34;User 输出: ~a\\n\u0026#34; (user-logic ce-x ce-y)) )) 我们发现 bvor（即按位或）正是这个函数的等价物。而如果你改成 bvand/bvxor 则会得到 unsat 以及反例。这个问题就解决了。\n这类东西在夺旗赛（CTF）中非常有用。你可以猜测一个被混淆了的表达式实际上是什么，然后利用 Rosette 的 verify 去验证是不是这么回事。\n在形式化验证领域也非常有用。你可以写好一些规范，然后 verify 一下你的程序是否符合这些规范。一个特例是 verify 你的程序的输出是否和暴力相同，即对拍。不过形式化方法可以确保程序 100% 必定符合规范，而不像对拍可能会遗漏 corner。\n到这里我们就展示了 Rosette 的 synthesize 和 verify 能力，它们一个给指定的规范寻找解（exist 量词），另一个判断指定规范是否永远正确（forall 量词）。Rosette 还有一个“天使执行”能力，可以造出让你的代码运行到某个指定 case 的数据，但是太复杂所以我们不讲（在入门中也用不到）。\nracket 真是一个秘密武器。在某些领域威力简直无可匹敌。比如说形式化验证。又比如，写一个求解数独的程序。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 #lang rosette ; 0. 初始时等待完善的数独。0 代表空位。 (define org #(#(0 0 0 0 0 0 0 0 0) #(0 0 0 0 0 0 0 0 0) #(0 0 0 0 0 0 0 0 0) #(0 0 0 0 0 0 0 0 0) #(0 0 0 0 0 0 0 0 0) #(0 0 0 0 0 0 0 0 0) #(0 0 0 0 0 0 0 0 0) #(0 0 0 0 0 0 0 0 0) #(0 0 0 0 0 0 0 0 0))) ; 1. 定义 9x9 的符号变量矩阵 (define a (for/vector ([i (in-range 9)]) (for/vector ([j (in-range 9)]) (let ([x (vector-ref (vector-ref org i) j)]) (if (zero? x) (begin (define-symbolic* sym integer?) sym) x))))) ; 2. 定义约束并求解 (define solution (solve (begin ; 约束 A: 所有数字必须在 1 到 9 之间 (for* ([row a] [x row]) (assert (and (\u0026gt;= x 1) (\u0026lt;= x 9)))) ; 约束 B: 每一行必须互不相同 (Row restriction) (for ([row a]) ; distinct? 接受变长参数，所以我们要把 vector 转为 list 并 apply (assert (apply distinct? (vector-\u0026gt;list row)))) ; 约束 C: 每一列必须互不相同 (for ([j (in-range 9)]) (define col (for/list ([i (in-range 9)]) (vector-ref (vector-ref a i) j))) (assert (apply distinct? col))) ; 约束 D: 每个宫格不能有相同数字 (for* ([i \u0026#39;(0 3 6)] [j \u0026#39;(0 3 6)]) (assert (apply distinct? (for*/list ([k (in-range 3)] [l (in-range 3)]) (vector-ref (vector-ref a (+ i k)) (+ j l))))))))) ; 3. 输出结果 (if (sat? solution) (let ([concrete-a (evaluate a solution)]) (displayln \u0026#34;Found a solution:\u0026#34;) (displayln concrete-a)) (displayln \u0026#34;No solution!\u0026#34;)) 求解数独是（迄今为止）不能多项式的（数独是 NPC）。经典算法是 DLX。但假如说我增加一些限制，比如 9*9 网格的两条对角线上也不能有相同元素呢？或者比如说第一列有恰好两个 1，第 i 列有恰好两个 i 呢？DLX 就比较难以拓展了。\nSMT 则能够方便地添加更多的约束以适应种种变体。你可以自己试一试。\n我想肯定有人会问我怎么不像以前那样自己实现一个求解器……我只能说实在太难了搞不动。SMT 求解器这样的工程智慧，如果只是核心的 CDCL 和 SAT 求解其实还是能玩一玩的。但是外置的算术理论太过高深复杂了，写不动。\n","permalink":"https://litjohn.github.io/posts/what-is-meant-by-miracle/","summary":"\u003cp\u003e光剑的后日谈 #3. 这次来聊聊什么是许愿机。\u003c/p\u003e\n\u003ch2 id=\"if-bird-born-with-no-shackles\"\u003eIf bird born with no shackles\u003c/h2\u003e\n\u003cp\u003e现在我们需要写一段代码，用矩阵快速幂求解一个递推数列：\u003c/p\u003e\n$$\n\\begin{cases}\nf(0)=f(1)=f(2)=1 \\\\\\\\\nf(n)=f(n-1)+2f(n-2)+5f(n-3), n \\geq 3\n\\end{cases}\n$$\u003cp\u003e我们知道我们将数列中的相邻几项写成一个向量 $(f(i), f(i+1), f(i+2))$，然后找到一个矩阵乘上它转移到下一个向量 $(f(i+1), f(i+2), f(i+3))$，那么这个矩阵怎么算呢？\u003c/p\u003e\n\u003cp\u003e猜肯定是一个办法，但肯定不好。手动求解，待定系数也是一种方法。\u003c/p\u003e\n\u003cp\u003e然而，我们还有更加优雅的做法。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e28\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e29\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e30\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e31\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e32\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e33\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e34\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e35\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e36\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e37\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e38\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e39\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e40\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e41\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e42\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e43\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e44\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e45\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e46\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e47\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e48\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e49\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e50\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e51\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e52\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e53\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e54\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e55\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e56\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e57\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e58\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e59\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e60\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e61\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kn\"\u003efrom\u003c/span\u003e \u003cspan class=\"nn\"\u003ez3\u003c/span\u003e \u003cspan class=\"kn\"\u003eimport\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003edef\u003c/span\u003e \u003cspan class=\"nf\"\u003esolve_transition_matrix\u003c/span\u003e\u003cspan class=\"p\"\u003e():\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# 1. 创建求解器\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003es\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eSolver\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# 2. 定义我们需要求解的 3x3 转移矩阵 M\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# 变量 m_r_c 代表矩阵第 r 行第 c 列的元素 (全是整数)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003eM\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e[[\u003c/span\u003e\u003cspan class=\"n\"\u003eInt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"sa\"\u003ef\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;m_\u003c/span\u003e\u003cspan class=\"si\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s1\"\u003e_\u003c/span\u003e\u003cspan class=\"si\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"ow\"\u003ein\u003c/span\u003e \u003cspan class=\"nb\"\u003erange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003er\u003c/span\u003e \u003cspan class=\"ow\"\u003ein\u003c/span\u003e \u003cspan class=\"nb\"\u003erange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# 3. 定义“任意”时刻的输入向量状态\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# 设 f0, f1, f2 分别代表 f(i), f(i+1), f(i+2)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# 我们使用 Ints 创建符号变量，这些将作为全称量词的变量\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003ef0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ef1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ef2\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eInts\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s1\"\u003e\u0026#39;f0 f1 f2\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# 构造当前向量 V_i\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003ev_current\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ef0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ef1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ef2\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# 4. 根据递推公式定义期望的输出向量 V_{i+1}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# 题目递推式: f(n) = f(n-1) + 2f(n-2) + 5f(n-3)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# 对应到我们的符号: 下一项 f3 = f2 + 2*f1 + 5*f0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003ef3\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ef2\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ef1\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e5\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ef0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# 构造下一刻向量 V_{i+1} = [f(i+1), f(i+2), f(i+3)]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003ev_next\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ef1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ef2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ef3\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# 5. 核心逻辑：构造约束\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# 约束条件：M * v_current == v_next\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# 这个等式必须对“所有”的 f0, f1, f2 都成立\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003econstraints\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003er\u003c/span\u003e \u003cspan class=\"ow\"\u003ein\u003c/span\u003e \u003cspan class=\"nb\"\u003erange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e# 矩阵乘法：第 r 行 点乘 输入向量\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"n\"\u003erow_product\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003esum\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eM\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ev_current\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"ow\"\u003ein\u003c/span\u003e \u003cspan class=\"nb\"\u003erange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e# 结果必须等于输出向量的对应项\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"n\"\u003econstraints\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eappend\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erow_product\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003ev_next\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# 使用 ForAll (全称量词)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# 读作：对于任意整数 f0, f1, f2，上述约束(And(constraints))都必须成立\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eadd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eForAll\u003c/span\u003e\u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003ef0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ef1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ef2\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003eAnd\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econstraints\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e# 6. 求解并打印结果\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003echeck\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003esat\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"n\"\u003em\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emodel\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nb\"\u003eprint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;成功找到转移矩阵 M：\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nb\"\u003eprint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;-\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e15\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e# 将 z3 的解转换为 Python 整数并格式化输出\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003er\u003c/span\u003e \u003cspan class=\"ow\"\u003ein\u003c/span\u003e \u003cspan class=\"nb\"\u003erange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e):\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"n\"\u003erow_vals\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eevaluate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eM\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eas_long\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"ow\"\u003ein\u003c/span\u003e \u003cspan class=\"nb\"\u003erange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"nb\"\u003eprint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"sa\"\u003ef\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;| \u003c/span\u003e\u003cspan class=\"si\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003erow_vals\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"si\"\u003e:\u003c/span\u003e\u003cspan class=\"s2\"\u003e^3\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e \u003c/span\u003e\u003cspan class=\"si\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003erow_vals\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"si\"\u003e:\u003c/span\u003e\u003cspan class=\"s2\"\u003e^3\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e \u003c/span\u003e\u003cspan class=\"si\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003erow_vals\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"si\"\u003e:\u003c/span\u003e\u003cspan class=\"s2\"\u003e^3\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e |\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nb\"\u003eprint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;-\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e15\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e# 验证一下文章开头的直觉\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e# 第一行应该是 0 1 0 (输出 f1)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e# 第二行应该是 0 0 1 (输出 f2)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e# 第三行应该是 5 2 1 (输出 5f0 + 2f1 + 1f2)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eelse\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"nb\"\u003eprint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;未找到满足条件的矩阵。\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"vm\"\u003e__name__\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;__main__\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003esolve_transition_matrix\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e用 Python 运行这段代码（当然你需要先使用 \u003ccode\u003epip install z3-solver\u003c/code\u003e 来解决库的依赖），你会得到这样的输出：\u003c/p\u003e","title":"What is meant by miracle?"},{"content":"（一篇习作记录）\n我思我见：何为“最美少年”？ 在我们这个时代，“最美少年”的称谓频频见诸报端，它赞美着那些品学兼优、拥有杰出事迹的年轻人。然而，抛开这些具体的标签，我们是否曾真正深入地思考过：究竟什么，才构成了一位少年真正的“美”？在我看来，要解答这个问题，必须先拆解其核心——“美”的本质与“少年”的精神。\n欲论少年之美，必先探寻“美”的本质。美为何物？是卢浮宫里《蒙娜丽莎》的神秘微笑，是唐诗宋词中凝练的意境，是俊朗秀丽的容颜，亦或是危难中闪耀的人性光辉。美似乎无处不在，却又无从捕捉，它横跨东西，贯通古今，难以被一个统一的定义所禁锢。\n然而，在我看来，一切“美”的背后，都潜藏着两种共性：其一为“非凡”，指向稀缺与卓越；其二为“向往”，源自人类内心深处的渴望与认同。我们不会赞叹一块随处可见的顽石，却会为温润剔透的美玉而心动；我们不会惊艳于孩童稚拙的涂鸦本身，却会被其背后那份纯粹的专注与热情所打动。从嶙峋的古树到浩瀚的繁星，从巧夺天工的建筑到熊熊燃烧的火焰，甚至是雷霆风暴、巨型武器，这些事物之所以能带来震撼的美感，皆因其蕴含着打破平庸、超越寻常的力量。美，正是这种“非凡”与“向往”的结合体，是人类对稀缺、卓越之物的本能追寻。\n倘若“美”是我们渴望攀登的非凡高峰，那么“少年”，便代表着攀登本身——那份一往无前的姿态与信念。常言道：“人的成长，就是逐渐认识到自己‘比不上’‘做不到’的过程。”这是一个向现实妥协、被经验磨平棱角的过程。而“少年”恰恰是这一过程的反面。它并非一个年龄的标签，而是一种生命的原初状态——一颗尚未对世界说“我不行”，尚未向现实低头，依旧满怀热爱与笃信，坚信自己能够创造“非凡”的心。\n当这两种特质交汇，一幅“最美少年”的画像便跃然纸上。一个坚信自己能够创造“非凡之美”的少年，本身就是一种“超乎寻常”的美好。这样的人，我们通常称之为“强者”。强者之强，在于能为常人所不能为，能创造不可思议的奇迹。\n真正的强者之美，并非仅仅体现在拥有的力量或技艺上，更在于掌握了获取力量的方法与永不熄灭的信念。这正如一位传奇企业家所言：“即便夺走我的一切，将我扔到沙漠中央，只要有一支商队经过，我就能东山再起。”知识和技能可以被传授，可以被遗忘，但那份从零到一、探索未知的方法论，那种“我能行”的内在驱动力，才是更本质、更强大的力量。这，也正是“少年”精神的核心。\n因此，我心目中的“最美少年”，他/她或许没有惊艳的外貌，或许尚未取得惊人的成就，但他/她的心中燃烧着一团火焰——坚信自己拥有创造非凡的潜能，并为之不懈地探索、努力，对生活报以最纯粹的热爱与激情。\n这份美，无关外在，直抵灵魂。它是不向局限低头的勇气，是面对未知敢于开拓的锐气，是相信“我能成为强者”的生命意气。这份美，不为岁月所侵蚀，不为困境所磨灭，它是一种精神的肖像，一种生命最昂扬的姿态。这，便是我所认为的，真正的“最美”。\n","permalink":"https://litjohn.github.io/posts/what-is-beauty/","summary":"\u003cp\u003e（一篇习作记录）\u003c/p\u003e\n\u003ch2 id=\"我思我见何为最美少年\"\u003e我思我见：何为“最美少年”？\u003c/h2\u003e\n\u003cp\u003e在我们这个时代，“最美少年”的称谓频频见诸报端，它赞美着那些品学兼优、拥有杰出事迹的年轻人。然而，抛开这些具体的标签，我们是否曾真正深入地思考过：究竟什么，才构成了一位少年真正的“美”？在我看来，要解答这个问题，必须先拆解其核心——“美”的本质与“少年”的精神。\u003c/p\u003e\n\u003cp\u003e欲论少年之美，必先探寻“美”的本质。美为何物？是卢浮宫里《蒙娜丽莎》的神秘微笑，是唐诗宋词中凝练的意境，是俊朗秀丽的容颜，亦或是危难中闪耀的人性光辉。美似乎无处不在，却又无从捕捉，它横跨东西，贯通古今，难以被一个统一的定义所禁锢。\u003c/p\u003e\n\u003cp\u003e然而，在我看来，一切“美”的背后，都潜藏着两种共性：其一为“非凡”，指向稀缺与卓越；其二为“向往”，源自人类内心深处的渴望与认同。我们不会赞叹一块随处可见的顽石，却会为温润剔透的美玉而心动；我们不会惊艳于孩童稚拙的涂鸦本身，却会被其背后那份纯粹的专注与热情所打动。从嶙峋的古树到浩瀚的繁星，从巧夺天工的建筑到熊熊燃烧的火焰，甚至是雷霆风暴、巨型武器，这些事物之所以能带来震撼的美感，皆因其蕴含着打破平庸、超越寻常的力量。美，正是这种“非凡”与“向往”的结合体，是人类对稀缺、卓越之物的本能追寻。\u003c/p\u003e\n\u003cp\u003e倘若“美”是我们渴望攀登的非凡高峰，那么“少年”，便代表着攀登本身——那份一往无前的姿态与信念。常言道：“人的成长，就是逐渐认识到自己‘比不上’‘做不到’的过程。”这是一个向现实妥协、被经验磨平棱角的过程。而“少年”恰恰是这一过程的反面。它并非一个年龄的标签，而是一种生命的原初状态——一颗尚未对世界说“我不行”，尚未向现实低头，依旧满怀热爱与笃信，坚信自己能够创造“非凡”的心。\u003c/p\u003e\n\u003cp\u003e当这两种特质交汇，一幅“最美少年”的画像便跃然纸上。一个坚信自己能够创造“非凡之美”的少年，本身就是一种“超乎寻常”的美好。这样的人，我们通常称之为“强者”。强者之强，在于能为常人所不能为，能创造不可思议的奇迹。\u003c/p\u003e\n\u003cp\u003e真正的强者之美，并非仅仅体现在拥有的力量或技艺上，更在于掌握了获取力量的方法与永不熄灭的信念。这正如一位传奇企业家所言：“即便夺走我的一切，将我扔到沙漠中央，只要有一支商队经过，我就能东山再起。”知识和技能可以被传授，可以被遗忘，但那份从零到一、探索未知的方法论，那种“我能行”的内在驱动力，才是更本质、更强大的力量。这，也正是“少年”精神的核心。\u003c/p\u003e\n\u003cp\u003e因此，我心目中的“最美少年”，他/她或许没有惊艳的外貌，或许尚未取得惊人的成就，但他/她的心中燃烧着一团火焰——坚信自己拥有创造非凡的潜能，并为之不懈地探索、努力，对生活报以最纯粹的热爱与激情。\u003c/p\u003e\n\u003cp\u003e这份美，无关外在，直抵灵魂。它是不向局限低头的勇气，是面对未知敢于开拓的锐气，是相信“我能成为强者”的生命意气。这份美，不为岁月所侵蚀，不为困境所磨灭，它是一种精神的肖像，一种生命最昂扬的姿态。这，便是我所认为的，真正的“最美”。\u003c/p\u003e","title":"什么是美？"},{"content":"l\u0026rsquo;oiseauetl\u0026rsquo;enfant，鸟儿与孩子。\n非常喜欢的诗歌，是经典法语歌曲的译本。但也可以视作独立的现代诗。\n译者不明。但是最早可确认的来源是《怪物被杀就会死》完结感言，很可能是阴天的作品。\n就像是一个眼睛明亮的孩子 目送飞向远方的鸟儿 就像一只青鸟飞跃地球 凝望这美丽的世界 美丽的小船随波而起舞 沉醉于生活，爱与清风 悠扬的歌曲于浪中诞生 离开了白色的沙滩 纯洁的白色，诗人的血液 他们在歌唱，歌颂着爱 把生命的每一天装点成节日 将黑暗用光明来取代 启明的光辉点亮了生命的白昼 为了唤醒那些城市中晦暗的眼睛 在那里，清晨将梦境扰乱 是为了还给我们一个爱的世界 爱是你，爱是我 鸟儿是你，孩子是我 我只是一个孤独于影中的孩子 看见了被繁星点亮的夜 而你，我的星星，一同编织了我们的舞曲 来点燃我熄灭的太阳…… 注：对原文有两处修改。“美丽的小船随波而起舞”原文是“美丽的小船于随波而起舞”，是一个笔误，所以修正。“是为了还给我们一个爱的世界”原文是“是为了给我们一个爱的世界”，这里是我的修改。\n","permalink":"https://litjohn.github.io/posts/loiseauetlenfant/","summary":"\u003cp\u003el\u0026rsquo;oiseauetl\u0026rsquo;enfant，鸟儿与孩子。\u003c/p\u003e\n\u003cp\u003e非常喜欢的诗歌，是经典法语歌曲的译本。但也可以视作独立的现代诗。\u003c/p\u003e\n\u003cp\u003e译者不明。但是最早可确认的来源是《怪物被杀就会死》完结感言，很可能是阴天的作品。\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e就像是一个眼睛明亮的孩子\n\n目送飞向远方的鸟儿\n\n就像一只青鸟飞跃地球\n\n凝望这美丽的世界\n\n美丽的小船随波而起舞\n\n沉醉于生活，爱与清风\n\n悠扬的歌曲于浪中诞生\n\n离开了白色的沙滩\n\n纯洁的白色，诗人的血液\n\n他们在歌唱，歌颂着爱\n\n把生命的每一天装点成节日\n\n将黑暗用光明来取代\n\n启明的光辉点亮了生命的白昼\n\n为了唤醒那些城市中晦暗的眼睛\n\n在那里，清晨将梦境扰乱\n\n是为了还给我们一个爱的世界\n\n爱是你，爱是我\n\n鸟儿是你，孩子是我\n\n我只是一个孤独于影中的孩子\n\n看见了被繁星点亮的夜\n\n而你，我的星星，一同编织了我们的舞曲\n\n来点燃我熄灭的太阳……\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e注：对原文有两处修改。“美丽的小船随波而起舞”原文是“美丽的小船于随波而起舞”，是一个笔误，所以修正。“是为了还给我们一个爱的世界”原文是“是为了给我们一个爱的世界”，这里是我的修改。\u003c/p\u003e","title":"鸟儿与孩子"},{"content":"魔怔了。破防了。\nrefresh remainder rethink review relation reverse reserve reunion regret return || T1 retry T2 remind T3 remain T4 renew || @Halberd_Cease : 我来押 NOIP T1：rebuild T2 rehash T3 relink T4 remove\n带来好运的黄黑之王。在 NOIP 遇到 NOI plus 还能说什么呢？\n建议评黄黑黑黑。呼应一下诡秘。\n获得了严格不超过 140pts。除了 T1 签到之外其他几个题一点不会，随便拼了一些零碎暴力。\n只能说比去年 63pts 的招笑分数好一点吧。\n","permalink":"https://litjohn.github.io/posts/noip2025/","summary":"\u003cp\u003e魔怔了。破防了。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003erefresh remainder rethink review relation reverse reserve reunion regret return || T1 retry T2 remind T3 remain T4 renew ||\n@Halberd_Cease : 我来押 NOIP T1：rebuild T2 rehash T3 relink T4 remove\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e带来好运的黄黑之王。在 NOIP 遇到 NOI plus 还能说什么呢？\u003c/p\u003e\n\u003cp\u003e建议评黄黑黑黑。呼应一下诡秘。\u003c/p\u003e\n\u003cp\u003e获得了严格不超过 140pts。除了 T1 签到之外其他几个题一点不会，随便拼了一些零碎暴力。\u003c/p\u003e\n\u003cp\u003e只能说比去年 63pts 的招笑分数好一点吧。\u003c/p\u003e","title":"re：从 no egg 开始的 2025 OI 赛季"},{"content":"简单技巧。实用的小 trick。\n一般而言多维偏序（比如大于等于 3 维的偏序）做法是 CDQ 分治。但是当维度比较多（比如 5D 以上）时 CDQ 会极其难写，并且带有很多 log，实际效率很劣。\nbitset 能够以 $O(\\frac{n^2d}{w})$ 时间和 $O(\\frac{n^2}{8})$ 空间解决这类问题。\n方法非常简单：高维偏序，要求我们统计满足在每一维度上的属性都被当前元素偏序的元素的集合。“在每一维度上都被偏序”就是每个维度上的独立偏序条件的逻辑与，在集合上，对应的就是交集。\n这可以用 bitset 维护，于是做完了。\n具体的，我们设 ans[i] 是一个 bitset，维护被 i 偏序的元素的集合，第 j 位为 1 代表 j 被 i 偏序。那么，我们枚举每个维度，设 f[i] 是这个维度上被 i 偏序的元素的集合（同样，第 j 位为 1 代表 j 在这一维度上被 i 偏序。），令 ans[i] = ans[i] \u0026amp; f[i] 即可。\n例题：【模板】三维偏序/陌上花开。以及 CF1826E Walk the Runway，等等。\n放一个后面那道题的代码：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 #include \u0026lt;bits/stdc++.h\u0026gt; using namespace std; int m, n; array\u0026lt;int, 5005\u0026gt; p; array\u0026lt;bitset\u0026lt;5005\u0026gt;, 5005\u0026gt; e; array\u0026lt;long long, 5005\u0026gt; ans; array\u0026lt;array\u0026lt;int, 5005\u0026gt;, 505\u0026gt; r; int main() { ios_base::sync_with_stdio(false); cin.tie(nullptr); cin \u0026gt;\u0026gt; m \u0026gt;\u0026gt; n; for (int i = 1; i \u0026lt;= n; ++i) { cin \u0026gt;\u0026gt; p[i]; } for (int i = 1; i \u0026lt;= m; ++i) { for (int j = 1; j \u0026lt;= n; ++j) { cin \u0026gt;\u0026gt; r[i][j]; } } for (int i = 1; i \u0026lt;= m; ++i) { vector\u0026lt;pair\u0026lt;int, int\u0026gt;\u0026gt; tmp(n + 2); for (int j = 1; j \u0026lt;= n; ++j) { tmp[j] = {r[i][j], j}; } sort(tmp.begin() + 1, tmp.begin() + n + 1); bitset\u0026lt;5005\u0026gt; cur; cur.set(); int banned = 0; for (int j = 1; j \u0026lt;= n; ++j) { while (banned \u0026lt;= n \u0026amp;\u0026amp; tmp[banned].first \u0026lt; tmp[j].first) { cur[tmp[banned].second] = false; banned++; } e[tmp[j].second] |= cur; } if (i == m) { for (int id: views::values(tmp)) { e[id].flip(); for (int pre = e[id]._Find_first(); pre \u0026lt;= n; pre = e[id]._Find_next(pre)) { ans[id] = max(ans[id], ans[pre]); } ans[id] += p[id]; } } } long long final = 0; for (int i = 1; i \u0026lt;= n; ++i) { final = max(final, ans[i]); } cout \u0026lt;\u0026lt; final; return 0; } ","permalink":"https://litjohn.github.io/posts/bitset-%E7%BB%B4%E6%8A%A4%E9%AB%98%E7%BB%B4%E5%81%8F%E5%BA%8F/","summary":"\u003cp\u003e简单技巧。实用的小 trick。\u003c/p\u003e\n\u003cp\u003e一般而言多维偏序（比如大于等于 3 维的偏序）做法是 CDQ 分治。但是当维度比较多（比如 5D 以上）时 CDQ 会极其难写，并且带有很多 log，实际效率很劣。\u003c/p\u003e\n\u003cp\u003ebitset 能够以 $O(\\frac{n^2d}{w})$ 时间和 $O(\\frac{n^2}{8})$ 空间解决这类问题。\u003c/p\u003e\n\u003cp\u003e方法非常简单：高维偏序，要求我们统计满足在每一维度上的属性都被当前元素偏序的元素的集合。“在每一维度上都被偏序”就是每个维度上的独立偏序条件的逻辑与，在集合上，对应的就是交集。\u003c/p\u003e\n\u003cp\u003e这可以用 bitset 维护，于是做完了。\u003c/p\u003e\n\u003cp\u003e具体的，我们设 \u003ccode\u003eans[i]\u003c/code\u003e 是一个 bitset，维护被 \u003ccode\u003ei\u003c/code\u003e 偏序的元素的集合，第 \u003ccode\u003ej\u003c/code\u003e 位为 1 代表 \u003ccode\u003ej\u003c/code\u003e 被 \u003ccode\u003ei\u003c/code\u003e 偏序。那么，我们枚举每个维度，设 \u003ccode\u003ef[i]\u003c/code\u003e 是这个维度上被 \u003ccode\u003ei\u003c/code\u003e 偏序的元素的集合（同样，第 \u003ccode\u003ej\u003c/code\u003e 位为 1 代表 \u003ccode\u003ej\u003c/code\u003e 在这一维度上被 \u003ccode\u003ei\u003c/code\u003e 偏序。），令 \u003ccode\u003eans[i] = ans[i] \u0026amp; f[i]\u003c/code\u003e 即可。\u003c/p\u003e\n\u003cp\u003e例题：【模板】三维偏序/陌上花开。以及 \u003ca href=\"https://www.luogu.com.cn/problem/CF1826E\"\u003eCF1826E Walk the Runway\u003c/a\u003e，等等。\u003c/p\u003e\n\u003cp\u003e放一个后面那道题的代码：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e28\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e29\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e30\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e31\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e32\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e33\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e34\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e35\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e36\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e37\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e38\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e39\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e40\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e41\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e42\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e43\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e44\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e45\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e46\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e47\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e48\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e49\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e50\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e51\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e52\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e53\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e54\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e55\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e56\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e57\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e58\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e59\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e60\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e61\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e62\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-cpp\" data-lang=\"cpp\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;bits/stdc++.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003eusing\u003c/span\u003e \u003cspan class=\"k\"\u003enamespace\u003c/span\u003e \u003cspan class=\"n\"\u003estd\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003earray\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e5005\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003earray\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003ebitset\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"mi\"\u003e5005\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e5005\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003earray\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e5005\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eans\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"n\"\u003earray\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003earray\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e5005\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e505\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003eios_base\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003esync_with_stdio\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003ecin\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etie\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003enullptr\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003ecin\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003em\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"n\"\u003ecin\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"n\"\u003ecin\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"n\"\u003evector\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003epair\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003etmp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"n\"\u003etmp\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e][\u003c/span\u003e\u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"n\"\u003esort\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etmp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebegin\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etmp\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebegin\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"n\"\u003ebitset\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"mi\"\u003e5005\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ecur\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"n\"\u003ecur\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eset\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ebanned\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebanned\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003etmp\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ebanned\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003efirst\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003etmp\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003efirst\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"n\"\u003ecur\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003etmp\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ebanned\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003esecond\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"n\"\u003ebanned\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003etmp\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003esecond\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e|=\u003c/span\u003e \u003cspan class=\"n\"\u003ecur\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nl\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eviews\u003c/span\u003e\u003cspan class=\"o\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003evalues\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etmp\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eflip\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003epre\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003e_Find_first\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"n\"\u003epre\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003epre\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003e_Find_next\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epre\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u003cspan class=\"n\"\u003eans\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eans\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003eans\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003epre\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"n\"\u003eans\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"k\"\u003efinal\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003efinal\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emax\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efinal\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eans\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e]);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003ecout\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"k\"\u003efinal\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e","title":"Bitset 维护高维偏序"},{"content":"对 $2^{61}-1$ 快速取模的实现存档。\n1 2 3 4 5 6 7 8 9 10 11 template \u0026lt;typename T\u0026gt; constexpr uint64_t mod(T res) { constexpr uint64_t mod_p = (1ull \u0026lt;\u0026lt; 61) - 1; res = (res \u0026gt;\u0026gt; 61) + (res \u0026amp; mod_p); res = (res \u0026gt;\u0026gt; 61) + (res \u0026amp; mod_p); if (res == mod_p) { return 0; } return res; } ","permalink":"https://litjohn.github.io/posts/fast-mod-261-1/","summary":"\u003cp\u003e对 $2^{61}-1$ 快速取模的实现存档。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-cpp\" data-lang=\"cpp\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003etemplate\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"k\"\u003etypename\u003c/span\u003e \u003cspan class=\"n\"\u003eT\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003econstexpr\u003c/span\u003e \u003cspan class=\"kt\"\u003euint64_t\u003c/span\u003e \u003cspan class=\"n\"\u003emod\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eT\u003c/span\u003e \u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003econstexpr\u003c/span\u003e \u003cspan class=\"kt\"\u003euint64_t\u003c/span\u003e \u003cspan class=\"n\"\u003emod_p\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1ull\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e61\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003eres\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e61\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003emod_p\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003eres\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e61\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003emod_p\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003emod_p\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e","title":"对 2^{61}-1 快速取模"},{"content":"splitmix64 的实现存档。\n1 2 3 4 5 6 7 8 9 10 #include \u0026lt;cstdint\u0026gt; uint64_t splitmix64(uint64_t x) { // 固定的“魔法”常数，都是精心挑选的 x += 0x9e3779b97f4a7c15; x = (x ^ (x \u0026gt;\u0026gt; 30)) * 0xbf58476d1ce4e5b9; x = (x ^ (x \u0026gt;\u0026gt; 27)) * 0x94d049bb133111eb; x = x ^ (x \u0026gt;\u0026gt; 31); return x; } ","permalink":"https://litjohn.github.io/posts/splitmix64/","summary":"\u003cp\u003esplitmix64 的实现存档。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-cpp\" data-lang=\"cpp\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;cstdint\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kt\"\u003euint64_t\u003c/span\u003e \u003cspan class=\"nf\"\u003esplitmix64\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003euint64_t\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e// 固定的“魔法”常数，都是精心挑选的\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"mh\"\u003e0x9e3779b97f4a7c15\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e^\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e30\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mh\"\u003e0xbf58476d1ce4e5b9\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e^\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e27\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e \u003cspan class=\"mh\"\u003e0x94d049bb133111eb\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e^\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e31\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e","title":"Splitmix64"},{"content":"CSP2025 游记。标题本来打算起“既渡厄劫，自登天门”，但是转念一想我似乎还没有渡过劫难，甚至连准确的估分都做不到。那么就换个标题吧。\n在我学习 OI 的三年以来，一个巨大的疑问始终悬挂在心头：我到底会做什么题？\n这个疑问从未消解过。在我刚学 OI 的时候，水平很菜，理解力不高，外加自己学的也不是非常刻苦，导致什么都不会。\n后来几年里，我学会了很多东西，做了不少题。然而每每点进一道新的洛谷/CF/at 题，却又发现自己完全不会。尤其是梦熊比赛的题目。\n一直觉得自己的实力应当有提高，然而却不知道到底高了多少，现在又是什么情况。\n就这样渡过了 2024 CSP。因为题目的水分得到了提高一等。在场上觉得自己做不了不去想正解，在下场之后才发现题怎么这么简单。\n之后的一年似乎什么都没干。跟着代码源（机构）训练了一整年，做的全是 CF/at 题目，OI 题倒是没做多少。\n每次被 CF 任意难度的题（从 1200 到 2000 的简单题）创死。ABC 成绩也一直没有长进，很少 6 题，我到现在 at 都没有突破 1600.\n比较逆天的是代码源普及组课程（L4 上）结课测试，被当场击杀，T2 和 T3 都想假了，两题一共只有 10 pts，整场比赛得分 140 pts。\n然后就到了 11 月。秋天开始了。\n在我的记忆里，我好像还是当初五年级全校最小的 OIer，还有着充足的时间和光明的未来。但现在我已经初三（学籍初二）了，离退役也不远了。\n2024-2025 的一整年如同飞一般滑过，未来滚滚而来，不问人们意见。\n初赛，我一直认为初赛虽然不重要，却是挺有意思的。可以拿到文化课去当思考题。\n我之前的初赛分数一直都不高，常常挂在程序判断/填空上。这次初赛，我在第二题就被卡住了：没学 KMP ;) 试图现场理解 border 是什么，弄错了几次感觉题目有问题，最后发现是自己理解错了然后切掉了。\n选择题都比较简单，后面的几个程序题一眼看上去还是同样困难。然而，令人惊讶的是，在长时间的奋力思考下，我最终都成功理解了它们的意图。唯一的例外是最后那个 (t, n) 门限的组合构造，不过我至少填出了 43 题之外的其他题。\n最后得分 97.\n复赛。没什么好讲的，该会就会，不会就不会。T1 类似于 duel 和密码锁，不过中间想错一次，又没有注意到 n 是偶数（事实上我考前几天才做过一个保证 n 是偶数的题：https://www.luogu.com.cn/problem/P11452，这个题 n 为奇数难度会飙升）。半小时通过大样例。\nT2 不会。一开始还想这个题怎么这么神秘，用了一会才注意到是最小生成树（ad-hoc 做傻了）。但是我还是只会枚举选哪些乡村的 $O(2^k m \\log m)$ 做法，过不了。先看了 T3，但是也不会，又回来。想了 114514 种神秘的图论建模试图去掉乡村改造的费用从而自动化求解，都行不通。最后仔细想了想为什么 n，m 不同阶，偶然注意到可以只保留最小生成树上的边，就会了。写了一个 k 路归并，$O(2^k n k^2)$。过了大样例，此时是 2h。\n当然我最后发现大样例只有真实数据的 1/10 规模，而我大样例本机 200ms，感觉要挂 20 pts。有一种比较好的做法可以去掉两个 k：每个乡村改造的状态有一个 MST，每个状态都可以从之前的一个状态递推转移过来，这个转移使用二路归并，然后重跑 kruskal 即可。\nT3 一开始被 t1, t2 不等长迷惑了，想的非常复杂。过了一会儿发现 t1, t2 必须等长，否则方案数一定是 0（不可以，总司令）。然后就可以分解为最长前后缀加上中间不同一段三部分。对于任意一个替换方案，它必然是将中间不同部分替换，然后外加一段相同的前/后缀。\n然后就不会了。写了 hash 的 nq 暴力，但是跑的非常快（跑不满），轻松过了所有大样例。最低 50，如果数据水说不定能高一些。\n我在想的时候也发现了这个题和多串匹配似乎是有不小的关系。然而我不会 AC 自动机 :( 以及 2048 MiB 让人想起追忆Trie，我也没想到怎么用。\nT4 觉得不像是我能会的题，打了 20 pts 暴力，这时只剩很少的时间了，检查了前几个题，发现 T2 有挂分可能，但是解决不了。离场了。\n之后发现 T4 竟然还有 16 pts 特殊性质分可以拿我没拿。\n出来之后发现 T2 人均被卡常，不用精细实现确实难过。T3 有同学弄出来了，但是银牌佬学长用了 AC 自动机+三维偏序，也有被卡常风险。\n分数在 [250, 320] 之间随机取值。我能拿到 7 级钩子吗？\nupd：T3 没看到 s1==s2 吓得半死。T2 数组开小有可能挂到 64 pts，最低 184 pts了。\nupd2：似乎我获得了 250 pts。银牌学长得到了 336.成绩不算太差了。\nupd3：发现赛时代码没有任何问题。我 T2 数组开到了正确的大小（1e4+25），T3 加了防御性的特判。之前是自己吓自己了。\n并且似乎打进二倍队线了。\n我剑我法，新世新生。\n既渡厄劫，自登天门。\n","permalink":"https://litjohn.github.io/posts/csp-s2025/","summary":"\u003cp\u003eCSP2025 游记。标题本来打算起“既渡厄劫，自登天门”，但是转念一想我似乎还没有渡过劫难，甚至连准确的估分都做不到。那么就换个标题吧。\u003c/p\u003e\n\u003cp\u003e在我学习 OI 的三年以来，一个巨大的疑问始终悬挂在心头：我到底会做什么题？\u003c/p\u003e\n\u003cp\u003e这个疑问从未消解过。在我刚学 OI 的时候，水平很菜，理解力不高，外加自己学的也不是非常刻苦，导致什么都不会。\u003cbr\u003e\n后来几年里，我学会了很多东西，做了不少题。然而每每点进一道新的洛谷/CF/at 题，却又发现自己完全不会。尤其是梦熊比赛的题目。\u003c/p\u003e\n\u003cp\u003e一直觉得自己的实力应当有提高，然而却不知道到底高了多少，现在又是什么情况。\u003c/p\u003e\n\u003cp\u003e就这样渡过了 2024 CSP。因为题目的水分得到了提高一等。在场上觉得自己做不了不去想正解，在下场之后才发现题怎么这么简单。\u003c/p\u003e\n\u003cp\u003e之后的一年似乎什么都没干。跟着代码源（机构）训练了一整年，做的全是 CF/at 题目，OI 题倒是没做多少。\u003cbr\u003e\n每次被 CF 任意难度的题（从 1200 到 2000 的简单题）创死。ABC 成绩也一直没有长进，很少 6 题，我到现在 at 都没有突破 1600.\u003c/p\u003e\n\u003cp\u003e比较逆天的是代码源普及组课程（L4 上）结课测试，被当场击杀，T2 和 T3 都想假了，两题一共只有 10 pts，整场比赛得分 140 pts。\u003c/p\u003e\n\u003cp\u003e然后就到了 11 月。秋天开始了。\u003c/p\u003e\n\u003cp\u003e在我的记忆里，我好像还是当初五年级全校最小的 OIer，还有着充足的时间和光明的未来。但现在我已经初三（学籍初二）了，离退役也不远了。\u003c/p\u003e\n\u003cp\u003e2024-2025 的一整年如同飞一般滑过，未来滚滚而来，不问人们意见。\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e初赛，我一直认为初赛虽然不重要，却是挺有意思的。可以拿到文化课去当思考题。\u003c/p\u003e\n\u003cp\u003e我之前的初赛分数一直都不高，常常挂在程序判断/填空上。这次初赛，我在第二题就被卡住了：没学 KMP ;) 试图现场理解 border 是什么，弄错了几次感觉题目有问题，最后发现是自己理解错了然后切掉了。\u003c/p\u003e\n\u003cp\u003e选择题都比较简单，后面的几个程序题一眼看上去还是同样困难。然而，令人惊讶的是，在长时间的奋力思考下，我最终都成功理解了它们的意图。唯一的例外是最后那个 (t, n) 门限的组合构造，不过我至少填出了 43 题之外的其他题。\u003c/p\u003e\n\u003cp\u003e最后得分 97.\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e复赛。没什么好讲的，该会就会，不会就不会。T1 类似于 duel 和密码锁，不过中间想错一次，又没有注意到 n 是偶数（事实上我考前几天才做过一个保证 n 是偶数的题：\u003ca href=\"https://www.luogu.com.cn/problem/P11452\"\u003ehttps://www.luogu.com.cn/problem/P11452\u003c/a\u003e，这个题 n 为奇数难度会飙升）。半小时通过大样例。\u003c/p\u003e","title":"未来滚滚而来，不问人们意见"},{"content":"如题，一种 lisp 列表的增强版，支持 $O(\\log n)$ 级别的随机访问和修改，并且无缝可持久化。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 #lang racket/base (define (length-geq? l n) (let loop ([cur l] [len 0]) (cond [(\u0026gt;= len n) #t] [(null? cur) #f] [else (loop (cdr cur) (add1 len))]))) (struct alist (roots) #:transparent) (struct single-tree (root size) #:transparent) (struct tree-node (val l r) #:transparent) (define (alist-cons head l) (let ([rt (alist-roots l)]) (if (length-geq? rt 2) (let ([a (car rt)] [b (cadr rt)] [rest (cddr rt)]) (if (= (single-tree-size a) (single-tree-size b)) (alist (cons (single-tree (tree-node head (single-tree-root a) (single-tree-root b)) (add1 (* 2 (single-tree-size b)))) rest)) (alist (cons (single-tree (tree-node head #f #f) 1) rt)))) (alist (cons (single-tree (tree-node head #f #f) 1) rt))))) (define (alist-car l) (let ([head (car (alist-roots l))]) (tree-node-val (single-tree-root head)))) (define (alist-cdr l) (let ([head (car (alist-roots l))] [rest (cdr (alist-roots l))]) (if (= (single-tree-size head) 1) (alist rest) (let* ([root (single-tree-root head)] [lson (tree-node-l root)] [rson (tree-node-r root)] [size (arithmetic-shift (single-tree-size head) -1)]) (alist (cons (single-tree lson size) (cons (single-tree rson size) rest))))))) (define (get-binary x) (define width (integer-length x)) (define res (make-vector width #f)) (let loop ([i (sub1 width)]) (when (\u0026gt;= i 0) (when (not (zero? (bitwise-and 1 (arithmetic-shift x (- i))))) (vector-set! res i #t)) (loop (sub1 i)))) res) (define (access-in-single-tree p idx) (define width (integer-length idx)) (define bin (get-binary idx)) (let loop ([i (- width 2)] [cur p]) (if (\u0026gt;= i 0) (if (vector-ref bin i) (loop (sub1 i) (tree-node-r cur)) (loop (sub1 i) (tree-node-l cur))) (tree-node-val cur)))) (define (random-access l pos) (set! pos (add1 pos)) ;; 0-base =\u0026gt; 1-base (let ([roots (alist-roots l)]) (let loop ([cur roots] [i pos]) (let ([rt (car cur)]) (if (\u0026gt; i (single-tree-size rt)) (loop (cdr cur) (- i (single-tree-size rt))) (access-in-single-tree (single-tree-root rt) i)))))) (define (set-in-single-tree p idx v) (define width (integer-length idx)) (define bin (get-binary idx)) (let loop ([i (- width 2)] [cur p]) (let ([org (tree-node-val cur)] [lson (tree-node-l cur)] [rson (tree-node-r cur)]) (if (\u0026lt; i 0) (tree-node v lson rson) (if (vector-ref bin i) (tree-node org lson (loop (sub1 i) rson)) (tree-node org (loop (sub1 i) lson) rson)))))) (define (random-set l pos v) (set! pos (add1 pos)) (define res (let ([roots (alist-roots l)]) (let loop ([cur roots] [i pos]) (let ([rt (car cur)]) (if (\u0026gt; i (single-tree-size rt)) (cons rt (loop (cdr cur) (- i (single-tree-size rt)))) (cons (single-tree (set-in-single-tree (single-tree-root rt) i v) (single-tree-size rt)) (cdr cur))))))) (alist res)) ;; tests (define a (alist \u0026#39;())) (set! a (alist-cons 3 a)) (set! a (alist-cons 5 a)) (displayln (random-access a 0)) (set! a (alist-cons 7 a)) (set! a (alist-cons 9 a)) (displayln (random-access a 2)) (set! a (random-set a 2 \u0026#39;a)) (displayln (random-access a 2)) (displayln (random-access (alist-cdr a) 1)) 概述 一种基于完美二叉树以及斜二进制分解的结构。lisp 列表的上位替代，支持 $O(1)$ 的 car/cdr/cons，$O(\\log n)$ 的随机访问修改。完全可持久化，支持不可变性和结构共享。\n后面的几点才是真正的优势。如果只是要常数级别头部添加以及高效随机访问，vector 快得多（类似 C++ std::vector 的结构，但是反转过来）。然而我们使用列表时常用的是结构共享和可持久化的功能，也要求不可变性，vector 就无法胜任。\n权值线段树不支持 cons/cdr，而平衡树不支持 $O(1)$ car/cdr/cons。\n原理 维护一组完美二叉树组成的列表。\n我们将列表中的元素存储在这些树中，靠前的树中任意元素的下标小于靠后的树中元素的下标（形式化的，对于任意 $i, j$ 满足 $i","permalink":"https://litjohn.github.io/posts/random-accessible-funtional-list/","summary":"\u003cp\u003e如题，一种 lisp 列表的增强版，支持 $O(\\log n)$ 级别的随机访问和修改，并且无缝可持久化。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e  1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e  2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e  3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e  4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e  5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e  6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e  7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e  8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e  9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 27\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 28\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 29\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 30\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 31\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 32\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 33\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 34\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 35\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 36\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 37\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 38\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 39\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 40\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 41\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 42\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 43\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 44\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 45\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 46\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 47\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 48\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 49\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 50\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 51\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 52\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 53\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 54\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 55\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 56\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 57\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 58\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 59\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 60\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 61\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 62\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 63\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 64\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 65\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 66\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 67\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 68\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 69\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 70\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 71\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 72\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 73\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 74\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 75\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 76\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 77\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 78\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 79\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 80\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 81\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 82\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 83\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 84\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 85\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 86\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 87\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 88\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 89\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 90\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 91\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 92\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 93\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 94\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 95\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 96\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 97\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 98\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 99\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e100\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e101\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e102\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e103\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e104\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e105\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e106\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e107\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e108\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e109\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e110\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e111\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e112\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e113\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e114\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e115\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e116\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e117\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e118\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e119\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e120\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e121\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e122\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e123\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e124\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e125\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e126\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e127\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e128\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e129\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e130\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e131\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e132\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e133\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e134\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e135\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e136\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-racket\" data-lang=\"racket\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kn\"\u003e#lang \u003c/span\u003e\u003cspan class=\"nn\"\u003eracket/base\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elength-geq?\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"n\"\u003eloop\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003ecur\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e             \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003elen\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003econd\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"nb\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"n\"\u003elen\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"no\"\u003e#t\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"nb\"\u003enull?\u003c/span\u003e \u003cspan class=\"n\"\u003ecur\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"no\"\u003e#f\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eloop\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecdr\u003c/span\u003e \u003cspan class=\"n\"\u003ecur\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eadd1\u003c/span\u003e \u003cspan class=\"n\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e))])))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ealist\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eroots\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kd\"\u003e#:transparent\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003esingle-tree\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eroot\u003c/span\u003e \u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kd\"\u003e#:transparent\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003etree-node\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eval\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e \u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kd\"\u003e#:transparent\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealist-cons\u003c/span\u003e \u003cspan class=\"n\"\u003ehead\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003ert\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealist-roots\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"p\"\u003e)])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elength-geq?\u003c/span\u003e \u003cspan class=\"n\"\u003ert\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecar\u003c/span\u003e \u003cspan class=\"n\"\u003ert\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e              \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecadr\u003c/span\u003e \u003cspan class=\"n\"\u003ert\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e              \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003erest\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecddr\u003c/span\u003e \u003cspan class=\"n\"\u003ert\u003c/span\u003e\u003cspan class=\"p\"\u003e)])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esingle-tree-size\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esingle-tree-size\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e              \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealist\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e               \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003econs\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esingle-tree\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                      \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etree-node\u003c/span\u003e \u003cspan class=\"n\"\u003ehead\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esingle-tree-root\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esingle-tree-root\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                      \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eadd1\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e*\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esingle-tree-size\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                     \u003cspan class=\"nb\"\u003erest\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e              \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealist\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003econs\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esingle-tree\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etree-node\u003c/span\u003e \u003cspan class=\"n\"\u003ehead\u003c/span\u003e \u003cspan class=\"no\"\u003e#f\u003c/span\u003e \u003cspan class=\"no\"\u003e#f\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003ert\u003c/span\u003e\u003cspan class=\"p\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealist\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003econs\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esingle-tree\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etree-node\u003c/span\u003e \u003cspan class=\"n\"\u003ehead\u003c/span\u003e \u003cspan class=\"no\"\u003e#f\u003c/span\u003e \u003cspan class=\"no\"\u003e#f\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003ert\u003c/span\u003e\u003cspan class=\"p\"\u003e)))))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealist-car\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003ehead\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecar\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealist-roots\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"p\"\u003e))])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etree-node-val\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e     \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esingle-tree-root\u003c/span\u003e \u003cspan class=\"n\"\u003ehead\u003c/span\u003e\u003cspan class=\"p\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealist-cdr\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003ehead\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecar\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealist-roots\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"p\"\u003e))]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003erest\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecdr\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealist-roots\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"p\"\u003e))])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esingle-tree-size\u003c/span\u003e \u003cspan class=\"n\"\u003ehead\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealist\u003c/span\u003e \u003cspan class=\"nb\"\u003erest\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet*\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003eroot\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esingle-tree-root\u003c/span\u003e \u003cspan class=\"n\"\u003ehead\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e               \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003elson\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etree-node-l\u003c/span\u003e \u003cspan class=\"n\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e               \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003erson\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etree-node-r\u003c/span\u003e \u003cspan class=\"n\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e               \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003esize\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003earithmetic-shift\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esingle-tree-size\u003c/span\u003e \u003cspan class=\"n\"\u003ehead\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"mi\"\u003e-1\u003c/span\u003e\u003cspan class=\"p\"\u003e)])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealist\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003econs\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esingle-tree\u003c/span\u003e \u003cspan class=\"n\"\u003elson\u003c/span\u003e \u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003econs\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esingle-tree\u003c/span\u003e \u003cspan class=\"n\"\u003erson\u003c/span\u003e \u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nb\"\u003erest\u003c/span\u003e\u003cspan class=\"p\"\u003e)))))))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eget-binary\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine\u003c/span\u003e \u003cspan class=\"n\"\u003ewidth\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003einteger-length\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine\u003c/span\u003e \u003cspan class=\"n\"\u003eres\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003emake-vector\u003c/span\u003e \u003cspan class=\"n\"\u003ewidth\u003c/span\u003e \u003cspan class=\"no\"\u003e#f\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"n\"\u003eloop\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003esub1\u003c/span\u003e \u003cspan class=\"n\"\u003ewidth\u003c/span\u003e\u003cspan class=\"p\"\u003e)])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ewhen\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ewhen\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003enot\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ezero?\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ebitwise-and\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003earithmetic-shift\u003c/span\u003e \u003cspan class=\"n\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)))))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evector-set!\u003c/span\u003e \u003cspan class=\"n\"\u003eres\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"no\"\u003e#t\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eloop\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003esub1\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eaccess-in-single-tree\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e \u003cspan class=\"n\"\u003eidx\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine\u003c/span\u003e \u003cspan class=\"n\"\u003ewidth\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003einteger-length\u003c/span\u003e \u003cspan class=\"n\"\u003eidx\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine\u003c/span\u003e \u003cspan class=\"n\"\u003ebin\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eget-binary\u003c/span\u003e \u003cspan class=\"n\"\u003eidx\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"n\"\u003eloop\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ewidth\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e             \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ecur\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evector-ref\u003c/span\u003e \u003cspan class=\"n\"\u003ebin\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eloop\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003esub1\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etree-node-r\u003c/span\u003e \u003cspan class=\"n\"\u003ecur\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eloop\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003esub1\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etree-node-l\u003c/span\u003e \u003cspan class=\"n\"\u003ecur\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etree-node-val\u003c/span\u003e \u003cspan class=\"n\"\u003ecur\u003c/span\u003e\u003cspan class=\"p\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erandom-access\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e \u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eset!\u003c/span\u003e \u003cspan class=\"n\"\u003epos\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eadd1\u003c/span\u003e \u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"c1\"\u003e;; 0-base =\u0026gt; 1-base\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003eroots\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealist-roots\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"p\"\u003e)])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"n\"\u003eloop\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003ecur\u003c/span\u003e \u003cspan class=\"n\"\u003eroots\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e               \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003ert\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecar\u003c/span\u003e \u003cspan class=\"n\"\u003ecur\u003c/span\u003e\u003cspan class=\"p\"\u003e)])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esingle-tree-size\u003c/span\u003e \u003cspan class=\"n\"\u003ert\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eloop\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecdr\u003c/span\u003e \u003cspan class=\"n\"\u003ecur\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esingle-tree-size\u003c/span\u003e \u003cspan class=\"n\"\u003ert\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eaccess-in-single-tree\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esingle-tree-root\u003c/span\u003e \u003cspan class=\"n\"\u003ert\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e))))))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eset-in-single-tree\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e \u003cspan class=\"n\"\u003eidx\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine\u003c/span\u003e \u003cspan class=\"n\"\u003ewidth\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003einteger-length\u003c/span\u003e \u003cspan class=\"n\"\u003eidx\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine\u003c/span\u003e \u003cspan class=\"n\"\u003ebin\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eget-binary\u003c/span\u003e \u003cspan class=\"n\"\u003eidx\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"n\"\u003eloop\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ewidth\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e             \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ecur\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003eorg\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etree-node-val\u003c/span\u003e \u003cspan class=\"n\"\u003ecur\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003elson\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etree-node-l\u003c/span\u003e \u003cspan class=\"n\"\u003ecur\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003erson\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etree-node-r\u003c/span\u003e \u003cspan class=\"n\"\u003ecur\u003c/span\u003e\u003cspan class=\"p\"\u003e)])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etree-node\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e \u003cspan class=\"n\"\u003elson\u003c/span\u003e \u003cspan class=\"n\"\u003erson\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evector-ref\u003c/span\u003e \u003cspan class=\"n\"\u003ebin\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e              \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etree-node\u003c/span\u003e \u003cspan class=\"n\"\u003eorg\u003c/span\u003e \u003cspan class=\"n\"\u003elson\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eloop\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003esub1\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003erson\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e              \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etree-node\u003c/span\u003e \u003cspan class=\"n\"\u003eorg\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eloop\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003esub1\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003elson\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003erson\u003c/span\u003e\u003cspan class=\"p\"\u003e))))))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erandom-set\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e \u003cspan class=\"n\"\u003epos\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eset!\u003c/span\u003e \u003cspan class=\"n\"\u003epos\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eadd1\u003c/span\u003e \u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine\u003c/span\u003e \u003cspan class=\"n\"\u003eres\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003eroots\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealist-roots\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"p\"\u003e)])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"n\"\u003eloop\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003ecur\u003c/span\u003e \u003cspan class=\"n\"\u003eroots\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                 \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"n\"\u003epos\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003ert\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecar\u003c/span\u003e \u003cspan class=\"n\"\u003ecur\u003c/span\u003e\u003cspan class=\"p\"\u003e)])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esingle-tree-size\u003c/span\u003e \u003cspan class=\"n\"\u003ert\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e              \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003econs\u003c/span\u003e \u003cspan class=\"n\"\u003ert\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eloop\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecdr\u003c/span\u003e \u003cspan class=\"n\"\u003ecur\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esingle-tree-size\u003c/span\u003e \u003cspan class=\"n\"\u003ert\u003c/span\u003e\u003cspan class=\"p\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e              \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003econs\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esingle-tree\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eset-in-single-tree\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esingle-tree-root\u003c/span\u003e \u003cspan class=\"n\"\u003ert\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esingle-tree-size\u003c/span\u003e \u003cspan class=\"n\"\u003ert\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecdr\u003c/span\u003e \u003cspan class=\"n\"\u003ecur\u003c/span\u003e\u003cspan class=\"p\"\u003e)))))))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealist\u003c/span\u003e \u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e;; tests\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealist\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e()))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eset!\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealist-cons\u003c/span\u003e \u003cspan class=\"mi\"\u003e3\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eset!\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealist-cons\u003c/span\u003e \u003cspan class=\"mi\"\u003e5\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003edisplayln\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erandom-access\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eset!\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealist-cons\u003c/span\u003e \u003cspan class=\"mi\"\u003e7\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eset!\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealist-cons\u003c/span\u003e \u003cspan class=\"mi\"\u003e9\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003edisplayln\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erandom-access\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eset!\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erandom-set\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"ss\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003edisplayln\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erandom-access\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003edisplayln\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erandom-access\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ealist-cdr\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch2 id=\"概述\"\u003e概述\u003c/h2\u003e\n\u003cp\u003e一种基于完美二叉树以及斜二进制分解的结构。lisp 列表的上位替代，支持 $O(1)$ 的 car/cdr/cons，$O(\\log n)$ 的随机访问修改。完全可持久化，支持不可变性和结构共享。\u003c/p\u003e","title":"函数式随机访问列表（斜二叉树队列）"},{"content":"前言 · 一点吐槽 为什么诸位都如此热衷于 vscode 啊？\n我随便一翻都能看到 inf 篇介绍 vscode 配置的文章，真是够了。\n不如来玩点神秘的：Emacs。\n什么是 Emacs？ Emacs 是一款由 GNU 开源软件基金会完全自主研发的开源文本编辑器。在这款编辑器中，你将在一个叫做“buffer”的环境中冒险，与 elisp 邂逅，并探明“Emacs pinky”的真相……\n不开玩笑了。Emacs 是知名的老牌文本编辑器，与 vi/vim 齐名，长期处于编辑器鄙视链的顶端。它的主要优势是无与伦比的可定制性——它是 Lisp Machine 思想的继承者，整个编辑器内核连同各种功能都由一种叫做 elisp 的语言写成，并且自带一个 elisp 解释器。这意味着用户可以像修改游戏 Mod 一样，自由地修改编辑器的任何代码，或者增加自己的函数，把它打造成任何你想要的样子。\n它的可定制性是图灵完备的：理论上，你可以用它来做任何事情，包括但不限于浏览网页，管理日程，与朋友吹水，又或者……原神，启动！\n如何获取？ 最简单的方法是访问 GNU Emacs 项目官网或者其 GitHub 仓库然后下载。你也可以用你的包管理器，比如 Windows 的 winget 或 scoop，macOS 的 brew，或者 Linux 的 apt、pacman 等等。在包管理器里搜 emacs 通常就能找到。\n装好后先别急着打开，因为这时的 Emacs 没有任何配置，外观简陋，功能匮乏，保证劝退。我们需要给它注入灵魂。\n如何配置？（新手的捷径） 好问题。你肯定听说过 Emacs 的配置极其困难，但作为一个刚入门的新手（就像我），想快速上手其实非常简单。\n要义在于：不要自己从头配！ 靠自己一行行攒配置所消耗的时间精力是巨大的，很可能在你配出一个好用的编辑器之前，就已经失去兴趣了。\n我们可以直接站在巨人的肩膀上，搜寻一些别人做好的 Emacs 发行版。比如经典的 Doom Emacs、Spacemacs、Centaur Emacs 或者 Prelude。\n其中 Doom Emacs 和 Spacemacs 默认开启 evil-mode（Vim 模式），使用体验类似 Vim。我不会用 Vim，所以自然放弃了它们。Centaur Emacs 和 Prelude 则坚持原生快捷键体验，而 Prelude 更加轻量级，并且为用户保留了充足的自定义空间，所以我最终选择了它。\n对于 Prelude，你只需要一条命令就能完成安装。打开你的终端（Windows 建议使用 PowerShell）：\n1 git clone https://github.com/bbatsov/prelude.git $env:appdata/.emacs.d/ 这条命令会把 Prelude 的所有配置下载到 Emacs 的默认配置目录里。\n$env:appdata 是一个环境变量，代表你的 Windows 放置 APP 数据的目录。\nPrelude 接管了主配置文件 init.el，我们最好不要动它。如果你想自己加点东西，Prelude 已经为我们预留了 ~/.emacs.d/personal/ 目录，你自己的配置可以写在 personal/custom.el 文件里。\n等等，~/.emacs.d 是什么？ 这里的波浪线 ~ 是命令行的快捷方式，代表你的用户主目录（Home Directory）。\n在 Windows 上，通常是 C:\\Users\\\u0026lt;你的用户名\u0026gt;。 在 Linux 或 macOS 上，是 /home/\u0026lt;你的用户名\u0026gt;。 Emacs 会自动在这个目录下的 .emacs.d 子目录里寻找配置文件。 现在，启动 Emacs（Windows 用户建议用 runemacs.exe，可以避免一个黑色的控制台窗口）。第一次启动时，Emacs 会自动运行 Prelude 的配置脚本，下载并编译一大堆插件。这个过程可能会持续几分钟，期间 Emacs 可能会“未响应”，别慌，这是正常现象，耐心等待即可。\n跑完之后，你的 Emacs 就配置好了。尽情玩耍吧。\n如何使用？ 就把它当做一个普通的文本编辑器用。和 VS Code 或者 Sublime 没有本质区别。\n当然，还是有些奇特的地方。比如快捷键。但别怕，去问你的 ChatGPT/Gemini：“Emacs 最基本、最常用的快捷键有哪些？”花几分钟就能学会核心操作。都 2025 年了，这种小事不应该成为门槛。\n至于外观，Prelude 默认的主题我就很喜欢，有点像 CLion，至少比上古神器 Dev-C++ 好看多了。Prelude 安装的插件也提供了很多强大的功能，你在使用中会慢慢发现它们的妙用。\n我的个人配置 我基于 Prelude，只改了 $O(1)$ 个小地方：\n设置了默认编码为 UTF-8，避免中文乱码。 设置了中文字体，不然中文没法看。 关掉了 whitespace-mode 对长行的紫色高亮提示（太丑了）。 因为我用 Emacs 写 Scheme 和 Racket，所以启用了对应的模式，并做了一些微调。 我的配置文件放在了 GitHub 上：litjohn/my-emacs-settings，欢迎自取。\n注意： 我出于个人喜好用了 Jetbrains Mono 作为编程字体。如果你电脑上没有安装，Emacs 可能会回退到某个丑陋的默认字体。你可以在我的 personal/custom.el 文件里找到设置字体的代码，把它改成你喜欢的，比如 Consolas、Cascadia Code 或者 Fira Code。\n你问我怎么没配置 C++ 开发环境？\n不是，哥们儿，写 C++ 这种主流语言为什么不用 JetBrains 的产品？CLion 现在对个人都免费了！\n我用 Emacs，纯粹是因为它写 Scheme 和 Racket 真的很顺手。工具嘛，顺手好用就行。\n","permalink":"https://litjohn.github.io/posts/set-up-emacs/","summary":"\u003ch3 id=\"前言--一点吐槽\"\u003e前言 · 一点吐槽\u003c/h3\u003e\n\u003cp\u003e为什么诸位都如此热衷于 vscode 啊？\u003c/p\u003e\n\u003cp\u003e我随便一翻都能看到 inf 篇介绍 vscode 配置的文章，真是够了。\u003c/p\u003e\n\u003cp\u003e不如来玩点神秘的：Emacs。\u003c/p\u003e\n\u003ch3 id=\"什么是-emacs\"\u003e什么是 Emacs？\u003c/h3\u003e\n\u003cp\u003e\u003cdel\u003eEmacs 是一款由 GNU 开源软件基金会完全自主研发的开源文本编辑器。在这款编辑器中，你将在一个叫做“buffer”的环境中冒险，与 elisp 邂逅，并探明“Emacs pinky”的真相……\u003c/del\u003e\u003c/p\u003e\n\u003cp\u003e不开玩笑了。Emacs 是知名的老牌文本编辑器，与 vi/vim 齐名，长期处于编辑器鄙视链的顶端。它的主要优势是无与伦比的可定制性——它是 Lisp Machine 思想的继承者，整个编辑器内核连同各种功能都由一种叫做 elisp 的语言写成，并且自带一个 elisp 解释器。这意味着用户可以像修改游戏 Mod 一样，自由地修改编辑器的任何代码，或者增加自己的函数，把它打造成任何你想要的样子。\u003c/p\u003e\n\u003cp\u003e它的可定制性是图灵完备的：理论上，你可以用它来做任何事情，包括但不限于浏览网页，管理日程，与朋友吹水，又或者……原神，启动！\u003c/p\u003e\n\u003ch3 id=\"如何获取\"\u003e如何获取？\u003c/h3\u003e\n\u003cp\u003e最简单的方法是访问 \u003ca href=\"https://www.gnu.org/software/emacs/\"\u003eGNU Emacs 项目官网\u003c/a\u003e或者其 \u003ca href=\"https://github.com/emacs-mirror/emacs\"\u003eGitHub 仓库\u003c/a\u003e然后下载。你也可以用你的包管理器，比如 Windows 的 \u003ccode\u003ewinget\u003c/code\u003e 或 \u003ccode\u003escoop\u003c/code\u003e，macOS 的 \u003ccode\u003ebrew\u003c/code\u003e，或者 Linux 的 \u003ccode\u003eapt\u003c/code\u003e、\u003ccode\u003epacman\u003c/code\u003e 等等。在包管理器里搜 \u003ccode\u003eemacs\u003c/code\u003e 通常就能找到。\u003c/p\u003e\n\u003cp\u003e装好后先别急着打开，因为这时的 Emacs 没有任何配置，外观简陋，功能匮乏，保证劝退。我们需要给它注入灵魂。\u003c/p\u003e\n\u003ch3 id=\"如何配置新手的捷径\"\u003e如何配置？（新手的捷径）\u003c/h3\u003e\n\u003cp\u003e好问题。你肯定听说过 Emacs 的配置极其困难，但作为一个刚入门的新手（就像我），想快速上手其实非常简单。\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e要义在于：不要自己从头配！\u003c/strong\u003e 靠自己一行行攒配置所消耗的时间精力是巨大的，很可能在你配出一个好用的编辑器之前，就已经失去兴趣了。\u003c/p\u003e\n\u003cp\u003e我们可以直接站在巨人的肩膀上，搜寻一些别人做好的 Emacs \u003cstrong\u003e发行版\u003c/strong\u003e。比如经典的 \u003cstrong\u003eDoom Emacs\u003c/strong\u003e、\u003cstrong\u003eSpacemacs\u003c/strong\u003e、\u003cstrong\u003eCentaur Emacs\u003c/strong\u003e 或者 \u003cstrong\u003ePrelude\u003c/strong\u003e。\u003c/p\u003e","title":"Emacs 入门笔记"},{"content":" 1 2 3 4 5 6 7 8 关于 \u0026lt;我的问题\u0026gt; 这个问题，请不要给出一个平衡各方的中立答案。 请你提出**三种不同且有明确立场的观点**。对于每一种观点，请你评估： - 观点名称：给这个观点起个名字。 - 核心论点：简要阐述其主要逻辑。 - 被接受程度：评估这个观点在当前专家和公众讨论中的普遍程度（高/中/低）。 - 信心指数：你（作为LLM）认为这个观点在未来成为现实的可能性有多大（1-10分）。 ","permalink":"https://litjohn.github.io/posts/consider-in-different-sides/","summary":"\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e8\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-markdown\" data-lang=\"markdown\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e关于 \u0026lt;我的问题\u0026gt; 这个问题，请不要给出一个平衡各方的中立答案。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e请你提出**三种不同且有明确立场的观点**。对于每一种观点，请你评估：\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003e-\u003c/span\u003e 观点名称：给这个观点起个名字。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003e-\u003c/span\u003e 核心论点：简要阐述其主要逻辑。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003e-\u003c/span\u003e 被接受程度：评估这个观点在当前专家和公众讨论中的普遍程度（高/中/低）。\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"k\"\u003e-\u003c/span\u003e 信心指数：你（作为LLM）认为这个观点在未来成为现实的可能性有多大（1-10分）。\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e","title":"用于缓解 LLM 绝对中立倾向的提示词"},{"content":"光剑后日谈 #2.\n在 Scheme/Racket 的世界里，我们常说“一切代码皆为 S-expression”。一个函数调用是 (函数名 参数1 参数2)，一个列表是 (元素1 元素2 元素3)，它们都遵循着括号包裹、前缀表示的统一形式。\n但细心的你可能会问，'(a b c) 或者 #'(+ 1 stx) 呢？开头的那个 ' 或 #' 字符，怎么看也不像是列表的一部分。它们是如何融入这套 S-expression 体系的？\n答案很简单：它们是一种语法糖。我们都知道 'exp 等价于 (quote exp)，#'exp 等价于 (syntax exp)。这个单引号 ' 仿佛是一个别名，在 Racket 读取我们的代码时，就悄无声息地将它转换成了标准的形式。这种在“读取阶段”就生效的转换规则，被称为读取器宏（Reader Macro）。\n读取器宏背后，是整个 Lisp 家族语言引以为傲的宏系统。宏是一种强大的元编程工具，它本质上是一个在编译期（或称为“展开时”）执行的函数。这个特殊的函数，它的输入是代码（以语法对象的形式），输出也是代码。它允许我们对代码进行任意复杂的、图灵完备的变换，从而彻底扩展语言本身的语法。\n那么，亲手编写一个宏，究竟是怎样的体验呢？\n宏之初体验：编写你的第一个宏 when 让我们从一个简单的需求开始。在编程中，我们经常遇到一个场景：“当某个条件成立时，执行一系列操作”。用 Racket 的 if 可以这样写：\n1 2 3 4 5 (if (\u0026lt; user-level 5) (begin (display \u0026#34;权限不足！\u0026#34;) (log-warning \u0026#34;Attempted access by low-level user.\u0026#34;)) #f) 每次都写 (begin ...) 有点繁琐（更何况 Racket 强制 if 有两个分支，那个不需要的分支混淆了语义）。如果我们能创造一个新语法 when，让代码变成下面这样，岂不是更清晰？\n1 2 3 (when (\u0026lt; user-level 5) (display \u0026#34;权限不足！\u0026#34;) (log-warning \u0026#34;Attempted access by low-level user.\u0026#34;)) 这个 when 无法用普通函数实现，因为函数会立即计算所有参数的值，而我们希望只有在条件为真时才执行后面的操作。这正是宏的用武之地。\n在 Racket 中，我们可以用 define-syntax 和 syntax-rules 来定义简单的宏，它的工作方式就像“查找与替换”的模式匹配。\n1 2 3 4 5 6 7 8 #lang racket (define-syntax when (syntax-rules () [(_ condition body ...) (if condition (begin body ...) (void))])) 让我们来拆解这段神奇的代码：\n(define-syntax when ...)：我们声明，when 不是一个函数或变量，而是一个新的语法。 (syntax-rules () ...)：这是一个简单宏的声明，() 表示这个宏里没有特殊的关键字（暂不深究）。 [(_ condition body ...)]：这是匹配模式。 _ (下划线) 是一个占位符，它能够匹配任意单个 S-expression 并忽略它。在这里，它会匹配宏调用中的第一个 S-expression，也就是宏的名字 when 本身。 condition 是一个模式变量，它会匹配 when 后面的第一个表达式。 body ... 是最巧妙的部分。... (省略号) 表示它会匹配接下来零个或多个表达式，并将它们收集到一个序列里。 (if condition (begin body ...) (void))：这是输出模板。 它描述了目标代码的样子。condition 和 body 是上面的模式匹配部分捕获的模式变量。在一个真正的宏调用中，它们会被替换成模式中的实际内容。 所以，当我们写下 (when (\u0026lt; user-level 5) (display \u0026quot;...\u0026quot;) (log-warning \u0026quot;...\u0026quot;)) 时，宏展开器会：\n匹配到 condition 是 (\u0026lt; user-level 5)。 匹配到 body ... 是 (display \u0026quot;...\u0026quot;) 和 (log-warning \u0026quot;...\u0026quot;) 两个表达式。 然后将它们填充到模板中，最终代码被转换为：(if (\u0026lt; user-level 5) (begin (display \u0026quot;...\u0026quot;) (log-warning \u0026quot;...\u0026quot;)) (void))。 编译器真正看到的，永远是转换后的标准 Racket 代码。我们通过宏，成功地为语言添加了一个新的控制结构。\n这就是 define-syntax 和 syntax-rules。它们提供了简单易用的构造新语法的能力。具体的用法是这样的：\n1 2 3 4 5 (define-syntax name (syntax-rules \u0026lt;special-words\u0026gt; \u0026lt;clause1\u0026gt; \u0026lt;clause2\u0026gt; ...)) syntax-rules 的每一个 clause（子句）形如 (pattern template)。用过模式匹配的朋友应该很熟，pattern 部分会匹配宏调用的模式，如果匹配成功就会对其中的模式变量进行绑定，然后将 template 部分中的模式变量替换为它们的值作为宏的输出。syntax-rules 展开时会从上到下依次尝试匹配每条子句，如果没有任何子句能够匹配就报错。syntax-rules 支持 (else ...) 这样的子句，else 能够匹配任何东西。\nspecial-words 列表则指定一些特殊关键字，它们会被精确匹配，而不是作为模式变量名匹配并绑定任意值。你只需要把精确匹配关键字加到列表里就可以了，比如 (syntax-rules (keyword1 keyword2 ...) ...)。\n对于只有一个子句的 syntax-rules，可以用 define-syntax-rule 这个语法糖进一步简化。\n突然发现 Racket 官网上的文档非常好。那我就省去说明的口舌了，大家都去读文档吧。借助 genAI 会很轻松。\n宏之意义：一门可编程的编程语言 通过 when 这个小例子，我们看到了宏如何让我们创造新的语法。但这只是冰山一角。这种“用代码生成代码”的能力，正是 Racket 被誉为“可编程的编程语言（Programmable Programming Language）” 的核心。\n在上一篇文章 https://litjohn.github.io/posts/start-to-build-a-compiler/ 中，我们构建了一个源到源的编译器。其实，宏系统本身就是一个内嵌在语言里的微型编译器。它接受你用扩展语法写成的代码，然后把它转换成标准的 Racket 代码。\n这赋予了我们极大的自由：\n构建领域特定语言（DSL）：当你在解决某个特定领域的问题时（如图形、数据库查询、并发控制），你可以利用宏创造一套专为此领域设计的语法，让代码读起来更像是对问题的直接描述。 抽象样板代码：将复杂的、重复的代码模式封装成一个简洁的宏。 创造新的语言范式：你甚至可以在 Racket 中用宏实现面向对象、逻辑编程等不同的编程范式。 Racket 著名的 #lang 机制，允许我们把整个文件切换成另一种“语言”，其背后也是宏系统的强大支撑。\n宏之进阶：迈向更复杂的变换 syntax-rules 对于简单的模式匹配非常方便，但如果我们的语法转换需要更复杂的逻辑呢？比如，我们想在 Racket 中直接写中缀表达式：\n(bin-exp 1 + (2 + 3 + 4) * 5 + 6)\n我们希望 Racket 能正确理解运算符的优先级，将它转换为标准的前缀表达式 (+ (+ 1 (* (+ 2 3 4) 5)) 6)。\n这个任务无法通过简单的模式匹配完成。我们需要一个真正的解析算法：遍历表达式，找到优先级最低的运算符（在这里是最后的 +），将其作为根节点，然后递归地处理左右两边的子表达式。这是一个计算过程。\n为此，Racket 提供了更强大的宏工具 syntax-case。与 syntax-rules 不同，syntax-case 允许你在宏展开阶段执行任意的 Racket 代码来分析和构建语法。你可以编写辅助函数，在编译期对输入的语法对象进行遍历、判断和重组，最终生成目标代码。\n实现 bin-exp 的过程，本质上就是在 Racket 的宏系统里，为中缀表达式这个“迷你语言”编写一个微型解析器。这完美地展示了宏的图灵完备计算能力。\n当然这个转换的算法大概不用我说。各位身为 OIer 应该都会做这个入门题。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 #lang racket (begin-for-syntax (define (find-last-add exp-vec l r) (let loop ([i (sub1 r)]) (if (\u0026lt; i l) #f (if (eq? (vector-ref exp-vec i) \u0026#39;+) i (loop (sub1 i))))))) (begin-for-syntax (define (find-last-mul exp-vec l r) (let loop ([i (sub1 r)]) (if (\u0026lt; i l) #f (if (eq? (vector-ref exp-vec i) \u0026#39;*) i (loop (sub1 i))))))) (begin-for-syntax (define (transform exp-vec l r) (if (= (add1 l) r) (let ([tmp (vector-ref exp-vec l)]) (if (not (pair? tmp)) tmp (let ([v (list-\u0026gt;vector tmp)]) (transform v 0 (vector-length v))))) (let ([add-pos (find-last-add exp-vec l r)]) (if add-pos `(+ ,(transform exp-vec l add-pos) ,(transform exp-vec (add1 add-pos) r)) (let ([mul-pos (find-last-mul exp-vec l r)]) (if mul-pos `(* ,(transform exp-vec l mul-pos) ,(transform exp-vec (add1 mul-pos) r)) (error \u0026#34;Invalid input!\u0026#34;)))))))) (define-syntax bin-exp (lambda (stx) (syntax-case stx () [(_ . exp) (let ([exp-vec (list-\u0026gt;vector (syntax-\u0026gt;datum #\u0026#39;exp))]) (datum-\u0026gt;syntax #\u0026#39;exp (transform exp-vec 0 (vector-length exp-vec))))]))) 注意上面的几个辅助函数都被 begin-for-syntax 包裹了。这是必要的，如果去掉会编译错误。因为宏和函数的存在时期不一样，函数存在于运行时，但那时宏早已不存在了。宏无法引用更晚才被定义的函数，所以需要使用这个语法。它就像 C++ 的 constexpr 能够标记一个函数在编译期求值一样，标记一个函数是给宏使用的辅助函数，存在于宏展开期。\n以及注意我们寻找运算符是从右到左的。这是实现左结合性的必要操作。对于加法和乘法，左结合或右结合都无所谓，但是一旦引入减法，这就成为了一个必须要注意的细节。\n一个有趣的问题：如果一个被标记为 begin-for-syntax 的函数需要用到一个宏呢？而如果这个函数和宏互相引用呢？\n结论 我们从一个不起眼的单引号 ' 出发，通过亲手实现一个简单的 when 宏，窥见了 Racket 宏系统的基本工作原理。进而，我们理解了宏如何赋予我们创造 DSL、甚至重塑语言的能力，这是“可编程的编程语言”这一称号的底气所在。最后，我们看到了像中缀表达式解析这样的复杂任务，展示了宏系统深不可测的潜力。\nLisp/Scheme/Racket 的宏系统邀请我们从一个语言的“使用者”，转变为一个语言的“设计者”。它给予了我们工具，去打造最适合我们问题的语言。这是一种深刻而强大的编程思想。\n","permalink":"https://litjohn.github.io/posts/bin-exp/","summary":"\u003cp\u003e光剑后日谈 #2.\u003c/p\u003e\n\u003cp\u003e在 Scheme/Racket 的世界里，我们常说“一切代码皆为 S-expression”。一个函数调用是 \u003ccode\u003e(函数名 参数1 参数2)\u003c/code\u003e，一个列表是 \u003ccode\u003e(元素1 元素2 元素3)\u003c/code\u003e，它们都遵循着括号包裹、前缀表示的统一形式。\u003c/p\u003e\n\u003cp\u003e但细心的你可能会问，\u003ccode\u003e'(a b c)\u003c/code\u003e 或者 \u003ccode\u003e#'(+ 1 stx)\u003c/code\u003e 呢？开头的那个 \u003ccode\u003e'\u003c/code\u003e 或 \u003ccode\u003e#'\u003c/code\u003e 字符，怎么看也不像是列表的一部分。它们是如何融入这套 S-expression 体系的？\u003c/p\u003e\n\u003cp\u003e答案很简单：它们是一种语法糖。我们都知道 \u003ccode\u003e'exp\u003c/code\u003e 等价于 \u003ccode\u003e(quote exp)\u003c/code\u003e，\u003ccode\u003e#'exp\u003c/code\u003e 等价于 \u003ccode\u003e(syntax exp)\u003c/code\u003e。这个单引号 \u003ccode\u003e'\u003c/code\u003e 仿佛是一个别名，在 Racket 读取我们的代码时，就悄无声息地将它转换成了标准的形式。这种在“读取阶段”就生效的转换规则，被称为\u003cstrong\u003e读取器宏（Reader Macro）\u003c/strong\u003e。\u003c/p\u003e\n\u003cp\u003e读取器宏背后，是整个 Lisp 家族语言引以为傲的宏系统。宏是一种强大的元编程工具，它本质上是一个在\u003cstrong\u003e编译期\u003c/strong\u003e（或称为“展开时”）执行的函数。这个特殊的函数，它的输入是代码（以语法对象的形式），输出也是代码。它允许我们对代码进行任意复杂的、图灵完备的变换，从而彻底扩展语言本身的语法。\u003c/p\u003e\n\u003cp\u003e那么，亲手编写一个宏，究竟是怎样的体验呢？\u003c/p\u003e\n\u003ch3 id=\"宏之初体验编写你的第一个宏-when\"\u003e宏之初体验：编写你的第一个宏 \u003ccode\u003ewhen\u003c/code\u003e\u003c/h3\u003e\n\u003cp\u003e让我们从一个简单的需求开始。在编程中，我们经常遇到一个场景：“当某个条件成立时，执行一系列操作”。用 Racket 的 \u003ccode\u003eif\u003c/code\u003e 可以这样写：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-racket\" data-lang=\"racket\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003euser-level\u003c/span\u003e \u003cspan class=\"mi\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ebegin\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003edisplay\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;权限不足！\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elog-warning\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;Attempted access by low-level user.\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"no\"\u003e#f\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e每次都写 \u003ccode\u003e(begin ...)\u003c/code\u003e 有点繁琐（更何况 Racket 强制 if 有两个分支，那个不需要的分支混淆了语义）。如果我们能创造一个新语法 \u003ccode\u003ewhen\u003c/code\u003e，让代码变成下面这样，岂不是更清晰？\u003c/p\u003e","title":"宏，中缀表达式，自定义语法与可编程的编程语言"},{"content":"一个由不可以总司令想到的有趣概率/期望题。\n题面 一套卷子上有 $n$ 道判断题。你不知道它们的答案，但是你知道存在一个常数 $p \\in [0, 1]$，对任意一道题，它的答案是“正确”的概率为 $p$。\n你决定采用一种策略来答题：选择一个常数 $p' \\in [0, 1]$，对于任意一道题，你以 $p'$ 的概率选择“正确”。\n求问：\n若要使得期望做对题数最多，应该选择怎样的 $p'$？期望做对题数是多少？ 若要使得期望全对概率最大，应当选择怎样的 $p'$？期望全对概率是多大？ 解答 这是一个非常棒的问题！它涉及了期望、概率和优化策略，我们来一步步分解它。\n首先，我们来明确一下变量和事件：\n$n$: 题目的总数。 $p$: 任意一道题的真实答案是“正确”的概率。 $1-p$: 任意一道题的真实答案是“错误”的概率。 $p'$: 你回答任意一道题为“正确”的概率。 $1-p'$: 你回答任意一道题为“错误”的概率。 你的回答策略和你不知道的真实答案是相互独立的。\n1) 使得期望做对题数最多 我们要计算做对题数的期望值，并找到使这个期望值最大的 $p'$。\n计算单题做对的概率\n首先，我们考虑只做对一道题的概率。有两种情况可以做对一道题：\n题目的真实答案是“正确”（概率为 $p$），你也回答“正确”（概率为 $p'$）。这件事情发生的概率是 $p \\cdot p'$。 题目的真实答案是“错误”（概率为 $1-p$），你也回答“错误”（概率为 $1-p'$）。这件事情发生的概率是 $(1-p) \\cdot (1-p')$。 由于这两种情况是互斥的，所以做对任意一道题的概率 $P(\\text{单题正确})$ 是两者之和： $P(\\text{单题正确}) = p p' + (1-p)(1-p')$\n计算期望做对题数\n设 $X$ 为你做对的总题数。$X$ 可以看作是 $n$ 个独立的伯努利试验的和，其中每次试验“成功”（即做对题）的概率为 $P(\\text{单题正确})$。\n根据期望的线性性质，总期望做对题数 $E[X]$ 就是单题做对的期望乘以题目总数 $n$。而单题做对的期望就是单题做对的概率。 $E[X] = n \\cdot P(\\text{单题正确})$ $E[X] = n \\cdot [p p' + (1-p)(1-p')]$\n优化 $p'$\n我们的目标是选择一个 $p' \\in [0, 1]$，使得 $E[X]$ 最大。我们可以把 $E[X]$ 看作是关于 $p'$ 的函数 $f(p')$： $f(p') = n \\cdot [p p' + 1 - p - p' + p p']$ $f(p') = n \\cdot [(2p - 1)p' + (1-p)]$\n这是一个关于 $p'$ 的线性函数，其斜率为 $n(2p-1)$。线性函数在闭区间上的最大值一定在区间的端点处取得。\n当 $2p - 1 \u003e 0$ (即 $p \u003e 1/2$): 斜率为正，函数是增函数。为了使 $f(p')$ 最大，我们应该取 $p'$ 的最大值，即 $p' = 1$。\n直观解释：如果“正确”答案本身出现的概率就大于一半，那么你最稳妥的策略就是全部猜“正确”。\n当 $2p - 1 \u003c 0$ (即 $p \u003c 1/2$): 斜率为负，函数是减函数。为了使 $f(p')$ 最大，我们应该取 $p'$ 的最小值，即 $p' = 0$。\n直观解释：如果“错误”答案本身出现的概率大于一半，那么你就应该全部猜“错误”。\n当 $2p - 1 = 0$ (即 $p = 1/2$): 斜率为零，函数是常数函数。$f(p') = n \\cdot (1 - 1/2) = n/2$。此时任何 $p' \\in [0, 1]$ 的选择都会得到相同的期望值。\n直观解释：如果“正确”和“错误”的概率完全一样，那么你怎么猜，期望值都是对一半。\n结论与期望值\n若 $p \u003e 1/2$，应选择 $p'=1$。最大期望做对题数是 $n \\cdot [p \\cdot 1 + (1-p) \\cdot 0] = np$。 若 $p \u003c 1/2$，应选择 $p'=0$。最大期望做对题数是 $n \\cdot [p \\cdot 0 + (1-p) \\cdot 1] = n(1-p)$。 若 $p = 1/2$，可选择任意 $p' \\in [0, 1]$。最大期望做对题数是 $n/2$。 我们可以把这个结果统一写成：最大期望做对题数是 $n \\cdot \\max(p, 1-p)$。\n2) 使得期望全对概率最大 我们要计算 $n$ 道题全部做对的概率，并找到使这个概率最大的 $p'$。\n计算全对的概率\n由于每道题的作答过程是相互独立的，所以全部答对的概率是单题答对概率的 $n$ 次方。 $P(\\text{全对}) = [P(\\text{单题正确})]^n$ $P(\\text{全对}) = [p p' + (1-p)(1-p')]^n$\n优化 $p'$\n我们的目标是选择一个 $p' \\in [0, 1]$，使得 $P(\\text{全对})$ 最大。 设函数 $g(x) = x^n$。在 $x \\ge 0$ 的区间上，$g(x)$ 是一个单调递增函数。因此，要最大化 $[P(\\text{单题正确})]^n$，我们只需要最大化它的底数 $P(\\text{单题正确})$ 即可。\n这个问题就转化为了最大化 $P(\\text{单题正确}) = p p' + (1-p)(1-p')$。\n这正是我们在第一问中解决的优化问题！因此，最优的 $p'$ 选择和第一问完全一样。\n结论与概率值\n若 $p \u003e 1/2$，应选择 $p'=1$。 若 $p \u003c 1/2$，应选择 $p'=0$。 若 $p = 1/2$，可选择任意 $p' \\in [0, 1]$。 最大全对概率\n我们把最优的 $p'$ 带入，计算单题做对的概率的最大值：\n若 $p \u003e 1/2$，选择 $p'=1$，单题做对概率为 $p \\cdot 1 + (1-p) \\cdot 0 = p$。 若 $p \u003c 1/2$，选择 $p'=0$，单题做对概率为 $p \\cdot 0 + (1-p) \\cdot 1 = 1-p$。 若 $p = 1/2$，单题做对概率为 $1/2 \\cdot p' + 1/2 \\cdot (1-p') = 1/2$。 这可以统一写成 $\\max(p, 1-p)$。\n所以，最大全对概率是 $[\\max(p, 1-p)]^n$。\n总结 目标 最佳策略 $p'$ 最大值 期望做对题数最多 若 $p \u003e 1/2$，选 $p'=1$（全猜“正确”）若 $p \u003c 1/2$，选 $p'=0$（全猜“错误”）若 $p = 1/2$，任选 $p' \\in [0, 1]$ $n \\cdot \\max(p, 1-p)$ 全对概率最大 若 $p \u003e 1/2$，选 $p'=1$（全猜“正确”）若 $p \u003c 1/2$，选 $p'=0$ （全猜“错误”）若 $p = 1/2$，任选 $p' \\in [0, 1]$ $[\\max(p, 1-p)]^n$ 这个结果非常直观：无论你是想最大化期望对题数，还是最大化全对的概率，你的最佳策略都是一样的：找出概率更高的那个选项，然后死磕到底。\n","permalink":"https://litjohn.github.io/posts/answer-the-paper-randomly/","summary":"\u003cp\u003e一个由不可以总司令想到的有趣概率/期望题。\u003c/p\u003e\n\u003ch2 id=\"题面\"\u003e题面\u003c/h2\u003e\n\u003cp\u003e一套卷子上有 $n$ 道判断题。你不知道它们的答案，但是你知道存在一个常数 $p \\in [0, 1]$，对任意一道题，它的答案是“正确”的概率为 $p$。\u003c/p\u003e\n\u003cp\u003e你决定采用一种策略来答题：选择一个常数 $p' \\in [0, 1]$，对于任意一道题，你以 $p'$ 的概率选择“正确”。\u003c/p\u003e\n\u003cp\u003e求问：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e若要使得期望做对题数最多，应该选择怎样的 $p'$？期望做对题数是多少？\u003c/li\u003e\n\u003cli\u003e若要使得期望全对概率最大，应当选择怎样的 $p'$？期望全对概率是多大？\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"解答\"\u003e解答\u003c/h2\u003e\n\u003cp\u003e这是一个非常棒的问题！它涉及了期望、概率和优化策略，我们来一步步分解它。\u003c/p\u003e\n\u003cp\u003e首先，我们来明确一下变量和事件：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e$n$: 题目的总数。\u003c/li\u003e\n\u003cli\u003e$p$: 任意一道题的真实答案是“正确”的概率。\u003c/li\u003e\n\u003cli\u003e$1-p$: 任意一道题的真实答案是“错误”的概率。\u003c/li\u003e\n\u003cli\u003e$p'$: 你回答任意一道题为“正确”的概率。\u003c/li\u003e\n\u003cli\u003e$1-p'$: 你回答任意一道题为“错误”的概率。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e你的回答策略和你不知道的真实答案是相互独立的。\u003c/p\u003e\n\u003chr\u003e\n\u003ch3 id=\"1-使得期望做对题数最多\"\u003e1) 使得期望做对题数最多\u003c/h3\u003e\n\u003cp\u003e我们要计算做对题数的期望值，并找到使这个期望值最大的 $p'$。\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e计算单题做对的概率\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e首先，我们考虑只做对一道题的概率。有两种情况可以做对一道题：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e题目的真实答案是“正确”（概率为 $p$），你也回答“正确”（概率为 $p'$）。这件事情发生的概率是 $p \\cdot p'$。\u003c/li\u003e\n\u003cli\u003e题目的真实答案是“错误”（概率为 $1-p$），你也回答“错误”（概率为 $1-p'$）。这件事情发生的概率是 $(1-p) \\cdot (1-p')$。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e由于这两种情况是互斥的，所以做对任意一道题的概率 $P(\\text{单题正确})$ 是两者之和：\n$P(\\text{单题正确}) = p p' + (1-p)(1-p')$\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e计算期望做对题数\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e设 $X$ 为你做对的总题数。$X$ 可以看作是 $n$ 个独立的伯努利试验的和，其中每次试验“成功”（即做对题）的概率为 $P(\\text{单题正确})$。\u003c/p\u003e","title":"可以吗，总司令？"},{"content":"从上一篇文章 https://www.luogu.com.cn/article/a0rd1bxx 的线性代数大学习中，我们知道旋转可以视为乘以一个矩阵。\n那么，记 $R_\\theta$ 是旋转 $\\theta$ 对应的矩阵。\n设旋转 $\\alpha$ 的变换 $f_\\alpha (P) = R_\\alpha P$，以及相应的旋转 $\\beta$ 角的变换 $f_\\beta (P) = R_\\beta P$。\n显然有旋转 $\\alpha + \\beta$ 角等于先转 $\\alpha$ 再转 $\\beta$，也就是说 $f_{\\alpha+\\beta}(P) = f_\\alpha(f_\\beta(P))$ 恒成立。那么，代入函数的定义：\n$R_{\\alpha+\\beta}P = R_\\alpha (R_\\beta P)$\n用结合律，就有\n$R_{\\alpha+\\beta}P = (R_\\alpha R_\\beta) P$\n既然对任意向量两个矩阵的变换结果相同，那么它们肯定是相同的。有\n$R_{\\alpha+\\beta} = R_\\alpha R_\\beta$\n这样，由于我们知道 $R_{\\alpha+\\beta}$ 中包含 $\\sin (\\alpha+\\beta)$ 和 $\\cos (\\alpha+\\beta)$ 项，我们就可以用矩阵乘法算出来 $R_{\\alpha+\\beta}$，然后从中取出相应的项。\n计算过程如下：\n$R_{\\alpha+\\beta} = R_\\alpha R_\\beta = \\begin{pmatrix} \\cos\\alpha \u0026 -\\sin\\alpha \\\\\\\\ \\sin\\alpha \u0026 \\cos\\alpha \\end{pmatrix} \\begin{pmatrix} \\cos\\beta \u0026 -\\sin\\beta \\\\\\\\ \\sin\\beta \u0026 \\cos\\beta \\end{pmatrix}$\n根据矩阵乘法法则（第一行乘以第一列，第一行乘以第二列……）： $R_\\alpha R_\\beta = \\begin{pmatrix} \\cos\\alpha\\cos\\beta - \\sin\\alpha\\sin\\beta \u0026 -\\cos\\alpha\\sin\\beta - \\sin\\alpha\\cos\\beta \\\\\\\\ \\sin\\alpha\\cos\\beta + \\cos\\alpha\\sin\\beta \u0026 -\\sin\\alpha\\sin\\beta + \\cos\\alpha\\cos\\beta \\end{pmatrix}$\n整理一下： $R_\\alpha R_\\beta = \\begin{pmatrix} \\cos\\alpha\\cos\\beta - \\sin\\alpha\\sin\\beta \u0026 -(\\sin\\alpha\\cos\\beta + \\cos\\alpha\\sin\\beta) \\\\\\\\ \\sin\\alpha\\cos\\beta + \\cos\\alpha\\sin\\beta \u0026 \\cos\\alpha\\cos\\beta - \\sin\\alpha\\sin\\beta \\end{pmatrix}$\n因为 $R_{\\alpha+\\beta} = R_\\alpha R_\\beta$，所以两个矩阵的对应元素必须相等。我们来比较一下左上角和左下角的元素：\n$\\cos(\\alpha+\\beta) = \\cos\\alpha\\cos\\beta - \\sin\\alpha\\sin\\beta$ $\\sin(\\alpha+\\beta) = \\sin\\alpha\\cos\\beta + \\cos\\alpha\\sin\\beta$ 发现了吗？这样得到的结果与和角公式是相同的，于是我们就证明了和角公式。\n笑点解析：本文使用了循环论证的手法。\n当然，本文也可以不仅仅是循环论证。我们考虑用比和角公式更基本的方法找出旋转矩阵，这样我们的证明就是成立的了。\n这是最纯粹的几何方法。我们不预设任何三角函数知识，而是从旋转这个变换本身的性质出发。\n定义旋转：我们定义一个逆时针旋转 $\\theta$ 角的变换 $R_\\theta$ 是一个线性变换，它必须满足以下几个几何性质：\n保长度：旋转一个向量，其长度不变。$||R_\\theta \\mathbf{v}|| = ||\\mathbf{v}||$. 保定向：旋转不会把平面“翻转”过来（比如变成镜像）。在线性代数里，这意味着变换矩阵的行列式为 +1。 变换基向量：我们来看看它如何作用于基向量 $\\mathbf{i} = (1, 0)$ 和 $\\mathbf{j} = (0, 1)$。 将 $\\mathbf{i}=(1,0)$ 旋转 $\\theta$ 角，根据单位圆的定义，得到的新向量就是 $(\\cos\\theta, \\sin\\theta)$。注意：这里的 $\\cos\\theta$ 和 $\\sin\\theta$ 仅仅是单位圆上一个点的坐标的记号，我们暂时不知道它们的任何性质（比如和角公式）。 将 $\\mathbf{j}=(0,1)$ 旋转 $\\theta$ 角，得到的新向量是 $(-\\sin\\theta, \\cos\\theta)$。 构造矩阵：线性变换的矩阵，其第一列就是变换后的 $\\mathbf{i}$，第二列就是变换后的 $\\mathbf{j}$。所以，我们直接得到了旋转矩阵： $R_\\theta = \\begin{pmatrix} \\cos\\theta \u0026 -\\sin\\theta \\\\\\\\ \\sin\\theta \u0026 \\cos\\theta \\end{pmatrix}$\n这个矩阵的推导过程完全没有使用和角公式。它仅仅是基于“旋转”这个变换作用在基向量上的几何结果。\n这说明了，旋转的几何性质和代数性质是相同的。我们可以选择几何方法或者代数方法定义它，然后推导出它的全部性质，不会有什么差别。\n然而，你可以发现，我们的文章仍然存在诸多漏洞。\n我们假设了旋转是一种线性变换。这是一个先验知识，其实问题不大，毕竟我们总是需要一些公理。\n然而，在使用了这个先验知识之后，我们又诉诸了几何直觉：两个基向量旋转的结果，与“单位圆上与原点连线和 x 轴成一定夹角的点的坐标”有关，这本质上已经诉诸了几何直觉，这就要求我们证明几何直觉和“线性变换”之间是自洽的。\n更严重的是，我们假设“旋转 a+b，等价于旋转 a 再旋转 b”，对于一般的线性变换，这是不成立的（“旋转 a+b”对于一般的线性变换根本不知道你在说什么）。而这一条里面很可能已经蕴含了和角公式。\n能不能救呢？可以的。\n疑虑一：几何直觉与“线性变换”公理的自洽性\n线性变换的定义是：$T(a\\mathbf{u} + b\\mathbf{v}) = aT(\\mathbf{u}) + bT(\\mathbf{v})$。 我们可以把它拆成两步来验证我们对“旋转”的几何直觉：\n$T(\\mathbf{u} + \\mathbf{v}) = T(\\mathbf{u}) + T(\\mathbf{v})$（可加性） 几何直觉：向量加法 $\\mathbf{u} + \\mathbf{v}$ 遵循平行四边形法则。$\\mathbf{u}$ 和 $\\mathbf{v}$ 是平行四边形的两条边，$\\mathbf{u} + \\mathbf{v}$ 是对角线。 旋转操作：旋转是一种刚体变换。它会移动和旋转图形，但不会改变图形的形状和大小。 自洽性证明：当我们旋转整个平行四边形时，它仍然是一个平行四边形。原来的边 $\\mathbf{u}$ 和 $\\mathbf{v}$ 变成了旋转后的 $R(\\mathbf{u})$ 和 $R(\\mathbf{v})$。原来的对角线 $\\mathbf{u}+\\mathbf{v}$ 变成了旋转后的 $R(\\mathbf{u}+\\mathbf{v})$。由于旋转后的图形依然是平行四边形，所以它的对角线必然等于两条边的和，即 $R(\\mathbf{u}+\\mathbf{v}) = R(\\mathbf{u}) + R(\\mathbf{v})$。 结论：可加性成立。 这本质上是三角形全等。\n$T(c\\mathbf{u}) = cT(\\mathbf{u})$（齐次性） 几何直觉：向量 $c\\mathbf{u}$ 是将向量 $\\mathbf{u}$ 的长度缩放 $c$ 倍（方向可能相反）。 旋转操作：旋转保持长度不变。 自洽性证明：旋转 $c\\mathbf{u}$ 时，它的方向会改变，但长度仍然是 $\\mathbf{u}$ 的 $c$ 倍。这与先旋转 $\\mathbf{u}$ 得到 $R(\\mathbf{u})$，再将其长度缩放 $c$ 倍得到的结果 $cR(\\mathbf{u})$ 是完全一样的。 结论：齐次性成立。 这和相似则是类似的。\n通过这个论证，我们证明了我们脑海中那个直观的、刚性的“旋转”概念，内生地满足线性变换的代数定义。所以，将“旋转是线性变换”作为起点是合理且自洽的。\n疑虑二：“旋转 $\\alpha+\\beta$ = 先转 $\\alpha$ 再转 $\\beta$” 这一条里面很可能已经蕴含了和角公式\n这是更致命、也更深刻的一个问题。\n这个性质 $R_{\\alpha+\\beta} = R_\\alpha R_\\beta$ 实际上是在描述旋转变换构成了一个阿贝尔群（交换群），并且这个群的结构与实数的加法群是同构的。这确实是一个非常强的性质。\n那么，这个性质本身是否依赖于和角公式呢？\n答案是：不依赖，如果我们小心地定义我们的术语。\n这里的关键在于我们如何定义“角度”和“角度的加法”。\n操作主义定义：让我们把旋转操作本身视为最基本的东西。 有一个操作叫“旋转”，它由一个参数（我们称之为“角度”）来标识，记作 $R_\\theta$。 我们观察到，连续进行两次旋转操作 $R_\\beta$ 和 $R_\\alpha$（即复合函数 $R_\\alpha \\circ R_\\beta$），其结果也是一个旋转操作。 我们定义“角度的加法”为：如果 $R_\\alpha \\circ R_\\beta$ 的结果是 $R_\\gamma$，那么我们就定义 $\\gamma = \\alpha + \\beta$。 看到这里的精妙之处了吗？我们不是先有了角度的加法，然后去证明旋转复合满足这个关系。我们是反过来，用旋转的复合操作来定义角度应该如何相加。\n在这种视角下，等式 $R_{\\alpha+\\beta} = R_\\alpha R_\\beta$（这里矩阵乘法代表函数复合）就不是一个需要证明的定理，而是一个定义式，它定义了下标“+”的含义。\n所以，我们的证明可以被拯救，并变得更加严谨：\n严谨化后的证明逻辑链 公理1（几何）：我们接受一个几何实体叫“旋转”，它是一种刚体运动，保持原点不动。 定理1（线性）：从公理1，我们证明了旋转是一种线性变换（如上文所述）。 推论1（矩阵）：因为旋转是线性变换，所以它可以表示为一个矩阵。通过考察基向量的变换，我们得到 $R_\\theta = \\begin{pmatrix} \\cos\\theta \u0026 -\\sin\\theta \\\\\\\\ \\sin\\theta \u0026 \\cos\\theta \\end{pmatrix}$。在这里，$\\cos\\theta$ 和 $\\sin\\theta$ 仅仅是单位圆上点的坐标的记号，我们对它们的函数性质一无所知。 公理2（群结构）：旋转的集合在函数复合下构成一个群。任意两个旋转的复合仍然是一个旋转。 定义1（角度加法）：我们定义角度的加法 $\\alpha+\\beta$ 是这样一个角度 $\\gamma$，它使得 $R_\\gamma = R_\\alpha \\circ R_\\beta$。因此，关系式 $R_{\\alpha+\\beta} = R_\\alpha R_\\beta$ 成为我们体系内的真理（根据定义）。 最终推导：现在，我们将来自推论1的矩阵形式代入到来自定义1的关系式中： $\\begin{pmatrix} \\cos(\\alpha+\\beta) \u0026 \\dots \\\\\\\\ \\sin(\\alpha+\\beta) \u0026 \\dots \\end{pmatrix} = \\begin{pmatrix} \\cos\\alpha \u0026 \\dots \\\\\\\\ \\sin\\alpha \u0026 \\dots \\end{pmatrix} \\begin{pmatrix} \\cos\\beta \u0026 \\dots \\\\\\\\ \\sin\\beta \u0026 \\dots \\end{pmatrix}$ 结论：通过计算右侧的矩阵乘积，我们就发现了 $\\cos(\\alpha+\\beta)$ 和 $\\sin(\\alpha+\\beta)$ 必须满足的代数恒等式。这些恒等式就是我们所说的“和角公式”。 致谢 \u0026amp;\u0026amp; 声明：感谢 Gemini 对本文做出的贡献。Gemini 提供了避免循环论证的思路。\n","permalink":"https://litjohn.github.io/posts/proof-of-the-sum-and-difference-formula/","summary":"\u003cp\u003e从上一篇文章 \u003ca href=\"https://www.luogu.com.cn/article/a0rd1bxx\"\u003ehttps://www.luogu.com.cn/article/a0rd1bxx\u003c/a\u003e 的线性代数大学习中，我们知道旋转可以视为乘以一个矩阵。\u003c/p\u003e\n\u003cp\u003e那么，记 $R_\\theta$ 是旋转 $\\theta$ 对应的矩阵。\u003c/p\u003e\n\u003cp\u003e设旋转 $\\alpha$ 的变换 $f_\\alpha (P) = R_\\alpha P$，以及相应的旋转 $\\beta$ 角的变换 $f_\\beta (P) = R_\\beta P$。\u003c/p\u003e\n\u003cp\u003e显然有旋转 $\\alpha + \\beta$ 角等于先转 $\\alpha$ 再转 $\\beta$，也就是说 $f_{\\alpha+\\beta}(P) = f_\\alpha(f_\\beta(P))$ 恒成立。那么，代入函数的定义：\u003c/p\u003e\n\u003cp\u003e$R_{\\alpha+\\beta}P = R_\\alpha (R_\\beta P)$\u003c/p\u003e\n\u003cp\u003e用结合律，就有\u003c/p\u003e\n\u003cp\u003e$R_{\\alpha+\\beta}P = (R_\\alpha R_\\beta) P$\u003c/p\u003e\n\u003cp\u003e既然对任意向量两个矩阵的变换结果相同，那么它们肯定是相同的。有\u003c/p\u003e\n\u003cp\u003e$R_{\\alpha+\\beta} = R_\\alpha R_\\beta$\u003c/p\u003e\n\u003cp\u003e这样，由于我们知道 $R_{\\alpha+\\beta}$ 中包含 $\\sin (\\alpha+\\beta)$ 和 $\\cos (\\alpha+\\beta)$ 项，我们就可以用矩阵乘法算出来 $R_{\\alpha+\\beta}$，然后从中取出相应的项。\u003c/p\u003e\n\u003cp\u003e计算过程如下：\u003c/p\u003e\n\u003cp\u003e$R_{\\alpha+\\beta} = R_\\alpha R_\\beta = \\begin{pmatrix} \\cos\\alpha \u0026 -\\sin\\alpha \\\\\\\\ \\sin\\alpha \u0026 \\cos\\alpha \\end{pmatrix} \\begin{pmatrix} \\cos\\beta \u0026 -\\sin\\beta \\\\\\\\ \\sin\\beta \u0026 \\cos\\beta \\end{pmatrix}$\u003c/p\u003e","title":"和角公式证明"},{"content":"瓜豆原理 一个图形经过任意旋转、缩放、平移、对称之后，与原图形保持相似，且相似比等于缩放比。\n非常强大而泛用的定理。可以用来解决一整类初中的几何题。\n这篇文章的目的是证明它，从地基开始重构这整套工具箱。所以默认读者已经会了这些东西，主要进行推式子。\n定义 1：线性变换与仿射变换 线性变换 我们常常听说，“某某变换（比如缩放，旋转）是线性变换”。那么什么是“线性变换”？\n我们称一个对 $n$ 维点的变换是线性变换，当且仅当存在一组 $\\R^n \\to \\R$ 的线性变换 $\\{g_i\\}(1\\le i \\le n)$ 使得：\n$$f((x_1, x_2, \\cdots x_n)) = (g_1((x_1, x_2, \\cdots x_n)), g_2((x_1, x_2, \\cdots x_n)), \\cdots g_n((x_1, x_2, \\cdots x_n)))$$这里的“$\\R^n\\to \\R$ 的线性变换”指满足以下两条性质的变换：\n可加性。对于变换 $f$，当且仅当 $\\forall x\\in \\R^n, y\\in \\R^n\\; f(x + y) = f(x)+f(y)$ 时它满足这条性质。 齐性。对于变换 $f$，当且仅当 $\\forall x\\in \\R^n, c\\in \\R\\; f(cx) = cf(x)$ 时它满足这条性质。 容易发现，这样的变换一定是形如 $f((x_1, \\cdots x_n)) = \\sum_{i = 1}^n a_ix_i$ 的变换，其中 $a_i$ 是常数。\n仿射变换 很简单。一个变换 $f(x)$ 是仿射变换当且仅当它可以写成 $g(x)+c$ 的形式，其中 $g(x)$ 是一个线性变换，而 $c$ 是常数。\n证明 1：旋转是线性变换 考虑点 $P(x, y)$，将它旋转 $\\theta$ 这个角。\n自然的方法是使用极坐标。我们设 $P = (r, \\phi)$，其中 $r = \\sqrt{x^2+y^2}$，$\\phi$ 是 $P$ 到原点连线与 $x$ 轴的夹角。\n进而有 $x = r\\cos \\phi, y = r\\sin \\phi$。\n旋转 $\\theta$ 之后，$P' = (r, \\phi + \\theta)$，可以算出 $x'=r\\cos(\\phi+\\theta), y'=r\\sin(\\phi+\\theta)$。\n用和角公式拆开：\n$$x'=r(\\cos \\phi\\cos \\theta-\\sin\\phi\\sin\\theta),\\\\\\\\ y'=r(\\sin \\phi\\cos \\theta+\\sin \\theta\\cos \\phi)$$拆开括号。\n$$x'=r\\cos \\phi\\cos \\theta-r\\sin\\phi\\sin\\theta,\\\\\\\\ y'=r\\sin \\phi\\cos \\theta+r\\sin \\theta\\cos \\phi$$代回 $x = r\\cos \\phi, y = r\\sin \\phi$。\n$$x'=x\\cos \\theta-y\\sin\\theta,\\\\\\\\ y'=y\\cos \\theta+x\\sin \\theta$$于是不难发现旋转是线性变换。设 $a = \\cos \\theta, b = \\sin \\theta$（此时由于旋转角是常数，它们都是常数），只需选取 $\\{g_i\\}=\\{(x, y) \\to ax-by,(x, y)\\to bx+ay\\}$ 即可。\n你甚至可以写成矩阵的形式： $$ f\\left(\\begin{pmatrix} x \\\\\\\\ y \\end{pmatrix}\\right) = \\begin{pmatrix} a \u0026 -b \\\\\\\\ b \u0026 a \\end{pmatrix} \\begin{pmatrix} x \\\\\\\\ y \\end{pmatrix} $$定义 2：缩放 点（或向量）$\\bold{v}$ 的缩放是 $s\\bold{v}$，其中 $s$ 是一个常数。如果点的缩放不关于原点，平移坐标系使得缩放中心为原点即可。\n注意我们这里的缩放特指均匀缩放。\n显然，缩放是一个线性变换。\n证明 2：对一条直线上的每个点进行仿射变换，得到的新图形依然是直线 设一条直线 $l: Ax+By+C=0$。对于它上面的任一点 $(x_1, y_1)$，我们进行仿射变换，得到点 $(k_1x_1+k_2y_1+c_1, k_3x_1+k_4y_1+c_2) = (a, b)$。\n我们需要证明的是，存在一组常数 $A',B',C'$，使得对于任意这样产生的 $(a, b)$，都有 $A'a+B'b+C'=0$。\n这显然是存在的。我们首先考虑一次项的系数 $A', B'$，考虑调整它们使得 $x_1,y_1$ 的系数分别是 $A$ 和 $B$ 的倍数，这样，我们就可以利用 $Ax+By+C=0$ 的性质确保整个式子的值是常数。并且溢出的常数项可以被 $C'$ 吸收掉。\n这是可以做到的，具体而言考虑方程组： $$ \\begin{cases} A'k_1+B'k_3=nA\\\\\\\\ A'k_2+B'k_4=nB \\end{cases} $$ （其中 $n$ 是任意非零常数）\n这样就能使得 $x_1,y_1$ 的系数分别是 $A$ 和 $B$ 的倍数。并且两个未知数，两个方程，刚好有解（除非仿射变换本身是奇异的，行列式的值 $k_1k_4-k_2k_3$ 等于 0）。常数项可以用 $C'$ 全部吸收。\n于是证毕，直线经过仿射变换之后依然是直线。\n这样，我们就证明了瓜豆原理的一种基础情形：被变换的对象是直线。\n证明 3：对一个图形进行旋转，对称或平移，新图形与原图形全等 证明框架 设 $T$ 是一个变换（平移、旋转或反射）。\n取任意两个点 $P_1 = (x_1, y_1)$ 和 $P_2 = (x_2, y_2)$。\n它们之间的向量是 $\\vec{v} = P_2 - P_1 = (x_2-x_1, y_2-y_1)$。\n它们之间的距离的平方是 $d^2 = |\\vec{v}|^2 = (x_2-x_1)^2 + (y_2-y_1)^2$。\n经过变换后，得到新点 $P'_1 = T(P_1)$ 和 $P'_2 = T(P_2)$。\n它们之间的新向量是 $\\vec{v}' = P'_2 - P'_1$。\n新距离的平方是 $(d')^2 = |\\vec{v}'|^2$。\n我们要证明的就是，对于平移、旋转和反射，始终有 $(d')^2 = d^2$。\n1. 平移（Translation） 设平移向量为 $\\vec{b} = (c, d)$。\n$T(P) = P + \\vec{b}$。\n$P'_1 = P_1 + \\vec{b} = (x_1+c, y_1+d)$\n$P'_2 = P_2 + \\vec{b} = (x_2+c, y_2+d)$\n计算新向量 $\\vec{v}'$：\n$\\vec{v}' = P'_2 - P'_1 = ((x_2+c)-(x_1+c), (y_2+d)-(y_1+d))$\n$\\vec{v}' = (x_2-x_1, y_2-y_1) = \\vec{v}$\n结论： 平移变换不改变点对之间的向量。\n所以，距离显然不变：$|\\vec{v}'|^2 = |\\vec{v}|^2$。\n因为向量本身都没变，夹角自然也不可能变。\n平移保持全等，证毕。\n2. 旋转（Rotation） 设绕原点逆时针旋转 $\\theta$ 角。 $T(P) = R_\\theta P$，其中 $R_\\theta = \\begin{pmatrix} \\cos\\theta \u0026 -\\sin\\theta \\\\\\\\ \\sin\\theta \u0026 \\cos\\theta \\end{pmatrix}$。\n对于线性变换，有一个极好的性质：$T(P_2 - P_1) = T(P_2) - T(P_1)$。\n所以，$\\vec{v}' = P'_2 - P'_1 = R_{\\theta} P_2 - R_{\\theta} P_1 = R_{\\theta}(P_2-P_1) = R_{\\theta} \\vec{v}$。\n这意味着，原图中的任意向量 $\\vec{v}$，在旋转后变成了 $R_\\theta \\vec{v}$。\n现在我们来证明距离不变。设 $\\vec{v}=(x, y)$。\n$R_\\theta \\vec{v} = (x\\cos\\theta - y\\sin\\theta, x\\sin\\theta + y\\cos\\theta)$\n$|\\vec{v}'|^2 = |R_\\theta \\vec{v}|^2 = (x\\cos\\theta - y\\sin\\theta)^2 + (x\\sin\\theta + y\\cos\\theta)^2$\n展开它：\n$= (x^2\\cos^2\\theta - 2xy\\cos\\theta\\sin\\theta + y^2\\sin^2\\theta) + (x^2\\sin^2\\theta + 2xy\\sin\\theta\\cos\\theta + y^2\\cos^2\\theta)$\n合并同类项：\n$= x^2(\\cos^2\\theta+\\sin^2\\theta) + y^2(\\sin^2\\theta+\\cos^2\\theta)$\n$= x^2(1) + y^2(1) = x^2+y^2 = |\\vec{v}|^2$\n结论： 旋转变换保持距离不变（保距性）。\n接下来证明保角性。\n设有两个向量 $\\vec{u}$ 和 $\\vec{v}$。它们夹角的余弦值由点积公式给出：$\\cos\\alpha = \\frac{\\vec{u} \\cdot \\vec{v}}{|\\vec{u}||\\vec{v}|}$。\n变换后的向量是 $\\vec{u}'=R_\\theta\\vec{u}$ 和 $\\vec{v}'=R_\\theta\\vec{v}$。\n我们已经证明了 $|\\vec{u}'|=|\\vec{u}|$ 和 $|\\vec{v}'|=|\\vec{v}|$。\n所以，要证明夹角不变，我们只需要证明点积不变，即 $\\vec{u}' \\cdot \\vec{v}' = \\vec{u} \\cdot \\vec{v}$。\n设 $\\vec{u}=(u_x, u_y)$, $\\vec{v}=(v_x, v_y)$。\n$\\vec{u}' = (u_x c - u_y s, u_x s + u_y c)$\n$\\vec{v}' = (v_x c - v_y s, v_x s + v_y c)$\n(其中 $c=\\cos\\theta, s=\\sin\\theta$)\n$\\vec{u}' \\cdot \\vec{v}' = (u_x c - u_y s)(v_x c - v_y s) + (u_x s + u_y c)(v_x s + v_y c)$\n$= (u_x v_x c^2 - u_x v_y cs - u_y v_x cs + u_y v_y s^2) + (u_x v_x s^2 + u_x v_y sc + u_y v_x sc + u_y v_y c^2)$\n中间的四项 $cs$ 项两两抵消！\n$= u_x v_x (c^2+s^2) + u_y v_y (s^2+c^2)$\n$= u_x v_x + u_y v_y = \\vec{u} \\cdot \\vec{v}$\n点积确实不变！所以角度也不变。\n旋转保持全等，证毕。\n3. 对称/反射（Reflection） 以关于 x 轴的反射为例。变换矩阵是 $F = \\begin{pmatrix} 1 \u0026 0 \\\\\\\\ 0 \u0026 -1 \\end{pmatrix}$。\n这也是一个线性变换，所以 $\\vec{v}' = F\\vec{v}$。\n设 $\\vec{v}=(x, y)$，则 $\\vec{v}'=(x, -y)$。\n保距性： $|\\vec{v}'|^2 = x^2 + (-y)^2 = x^2+y^2 = |\\vec{v}|^2$。距离不变。\n保角性（点积不变性）： 设 $\\vec{u}=(u_x, u_y), \\vec{v}=(v_x, v_y)$。\n$\\vec{u}'=(u_x, -u_y), \\vec{v}'=(v_x, -v_y)$。\n$\\vec{u}' \\cdot \\vec{v}' = (u_x)(v_x) + (-u_y)(-v_y) = u_x v_x + u_y v_y = \\vec{u} \\cdot \\vec{v}$。\n点积依然不变！所以角度大小也不变。\n对称保持全等，证毕。\n这样我们就证明了瓜豆原理的大部分。剩下的是证明缩放保持相似，且相似比等于缩放比。这几乎是相似的定义（缩放，大小不同形状相同），所以不加证明。读者也可将其作为习题。\n应用与工具 瓜豆原理常用于求一个点的轨迹。在一些最值问题中很常用。尤其是与点到直线距离公式搭配：\n点到直线距离公式：\n$P(x_0,y_0)$ 到 $l:Ax+By+C$ 的距离等于：\n$$\\frac{|Ax_0+By_0+C|}{\\sqrt{A^2+B^2}}$$。\n证明思路非常简单：我们首先考虑 $A$ 和 $B$ 均不为零的直线，再考虑对于特例验证其正确性。\n对于一般情况，我们使用面积法。在 $l$ 上取两点 $M, N$，求出三角形 $PMN$ 的面积和 $MN$ 的长度，然后就可以求出 $P$ 到 $l$ 的高也即距离。\n为了简化计算，我们选取 $M$ 的纵坐标与 $P$ 相同，$N$ 的横坐标与 $P$ 相同。\n那么有 $M = (-\\frac{By_0+C}{A}, y_0), N = (x_0, -\\frac{Ax_0+C}{B})$。\n设 $V_p = Ax_0+By_0+C$。\n我们有 $MN$ 等于 $$ \\sqrt{(\\frac{V_p}{A})^2+(\\frac{V_p}{B})^2} $$而三角形 $PMN$ 的面积则等于： $$ |\\frac{V_p^2}{2AB}| $$$P$ 到 $l$ 的距离则是： $$ \\frac{|\\frac{V_p^2}{AB}|}{\\sqrt{(\\frac{V_p}{A})^2+(\\frac{V_p}{B})^2}} $$ （注意分子是面积的二倍，也就是两直角边的乘积）\n把分子上的 $AB$ 乘下去，并且上下同时约去一个 $|V_p|$，就得到 $$ \\frac{|V_p|}{\\sqrt{A^2+B^2}} $$ 也就是我们一开始的公式。\n","permalink":"https://litjohn.github.io/posts/studying-linear-algebra/","summary":"\u003ch2 id=\"瓜豆原理\"\u003e瓜豆原理\u003c/h2\u003e\n\u003cp\u003e一个图形经过任意旋转、缩放、平移、对称之后，与原图形保持相似，且相似比等于缩放比。\u003c/p\u003e\n\u003cp\u003e非常强大而泛用的定理。可以用来解决一整类初中的几何题。\u003c/p\u003e\n\u003cp\u003e这篇文章的目的是证明它，从地基开始重构这整套工具箱。所以默认读者已经会了这些东西，主要进行推式子。\u003c/p\u003e\n\u003ch2 id=\"定义-1线性变换与仿射变换\"\u003e定义 1：线性变换与仿射变换\u003c/h2\u003e\n\u003ch3 id=\"线性变换\"\u003e线性变换\u003c/h3\u003e\n\u003cp\u003e我们常常听说，“某某变换（比如缩放，旋转）是线性变换”。那么什么是“线性变换”？\u003c/p\u003e\n\u003cp\u003e我们称一个对 $n$ 维点的变换是线性变换，当且仅当存在一组 $\\R^n \\to \\R$ 的线性变换 $\\{g_i\\}(1\\le i \\le n)$ 使得：\u003c/p\u003e\n$$f((x_1, x_2, \\cdots x_n)) = (g_1((x_1, x_2, \\cdots x_n)), g_2((x_1, x_2, \\cdots x_n)), \\cdots g_n((x_1, x_2, \\cdots x_n)))$$\u003cp\u003e这里的“$\\R^n\\to \\R$ 的线性变换”指满足以下两条性质的变换：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e可加性。对于变换 $f$，当且仅当 $\\forall x\\in \\R^n, y\\in \\R^n\\; f(x + y) = f(x)+f(y)$ 时它满足这条性质。\u003c/li\u003e\n\u003cli\u003e齐性。对于变换 $f$，当且仅当 $\\forall x\\in \\R^n, c\\in \\R\\; f(cx) = cf(x)$ 时它满足这条性质。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e容易发现，这样的变换一定是形如 $f((x_1, \\cdots x_n)) = \\sum_{i = 1}^n a_ix_i$ 的变换，其中 $a_i$ 是常数。\u003c/p\u003e","title":"瓜豆原理学习笔记/线性代数大学习"},{"content":"一个自动的 24 点求解器。输入四个数字就会自动输出所有解。\n目前还有一点局限性：它会输出许多本质相同的解，比如 a 和 -(-a)。所以下一步可以实现表达式正则化和去重。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 #lang racket (define a (make-vector 4)) (let read-a ([i 0]) (when (\u0026lt; i 4) (vector-set! a i (read)) (when (not (number? (vector-ref a i))) (error \u0026#34;Invalid input!\u0026#34;)) (read-a (+ i 1))) (vector-sort! a \u0026lt;)) (struct node (val op1 op2 e1 e2) #:transparent #:mutable) (define (print-ans p) (if (eq? (node-e1 p) (void)) (display (node-val p)) (begin (display #\\() ; (display #\\() (when (eq? (node-op1 p) \u0026#39;-) (display (node-op1 p))) (print-ans (node-e1 p)) (display (node-op2 p)) ; (display #\\() (print-ans (node-e2 p)) ; (display #\\)) (display #\\))))) (define operators (list (cons \u0026#39;+ +) (cons \u0026#39;- -) (cons \u0026#39;* *) (cons \u0026#39;/ /))) (define (solve l r) (if (= l r) (list (node (vector-ref a l) (void) (void) (void) (void))) (let ([res \u0026#39;()]) (let loop ([i l]) (when (\u0026lt; i r) (let ([p1 (solve l i)] [p2 (solve (+ i 1) r)]) (for* ([op1 operators] [op2 operators] [e1 p1] [e2 p2]) (unless (or (and (= (node-val e2) 0) (eq? (car op2) \u0026#39;/)) (eq? (car op1) \u0026#39;*) (eq? (car op1) \u0026#39;/)) (let ([val ((cdr op2) ((cdr op1) (node-val e1)) (node-val e2))]) (set! res (cons (node val (car op1) (car op2) e1 e2) res)))))) (loop (+ i 1)))) res))) (define ans (void)) ; Helper function to reverse a subarray of vector `v` from `start` to `end` inclusive. (define (reverse-subarray v start end) (let loop ([i start] [j end]) (when (\u0026lt; i j) ; Swap elements at index i and j (let ([temp (vector-ref v i)]) (vector-set! v i (vector-ref v j)) (vector-set! v j temp)) (loop (+ i 1) (- j 1))))) ; Implements the C++ std::next_permutation algorithm. ; Mutates global vector \u0026#39;a\u0026#39; in place to the next lexicographical permutation. ; Returns #t if a next permutation was found, #f if it wrapped around to the first permutation. (define (next-permutation a) (let ([n (vector-length a)]) ; Step 1: Find pivot point \u0026#39;i\u0026#39; (find first element a[i] \u0026lt; a[i+1] from right) (let loop-find-pivot ([i (- n 2)]) (cond ; Case 1: No pivot found (vector is in reverse order) [(\u0026lt; i 0) ; Reverse the whole vector to get the first permutation. (reverse-subarray a 0 (- n 1)) ; (displayln \u0026#34;!!!!!!!\\n\u0026#34;) #f] ; Return #f to indicate we wrapped around. ; Case 2: Found pivot point \u0026#39;i\u0026#39; [(\u0026lt; (vector-ref a i) (vector-ref a (+ i 1))) ; (displayln i) ; Step 2: Find swap element \u0026#39;j\u0026#39; (find first element a[j] \u0026gt; a[i] from right) (let loop-find-swap ([j (- n 1)]) (if (\u0026gt; (vector-ref a j) (vector-ref a i)) ; Step 3: Swap elements at i and j (let ([temp (vector-ref a i)]) (vector-set! a i (vector-ref a j)) (vector-set! a j temp)) (loop-find-swap (- j 1)))) ; Step 4: Reverse suffix starting from i + 1 (reverse-subarray a (+ i 1) (- n 1)) #t] ; Return #t to indicate a next permutation was found. ; Case 3: Continue searching for pivot point \u0026#39;i\u0026#39; to the left [else (loop-find-pivot (- i 1))])))) (define (print-a) (let loop ([i 0]) (when (\u0026lt; i 4) (display (vector-ref a i)) (display #\\space) (loop (+ i 1)))) (newline)) (let loop ([i 0]) (when (\u0026lt; i 24) ; (print-a) (set! ans (solve 0 3)) (for ([p ans]) (when (= (node-val p) 24) (print-ans p) (newline) #; (exit))) (when (next-permutation a) (loop (+ i 1))))) ","permalink":"https://litjohn.github.io/posts/24-points/","summary":"\u003cp\u003e一个自动的 24 点求解器。输入四个数字就会自动输出所有解。\u003c/p\u003e\n\u003cp\u003e目前还有一点局限性：它会输出许多本质相同的解，比如 a 和 -(-a)。所以下一步可以实现表达式正则化和去重。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e  1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e  2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e  3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e  4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e  5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e  6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e  7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e  8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e  9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 27\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 28\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 29\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 30\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 31\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 32\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 33\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 34\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 35\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 36\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 37\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 38\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 39\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 40\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 41\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 42\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 43\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 44\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 45\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 46\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 47\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 48\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 49\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 50\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 51\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 52\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 53\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 54\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 55\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 56\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 57\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 58\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 59\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 60\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 61\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 62\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 63\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 64\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 65\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 66\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 67\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 68\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 69\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 70\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 71\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 72\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 73\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 74\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 75\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 76\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 77\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 78\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 79\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 80\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 81\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 82\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 83\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 84\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 85\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 86\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 87\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 88\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 89\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 90\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 91\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 92\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 93\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 94\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 95\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 96\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 97\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 98\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 99\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e100\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e101\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e102\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e103\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e104\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e105\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e106\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e107\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e108\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e109\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e110\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e111\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e112\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e113\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e114\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e115\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e116\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e117\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e118\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e119\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e120\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e121\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e122\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e123\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e124\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e125\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e126\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e127\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e128\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e129\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e130\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e131\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e132\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e133\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-racket\" data-lang=\"racket\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"kn\"\u003e#lang \u003c/span\u003e\u003cspan class=\"nn\"\u003eracket\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003emake-vector\u003c/span\u003e \u003cspan class=\"mi\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"n\"\u003eread-a\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ewhen\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"mi\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evector-set!\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eread\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ewhen\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003enot\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003enumber?\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evector-ref\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eerror\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;Invalid input!\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eread-a\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003evector-sort!\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"nb\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eval\u003c/span\u003e \u003cspan class=\"n\"\u003eop1\u003c/span\u003e \u003cspan class=\"n\"\u003eop2\u003c/span\u003e \u003cspan class=\"n\"\u003ee1\u003c/span\u003e \u003cspan class=\"n\"\u003ee2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kd\"\u003e#:transparent\u003c/span\u003e \u003cspan class=\"kd\"\u003e#:mutable\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eprint-ans\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eeq?\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode-e1\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evoid\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003edisplay\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode-val\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ebegin\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003edisplay\u003c/span\u003e \u003cspan class=\"sc\"\u003e#\\(\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"c1\"\u003e; (display #\\()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ewhen\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eeq?\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode-op1\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"ss\"\u003e-\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003edisplay\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode-op1\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eprint-ans\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode-e1\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003edisplay\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode-op2\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"c1\"\u003e; (display #\\()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eprint-ans\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode-e2\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"c1\"\u003e; (display #\\))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003edisplay\u003c/span\u003e \u003cspan class=\"sc\"\u003e#\\)\u003c/span\u003e\u003cspan class=\"p\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine\u003c/span\u003e \u003cspan class=\"n\"\u003eoperators\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003elist\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003econs\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"ss\"\u003e+\u003c/span\u003e \u003cspan class=\"nb\"\u003e+\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003econs\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"ss\"\u003e-\u003c/span\u003e \u003cspan class=\"nb\"\u003e-\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003econs\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"ss\"\u003e*\u003c/span\u003e \u003cspan class=\"nb\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003econs\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"ss\"\u003e/\u003c/span\u003e \u003cspan class=\"nb\"\u003e/\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esolve\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e \u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e \u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003elist\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evector-ref\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evoid\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evoid\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evoid\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evoid\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e()])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"n\"\u003eloop\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ewhen\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003ep1\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esolve\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                          \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ep2\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esolve\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e)])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                          \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efor*\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003eop1\u003c/span\u003e \u003cspan class=\"n\"\u003eoperators\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                               \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eop2\u003c/span\u003e \u003cspan class=\"n\"\u003eoperators\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                               \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ee1\u003c/span\u003e \u003cspan class=\"n\"\u003ep1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                               \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ee2\u003c/span\u003e \u003cspan class=\"n\"\u003ep2\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                            \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                            \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eunless\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eor\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                                        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eand\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode-val\u003c/span\u003e \u003cspan class=\"n\"\u003ee2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                                             \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eeq?\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecar\u003c/span\u003e \u003cspan class=\"n\"\u003eop2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"ss\"\u003e/\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                                        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eeq?\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecar\u003c/span\u003e \u003cspan class=\"n\"\u003eop1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"ss\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                                        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eeq?\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecar\u003c/span\u003e \u003cspan class=\"n\"\u003eop1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"ss\"\u003e/\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                                \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003eval\u003c/span\u003e \u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"nb\"\u003ecdr\u003c/span\u003e \u003cspan class=\"n\"\u003eop2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"nb\"\u003ecdr\u003c/span\u003e \u003cspan class=\"n\"\u003eop1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode-val\u003c/span\u003e \u003cspan class=\"n\"\u003ee1\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode-val\u003c/span\u003e \u003cspan class=\"n\"\u003ee2\u003c/span\u003e\u003cspan class=\"p\"\u003e))])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                                    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eset!\u003c/span\u003e \u003cspan class=\"n\"\u003eres\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003econs\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode\u003c/span\u003e \u003cspan class=\"n\"\u003eval\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecar\u003c/span\u003e \u003cspan class=\"n\"\u003eop1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecar\u003c/span\u003e \u003cspan class=\"n\"\u003eop2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003ee1\u003c/span\u003e \u003cspan class=\"n\"\u003ee2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e))))))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eloop\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                    \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine\u003c/span\u003e \u003cspan class=\"n\"\u003eans\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evoid\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e; Helper function to reverse a subarray of vector `v` from `start` to `end` inclusive.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereverse-subarray\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e \u003cspan class=\"n\"\u003estart\u003c/span\u003e \u003cspan class=\"n\"\u003eend\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"n\"\u003eloop\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"n\"\u003estart\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ej\u003c/span\u003e \u003cspan class=\"n\"\u003eend\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ewhen\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"c1\"\u003e; Swap elements at index i and j\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003etemp\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evector-ref\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evector-set!\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evector-ref\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evector-set!\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e \u003cspan class=\"n\"\u003etemp\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eloop\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)))))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e; Implements the C++ std::next_permutation algorithm.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e; Mutates global vector \u0026#39;a\u0026#39; in place to the next lexicographical permutation.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e; Returns #t if a next permutation was found, #f if it wrapped around to the first permutation.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enext-permutation\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evector-length\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e)])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"c1\"\u003e; Step 1: Find pivot point \u0026#39;i\u0026#39; (find first element a[i] \u0026lt; a[i+1] from right)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"n\"\u003eloop-find-pivot\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003econd\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e; Case 1: No pivot found (vector is in reverse order)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"nb\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e         \u003cspan class=\"c1\"\u003e; Reverse the whole vector to get the first permutation.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e         \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereverse-subarray\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e         \u003cspan class=\"c1\"\u003e; (displayln \u0026#34;!!!!!!!\\n\u0026#34;)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e         \u003cspan class=\"no\"\u003e#f\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"c1\"\u003e; Return #f to indicate we wrapped around.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e; Case 2: Found pivot point \u0026#39;i\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e[(\u003c/span\u003e\u003cspan class=\"nb\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evector-ref\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evector-ref\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"c1\"\u003e; (displayln i)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e         \u003cspan class=\"c1\"\u003e; Step 2: Find swap element \u0026#39;j\u0026#39; (find first element a[j] \u0026gt; a[i] from right)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e         \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"n\"\u003eloop-find-swap\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003ej\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e           \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evector-ref\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evector-ref\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e             \u003cspan class=\"c1\"\u003e; Step 3: Swap elements at i and j\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e             \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003etemp\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evector-ref\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e               \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evector-set!\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evector-ref\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e               \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evector-set!\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e \u003cspan class=\"n\"\u003etemp\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e               \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eloop-find-swap\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ej\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e         \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e         \u003cspan class=\"c1\"\u003e; Step 4: Reverse suffix starting from i + 1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e         \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereverse-subarray\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e         \u003cspan class=\"no\"\u003e#t\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"c1\"\u003e; Return #t to indicate a next permutation was found.\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e; Case 3: Continue searching for pivot point \u0026#39;i\u0026#39; to the left\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eloop-find-pivot\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e))]))))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eprint-a\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"n\"\u003eloop\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ewhen\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"mi\"\u003e4\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003edisplay\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evector-ref\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003edisplay\u003c/span\u003e \u003cspan class=\"sc\"\u003e#\\space\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eloop\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003enewline\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"n\"\u003eloop\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ewhen\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"mi\"\u003e24\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"c1\"\u003e; (print-a)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eset!\u003c/span\u003e \u003cspan class=\"n\"\u003eans\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esolve\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"n\"\u003ep\u003c/span\u003e \u003cspan class=\"n\"\u003eans\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ewhen\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enode-val\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"mi\"\u003e24\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eprint-ans\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003enewline\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e                \u003cspan class=\"c\"\u003e#;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eexit\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ewhen\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enext-permutation\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eloop\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)))))\u003c/span\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e","title":"24 Points"},{"content":"光剑的后日谈 #1. 在文艺复兴之后，FP 也要大胜利！\n在这篇文章的讨论区中，我进行了引流。为了报答作者，我写了这篇文章。\n上面那篇文章中使用了一种伪代码语法来表示 lambda calculus。不过这种语法并不能直接运行。怎么办呢？让我们来构建一个源到源编译器！\n要写一种语言的编译器，显然我们需要知道它的语法和词法。这是第一步。另外还有语义，但是它是 lambda 的一种表示法，所以语义已经被 lambda 定义了，无需考虑。\n首先是词法。这种语言会出现哪些 tokens？\n分类一下。lambda 的核心是函数抽象和函数应用。函数抽象用到哪些 tokens？\nfunc 关键字。 冒号。 return 关键字。 参数列表和括号。 函数应用？\n括号 另外还有一个扩展语法，绑定创建。\n等号（赋值运算符） 然后我们需要定义它的语法。这篇文章使用的是单参数的原始 lambda，方便了我们的实现。\n1 2 3 4 5 6 identifier ::= symbol abstract-exp ::= func : (identifier) { return val-exp } apply-exp ::= val-exp(val-exp) bind-exp ::= identifier = val-exp val-exp ::= identifier | abstract-exp | apply-exp lc-exp ::= val-exp | bind-exp 看来挺简单的。\n在定义了词法和语法之后，就是解析环节了。我们需要把字符串解析成 token 流，从而需要一个 lexer。\n等于号，冒号和括号是可用的分隔符。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 #lang racket (define (get-a-token str) (define res \u0026#39;()) (let loop ([i 0]) (if (\u0026lt; i (string-length str)) (case (string-ref str i) [(#\\space) (if (null? res) (loop (+ i 1)) (values #f (string-\u0026gt;symbol (list-\u0026gt;string (reverse res))) (substring str (+ i 1) (string-length str))))] [(#\\: #\\( #\\) #\\= #\\{ #\\}) (values (if (null? res) #f (string-\u0026gt;symbol (list-\u0026gt;string (reverse res)))) (string-\u0026gt;symbol (string (string-ref str i))) (substring str (+ i 1) (string-length str)))] [else (set! res (cons (string-ref str i) res)) (loop (+ i 1))]) (values (string-\u0026gt;symbol (list-\u0026gt;string (reverse res))) #f \u0026#34;\u0026#34;)))) (define (lexer str) (if (= (string-length str) 0) \u0026#39;() (let-values ([(s1 s2 rest) (get-a-token str)]) (cond [(and s1 s2) (cons s1 (cons s2 (lexer rest)))] [s1 (list s1)] [s2 (cons s2 (lexer rest))] [else (error \u0026#34;There\u0026#39;s something wrong with lexer!\u0026#34;)])))) 写的非常唐，不过能用就行了。存在一个问题是换行符，但是这里又有 CRLF，CR 和 LF 的问题，就很难处理。索性不处理了，压行算了。\n这里还有另一个更严重的问题：我们调用了很多 substring，这导致复杂度退化成平方了。如何解决呢？\n其实很简单，我们的扫描步骤是顺序访问的，那么使用 racket 的经典数据结构列表就可以了。下面是重写之后的 lexer：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 #lang racket ;;; ====================================================== ;;; 新版 Lexer (基于列表处理的函数式风格) ;;; ====================================================== ;; 辅助函数: 判断一个字符是否为分隔符 (define (delimiter? c) (member c \u0026#39;(#\\: #\\( #\\) #\\= #\\{ #\\}))) ;; 辅助函数: 判断一个字符是否为空白符 (define (whitespace? c) (char-whitespace? c)) ;; 核心辅助函数: 从字符列表开头读取一个完整的单词(标识符或关键字) ;; 返回两个值: 1. 单词转换成的符号 2. 剩余的字符列表 (define (read-word char-list) (let loop ([cs char-list] [acc \u0026#39;()]) (if (or (null? cs) (let ([c (car cs)]) (or (whitespace? c) (delimiter? c)))) ;; 遇到空白或分隔符，或者列表为空，结束读取 (values (string-\u0026gt;symbol (list-\u0026gt;string (reverse acc))) cs) ;; 否则，将当前字符加入累加器，继续处理剩余列表 (loop (cdr cs) (cons (car cs) acc))))) ;; 主词法分析循环 (define (tokenize-loop char-list) (if (null? char-list) \u0026#39;() ; 输入列表为空，返回空列表 (let ([c (car char-list)]) (cond ;; 1. 如果是空白符，则忽略它，直接处理剩余部分 [(whitespace? c) (tokenize-loop (cdr char-list))] ;; 2. 如果是单个字符的分隔符，将其作为 token，然后处理剩余部分 [(delimiter? c) (cons (string-\u0026gt;symbol (string c)) (tokenize-loop (cdr char-list)))] ;; 3. 否则，它是一个单词的开始，调用 read-word 来读取它 [else (let-values ([(word remaining-chars) (read-word char-list)]) (cons word (tokenize-loop remaining-chars)))])))) ;; Lexer 的公共接口 ;; 它将字符串转换为字符列表，然后启动主循环 (define (lexer str) (tokenize-loop (string-\u0026gt;list str))) 下一步是可爱的 parser。把 token 流解析成 AST。这一步用 EOPL 模块的 define-datatype 会很好，但是我不想用。于是使用 racket 自己的 struct 作为 AST 节点。\n另外在这一步我用了一些不是非常 lisp-style 的做法，具体而言把符号列表的 token 流转化为 vector 来操作，用下标区间来标定当前在解析哪部分。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; ;; 1. AST Node Definitions ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; (struct identifier (name) #:transparent) (struct abstract-exp (param body) #:transparent) (struct apply-exp (rator rand) #:transparent) (struct bind-exp (name val) #:transparent) (define (is-keyword? s) (member s \u0026#39;(func : ( ) { } return =))) (define (is-identifier-token? t) (and (symbol? t) (not (is-keyword? t)))) ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; ;; 2. Parser ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; (define (parse tokens) (let-values ([(ast next-i) (parse-lc-exp (list-\u0026gt;vector tokens) 0)]) (if (= next-i (vector-length (list-\u0026gt;vector tokens))) ast (error \u0026#34;Parsing failed: unexpected tokens remain at the end.\u0026#34; (vector-ref (list-\u0026gt;vector tokens) next-i))))) (define (parse-lc-exp tokens i) (let ([tok1 (vector-ref tokens i)]) (if (and (is-identifier-token? tok1) (\u0026lt; (+ i 1) (vector-length tokens)) (eq? (vector-ref tokens (+ i 1)) \u0026#39;=)) (parse-bind-exp tokens i) (parse-val-exp tokens i)))) (define (parse-bind-exp tokens i) (let* ([id-name (vector-ref tokens i)] [val-start-i (+ i 2)]) (let-values ([(val-ast next-i) (parse-val-exp tokens val-start-i)]) (values (bind-exp (identifier id-name) val-ast) next-i)))) ; 使用 |(|, |)|, |{|, |}| 以防止与读取器冲突 (define (parse-abstract-exp tokens i) (let* ([param-name (vector-ref tokens (+ i 3))] [body-start-i (+ i 7)]) (unless (and (eq? (vector-ref tokens i) \u0026#39;func) (eq? (vector-ref tokens (+ i 1)) \u0026#39;:) (eq? (vector-ref tokens (+ i 2)) \u0026#39;|(|) (is-identifier-token? param-name) (eq? (vector-ref tokens (+ i 4)) \u0026#39;|)|) (eq? (vector-ref tokens (+ i 5)) \u0026#39;|{|) (eq? (vector-ref tokens (+ i 6)) \u0026#39;return)) (error \u0026#34;Invalid function definition syntax\u0026#34;)) (let-values ([(body-ast body-end-i) (parse-val-exp tokens body-start-i)]) (unless (and (\u0026lt; body-end-i (vector-length tokens)) (eq? (vector-ref tokens body-end-i) \u0026#39;|}|)) (error \u0026#34;Expected \u0026#39;}\u0026#39; at the end of function body\u0026#34;)) (values (abstract-exp (identifier param-name) body-ast) (+ body-end-i 1))))) (define (parse-val-exp tokens i) (let-values ([(left-ast next-i) (let ([tok (vector-ref tokens i)]) (cond [(eq? tok \u0026#39;func) (parse-abstract-exp tokens i)] [(is-identifier-token? tok) (values (identifier tok) (+ i 1))] [else (error \u0026#34;Invalid value expression: expected identifier or function at index\u0026#34; i)]))]) (let loop ([current-ast left-ast] [current-i next-i]) ; 检查是否是函数应用 (if (and (\u0026lt; current-i (vector-length tokens)) (eq? (vector-ref tokens current-i) \u0026#39;|(|)) ; 是: 解析参数, 构建 apply-exp, 然后继续循环 (let-values ([(arg-ast arg-end-i) (parse-val-exp tokens (+ current-i 1))]) (unless (and (\u0026lt; arg-end-i (vector-length tokens)) (eq? (vector-ref tokens arg-end-i) \u0026#39;|)|)) (error \u0026#34;Expected \u0026#39;)\u0026#39; to close function application\u0026#34;)) (loop (apply-exp current-ast arg-ast) (+ arg-end-i 1))) ; 否: 循环结束, 返回当前积累的 AST 和索引 (values current-ast current-i))))) 看着有点令人头大。其实这是 AIGC 代码，感谢 Gemini 2.5 Pro 给予的帮助。\nparser 写起来确实令人无比头大。各种神秘的位置编码和 hack……我开始怀疑自己为什么不使用（或者不打算使用）match 来进行分发。这段代码让人完全没有调试的想法。\n这些解析大致使用了递归下降法。这是一种非常经典的方法，具体而言，我们一开始以归纳（inductive）的形式定义了语言的语法。然后我们将具体语法转换为抽象语法，为每种语法元素定义一种节点类型，为每种节点类型定义一个过程进行解析，解析的过程就变成了这些函数互相递归的过程。\n也即是一种数据驱动的编程：一个语法元素对应一种 AST 节点和一个 struct 定义，解析它对应一个过程，元素可能的多种情形对应 cond 的不同分支，归纳的定义对应函数间的相互递归。\n要进行更多的了解，推荐阅读《essential of programming languages》（即 EOPL）。\n进行一些测试：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; ;; 3. Testing ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; (define test-str-1 \u0026#34;id = func : (x) { return x }\u0026#34;) (define test-str-2 \u0026#34;apply = func : (f) { return func : (x) { return f(x) } }\u0026#34;) (define test-str-3 \u0026#34;id(y)\u0026#34;) (define test-str-4 \u0026#34;get-y(f)(x)\u0026#34;) (displayln \u0026#34;--- Test 1: Binding ---\u0026#34;) (pretty-print (parse (lexer test-str-1))) (displayln \u0026#34;--- Test 2: Currying ---\u0026#34;) (pretty-print (parse (lexer test-str-2))) (displayln \u0026#34;--- Test 3: Simple Application ---\u0026#34;) (pretty-print (parse (lexer test-str-3))) (displayln \u0026#34;--- Test 4: Chained Application ---\u0026#34;) (pretty-print (parse (lexer test-str-4))) 结果：\n1 2 3 4 5 6 7 8 9 10 11 12 --- Test 1: Binding --- (bind-exp (identifier \u0026#39;id) (abstract-exp (identifier \u0026#39;x) (identifier \u0026#39;x))) --- Test 2: Currying --- (bind-exp (identifier \u0026#39;apply) (abstract-exp (identifier \u0026#39;f) (abstract-exp (identifier \u0026#39;x) (apply-exp (identifier \u0026#39;f) (identifier \u0026#39;x))))) --- Test 3: Simple Application --- (apply-exp (identifier \u0026#39;id) (identifier \u0026#39;y)) --- Test 4: Chained Application --- (apply-exp (apply-exp (identifier \u0026#39;get-y) (identifier \u0026#39;f)) (identifier \u0026#39;x)) 可以看到，parse 的结果是正确的。\n在建出 AST 之后，进行语法转换就非常容易了。因为源语言和目标语言只不过是 lc-exp 的两种不同表示法（具体语法，concrete syntax）。有了抽象语法，转换为不同的具体语法易如反掌。\n吸取了 parser 的惨痛教训，这次我们使用 match 进行操作。\n1 2 3 4 5 6 (define (convert node) (match node [(bind-exp name val) `(define ,(convert name) ,(convert val))] [(apply-exp rator rand) `(,(convert rator) ,(convert rand))] [(abstract-exp arg body) `(lambda (,(convert arg)) ,(convert body))] [(identifier id) id])) 然后一些测试。我们用上次的老例子：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 (define test-str-1 \u0026#34;id = func : (x) { return x }\u0026#34;) (define test-str-2 \u0026#34;apply = func : (f) { return func : (x) { return f(x) } }\u0026#34;) (define test-str-3 \u0026#34;id(y)\u0026#34;) (define test-str-4 \u0026#34;get-y(f)(x)\u0026#34;) (displayln \u0026#34;--- Test 1: Binding ---\u0026#34;) (displayln (convert (parse (lexer test-str-1)))) (displayln \u0026#34;--- Test 2: Currying ---\u0026#34;) (displayln (convert (parse (lexer test-str-2)))) (displayln \u0026#34;--- Test 3: Simple Application ---\u0026#34;) (displayln (convert (parse (lexer test-str-3)))) (displayln \u0026#34;--- Test 4: Chained Application ---\u0026#34;) (displayln (convert (parse (lexer test-str-4)))) 结果：\n1 2 3 4 5 6 7 8 --- Test 1: Binding --- (define id (lambda (x) x)) --- Test 2: Currying --- (define apply (lambda (f) (lambda (x) (f x)))) --- Test 3: Simple Application --- (id y) --- Test 4: Chained Application --- ((get-y f) x) 成功了！\n这样，我们就可以将伪代码直接送进 chez scheme 或者 racket 运行了！\n更重要的是，我们亲手走了一遍扫描（词法分析）、解析（语法分析）和代码生成的编译流程。构建了一个简易的源到源编译器。\n如果想要了解更多，推荐阅读 EOPL（《essential of programming languages》），friedman 教授的著作。其中第一章就是归纳式的语法，全书会带领你实现各种各样语言的解释器以学习种种语言特性。\n最后是完整代码：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 #lang racket ;;; ====================================================== ;;; 新版 Lexer (基于列表处理的函数式风格) ;;; ====================================================== ;; 辅助函数: 判断一个字符是否为分隔符 (define (delimiter? c) (member c \u0026#39;(#\\: #\\( #\\) #\\= #\\{ #\\}))) ;; 辅助函数: 判断一个字符是否为空白符 (define (whitespace? c) (char-whitespace? c)) ;; 核心辅助函数: 从字符列表开头读取一个完整的单词(标识符或关键字) ;; 返回两个值: 1. 单词转换成的符号 2. 剩余的字符列表 (define (read-word char-list) (let loop ([cs char-list] [acc \u0026#39;()]) (if (or (null? cs) (let ([c (car cs)]) (or (whitespace? c) (delimiter? c)))) ;; 遇到空白或分隔符，或者列表为空，结束读取 (values (string-\u0026gt;symbol (list-\u0026gt;string (reverse acc))) cs) ;; 否则，将当前字符加入累加器，继续处理剩余列表 (loop (cdr cs) (cons (car cs) acc))))) ;; 主词法分析循环 (define (tokenize-loop char-list) (if (null? char-list) \u0026#39;() ; 输入列表为空，返回空列表 (let ([c (car char-list)]) (cond ;; 1. 如果是空白符，则忽略它，直接处理剩余部分 [(whitespace? c) (tokenize-loop (cdr char-list))] ;; 2. 如果是单个字符的分隔符，将其作为 token，然后处理剩余部分 [(delimiter? c) (cons (string-\u0026gt;symbol (string c)) (tokenize-loop (cdr char-list)))] ;; 3. 否则，它是一个单词的开始，调用 read-word 来读取它 [else (let-values ([(word remaining-chars) (read-word char-list)]) (cons word (tokenize-loop remaining-chars)))])))) ;; Lexer 的公共接口 ;; 它将字符串转换为字符列表，然后启动主循环 (define (lexer str) (tokenize-loop (string-\u0026gt;list str))) ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; ;; 1. AST Node Definitions (保持不变) ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; (struct identifier (name) #:transparent) (struct abstract-exp (param body) #:transparent) (struct apply-exp (rator rand) #:transparent) (struct bind-exp (name val) #:transparent) (define (is-keyword? s) (member s \u0026#39;(func : ( ) { } return =))) (define (is-identifier-token? t) (and (symbol? t) (not (is-keyword? t)))) ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; ;; 2. Parser (修正版) ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; (define (parse tokens) (let-values ([(ast next-i) (parse-lc-exp (list-\u0026gt;vector tokens) 0)]) (if (= next-i (vector-length (list-\u0026gt;vector tokens))) ast (error \u0026#34;Parsing failed: unexpected tokens remain at the end.\u0026#34; (vector-ref (list-\u0026gt;vector tokens) next-i))))) (define (parse-lc-exp tokens i) (let ([tok1 (vector-ref tokens i)]) (if (and (is-identifier-token? tok1) (\u0026lt; (+ i 1) (vector-length tokens)) (eq? (vector-ref tokens (+ i 1)) \u0026#39;=)) (parse-bind-exp tokens i) (parse-val-exp tokens i)))) (define (parse-bind-exp tokens i) (let* ([id-name (vector-ref tokens i)] [val-start-i (+ i 2)]) (let-values ([(val-ast next-i) (parse-val-exp tokens val-start-i)]) (values (bind-exp (identifier id-name) val-ast) next-i)))) ; 修正: 使用 |(|, |)|, |{|, |}| (define (parse-abstract-exp tokens i) (let* ([param-name (vector-ref tokens (+ i 3))] [body-start-i (+ i 7)]) (unless (and (eq? (vector-ref tokens i) \u0026#39;func) (eq? (vector-ref tokens (+ i 1)) \u0026#39;:) (eq? (vector-ref tokens (+ i 2)) \u0026#39;|(|) (is-identifier-token? param-name) (eq? (vector-ref tokens (+ i 4)) \u0026#39;|)|) (eq? (vector-ref tokens (+ i 5)) \u0026#39;|{|) (eq? (vector-ref tokens (+ i 6)) \u0026#39;return)) (error \u0026#34;Invalid function definition syntax\u0026#34;)) (let-values ([(body-ast body-end-i) (parse-val-exp tokens body-start-i)]) (unless (and (\u0026lt; body-end-i (vector-length tokens)) (eq? (vector-ref tokens body-end-i) \u0026#39;|}|)) (error \u0026#34;Expected \u0026#39;}\u0026#39; at the end of function body\u0026#34;)) (values (abstract-exp (identifier param-name) body-ast) (+ body-end-i 1))))) ; 修正: 修复 loop 的逻辑, 确保有 else 分支, 并使用正确的符号 (define (parse-val-exp tokens i) (let-values ([(left-ast next-i) (let ([tok (vector-ref tokens i)]) (cond [(eq? tok \u0026#39;func) (parse-abstract-exp tokens i)] [(is-identifier-token? tok) (values (identifier tok) (+ i 1))] [else (error \u0026#34;Invalid value expression: expected identifier or function at index\u0026#34; i)]))]) (let loop ([current-ast left-ast] [current-i next-i]) ; 检查是否是函数应用 (if (and (\u0026lt; current-i (vector-length tokens)) (eq? (vector-ref tokens current-i) \u0026#39;|(|)) ; 是: 解析参数, 构建 apply-exp, 然后继续循环 (let-values ([(arg-ast arg-end-i) (parse-val-exp tokens (+ current-i 1))]) (unless (and (\u0026lt; arg-end-i (vector-length tokens)) (eq? (vector-ref tokens arg-end-i) \u0026#39;|)|)) (error \u0026#34;Expected \u0026#39;)\u0026#39; to close function application\u0026#34;)) (loop (apply-exp current-ast arg-ast) (+ arg-end-i 1))) ; 否: 循环结束, 返回当前积累的 AST 和索引 (values current-ast current-i))))) (define (convert node) (match node [(bind-exp name val) `(define ,(convert name) ,(convert val))] [(apply-exp rator rand) `(,(convert rator) ,(convert rand))] [(abstract-exp arg body) `(lambda (,(convert arg)) ,(convert body))] [(identifier id) id])) ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; ;; 3. Testing ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; #| (define test-str-1 \u0026#34;id = func : (x) { return x }\u0026#34;) (define test-str-2 \u0026#34;apply = func : (f) { return func : (x) { return f(x) } }\u0026#34;) (define test-str-3 \u0026#34;id(y)\u0026#34;) (define test-str-4 \u0026#34;get-y(f)(x)\u0026#34;) (displayln \u0026#34;--- Test 1: Binding ---\u0026#34;) (displayln (convert (parse (lexer test-str-1)))) (displayln \u0026#34;--- Test 2: Currying ---\u0026#34;) (displayln (convert (parse (lexer test-str-2)))) (displayln \u0026#34;--- Test 3: Simple Application ---\u0026#34;) (displayln (convert (parse (lexer test-str-3)))) (displayln \u0026#34;--- Test 4: Chained Application ---\u0026#34;) (displayln (convert (parse (lexer test-str-4)))) |# ","permalink":"https://litjohn.github.io/posts/start-to-build-a-compiler/","summary":"\u003cp\u003e光剑的后日谈 #1. 在文艺复兴之后，FP 也要大胜利！\u003c/p\u003e\n\u003cp\u003e在\u003ca href=\"https://www.luogu.com.cn/article/ha4xtgpc\"\u003e这篇文章\u003c/a\u003e的讨论区中，我进行了引流。为了报答作者，我写了这篇文章。\u003c/p\u003e\n\u003cp\u003e上面那篇文章中使用了一种伪代码语法来表示 lambda calculus。不过这种语法并不能直接运行。怎么办呢？让我们来构建一个源到源编译器！\u003c/p\u003e\n\u003cp\u003e要写一种语言的编译器，显然我们需要知道它的语法和词法。这是第一步。另外还有语义，但是它是 lambda 的一种表示法，所以语义已经被 lambda 定义了，无需考虑。\u003c/p\u003e\n\u003cp\u003e首先是词法。这种语言会出现哪些 tokens？\u003c/p\u003e\n\u003cp\u003e分类一下。lambda 的核心是函数抽象和函数应用。函数抽象用到哪些 tokens？\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003efunc 关键字。\u003c/li\u003e\n\u003cli\u003e冒号。\u003c/li\u003e\n\u003cli\u003ereturn 关键字。\u003c/li\u003e\n\u003cli\u003e参数列表和括号。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e函数应用？\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e括号\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e另外还有一个扩展语法，绑定创建。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e等号（赋值运算符）\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e然后我们需要定义它的语法。这篇文章使用的是单参数的原始 lambda，方便了我们的实现。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-plaintext\" data-lang=\"plaintext\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eidentifier ::= symbol\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eabstract-exp ::= func : (identifier) { return val-exp }\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eapply-exp ::= val-exp(val-exp)\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003ebind-exp ::= identifier = val-exp\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003eval-exp ::= identifier | abstract-exp | apply-exp\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003elc-exp ::= val-exp | bind-exp\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e看来挺简单的。\u003c/p\u003e","title":"Start to Build a Compiler"},{"content":"光剑系列的第六作！\n（放一个 Gemini 生成的欧比旺的图来解释一下光剑是什么） 前五作：\n第一篇：Let\u0026rsquo;s build our mathematics by using lambda calculus \u0026amp;\u0026amp; church encoding! 第二篇：惰性求值、无穷流与发生的魔法 第三篇：协程、生成器与 call/cc 的控制流 第四篇：动态作用域、词法作用域与表达式求值的环境模型 第五篇：基于环境模型的解释器 我们上篇文章写了解释器。在评论区里面可以看到一个非常神秘的东西：https://www.zhihu.com/question/30262900/answer/1943149381147660845\n1 2 3 4 5 6 7 8 9 10 11 12 ; 嵌套的括号不是 scheme 标准语法。表示定义柯里化的函数，和嵌套 lambda 等价。racket 支持这一扩展语法。 (define (Z env) (car env)) (define ((S vp) env) (vp (cdr env))) (define ((Lam e) env) (lambda (x) (e (cons x env)))) (define ((App e1 e2) env) ((e1 env) (e2 env))) ; (define global-env \u0026#39;()) 顺便，还有人问我为什么不再布置一道习题，那么这就是习题！\n这篇文章就是对这个东西的讲解。\n看到这个东西，相信大部分人都做不到一眼看懂。不过应该能够看出一点门道：一个变量不再是我们传统解释器中的那个符号，而是一个函数，这个函数的作用是在环境中查找它对应的值。\n但是，它究竟是怎么查找的呢？\nde Bruijn 索引 答案是，它使用了一种名为 de Bruijn 索引 的技术。\n它的核心思想是：用一个自然数来替代变量名，这个数字代表了变量定义距离其使用位置有多少层 lambda 嵌套。\n0 指代的是最内层（最近）的 lambda 绑定的变量。 1 指代的是往外一层的 lambda 绑定的变量。 以此类推。 举个例子，在 (lambda (x) (lambda (y) (+ x y))) 这个表达式中，对于 + 表达式而言：\n变量 y 是由最内层的 lambda (y) 绑定的，所以它的 de Bruijn 索引是 0。 变量 x 是由外一层的 lambda (x) 绑定的，所以它的索引是 1。 理解了这一点，我们再来审视那份神秘的代码。这里的“环境” env 不再是符号到值的映射，而是一个从内到外排列的实参列表，完美扮演了调用栈的角色。\n(Z env) 就是 (car env)，它获取列表的第一个元素。这正是查找索引为 0 的变量——“调用栈上最近的那个值”。 ((S vp) env) 的作用是 (vp (cdr env))。它将环境 env 去掉一层，再用 vp 去查找。这和邱奇编码中的后继函数非常相似，其效果就是让变量查找向外层移动一格。因此，S 操作符就是将变量的索引加一。S(Z) 就代表索引为 1 的变量，S(S(Z)) 代表索引为 2 的变量。 现在，另外两个函数的含义也清晰了：\n((Lam e) env) 构造了一个 lambda 表达式。它返回一个 Scheme 的 lambda，这个 lambda 接受一个实参 x，然后将 x 通过 cons 压入当前环境 env 的头部，形成一个新的环境，并在这个新环境中执行函数体 e。 ((App e1 e2) env) 实现了函数应用。它在当前环境 env 中分别对 e1 和 e2 求值，然后直接利用 Scheme 底层的函数应用机制完成调用。 这个实现还有一个极其精妙之处：它利用了 Scheme 的闭包。((Lam e) env) 返回的那个 lambda 自然地捕获了它定义时的环境 env。这使得我们的解释器免费地、正确地实现了词法作用域。\n至此，我们用寥寥数行代码，就实现了一个 lambda 演算的解释器。相较于我们在第五作中构建的那个庞大的解释器，这个方案无疑更加简洁、优雅。并且在合理的实现下更加高效。\n调用栈 这种函数式的栈模拟，不仅仅是理论上的奇技淫巧。敏锐的你可能已经发现了，它与汇编语言中的函数调用栈如出一辙。\n在 x86-64 汇编中，你可能会看到类似这样的代码：\n1 2 3 4 5 6 7 8 9 10 ; 函数序言 push rbp ; 保存旧的栈帧基址 mov rbp, rsp ; 设置新的栈帧基址 sub rsp, 16 ; 为局部变量分配16字节空间 ... mov rax, [rbp - 8] ; 访问第一个局部变量 a add rax, 114514 ; a += 114514 mov [rbp - 8], rax ; 写回 a 这里的 rbp 是栈帧基址指针（Base Pointer），而 rsp 是栈顶指针（Stack Pointer）。在一个函数被调用时，通常会建立一个新的栈帧（Stack Frame），rbp 会指向这个栈帧的固定基址，为函数内部的变量访问提供一个稳定的参考点。\n发现了什么？访问局部变量 a 的逻辑 [rbp - 8] 和我们上面的 (S Z) 简直一模一样！\nrbp 就像我们的 env，它为当前函数提供了一个稳定的“环境”基准。 -8 这个固定的偏移量，就如同 S 操作的次数，是在编译期就确定好的、变量相对于环境基准的“索引”。 这是一种深刻的同构。我们的 Scheme 代码，用纯函数式的方式，模拟了底层指令集架构中基于栈帧的变量访问机制。\n理解了这层同构关系后，我们可以进一步探讨一些与调用栈相关的有趣话题。\n逃逸分析 我们上面的 Scheme 解释器不需要手动管理内存，GC 会处理一切。同时，闭包中的自由变量也能得到妥善处置，因为列表天生就是可结构共享的。\n但是，如果我们把模型切换到汇编中那样的、由连续内存段实现的机械栈上，问题就来了：一个变量的生命周期被严格地限制在它的栈帧之内。当函数返回，栈帧被销毁，其中的所有变量也随之灰飞烟灭。\n这在大多数情况下没问题，但当一个变量的生命周期需要比创建它的函数更长时，矛盾就产生了。一个典型的例子是返回闭包：\n1 2 3 4 5 6 (define (make-adder add_val) ; 下面这个 lambda 捕获了外部的 add_val (lambda (x) (+ x add_val))) (define add5 (make-adder 5)) (add5 10) ; 结果是 15 当 make-adder 函数执行完毕并返回时，它的栈帧理应被销毁。但是，它创建并返回的 lambda（现在被 add5 引用）仍然需要访问 add_val 的值（也就是 5）。这意味着 add_val 这个变量的生命周期，必须比创建它的那个栈帧更长。它从自己的作用域中“逃逸”了。\n对于这种情况，简单的栈分配就无能为力了。通用的方法是把 add_val 这样的逃逸变量分配在 堆（Heap） 上，并在闭包中持有指向这块堆内存的引用。\n然而，堆分配和间接访问会带来性能开销。因此，现代编译器会进行逃逸分析（Escape Analysis）：如果编译器能证明一个变量绝不会“逃逸”出它的作用域，就可以安全地将它分配在栈上，从而消除开销，提升效率。\n堆和栈，动态和静态分配 逃逸分析引出了计算机内存管理中一对最核心的概念：栈与堆。\n栈（Stack） 的本质是静态内存布局。编译器在编译时就能精确计算出每个函数需要多少空间，以及每个局部变量相对于栈帧基址 rbp 的偏移量。这使得变量访问极其高效，只需要一次地址运算。但它的代价是死板：大小和生命周期必须在编译时确定。\n堆（Heap） 则是动态内存的舞台。当程序需要在运行时才能确定需要多少内存（例如，读取一个未知大小的文件），或者一个对象的生命周期无法在编译时确定（例如逃逸的闭包变量），就需要从堆上申请。\n为了在动态分配的同时不破坏栈的静态布局，常见的做法是在栈上只保存一个固定大小的指针，这个指针指向堆上那块大小不定的内存。这也是为什么 C++ 的 std::vector 或 Java 的所有对象都采用指针/引用的形式——栈上只存放一个引用，而真正的对象数据存放在堆上。\n函数调用的实现 那么，硬件层面是如何建立和销毁我们一直在讨论的栈帧的呢？我们来看看 call f 这样一个简单的函数调用背后发生了什么。\n调用（call f）：call 指令首先会将返回地址（也就是 call 指令的下一条指令的地址）压入栈顶。然后，它会无条件跳转到函数 f 的代码开头。保存返回地址至关重要，否则函数执行完后就不知道该回到哪里了。\n函数序言（Prologue）：函数 f 的开头通常会执行一系列指令来建立自己的新栈帧：\npush rbp：保存调用者（上一个函数）的 rbp 值。 mov rbp, rsp：将当前的栈顶位置设为新栈帧的基址。从此，rbp 在函数执行期间保持稳定。 sub rsp, N：在栈上为局部变量预留 N 字节的空间。 函数返回（ret）：当函数 f 执行完毕，它会执行函数尾声（Epilogue）和 ret 指令来拆除栈帧并返回：\nmov rsp, rbp（或 leave 指令）：释放局部变量空间，将栈顶指针恢复到栈帧基址。 pop rbp：从栈中恢复调用者的 rbp。 ret：从栈顶弹出之前保存的返回地址，并跳转到该地址，将控制权交还给调用者。 就这样，通过 call 和 ret 的精密配合，以及对 rbp 和 rsp 寄存器的约定用法，程序得以在函数间有序地跳转，同时高效地管理着各自的局部变量。\n总结：从 Lambda 到机器码的同构 从一段看似魔法的 Scheme 代码出发，我们踏上了一段奇妙的旅程。我们看到，lambda 演算中的变量绑定，通过 de Bruijn 索引，被转换成了一种基于相对位置的表达。\n这种相对位置的表达，与现代计算机体系结构中调用栈通过栈帧指针+偏移量来定位变量的方式，形成了惊人的同构。\n进一步地，这个看似简单的内存模型引出了深刻的工程挑战：当函数的生命周期与变量的生命周期不一致时（如闭包导致的变量逃逸），我们就必须引入更灵活的堆内存管理。而栈，作为一种编译期即可确定布局的高效静态模型，则由编译器通过逃逸分析来尽可能地加以利用。\n最终我们发现，无论是高级语言的抽象模型，还是底层的机器指令，都在用各自的方式解决同一个核心问题：如何高效、准确地管理和查找变量。抽象的计算理论与具体的硬件实现，在“调用栈”这一点上，达成了深刻的统一。\n","permalink":"https://litjohn.github.io/posts/%E8%B0%83%E7%94%A8%E6%A0%88de-bruijn-%E7%B4%A2%E5%BC%95%E4%B8%8E%E5%A0%86%E6%A0%88%E7%9A%84%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/","summary":"\u003cp\u003e光剑系列的第六作！\u003c/p\u003e\n\u003cp\u003e（放一个 Gemini 生成的欧比旺的图来解释一下光剑是什么）\n\u003cimg loading=\"lazy\" src=\"https://cdn.luogu.com.cn/upload/image_hosting/76io2hwx.png\"\u003e\u003c/p\u003e\n\u003cp\u003e前五作：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e第一篇：\u003ca href=\"https://www.luogu.com.cn/article/cr6hfiut\"\u003eLet\u0026rsquo;s build our mathematics by using lambda calculus \u0026amp;\u0026amp; church encoding!\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e第二篇：\u003ca href=\"https://www.luogu.com.cn/article/uhume1ou\"\u003e惰性求值、无穷流与发生的魔法\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e第三篇：\u003ca href=\"https://www.luogu.com.cn/article/ygxlqlsn\"\u003e协程、生成器与 call/cc 的控制流\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e第四篇：\u003ca href=\"https://www.luogu.com.cn/article/0hxig3i4\"\u003e动态作用域、词法作用域与表达式求值的环境模型\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e第五篇：\u003ca href=\"https://www.luogu.com.cn/article/h0g9paih\"\u003e基于环境模型的解释器\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e我们上篇文章写了解释器。在评论区里面可以看到一个非常神秘的东西：\u003ca href=\"https://www.zhihu.com/question/30262900/answer/1943149381147660845\"\u003ehttps://www.zhihu.com/question/30262900/answer/1943149381147660845\u003c/a\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-scheme\" data-lang=\"scheme\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e; 嵌套的括号不是 scheme 标准语法。表示定义柯里化的函数，和嵌套 lambda 等价。racket 支持这一扩展语法。\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003eZ\u003c/span\u003e \u003cspan class=\"nv\"\u003eenv\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecar \u003c/span\u003e\u003cspan class=\"nv\"\u003eenv\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine \u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"nf\"\u003eS\u003c/span\u003e \u003cspan class=\"nv\"\u003evp\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003eenv\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003evp\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecdr \u003c/span\u003e\u003cspan class=\"nv\"\u003eenv\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine \u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"nf\"\u003eLam\u003c/span\u003e \u003cspan class=\"nv\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003eenv\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elambda \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003ee\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003econs \u003c/span\u003e\u003cspan class=\"nv\"\u003ex\u003c/span\u003e \u003cspan class=\"nv\"\u003eenv\u003c/span\u003e\u003cspan class=\"p\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine \u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"nf\"\u003eApp\u003c/span\u003e \u003cspan class=\"nv\"\u003ee1\u003c/span\u003e \u003cspan class=\"nv\"\u003ee2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003eenv\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"nf\"\u003ee1\u003c/span\u003e \u003cspan class=\"nv\"\u003eenv\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003ee2\u003c/span\u003e \u003cspan class=\"nv\"\u003eenv\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e; (define global-env \u0026#39;())\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e顺便，还有人问我为什么不再布置一道习题，那么这就是习题！\u003c/p\u003e","title":"调用栈、de Bruijn 索引与堆栈的内存模型"},{"content":"光剑系列的第五作！前四篇：\n第一篇：Let\u0026rsquo;s build our mathematics by using lambda calculus \u0026amp;\u0026amp; church encoding!\n第二篇：惰性求值、无穷流与发生的魔法\n第三篇：协程、生成器与 call/cc 的控制流\n第四篇：动态作用域、词法作用域与表达式求值的环境模型\n前言 又见面了！上一篇文章中我将动态作用域的实现留作了习题，一定非常恶心吧！毕竟我尝试了两天枚举了各种不用宏和用宏的解决方案都没有任何成果，只能看着看不懂的编译错误或者不期望的展开结果发呆。\n如果有哪位读者做出了那个习题，请务必通过本文评论区联系我。\n不过，其实只要自己实现一个解释器，就能够轻松而优雅地完成这个习题。\n恰好，上一篇文章中介绍了环境模型，这将是我们解释器的原理。\n我们将选择 scheme 实现解释器。因为 scheme 的解释器特别好写而作者太菜了只会这个。\n实现 在实现一个具有比较多特性的 scheme 子集之前，我们将先实现一个更简单的 lambda 演算解释器。\n看过第一作的读者们想必还记得 lambda 演算吧？它只含有函数一种对象，函数抽象和函数应用两种操作，已经是图灵完备的。\n那么我们来实现它，使用环境模型和闭包。\n预备工作 · 函数 lambda 只有函数一种核心对象。实现函数自然成为了我们的重要任务。\n在环境模型下，想要实现词法作用域肯定要用闭包。所以我们的函数也将被表示为一个闭包。\n它含有四个字段：第一个是符号 closure，用于标识身份。后面三个字段分别是形式参数、函数体和保存的环境。这些是闭包的核心要素。\n我们可以先实现单参数的函数。因为具有一等公民函数的特性，我们可以通过柯里化实现多参数函数。\n对于闭包的存储，随便用什么都行。我用的是一个 vector（定长数组）。\n1 2 (define (make-closure params body env) (vector \u0026#39;closure params body env)) 有了函数的数据结构标识，我们还需要有对于闭包的操作：\n1 2 3 4 5 6 (define (closure? obj) (and (vector? obj) (eq? (vector-ref obj 0) \u0026#39;closure))) (define (closure-param closure) (vector-ref closure 1)) (define (closure-body closure) (vector-ref closure 2)) (define (closure-env closure) (vector-ref closure 3)) 然后，为了支持对于函数的应用和抽象，我们需要一些关于环境的操作。\n预备工作 · 环境 第一步是定义一个全局环境。\n1 (define global-env (list \u0026#39;())) 注意，环境会构成一个链，所以我们用一个链表表示。而链表内每个元素是一个映射。这里选择了简单的关联列表实现映射，虽然它的查找复杂度是线性的，但是可以简化实现。对于我们的教学示例，复杂度/性能并不是最重要的因素。\n同样的，有了环境的对象，我们就有对它的操作：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 ; 接受一个参数名，一个参数值(会是个闭包)，和父环境 (define (extend-environment param arg base-env) (let ((frame (list (cons param arg)))) ; 创建只有一个绑定的新帧 (cons frame base-env))) (define (lookup-variable-value var env) (let loop ((e env)) (if (null? e) (error \u0026#34;Unbound variable\u0026#34; var) (let ((frame (car e))) (cond ((assoc var frame) =\u0026gt; cdr) ; R6RS 的 =\u0026gt; 很有用 (else (loop (cdr e)))))))) (define (define-variable! var val) ; define 总是修改最外层（全局）环境 (set-car! global-env (cons (cons var val) (car global-env)))) 预备工作到这里就结束了。下面是重头戏。\n求值器 · 主循环 我们需要一个函数来对传入的表达式求值。\n那么，求值器应该处理哪些情况呢？\n首先，肯定有 define 和 lambda 两种特殊形式。\n对于 define，很简单：只需要求值被绑定值然后绑定到变量名上就可以了：\n1 2 3 4 5 6 7 ((eq? op \u0026#39;define) (let* ((var (cadr exp)) (val-exp (caddr exp)) (value (calc val-exp env))) (define-variable! var value) \u0026#39;ok)) ; 提示信息 而对于 lambda，我们采取一种非常懒惰的策略：拆开 S 表达式，然后再包装成一个闭包，函数体丝毫不动：\n1 2 3 4 5 ((eq? op \u0026#39;lambda) (let ((param (caadr exp)) (body (caddr exp))) (make-closure param body env))) 之后呢？之后还要处理递归的边界情况：单个符号。\n1 ((symbol? exp) (lookup-variable-value exp env)) 然后，三种简单情况就都做完了。下面是整个过程中最困难、重要和精妙的步骤：函数应用。\n对于这种情况，我们按照一贯做法先求值操作符，然后从左到右求值各操作数。\n最后怎么办呢？不急。我们进行一个锅的甩，使用一个另外的 apply-proc 函数来完成这项工作 ;)\n1 2 3 4 5 6 (else (let ((proc (calc (car exp) env)) ; 求值函数部分 -\u0026gt; 必须是个闭包 (arg (calc (cadr exp) env))) ; 求值参数部分 -\u0026gt; 也是个值(闭包) (apply-proc proc arg) ) ) 最后加上错误处理，就得到了求值器 calc 的完整代码：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 (define (calc exp env) (cond ((symbol? exp) (lookup-variable-value exp env)) ((list? exp) (let ((op (car exp))) (cond ((eq? op \u0026#39;lambda) (let ((param (caadr exp)) (body (caddr exp))) (make-closure param body env) ) ) ((eq? op \u0026#39;define) (let* ((var (cadr exp)) (val-exp (caddr exp)) (value (calc val-exp env))) (define-variable! var value) \u0026#39;ok)) (else (let ((proc (calc (car exp) env)) ; 求值函数部分 -\u0026gt; 必须是个闭包 (arg (calc (cadr exp) env))) ; 求值参数部分 -\u0026gt; 也是个值(闭包) (apply-proc proc arg) ) ) ) ) ) (else (error \u0026#34;Invalid expression\u0026#34; exp)) ) ) 各位可能很好奇 apply-proc 是何方神圣。不急不急，我这就把它放出来：\n1 2 3 4 5 6 7 8 9 (define (apply-proc proc arg) (if (closure? proc) (let ((param (closure-param proc)) (body (closure-body proc)) (env (closure-env proc))) ; 关键步骤：在闭包 *捕获的环境* 上扩展新绑定 (let ((new-env (extend-environment param arg env))) (calc body new-env))) (error \u0026#34;Not a procedure\u0026#34; proc))) 惊不惊喜，意不意外？\n完成了一切实际计算工作的 apply-proc，其实什么也没干！\n它只不过是把闭包保存的参数名和实际参数制造了一个绑定，添加到环境中。然后又把锅甩了回去，递归调用 calc 对函数体进行求值！\n不过不要忙着大跌眼镜。apply-proc 干的这件事，其实和“代入”非常类似。这样它能够生效就一点都不奇怪了。\n只不过环境模型下不是直接代入，而是扩展环境加入新的绑定。\n一点边角工作 交互循环以及美观打印器。由于不是重点，让 AI 生成的。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 (define (run exp) (calc exp global-env)) (define (pretty-print obj) (cond ; 我们的主角：闭包 ((closure? obj) (display \u0026#34;#\u0026lt;closure: (lambda (\u0026#34;) (write (closure-param obj)) (display \u0026#34;) \u0026#34;) (pretty-print (closure-body obj)) ; 递归地美化打印函数体 (display \u0026#34;)\u0026gt;\u0026#34;)) ; 对列表/S表达式进行美化 ((pair? obj) (display \u0026#34;(\u0026#34;) (pretty-print (car obj)) (let loop ((rest (cdr obj))) (cond ((null? rest) (display \u0026#34;)\u0026#34;)) ((pair? rest) (display \u0026#34; \u0026#34;) (pretty-print (car rest)) (loop (cdr rest))) ; 处理点对列表，如 (a . b) (else (display \u0026#34; . \u0026#34;) (pretty-print rest) (display \u0026#34;)\u0026#34;))))) ; 其他所有类型（符号、布尔值等）用默认方式打印 (else (write obj)))) (define (repl) (display \u0026#34;Lambda\u0026gt; \u0026#34;) (let ((exp (read))) (if (eq? exp \u0026#39;exit) (display \u0026#34;Goodbye!\u0026#34;) (begin (let ((result (run exp))) ; \u0026lt;-- 使用 run 而不是 calc (pretty-print result) (newline)) (repl))))) 如何实现动态作用域？ 太简单了。求值函数应用的时候，不要把它放在保存的环境中求值，而是直接在当前环境中求值。\n具体的，对于 apply-proc 函数：\n1 2 3 4 5 6 7 8 (define (apply-proc proc arg) ; 在这里加入 env 参数，让 calc 传入求值时的当前环境 (if (closure? proc) (let ((param (closure-param proc)) (body (closure-body proc)) (env (closure-env proc))) ; 去掉这一项，直接使用 calc 传入的当前环境而不是函数内部保存的环境 (let ((new-env (extend-environment param arg env))) (calc body new-env))) (error \u0026#34;Not a procedure\u0026#34; proc))) 这样函数的存储中也就不需要保存定义时环境了。\n后续 我们的解释器还很幼稚，只能处理函数一种对象。一切数字、布尔等等都需要邱奇编码来模拟，可读性差且效率低下。\n所以，我们就有了一个超级加强版的解释器！\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 ; (make-closure \u0026#39;(p1 p2) \u0026#39;(body) env) (define (make-closure params body env) (vector \u0026#39;closure params body env)) (define (make-closure-with-name params body env name) (vector \u0026#39;closure params body env name)) (define (closure? obj) (and (vector? obj) (eq? (vector-ref obj 0) \u0026#39;closure))) (define (closure-param closure) (vector-ref closure 1)) (define (closure-body closure) (vector-ref closure 2)) (define (closure-env closure) (vector-ref closure 3)) (define (closure-name closure) (vector-ref closure 4)) (define global-env (list \u0026#39;())) (define intrinsics (list (cons \u0026#39;+ +) (cons \u0026#39;- -) (cons \u0026#39;* *) (cons \u0026#39;/ /) (cons \u0026#39;= =) (cons \u0026#39;\u0026lt; \u0026lt;) (cons \u0026#39;\u0026gt; \u0026gt;) (cons \u0026#39;\u0026gt;= \u0026gt;=) (cons \u0026#39;\u0026lt;= \u0026lt;=) (cons \u0026#39;not not) (cons \u0026#39;cons cons) (cons \u0026#39;car car) (cons \u0026#39;cdr cdr) (cons \u0026#39;map map) (cons \u0026#39;filter filter) (cons \u0026#39;for-each for-each) (cons \u0026#39;vector-ref vector-ref) (cons \u0026#39;vector-set! vector-set!) (cons \u0026#39;vector vector) (cons \u0026#39;list list))) ; 内建函数。用于支持对于数字的操作等等。可以自行添加。 (define (new-environment bounds base-env) (cons bounds base-env)) (define (lookup-variable-value var env) (let loop ((e env)) (if (null? e) (error var \u0026#34;Unbound variable\u0026#34;) (let ((frame (car e))) (cond ((assq var frame) =\u0026gt; cdr) ; R6RS 的 =\u0026gt; 很有用 (else (loop (cdr e)))))))) (define (modify var val env) (let loop ((e env)) (if (null? e) (error var \u0026#34;Unbound variable\u0026#34;) (let ((frame (car e))) (cond ((assq var frame) =\u0026gt; (lambda (v) (set-cdr! v val))) (else (loop (cdr e)))))))) (define (define-variable! var val) ; 合法性检查：变量名必须是符号 (when (not (symbol? var)) (error var \u0026#34;Variable name must be a symbol\u0026#34;)) ; define 总是修改最外层（全局）环境 (set-car! global-env (cons (cons var val) (car global-env)))) (define (calc exp env) (cond ((or (number? exp) (string? exp) (vector? exp) (boolean? exp)) exp) ; 在这个解释器中，数字等原始数据结构也可以视为一种 intrinsics. ((and (list? exp) (assq (car exp) intrinsics)) =\u0026gt; (lambda (x) (let ([f (cdr x)]) (apply f (map (lambda (v) (calc v env)) (cdr exp)))))) ; 注意，操作数数量不匹配会由 scheme 自己报错。所以为了省事略去了。 ((symbol? exp) (lookup-variable-value exp env)) ((list? exp) (let ((op (car exp))) (cond ((eq? op \u0026#39;lambda) (let ((param (cadr exp)) (body (cons \u0026#39;begin (cddr exp)))) (make-closure param body env))) ((eq? op \u0026#39;define) (let* ((var (cadr exp)) (val-exp (caddr exp)) (value (calc val-exp env))) (if (closure? value) (let ([param (closure-param value)] [body (closure-body value)] [env (closure-env value)]) (define-variable! var (make-closure-with-name param body env var))) (define-variable! var value)))) ((eq? op \u0026#39;let) (calc (cons \u0026#39;begin (cddr exp)) (new-environment (map (lambda (x) (cons (car x) (calc (cadr x) env))) (cadr exp)) env))) ((eq? op \u0026#39;set!) (if (not (symbol? (cadr exp))) (error exp \u0026#34;Invalid syntax set!\u0026#34;) (modify (cadr exp) (calc (caddr exp) env) env))) ((eq? op \u0026#39;begin) (let loop ([x (cdr exp)]) (cond ((null? x) (error exp \u0026#34;Invalid syntax begin\u0026#34;)) ((null? (cdr x)) (calc (car x) env)) (else (calc (car x) env) (loop (cdr x)))))) ((eq? op \u0026#39;quote) (if (or (null? (cdr exp)) (not (null? (cddr exp)))) (error exp \u0026#34;Invalid syntax quote\u0026#34;) (cadr exp))) ((eq? op \u0026#39;if) (cond ((or (null? (cdr exp)) (null? (cddr exp))) (error exp \u0026#34;Invalid syntax if\u0026#34;)) ((null? (cdddr exp)) (if (calc (cadr exp) env) (calc (caddr exp) env))) ((null? (cddddr exp)) (if (calc (cadr exp) env) (calc (caddr exp) env) (calc (cadddr exp) env))) (else (error exp \u0026#34;Invalid syntax if\u0026#34;)))) (else (let ((proc (calc (car exp) env)) ; 求值函数部分 -\u0026gt; 必须是个闭包 (arg (map (lambda (x) (calc x env)) (cdr exp)))) ; 求值参数部分 -\u0026gt; 也是个值(闭包) (apply-proc proc arg)))))) (else (error exp \u0026#34;Invalid expression\u0026#34;)))) (define (apply-proc proc arg) (if (closure? proc) (let ((param (closure-param proc)) (body (closure-body proc)) (env (closure-env proc))) ; 关键步骤：在闭包 *捕获的环境* 上扩展新绑定 (let ((new-env (new-environment (map cons param arg) env))) (calc body new-env))) (error proc \u0026#34;Not a procedure\u0026#34;))) (define (run exp) (calc exp global-env)) (define (pretty-print obj) (cond ; 我们的主角：闭包 ((closure? obj) (if (= (vector-length obj) 4) (display \u0026#34;#\u0026lt;procedure\u0026gt;\u0026#34;) (begin (display \u0026#34;#\u0026lt;procedure \u0026#34;) (display (closure-name obj)) (display \u0026#34;\u0026gt;\u0026#34;)))) ; 其他所有类型（符号、布尔值等）用默认方式打印 (else (display obj)))) (define (repl) (display \u0026#34;Lambda\u0026gt; \u0026#34;) (let ((exp (read))) (if (eq? exp \u0026#39;exit) (display \u0026#34;Goodbye!\u0026#34;) (begin (let ((result (run exp))) ; \u0026lt;-- 使用 run 而不是 calc (pretty-print result) (newline)) (repl))))) 它实现的是一个 scheme 的核心子集。\n相较于上面的 lambda 解释器，它主要增加了以下特性：\n多参数函数调用\n这个是通过对 apply-proc 的修改做到的（虽然 calc 和扩展环境的函数也都进行了修改）。我们将所有参数存储为列表，apply-proc 时将形式参数和实际参数的列表通过 map 变成一个新的环境帧，然后链接到老环境上。 数字、字符串、向量、布尔值的原生支持\n实现非常简单，只用了 ((or (number? exp) (string? exp) (vector? exp) (boolean? exp)) exp) 一行，大概就是让这些量摆脱常规的变量查找求值，直接返回自己。 来自 scheme 的内建函数\n这一项是通过 intrinsics 列表做到的。我们先在 intrinsics 列表中查找对应的内建函数，如果有匹配就直接应用。这样我们就可以处理数字等等了。你也可以自行向 intrinsics 列表中添加新的内建函数。 对于 quote、let、begin、set!、if 等特殊形式的支持\n注意，标准 scheme 的 define 可以在内部块作用域的开头出现，定义作用域在块内的变量。而我为了简化没有实现这一点。 函数的美观打印：不再显示函数体和参数列表，而是显示函数名，就像标准 scheme 实现那样：#\u0026lt;procedure\u0026gt;/#\u0026lt;procedure name\u0026gt;。这样就可以方便的用它来玩邱奇编码了！ 一些意想不到的特性 我们的解释器是支持递归的。\n因为定义递归函数时，calc 会直接拆解表达式并构建闭包，最后绑定到函数名上，完全不动函数体。所以就不会出现递归函数名被视为未定义变量的状况。而调用时，函数名已经存在于环境中，对于递归函数的调用会正确地指向它自己。\n我们的解释器支持尾调用优化。\n我们自己没有出手实现这个特性。但是通过对 calc 和 apply-proc 的观察，你可以发现它们在处理函数应用时互相的递归是尾递归的，所以恰好借用了宿主语言 scheme 的尾递归优化。\n并且，尾调用被优化掉之后，无用的环境帧也就被 GC 清除了。所以，我们的解释器巧妙地利用了宿主语言的特性，获得了 TCO（尾调用优化）。\n后记 总之就是这样了。我们实现了一个简单的 lambda 演算的解释器，并展示了如何将它扩展到更强大的 scheme 方言。过程中顺便解决了上篇文章那个极其恶心的习题。\n下次再会！\n","permalink":"https://litjohn.github.io/posts/%E5%9F%BA%E4%BA%8E%E7%8E%AF%E5%A2%83%E6%A8%A1%E5%9E%8B%E7%9A%84%E8%A7%A3%E9%87%8A%E5%99%A8/","summary":"\u003cp\u003e光剑系列的第五作！前四篇：\u003c/p\u003e\n\u003cp\u003e第一篇：\u003ca href=\"https://www.luogu.com.cn/article/cr6hfiut\"\u003eLet\u0026rsquo;s build our mathematics by using lambda calculus \u0026amp;\u0026amp; church encoding!\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e第二篇：\u003ca href=\"https://www.luogu.com.cn/article/uhume1ou\"\u003e惰性求值、无穷流与发生的魔法\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e第三篇：\u003ca href=\"https://www.luogu.com.cn/article/ygxlqlsn\"\u003e协程、生成器与 call/cc 的控制流\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e第四篇：\u003ca href=\"https://www.luogu.com.cn/article/0hxig3i4\"\u003e动态作用域、词法作用域与表达式求值的环境模型\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"前言\"\u003e前言\u003c/h2\u003e\n\u003cp\u003e又见面了！上一篇文章中我将动态作用域的实现留作了习题，一定非常恶心吧！毕竟我尝试了两天枚举了各种不用宏和用宏的解决方案都没有任何成果，只能看着看不懂的编译错误或者不期望的展开结果发呆。\u003c/p\u003e\n\u003cp\u003e如果有哪位读者做出了那个习题，请务必通过本文评论区联系我。\u003c/p\u003e\n\u003cp\u003e不过，其实只要自己实现一个解释器，就能够轻松而优雅地完成这个习题。\u003c/p\u003e\n\u003cp\u003e恰好，上一篇文章中介绍了环境模型，这将是我们解释器的原理。\u003c/p\u003e\n\u003cp\u003e我们将选择 scheme 实现解释器。因为 scheme 的解释器特别好写而作者太菜了只会这个。\u003c/p\u003e\n\u003ch2 id=\"实现\"\u003e实现\u003c/h2\u003e\n\u003cp\u003e在实现一个具有比较多特性的 scheme 子集之前，我们将先实现一个更简单的 lambda 演算解释器。\u003c/p\u003e\n\u003cp\u003e看过第一作的读者们想必还记得 lambda 演算吧？它只含有函数一种对象，函数抽象和函数应用两种操作，已经是图灵完备的。\u003c/p\u003e\n\u003cp\u003e那么我们来实现它，使用环境模型和闭包。\u003c/p\u003e\n\u003ch3 id=\"预备工作--函数\"\u003e预备工作 · 函数\u003c/h3\u003e\n\u003cp\u003elambda 只有函数一种核心对象。实现函数自然成为了我们的重要任务。\u003c/p\u003e\n\u003cp\u003e在环境模型下，想要实现词法作用域肯定要用闭包。所以我们的函数也将被表示为一个闭包。\u003c/p\u003e\n\u003cp\u003e它含有四个字段：第一个是符号 closure，用于标识身份。后面三个字段分别是形式参数、函数体和保存的环境。这些是闭包的核心要素。\u003c/p\u003e\n\u003cp\u003e我们可以先实现单参数的函数。因为具有一等公民函数的特性，我们可以通过柯里化实现多参数函数。\u003c/p\u003e\n\u003cp\u003e对于闭包的存储，随便用什么都行。我用的是一个 vector（定长数组）。\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-scheme\" data-lang=\"scheme\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003emake-closure\u003c/span\u003e \u003cspan class=\"nv\"\u003eparams\u003c/span\u003e \u003cspan class=\"nv\"\u003ebody\u003c/span\u003e \u003cspan class=\"nv\"\u003eenv\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evector \u003c/span\u003e\u003cspan class=\"ss\"\u003e\u0026#39;closure\u003c/span\u003e \u003cspan class=\"nv\"\u003eparams\u003c/span\u003e \u003cspan class=\"nv\"\u003ebody\u003c/span\u003e \u003cspan class=\"nv\"\u003eenv\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e有了函数的数据结构标识，我们还需要有对于闭包的操作：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-scheme\" data-lang=\"scheme\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003eclosure?\u003c/span\u003e \u003cspan class=\"nv\"\u003eobj\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eand \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evector? \u003c/span\u003e\u003cspan class=\"nv\"\u003eobj\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eeq? \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evector-ref \u003c/span\u003e\u003cspan class=\"nv\"\u003eobj\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"ss\"\u003e\u0026#39;closure\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003eclosure-param\u003c/span\u003e \u003cspan class=\"nv\"\u003eclosure\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evector-ref \u003c/span\u003e\u003cspan class=\"nv\"\u003eclosure\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003eclosure-body\u003c/span\u003e \u003cspan class=\"nv\"\u003eclosure\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evector-ref \u003c/span\u003e\u003cspan class=\"nv\"\u003eclosure\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003eclosure-env\u003c/span\u003e \u003cspan class=\"nv\"\u003eclosure\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003evector-ref \u003c/span\u003e\u003cspan class=\"nv\"\u003eclosure\u003c/span\u003e \u003cspan class=\"mi\"\u003e3\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e然后，为了支持对于函数的应用和抽象，我们需要一些关于环境的操作。\u003c/p\u003e","title":"基于环境模型的解释器"},{"content":"光剑系列的第四作！前三篇：\n第一篇：Let\u0026rsquo;s build our mathematics by using lambda calculus \u0026amp;\u0026amp; church encoding!\n第二篇：惰性求值、无穷流与发生的魔法\n第三篇：协程、生成器与 call/cc 的控制流\n引子 在惰性求值、无穷流与发生的魔法中，我们使用无参 lambda 构建了一个 thunk。\n想必有读者读完之后苦思冥想，最后发现“不对呀！主播，你为什么要用一个 lambda 呢？这里用 quote 不是也可以起到‘冻结计算’的作用？最后用一次 eval 将被冻结的原始表达式求值就可以得到真实值了。”\n比如说，我们使用过的这个示例：\n1 2 3 \u0026gt; (define x (lambda () (+ 1 2))) \u0026gt; (x) 3 就可以转化为下面的形式：\n1 2 3 \u0026gt; (define x \u0026#39;(+ 1 2)) \u0026gt; (eval x) 3 如果你这么想了，恭喜你！你自己发现了一条通向本文核心内容，函数抽象的动态作用域与词法作用域区别的道路。\n接下来，请容我解释动态作用域、词法作用域，它们的区别以及 thunk 两种构建方法与它们的联系。在本文中，我们还将手动在 scheme 中构建一套动态作用域的函数抽象/应用体系。最终成果如下：\n1 2 3 4 5 6 7 8 ;; 假设使用支持 SRFI-39 的实现（chez 等很多支持） (define x (make-parameter 10)) (define (f y) (+ (x) y)) (f 5) ; =\u0026gt; 15 (parameterize ([x 100]) (f 5)) ; =\u0026gt; 105 ; x 按调用链动态解析 分道扬镳——当自由变量出现 上面的两种方法看似都能实现对计算的“冻结”，但是它们的作用真的完全一样吗？\n答案是否定的。原因在于，lambda 构建的 thunk 保存了 thunk 定义时的“环境”，而 quote 构建的 thunk 保存的仅仅是代码的“文本”（符号表达式）。当表达式中含有自由变量时，区别就显现出来了。\n一个很简单的例子：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 \u0026gt; (define x 3) \u0026gt; (define y 5) \u0026gt; (define thunk1 (lambda () (+ x y))) ; 期望的值是 3+5=8 \u0026gt; (define thunk2 \u0026#39;(+ x y)) ; 同上 \u0026gt; (thunk1) 8 \u0026gt; (eval thunk2) ; 对两个 thunk 求值，得到预期的 8 8 \u0026gt; (let ([x 100]) (thunk1)) ; 用一个 let 包裹，然后求值。依然得到 8 8 \u0026gt; (let ([x 100]) (eval thunk2)) ; 在某些实现中，eval 会在当前环境中求值。但是 R6RS 标准要求 eval 给定环境参数，并且没有给出获取当前环境的方法 105 我们惊讶地发现，第二种方法构建的 thunk，求出来的值发生了变化！在没有外部的 let 时，它得到的值就是我们想要的 8，但是包裹了一层 let 之后，它的值竟然神秘的变成了 105！\n表达式求值的环境模型 上面的现象，其实源于解释器对于表达式求值的策略。\n诸位对于表达式求值的实现有什么印象呢？\n可能有不少人想到的都是代入（β 规约）吧？对于一个函数 (define (f x) (+ x 2))，调用 (f 3) 的时候就是将 x=3 代入，得到 (+ 3 2)，然后求值得到 5.\n这样的模型看上去确实很简单，但是却隐藏了很大的复杂性。比如说：\n1 2 3 4 (define (id x) x) (define (double x) (+ x x)) (define (square x) (* x x)) (id (double (square 3))) 最后那行函数应用，嵌套的三个函数的参数都叫做“x”，然而却是三个完全不同的东西。贸然将 x 代换成 3 可能会误伤内层函数的无关变量。这里我们需要应用 α 变换，为内层的函数参数生成新的、独一无二的变量名。比如说 x0/x1/x2……这是一个代码混淆器。\n而且，代换模型在遇到可变状态和副作用时会产生根本性的困难。\n为了避免这些麻烦，解释器实际采用的求值策略是另一种：环境模型。\n“环境”是一个从名字到值的映射。解释器在求值过程中会维护一个当前环境，遇到任何符号都会去环境中查找它对应的值。\n变量的声明/绑定，就是向环境中添加新的键值对（名字-值的对应）。函数的应用，也自然地转化成了“将实际参数作为值，绑定到形式参数上”的变量绑定。\n环境不是一个单一的映射，也可以是多个映射（帧，frame）串起来构成的链表。这样的结构非常利于处理作用域嵌套：每一个子作用域都是一个新的帧，链接在父作用域环境前面。查找变量时从最前面的帧向后一帧帧查找，第一次找到就返回。这样就能轻松实现作用域遮蔽的特性，在全局作用域和局部作用域使用同样的变量名。退出作用域之后，就删除它对应的帧。这样就能够简单地清除它对于父作用域带来的影响。\n这就是环境模型。它简单优雅地解决了作用域嵌套时的遮蔽和变量销毁，以及不同位置的无关同名变量带来的问题。大部分的解释器使用的都是环境模型，而不是原始的代入。\n动态作用域与词法作用域 在了解了环境模型之后，我们终于可以深入这个有趣的话题了！\n定义一个函数时，我们可能会用到不在函数参数列表中的变量：\n1 2 3 4 int x = 100; int f() { return x * 2; } 这样的变量就是所谓的“自由变量”。动态作用域与词法作用域，就是处理这些变量的两种不同策略。\n词法作用域 函数中自由变量的意义取决于函数定义时的上下文，即函数在代码文本中的位置。\n比如说，上面的那个函数，无论在哪里调用，它内部引用的 x 都是定义时环境上下文中的 x（第一行定义的 x）。不会因为调用时的环境中有其他叫做 x 的变量而发生变化。\n1 2 3 4 int main() { int x = 3; cout \u0026lt;\u0026lt; f(); // 200 } 要实现这个，函数不能仅仅是参数列表和函数体代码。它还需要捕获定义时的环境，然后把它和参数以及函数体一起打包成一个闭包（closure）。\n动态作用域 与上面相反，动态作用域的函数中的自由变量，其含义取决于调用时的环境。\n（假设 C++ 是动态作用域的）\n1 2 3 4 int main() { int x = 3; cout \u0026lt;\u0026lt; f(); // 6 } 1 2 3 int main() { cout \u0026lt;\u0026lt; f(); // CE } 动态作用域的函数被调用时，会去调用者的环境链中查找自由变量的含义，而不是从自己被定义时的环境中查找。找不到就报错。\n动态作用域的函数，实现可以远比词法作用域简单。你只需要保存它的代码（函数体），然后调用时放到当前环境中求值就行了。不用维护闭包。\n动态作用域的缺陷 动态作用域有很大的问题。调用者手里的变量绑定，可能会莫名其妙地改变函数自由变量的值，从而导致函数产生奇怪的行为。（就像我们开头的例子中 quote 版 thunk 求出来的值发生了变化）\n这是非常不好的，因为它破坏了过程抽象。设计良好的封装/抽象，使用者不应该知道或者关心内部的细节。而动态作用域却要求你小心翼翼地处理函数中的自由变量——我凭什么要知道函数里用了哪些自由变量、都叫什么、取什么值才能得到正确结果？\n所以，几乎所有现代语言（比如 C++、Java、Python、JavaScript……，以及 scheme 和 common lisp 等现代 lisp 方言）都采用了词法作用域。\n但是在早期，许多语言是动态作用域的（比如早期的 lisp）。这并不是因为它们的作者“选择”了动态作用域，而是因为动态作用域实在是太简单、易于实现和容易想到了。缺乏经验的语言设计者，第一次想到的就是它，他们自然把自己的语言实现为动态作用域的。\n在现代，elisp（Emacs lisp）由于领域特定的便利性，依然保留着动态作用域的特性。不过也可以手动启用词法作用域。common lisp 也保留着手动开启动态作用域的方式。\n两种 thunk 实现到不同作用域策略的对应 用 lambda 实现的 thunk，本质上是 scheme 中的一个函数。自然也就继承了 scheme 中函数的共性：词法作用域、闭包。它是词法作用域的。\n而用 quote 实现的 thunk，就是简单地保存了函数的“代码”，并且把它放在调用环境中求值。这是典型的动态作用域特征。\n所以，在开头的那个例子中，你会看见 lambda 版 thunk 没有被外面的 let 影响，而 quote 版则做出了奇怪的行为。\n一个有趣的旁注：C++ 宏中的“动态”魅影\n谈到动态作用域这种“通过外部环境影响内部行为”的特性，一些熟悉 C++ 的读者可能会会心一笑，想起那个著名（甚至可以说是臭名昭著）的技巧：\n1 2 #define private public #include \u0026lt;some_library\u0026gt; 这里的 #define 就像一个动态绑定，它在 #include 这个“调用”发生时，强行改变了库内部代码的含义，让原本私有的成员变量变得公开可见。这与我们在 Lisp 中用 let 动态地为一个函数“注入”自由变量值的行为，在哲学思想上何其相似！它们都展现了强大的灵活性，也都带来了“跨越边界的幽灵般行为”（Spooky Action at a Distance）的风险，使得代码的局部推理变得困难。\n然而，我们必须清晰地认识到，两者貌合神离。C++ 宏的魔法发生在编译前的“预处理期”，它是一种静态的文本替换游戏。而我们所讨论的动态作用域，是语言语义的核心部分，它发生在程序真正执行的“运行期”，根据函数的调用链来动态地解析变量。\n尽管机制不同，这个 C++ 的例子却生动地提醒我们：任何允许上下文影响代码块内部语义的机制，都是一柄需要被审慎使用的强大“光剑”。\n手动构建动态作用域函数 下面是本文的高潮环节！我们已经理解了动态作用域的原理——函数的意义由其“调用时”的环境决定。现在，我们将利用 Scheme 的元编程能力，亲手构建一套动态作用域的函数体系。\n我们的核心思路很简单：\n“冻结”代码：一个动态作用域的函数，本质上就是它未经求值的“代码”本身。我们需要将函数的参数列表和函数体保存下来。quote 是实现这一点的完美工具。 “在调用时求值”：当函数被调用时，我们再用 eval 在当前的（也就是调用者的）环境中，将“解冻”后的代码求值。 仅仅 eval 函数体是不够的，我们还需要处理参数绑定。调用者传入的实际参数，必须先绑定到函数定义时的形式参数上。我们该如何在一个已经存在的环境中“注入”这些新的绑定呢？\n答案是巧妙地利用 let。我们可以在调用时动态地生成一个 let 表达式，用它来包裹原始的函数体。这个 let 会为形式参数创建绑定，而函数体中的自由变量，则会自然地在 let 外层的环境中——也就是调用者的环境中——被查找。这完美地复刻了动态作用域的行为！\n好，设计思路清晰了，我们开始动手实现。\n首先，我们需要一个辅助函数 make-let，它的作用是接收一个绑定列表（比如 ((x 1) (y 2))）和一个函数体列表，然后生成一个完整的 let S-表达式。得益于 Scheme 的同象性（代码即数据），这件事做起来就像拼接列表一样简单：\n1 2 3 ; make-let: 根据绑定和函数体，生成一个 let 表达式 (define (make-let bindings body) (append `(let ,bindings) body)) 一个 let 表达式的结构是 (let ((var1 val1) ...) body1 body2 ...)。我们的 make-let 精确地构造了这个结构。\n接下来是核心部分 dynamic-procedure。它将接收一个参数列表（符号列表）和函数体（S-表达式列表），然后返回一个真正可被调用的 Scheme 函数（一个闭包）。这个返回的函数才是我们的“动态作用域函数”。\n当这个函数被调用时，它会执行我们之前设计的魔法：\n用 map 和 list 将形式参数和接收到的实际参数配对，形成 let 所需的绑定。 调用 make-let 生成包裹着函数体的 let 表达式。 用 eval 在当前环境中执行这个表达式。 1 2 3 4 5 6 7 8 (define (dynamic-procedure params body) ; 返回一个普通的 lambda，它 captures 了 params 和 body (lambda actual-args ; 使用不定参数来接收所有传入的实参 (let ([bindings (map list params actual-args)]) (eval (make-let bindings body) ; (environment) ; 在某些 Scheme 实现中需要指定求值环境，不过 chez scheme 中缺省参数默认使用当前环境，符合我们的要求 )))) 大功告成！为了让定义函数更方便，我们最后再来一个语法糖宏 define-dynamic，让它的写法和普通的 define 几乎一模一样。\n1 2 3 4 (define-syntax define-dynamic (syntax-rules () ((_ (name param ...) body ...) (define name (dynamic-procedure \u0026#39;(param ...) \u0026#39;(body ...)))))) 现在，我们可以像这样定义和使用我们的动态作用域函数了：\n1 2 3 4 5 6 7 8 9 10 (define x 10) ; 定义一个动态函数 f，它有一个参数 y 和一个自由变量 x (define-dynamic (f y) (+ x y)) (f 5) ; =\u0026gt; 15, 因为这里的 x 是全局的 10 (let ([x 100]) (f 5)) ; 你觉得这里的求值结果会是什么呢？ 似乎大功告成了？\n？？？？？\n为什么最后那行调用，得到的值仍然是 15？！\n我们刚刚的实现，存在致命的缺陷。这使得它无法实现动态作用域。\n首先是第一个错误：我们的 dynamic-procedure 返回了一个 lambda。它含有一个闭包。这个闭包捕获了它被定义时的环境，eval 求值时使用的也是这个环境。\n我们不能返回任何闭包。很可惜 scheme 的几乎所有东西都是函数，也就是闭包。\n所幸我们还有宏。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 (define (make-let bindings body) (append `(let ,bindings) body)) (define (dynamic-procedure params body) (cons params body)) (define-syntax funcall (syntax-rules () ((_ f x ...) (eval (make-let (map list (car f) (list x ...)) (cdr f)))))) (define-syntax define-dynamic (syntax-rules () ((_ (name param ...) body ...) (define name (dynamic-procedure \u0026#39;(param ...) \u0026#39;(body ...)))))) 呃，依然不行。\n这份代码中还有第二个错误：eval。\neval 要求两个参数：表达式和环境。单参 eval 是 chez 的扩展，默认在 interaction-environment 返回的顶层环境中求值。而 let 创建的绑定并不在顶层，刚刚的 (let ([x 100]) (f 5)) 依然会得到 15.\n我们需要一些手法来捕获当前环境。\n在某些实现中，我们有 current-environment 之类的手法来捕获当前环境。所以，只需要将 funcall 改成下面这样：\n1 2 3 4 5 6 7 8 (define-syntax funcall (syntax-rules () ((_ f x ...) (eval (make-let (map list (car f) (list x ...)) (cdr f)) (current-environment))))) ; 或换成实现提供的具体方法 这样就行了。\n然而，RnRS 标准（和 chez scheme）并没有提供这种方便的函数。\n这就让 eval 完全废掉了（不能用在这里）。失去了 eval，我们不再能通过运行时代码生成来解决问题（因为任何构建出来的符号列表最终都需要通过 eval 转换为代码执行）。\n我们必须使用宏。放弃代码 -\u0026gt; 数据 -\u0026gt; 代码的转换（因为最后一步依赖于 eval，而它无法提供我们想要的效果），直接用宏对代码进行操作。\n大概的思路是让 define-dynamic 作为一个宏，接受函数名、参数列表和函数体，展开的结果是一个宏定义，将函数名定义为一个宏，匹配实际参数，并且展开成 let 表达式套函数体。不过这个技术有点过于复杂，留作读者练习 :P\n上面的宏方案相当难以实现，还有另外的一些问题：宏不是普通的函数，不具备一等公民特性，不能作为值传递。宏如果进行了递归会无限展开。\n我们有更好的方法，不过需要依赖于已有的库（SRFI）\nSRFI 39 提供了参数对象，类似于 common lisp 或者 elisp 提供的动态作用域对象。可以让我们演示动态作用域：\n1 2 3 4 5 6 7 8 ;; 假设使用支持 SRFI-39 的实现（chez 等很多支持） (define x (make-parameter 10)) (define (f y) (+ (x) y)) (f 5) ; =\u0026gt; 15 (parameterize ([x 100]) (f 5)) ; =\u0026gt; 105 ; x 按调用链动态解析 后记 累了……本来都以为写完了，得到了一个高潮和尾声。结果没想到是一个反高潮，引出了无穷多的问题，到现在还没有办法全部解决……\n实现动态作用域的特性可能确实需要手写解释器。不依赖于库或者手写解释器的方法就留给读者探索吧。一定是非常好的练习。\n为你们的练习提供一些工具：\nsyntax-\u0026gt;datum 函数：将一个语法对象剥离上下文转化为 S 表达式（符号列表）\ndatum-\u0026gt;syntax 函数：接受两个参数 template 和 data（template 是第一个参数，data 是第二个参数），第一个参数是一个语法实体，第二个参数是一个符号列表。返回一个语法实体，内容是 data，上下文与 template 相同。\n小示例：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 (define-syntax print (lambda (stx) (syntax-case stx () ((_ a) (begin (display (syntax-\u0026gt;datum stx)) (newline) (datum-\u0026gt;syntax #\u0026#39;stx \u0026#39;b)))))) \u0026gt; (print a) (print a) Exception: variable b is not bound Type (debug) to enter the debugger. \u0026gt; (define b 5) \u0026gt; (print b) (print b) 5 这两个函数是 syntax-case 打破卫生性，捕获调用者环境中的标识符。读者们，你们应该都能察觉到这和实现动态作用域的相关性。\n虽然看起来作者黔驴技穷了，但是在下一篇文章中，我们将用另一种方式彻底解决这个习题。\n","permalink":"https://litjohn.github.io/posts/%E5%8A%A8%E6%80%81%E4%BD%9C%E7%94%A8%E5%9F%9F%E8%AF%8D%E6%B3%95%E4%BD%9C%E7%94%A8%E5%9F%9F%E4%B8%8E%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B1%82%E5%80%BC%E7%9A%84%E7%8E%AF%E5%A2%83%E6%A8%A1%E5%9E%8B/","summary":"\u003cp\u003e光剑系列的第四作！前三篇：\u003c/p\u003e\n\u003cp\u003e第一篇：\u003ca href=\"https://www.luogu.com.cn/article/cr6hfiut\"\u003eLet\u0026rsquo;s build our mathematics by using lambda calculus \u0026amp;\u0026amp; church encoding!\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e第二篇：\u003ca href=\"https://www.luogu.com.cn/article/uhume1ou\"\u003e惰性求值、无穷流与发生的魔法\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e第三篇：\u003ca href=\"https://www.luogu.com.cn/article/ygxlqlsn\"\u003e协程、生成器与 call/cc 的控制流\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"引子\"\u003e引子\u003c/h2\u003e\n\u003cp\u003e在\u003ca href=\"https://www.luogu.com.cn/article/uhume1ou\"\u003e惰性求值、无穷流与发生的魔法\u003c/a\u003e中，我们使用无参 lambda 构建了一个 thunk。\u003c/p\u003e\n\u003cp\u003e想必有读者读完之后苦思冥想，最后发现“不对呀！主播，你为什么要用一个 lambda 呢？这里用 quote 不是也可以起到‘冻结计算’的作用？最后用一次 eval 将被冻结的原始表达式求值就可以得到真实值了。”\u003c/p\u003e\n\u003cp\u003e比如说，我们使用过的这个示例：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-scheme\" data-lang=\"scheme\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine \u003c/span\u003e\u003cspan class=\"nv\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elambda \u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e+ \u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e就可以转化为下面的形式：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-scheme\" data-lang=\"scheme\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine \u003c/span\u003e\u003cspan class=\"nv\"\u003ex\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026#39;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nv\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"nv\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eeval \u003c/span\u003e\u003cspan class=\"nv\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"mi\"\u003e3\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e如果你这么想了，恭喜你！你自己发现了一条通向本文核心内容，函数抽象的动态作用域与词法作用域区别的道路。\u003c/p\u003e\n\u003cp\u003e接下来，请容我解释动态作用域、词法作用域，它们的区别以及 thunk 两种构建方法与它们的联系。在本文中，我们还将手动在 scheme 中构建一套动态作用域的函数抽象/应用体系。最终成果如下：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e8\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-scheme\" data-lang=\"scheme\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"c1\"\u003e;; 假设使用支持 SRFI-39 的实现（chez 等很多支持）\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine \u003c/span\u003e\u003cspan class=\"nv\"\u003ex\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003emake-parameter\u003c/span\u003e \u003cspan class=\"mi\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003ef\u003c/span\u003e \u003cspan class=\"nv\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e+ \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003ey\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003ef\u003c/span\u003e \u003cspan class=\"mi\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c1\"\u003e; =\u0026gt; 15\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003eparameterize\u003c/span\u003e \u003cspan class=\"p\"\u003e([\u003c/span\u003e\u003cspan class=\"nv\"\u003ex\u003c/span\u003e \u003cspan class=\"mi\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003ef\u003c/span\u003e \u003cspan class=\"mi\"\u003e5\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"c1\"\u003e; =\u0026gt; 105  ; x 按调用链动态解析\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003ch2 id=\"分道扬镳当自由变量出现\"\u003e分道扬镳——当自由变量出现\u003c/h2\u003e\n\u003cp\u003e上面的两种方法看似都能实现对计算的“冻结”，但是它们的作用真的完全一样吗？\u003c/p\u003e","title":"动态作用域、词法作用域与表达式求值的环境模型"},{"content":"上期回顾 光剑系列的第三作！前两篇：\n第一篇：Let\u0026rsquo;s build our mathematics by using lambda calculus \u0026amp;\u0026amp; church encoding!\n第二篇：惰性求值、无穷流与发生的魔法\n前言与一个震撼的 demo 在上一篇文章中，我们探讨并实现了惰性求值与无穷流。希望你们还对自然数流印象深刻。\n自然数流也可以视为一个不断生成新的自然数的生成器。那么，从这个意义上，我们有更简洁而强大的实现方式。\n（还是一贯的 scheme 代码）\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 (define (nature-gen return) (let loop ((i 0)) (set! return (call/cc (lambda (state) (return (cons state i))))) (loop (+ i 1)))) (define nature-numbers (let ((k nature-gen)) (define (tmp-interface) (let ((result (call/cc k))) (set! k (car result)) (cdr result))) tmp-interface)) 这就是一个自然数的生成器！每次调用 nature-numbers，它都会返回一个新的自然数。\n1 2 3 4 5 6 7 8 9 10 \u0026gt; (nature-numbers) 0 \u0026gt; (nature-numbers) 1 \u0026gt; (nature-numbers) 2 \u0026gt; (nature-numbers) 3 \u0026gt; (nature-numbers) 4 正文 上面的代码虽然简短，但是相当晦涩。下面我们将一步步解开它的秘密。\n生成器：可以“暂停”的函数 我们在文章开头用那段晦涩的 Scheme 代码创造的东西，用一个更广为人知的术语来说，就是一个 “生成器” (Generator)。\n你可以把它想象成一个特殊的函数，它有一种超能力：可以在执行到一半时对自己喊“停！”，然后把一个值“扔”给调用者。当调用者下次再来找它时，它能从上次喊停的地方“满血复活”，继续执行。\n其实，这个概念对很多程序员来说并不陌生。Python 中的 yield 关键字就是实现生成器的经典方式，我们开头的 nature-numbers 就等价于下面这段 Python 代码：\n1 2 3 4 5 def nature_gen(): i = 0 while True: yield i i += 1 回顾我们上一篇文章的无穷流，你会发现它惊人地相似！每次我们从流中取出一个数，计算就会“产出”一个结果，而“剩余的无穷计算”则被巧妙地冻结了。这正是生成器的思想：执行、产出、暂停、等待下一次恢复。\n协程：控制权的对等转移 生成器这种“暂停-恢复”的模式，其实是一种更通用、更强大的编程思想的体现，那就是协程 (Coroutine)。\n普通函数调用是“主仆”关系：主函数调用子函数，子函数必须执行完毕并返回，控制权才能回到主函数。这就像经理给员工派活，员工必须做完才能交差。\n而协程之间是“对等”关系。它们就像两位正在对弈的棋手。你走一步，将控制权（棋盘的使用权）交给我；我走一步，再把控制权交还给你。任何一方都可以主动让出控制权。\n看到这里，你应该明白了：生成器，正是一种非对称的协程！ 它在 yield 时将控制权交还给主程序，主程序下次调用时又将控制权还给它，让它从断点处继续。\n那么，真正的问题来了：这种“控制权的任意转移”是如何实现的？我们要怎样才能在代码中抓住“控制流”这个看不见摸不着的东西，让它暂停，又让它在未来某个时刻精确地恢复呢？要铸造这柄控制流的光剑，我们需要一种终极材料——续延。\n续延：捕获程序的“未来” 想象一下，当程序执行到某个特定点时，我们按下了“暂停”键。此时，“程序接下来要做的所有事情”，就是我们所说的 “续延” (Continuation)。 它就像一个包含了程序未来的“时间胶囊”。比如在这段 C++ 代码中：\n1 2 3 4 5 6 int foo(int x) { x++; x *= 3; // \u0026lt;- 按下暂停键 x \u0026lt;\u0026lt;= 1; return x; } 在注释标记的那一行，续延就是“把当前 x 的值左移一位，然后返回结果”。它封装了当前计算剩下的所有步骤。 续延，就是协程暂停时需要保存的那个“断点”的精确描述。 如果我们能拿到这个“断点”，并能在之后随时回到这里，协程的实现不就迎刃而解了吗？\ncall/cc：铸造控制流的魔法棒 在 Scheme 中，call/cc (全称 call-with-current-continuation) 就是这样一个强大的魔法，它能将抽象的“续延”概念物化成一个我们可以操作的实体。 它的作用正如其名：捕获当前的续延，并将它作为一个函数参数，传递给你指定的另一个函数。\n1 2 3 (call/cc (lambda (k) ; k 就是被捕获的续延 (k 3))) k 就是那个“时间胶囊”，一个代表了“未来”的函数。它和其他函数一样，是一等公民。 当你调用 k 并给它一个参数（例如 (k 3)）时，奇迹发生了：程序会立刻放弃当前的所有计算，瞬移回 call/cc 被调用的那个时间点，并将你给的参数 3 作为整个 call/cc 表达式的返回值。因此，上面表达式的值就是 3。 更神奇的是，这个“时间胶囊”可以被保存起来，反复使用！\n1 2 3 4 5 6 7 8 9 (define saved-k #f) (let ((result (+ 1 (call/cc (lambda (k) (set! saved-k k) ; 把“时间胶囊”存起来 5))))) (display result) (newline)) ;; 第一次执行，call/cc 返回 5，所以 result 是 6，打印 6 ;; 现在，如果你在 REPL 中调用 (saved-k 100) ;; 程序会瞬间回到 let 表达式中，仿佛 call/cc 刚刚返回了 100 ;; 于是 result 变为 101，并再次打印 101！ 这个例子完美地展示了 call/cc 的威力：它不仅能逃出当前的计算，还能让我们在未来任何时候，都能像《命运石之门》一样，一次又一次地回到过去，并带着新的“世界线”参数（返回值）继续执行。\n这样的强大工具可以用于构建任意控制流，也包括协程。你可能已经发现了，协程归还控制权时保存状态可以用续延简单实现。更具体地，我们可以直接返回协程内部用 call/cc 捕获的续延！然后再次调用协程时调用那个续延。\n庖丁解牛：深入代码的魔法核心 现在，我们手握 call/cc 这柄能任意切割、重塑程序时间线的光剑，是时候回到最初那个令人惊叹的 demo，像一位精准的外科医生一样，剖析其运作的每一个细节了。\n整个结构分为两部分：作为“协程引擎”的 nature-gen，以及作为“用户接口”的 nature-numbers。我们将模拟一次完整的“生成-暂停-恢复”流程来理解它们。\n第一步：协程引擎 nature-gen 的内部构造 nature-gen 函数是生成器的核心。它的设计精妙之处在于一场**“双续延之舞”**。\n1 2 3 4 5 6 7 (define (nature-gen return) (let loop ((i 0)) (set! return ; 3. 更新“出口”，为下次恢复做准备 (call/cc (lambda (state) ; 1. 捕获“内部断点” (return (cons state i))))) ; 2. 带着“断点”和值，从“出口”返回 (loop (+ i 1)))) 让我们分解这支舞蹈的三个关键舞步：\nstate：捕获“内部断点” call/cc 在这里捕获了它所在位置的续延，我们称之为 state。这个 state 就是我们心心念念的“时间胶囊”，它精确地封装了 nature-gen 暂停时的一切：位于 loop 循环内，变量 i 的当前值，以及接下来要执行 (loop (+ i 1)) 这个步骤的“未来”。\nreturn：从指定的“出口”返回 return 参数是什么？它并不是一个普通的变量，而是主调程序（nature-numbers）的续延。可以把它想象成一个传送门，调用 (return ...) 就会立即将控制权和括号里的值一起“传送”回主调程序。 所以 (return (cons state i)) 这行代码的意义是：\n将我们刚刚捕获的“内部断点” state 和当前要产出的值 i 打包成一个 cons 对。 通过 return 这个“出口”，将这个包含了“未来”与“现在”的包裹，交还给主调程序。 至此，nature-gen 的一次“生成与暂停”就完成了。 set!：为下一次“恢复”更新出口 set! 语句是整个机制能反复运行的关键。当主调程序下一次要“恢复”协程时，它会提供一个新的“出口续延”。(set! return ...) 的作用就是将 nature-gen 内部记录的 return 更新为这个新的出口。否则，如果下次恢复时还使用旧的 return，程序就会陷入真正的时间循环，回到上一次调用的状态，那将是一场灾难！\n第二步：接口 nature-numbers 的封装艺术 如果说 nature-gen 是精密的引擎，那么 nature-numbers 就是驾驶舱，它负责启动引擎、处理引擎返回的状态，并为下一次启动做好准备。\n1 2 3 4 5 6 7 (define nature-numbers (let ((k nature-gen)) ; `k` 是状态存储器，初始为引擎本身 (define (tmp-interface) (let ((result (call/cc k))) ; 使用 call/cc 来启动或恢复引擎 (set! k (car result)) ; 保存引擎返回的新断点 (cdr result))) ; 返回生成的值 tmp-interface)) 让我们来追踪 (nature-numbers) 的前两次调用：\n第一次调用 (nature-numbers)：\n此时，k 的值是 nature-gen 这个函数本身。 执行 (call/cc k)，即 (call/cc nature-gen)。根据 call/cc 的规则，它会调用 nature-gen，并将 call/cc 自身的续延作为参数传进去。这个续延，就是 nature-gen 里的 return 参数！它代表的“未来”是：“拿到一个值，绑定给 result，然后继续执行 let 里的后续代码”。 nature-gen 开始执行，i 为 0。它遇到自己的 call/cc，捕获了内部断点 state。 nature-gen 调用 (return (cons state 0))。控制权立刻返回到 tmp-interface 的 let 表达式中，result 被绑定为 (cons state 0)。 (set! k (car result))：k 被更新为 state，即 nature-gen 的“暂停状态”。 (cdr result)：返回 0。第一次调用成功！ 第二次调用 (nature-numbers)：\n此时，k 的值已经是上一次保存的 state 续延（那个“时间胶囊”）。 再次执行 (call/cc k)。奇迹发生！调用一个续延 k 会让程序立即跳转回 k 被捕获的地方，也就是 nature-gen 内部的 call/cc 表达式处。同时，call/cc 现在的续延（代表着第二次调用的“未来”）会成为 k 的返回值。 也就是说，程序流回到了 nature-gen 中，set! 表达式的右侧部分返回了第二次调用的续延。这个新的续延被赋值给了 return，更新了“出口”。 nature-gen 从断点处继续执行 (loop (+ i 1))，此时 i 变成了 1。 重复第一次调用的流程：捕获新的断点 state'，通过新的 return 出口返回 (cons state' 1)。 tmp-interface 接收到 result，更新 k 为 state'，并返回 1。 就这样，每一次调用 nature-numbers，控制权都在主调程序的续延（return）和生成器的续延（k/state）之间进行一次优雅的交换。k 保存着协程的“过去”，而 call/cc 在调用时则提供了“未来”的去向。这正是协程——控制权的对等转移——最深刻、最本质的实现。一道看似简单的代码，背后却是控制流的绝妙魔法。\n展望：光剑出鞘，协程的应用场景 我们已经铸造了这柄名为续延的控制流“光剑”，并用它剖析了协程的内在机理。那么，这件强大的武器在真实的软件世界里，究竟能用来解决哪些棘手的问题呢？\n协程最广阔的战场，无疑是异步编程，尤其是处理网络请求、文件读写等 I/O 密集型任务。在传统的同步模型中，程序发起一个网络请求就必须“傻等”结果返回，CPU 在此期间完全被浪费。而协程就像一位技艺高超的厨房总管，他让一个任务去烤箱里“烤蛋糕”（等待网络响应），然后无需原地等待，立刻转身去“切菜”（处理其他计算），当烤箱叮咚作响（I/O 完成）时，他又能无缝地回来，继续完成蛋糕的装饰。这种非阻塞的模式极大地提升了程序的并发能力和资源利用率。今天，无数现代语言中的 async/await 语法，其背后正是协程思想的优雅体现。\n除了异步 I/O，协程还在许多领域闪耀着光芒：\n游戏开发：为游戏中的 NPC 编写行为逻辑。一个角色的复杂行动（例如“巡逻30秒”、“发现敌人后追击”、“丢失目标后返回”），可以被写成一个逻辑清晰的协程，而不是一个庞大而混乱的状态机。 数据流管道：构建高效的数据处理流水线。一个协程负责生产数据，另一个协程负责消费和处理，它们协同工作，像一条流畅的工厂传送带，优雅地处理无穷无尽的数据流。 用户界面：在保持 UI 流畅的同时执行耗时操作。将文件下载或图片处理任务放在协程中，可以防止界面冻结，为用户提供丝滑的体验。 总而言之，从我们这个小小的自然数生成器出发，我们窥见的是一种强大的编程范式。协程让我们能够用更符合人类直觉的、线性的方式，去编写本质上非线性的、并发的程序。它将复杂的控制流管理隐藏在优雅的 yield 或 await 之下，让开发者能更专注于业务逻辑本身。\n这柄曾经只属于 Scheme、Lisp 等“魔法师”语言的“光剑”，如今已成为现代软件开发中不可或缺的利器。\n","permalink":"https://litjohn.github.io/posts/%E5%8D%8F%E7%A8%8B%E7%94%9F%E6%88%90%E5%99%A8%E4%B8%8E-call-cc-%E7%9A%84%E6%8E%A7%E5%88%B6%E6%B5%81/","summary":"\u003ch2 id=\"上期回顾\"\u003e上期回顾\u003c/h2\u003e\n\u003cp\u003e光剑系列的第三作！前两篇：\u003c/p\u003e\n\u003cp\u003e第一篇：\u003ca href=\"https://www.luogu.com.cn/article/cr6hfiut\"\u003eLet\u0026rsquo;s build our mathematics by using lambda calculus \u0026amp;\u0026amp; church encoding!\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e第二篇：\u003ca href=\"https://www.luogu.com.cn/article/uhume1ou\"\u003e惰性求值、无穷流与发生的魔法\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"前言与一个震撼的-demo\"\u003e前言与一个震撼的 demo\u003c/h2\u003e\n\u003cp\u003e在上一篇文章中，我们探讨并实现了惰性求值与无穷流。希望你们还对自然数流印象深刻。\u003c/p\u003e\n\u003cp\u003e自然数流也可以视为一个不断生成新的自然数的生成器。那么，从这个意义上，我们有更简洁而强大的实现方式。\u003c/p\u003e\n\u003cp\u003e（还是一贯的 scheme 代码）\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-scheme\" data-lang=\"scheme\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003enature-gen\u003c/span\u003e \u003cspan class=\"nv\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet \u003c/span\u003e\u003cspan class=\"nv\"\u003eloop\u003c/span\u003e \u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"nf\"\u003ei\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eset! \u003c/span\u003e\u003cspan class=\"nv\"\u003ereturn\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e          \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003ecall/cc\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elambda \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003estate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e              \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003ereturn\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003econs \u003c/span\u003e\u003cspan class=\"nv\"\u003estate\u003c/span\u003e \u003cspan class=\"nv\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)))))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003eloop\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e+ \u003c/span\u003e\u003cspan class=\"nv\"\u003ei\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine \u003c/span\u003e\u003cspan class=\"nv\"\u003enature-numbers\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet \u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"nf\"\u003ek\u003c/span\u003e \u003cspan class=\"nv\"\u003enature-gen\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003etmp-interface\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elet \u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"nf\"\u003eresult\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecall/cc \u003c/span\u003e\u003cspan class=\"nv\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eset! \u003c/span\u003e\u003cspan class=\"nv\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecar \u003c/span\u003e\u003cspan class=\"nv\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecdr \u003c/span\u003e\u003cspan class=\"nv\"\u003eresult\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"nv\"\u003etmp-interface\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e这就是一个自然数的生成器！每次调用 nature-numbers，它都会返回一个新的自然数。\u003c/p\u003e","title":"协程、生成器与 call/cc 的控制流"},{"content":"光剑第二作！\n前言：什么是魔法？ （注：这个前言可以跳过。它是最终成果展示。感到迷惑很正常，请先阅读正文。）\n什么是魔法？\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 (define-syntax delay (syntax-rules () ((delay x) (lambda () x)))) (define (lazy-variable thunk) (cons #f thunk)) (define (is-calculated? variable) (car variable)) (define (force variable) (if (is-calculated? variable) (cdr variable) (begin (set-car! variable #t) (set-cdr! variable ((cdr variable))) (cdr variable)))) (define-syntax stream-cons (syntax-rules () ((stream-cons a b) (cons a (lazy-variable (delay b)))))) (define (stream-car x) (car x)) (define (stream-cdr x) (force (cdr x))) (define (int-from n) (stream-cons n (int-from (+ n 1)))) (define nature-numbers (int-from 1)) 真成四十行代码了。感兴趣的读者可以数一数，刚好 39 行。\n然后下面还有一些有趣的小工具：\n1 2 3 4 5 6 7 8 9 10 11 (define (get a pos) (if (= pos 0) (stream-car a) (get (stream-cdr a) (- pos 1)))) (define (take a len) (if (= len 0) \u0026#39;() (cons (stream-car a) (take (stream-cdr a) (- len 1))))) 这些有什么用呢？请见下文。\n1 2 3 4 5 6 7 8 9 10 (define org \u0026#39;(1 2 3 4 5)) (define (twice a) (if (null? a) \u0026#39;() (stream-cons (* 2 (car a)) (twice (cdr a))))) (define new (twice org)) 这里实现了类似于 C++ 20 std::views 库中的视窗的东西。具备类似的惰性求值特性。\n更加抽象的范式。我们发现上面的具体的“将一个元素变成它的二倍”的操作其实是和整体框架的“构建一个流，每个元素是原始列表/流中对应元素经过一个变换后得到的”的语义无关的。\n于是把框架提取出来，变成类似于列表的 map 的操作。\n1 2 3 4 5 6 7 8 9 10 11 12 13 (define (transfer-to-stream operator a) (if (null? a) \u0026#39;() (stream-cons (operator (car a)) (transfer-to-stream operator (cdr a))))) (define (stream-map operator a) (if (null? a) \u0026#39;() (stream-cons (operator (stream-car a)) (stream-map operator (stream-cdr a))))) 正文 好了好了炫技到此结束。如果看到这里你都能看懂的话就可以离开了，这篇文章大概不会对您这样的大佬产生什么帮助。\n而如果你一头雾水也完全不要紧。正文从这里才刚刚开始。\n目标 · 魔法 “一个存储着所有自然数的、无穷大的列表”。\n在有着有限内存的计算机中，这是不可能达成的任务。然而，今天我们将亲手实现它。用非常少的代码。\n惰性求值 · 魔法的机理 各位听说过“惰性求值”（lazy-evaluation）吗？大概的思想就是，一个变量我们不立刻算出它的值，而是把它背后的“计算”保存起来，直到要用的时候才算出它的值。以此避免不必要的计算。\n举个例子：\n1 2 3 4 5 6 7 myClass foo() { myClass res(); // lots of work return res; } auto x = foo(); 假设 C++ 是惰性求值的，这里程序就不会在 x 定义时立刻执行 foo() 并计算返回值。而是会到你真正使用 x 的值的时候再执行 foo() 并计算出 x 的真实值。\n不过，我们熟悉的 C++ 和大多数主流语言都是严格求值/应用序求值的。并不（默认）支持这种特性。一个表达式被绑定到变量上，它立刻就被求值。函数调用时，也先对函数本身以及各个参数进行求值。比如这个函数：\n1 2 3 int foo(int x) { return x * 2; } 调用 foo(3 + 3) 时就会先求值 foo 发现它是一个函数。然后求值参数 x，发现它是 3 + 3，等于 6.函数体里面 x 的值直接就是 6.\n但是某些语言是默认惰性求值的。一个著名的例子是 haskell。它们在这种地方会让 x 变成一个未完成的计算 3 + 3，直到使用了 x * 2 时才求出 x 的值是 6，并返回 6 * 2 = 12.\n这是第一项前置知识。它是整个魔法的基础，我们能够创造出无穷大的列表，正是因为我们并没有创造出它！\n我们只需要创造出那些我们需要使用的部分就可以了。比如说，如果我们的程序只访问了自然数列表的前十项，就只计算出这前十项。\n手动实现惰性求值 · 魔法的材料 在一门严格求值的语言中，我们也是可以通过一些手法实现惰性求值机制的。\n最经典的方法是利用 lambda。\n我们知道，一个函数的函数体只有在调用时才会被求值。这个特性是容易理解的：函数需要知道参数以及引用的自由变量的值才能确定函数体的值。你不可能在函数定义时就准确地知道每次调用它产生的副作用和返回值。\n这就产生了一个天然的惰性求值对象！我们可以用它来构建惰性求值系统。\n具体地。我们知道这样的东西：\n对于任意一个函数 $g$，定义 $$f:=\\lambda x.(g\\ x)$$ 则有 $f$ 和 $g$ 等价。\n从感性上，这是显然的。对于任意输入，$f$ 和 $g$ 的输出都一模一样。$f$ 干的唯一一件事就是把输入扔给了 $g$ 处理。它自己什么都没干。\n在 lambda 演算的体系中，这是三条计算法则之一 η 变换。\n那么，我们就可以用一层 lambda（lambda 本质上是匿名函数/函数字面量）来包裹住表达式！\n这样，表达式就不会立即被求值了。而如果我们要获取表达式的值，只需要应用那个 lambda，就能得到表达式的求值结果。\nlambda 的参数具体是什么不重要，因为我们只是想要创建一个延迟求值的计算或者得到被延迟的计算的值。所以，干脆就不要参数了！一个无参数的 lambda 能够最简洁清晰地达成我们的目的。\n有一个术语用来描述这些：thunk。它指的是被延迟求值的计算。\n下面不得不涉及到一些细节。用 C++ 来写本文的代码会非常痛苦，需要和类型系统搏斗，给代码加上大量的模板技巧……那会完全掩盖思想的优雅本质。所以本文的代码不采用 C++。\n相反地，我们采用 scheme。scheme 是一门 lisp 方言，具有动态类型和函数式特性。也是一门严格求值的语言。\nscheme 的代码是以“S 表达式”（符号表达式）的形式组织的。\n快速了解一下 S-表达式：\n核心是列表 (List)： S-表达式的基本形式是由圆括号 () 包围起来的列表。 结构：(操作符 参数1 参数2 ...)： 列表中的第一个元素通常是操作符（即要应用的函数），其余元素则是传递给该操作符的参数。 原子 (Atom) 与嵌套： 列表中的元素可以是原子（如数字 123、符号 x、+），也可以是另一个 S-表达式。这种嵌套能力使得 S-表达式可以表示复杂的树状结构。 例如，表达式 (+ 1 (* 2 3)) 在 Scheme 中表示数学上的 1 + (2 * 3)。 这里：\n最外层的 (+ 1 (* 2 3)) 是一个 S-表达式。+ 是操作符，1 和 (* 2 3) 是它的参数。 (* 2 3) 本身也是一个 S-表达式。* 是操作符，2 和 3 是它的参数。执行它会得到 6。 所以整个表达式 (+ 1 6) 最终会计算得到 7。 你可以通过搜索、查阅文档或者询问 AI 得到 scheme 的更多信息。本文不过多赘述。\n于是我们就可以理解前言的第一段，delay、force 以及 lazy-variable 是在干什么了。delay 接受一个表达式，把它用 lambda 包装起来变成一个 thunk。force 对一个惰性求值的变量求取值，得到它的真实值。\nlazy-variable 是在干什么？它对 delay 给出的 thunk 进行了进一步的封装，加上了一个标志说明它是否已被求值。因为如果每次 force 取值都重新调用一遍 thunk，我们会不停地重复计算一模一样的东西，时间复杂度就寄了。\n所以，我们需要记忆化。第一次对于一个惰性变量的取值会求值 thunk，之后它的值就被存储在一个普通变量里了，不需要重复计算。\nforce 如何区分一个惰性变量是否被求值过了？就是靠 lazy-variable 引入的那个标志位。\n注意到 delay 是一个宏。因为 scheme 是应用序求值的。如果用一般的函数，参数会被先求值，就无法实现惰性求值了。\n到这里，我们就在 scheme 这门严格求值的语言中手动实现了惰性求值系统。\n流 · 魔法现身！ 有了惰性的变量，我们自然可以定义惰性求值的数据结构！\n“流”就是一个这样的惰性数据结构。具体的，它是一个列表。不过，它并不从一开始就存储着所有的数据，而是在访问时才生成真实的元素。（惰性求值特性）\n流可以是无穷大的，因为它只有被访问的项才会被生成。这就是我们最开始提出的魔法。\n我们如何实现一个流呢？我们发现，一个流的被计算完成的 cons 单元，它的数据域（car）就是一个普通的值。而指针域指向的，“下一项”却有可能是依然没有被生成的 thunk。\n所以就有了前言中的这些：\n1 2 3 4 5 6 7 8 9 10 11 12 13 (define-syntax stream-cons (syntax-rules () ((stream-cons a b) (cons a (lazy-variable (delay b)))))) (define (stream-car x) (car x)) (define (stream-cdr x) (force (cdr x))) 有了这些，我们如何构造出一个具体的流呢？比如一个全部项都是 1 的无穷流？\n你可能会想，一个全部都是 1 的无穷流，和它自己前面加上一个 1 是完全等价的。于是你可能会写出：\n1 2 (define one (stream-cons 1 one)) 然而这是错的。你会惊讶地发现，把上面代码中的 stream-cons 换成 cons，也能运行并且生成一个循环列表。这是 scheme 的一个特性。\n所以，上面的代码并不是你想象中被延迟无穷递归的无穷流，而只是一个普通的循环列表，指针域被延迟求值了而已。\n真正的实现利用的是函数被延迟的无穷递归。\n1 2 3 4 (define (one) (stream-cons 1 (one))) (define stream-of-one (one)) 当你在这个流上遍历的时候，你会不断地触及到被延迟求值的 one 调用。而它返回 1 和另一个被延迟的 one 调用构成的 cons 单元，永无休止。这是一个无穷流。\n以及，我们可以完成那个魔法了！自然数流，启动！\n1 2 3 4 5 6 7 (define (int-from n) (stream-cons n (int-from (+ n 1)))) (define nature-numbers (int-from 1)) 魔法现身之后的应用 我们需要一些操纵流的方法。我们已经有了 stream-car 和 stream-cdr 来访问它。不过还不够。\n前言中的 take 和 get，一个用来取一个流的前若干项（项数不足就 RE），一个用来取一个流的第 i 项（0-base，流的第一项是第 0 项）\n这些都很简单。不过下面的才是真正的重量级，也是流的实际应用。\n1 2 3 4 5 6 (define (twice a) (if (null? a) \u0026#39;() (stream-cons (* 2 (car a)) (twice (cdr a))))) 从一个列表创建一个流，流的每一项是原始列表对应项的两倍。\n这里前言里面有介绍。\n然后是 transfer-to-stream 和 stream-map。都是类似于普通列表的 map 的操作（将每个元素做给定变换，然后用变换后的元素创建并返回新的列表）。不过一个是从列表 map 到流，一个是流 map 到流。\n操作的组合 · 管道 这里不得不提到另外一个概念：管道。\n管道是一种高阶函数。它描述的是这样的一种东西：数据进入第一个函数，流出来变成返回值，然后继续进入第二个函数……就像水流过管道，数据流过一系列处理它的函数。\n下面就是一个简单的管道实现：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 (define combine (lambda (f g) (lambda x (g (apply f x))))) (define tunnel (lambda list-of-params (let ((x (car list-of-params)) (tmp (cdr list-of-params))) (if (null? tmp) x (let ((y (car tmp)) (rest (cdr tmp))) (apply tunnel (cons (combine x y) rest))))))) 管道使得我们可以组合对一个流的不同操作，制造“数据的流水线”。\n1 2 3 4 5 6 7 (define example (stream-map (tunnel (lambda (x) (* x x)) (lambda (x) (+ x 3)) (lambda (x) (log x 2))) nature-numbers)) 魔法的代价：惰性与可变状态的冲突 scheme 中函数的闭包对作用域是默认按引用捕获的。也就是说，如果我包装的 thunk 在被计算之前，内部引用的自由变量被修改了或者生命周期结束，惰性求值的结果就会和严格求值不同。\n一个问题发生的示例：\n1 2 3 4 5 \u0026gt; (define x 10) \u0026gt; (define my-lazy-value (lazy-variable (delay (* x 2)))) ; 值是 2x = 20 \u0026gt; (set! x 100) \u0026gt; (force my-lazy-value) 200 ; something strange happened! haskell 就没有这种问题。因为它是“纯”的，状态不会被莫名其妙地改掉。而我们上面的构建流的代码也是纯的，所以它们是安全的。\n想要在可变状态中避免这种惨案的发生，我们需要一个“按值捕获”。\n1 2 3 4 5 6 7 8 9 10 11 12 (define x 10) ; 使用 let 来“冻结”x 当前的值 (define my-safe-lazy-value (let ((frozen-x x)) ; frozen-x 是一个全新的绑定，其值为 10 (lazy-variable (delay (* frozen-x 2))))) (set! x 100) (force my-safe-lazy-value) ; ==\u0026gt; 20 不过，需要注意的是，仅仅修改 delay 很难做到按值捕获。因为你无法预料哪些变量是自由的。或者你不可能先求值表达式再存储，那样惰性求值就不存在了。\n我们只能手动按值捕获。\n我们实现的 delay 机制，其默认行为是捕获变量的“绑定”而非“值”。这在处理可变状态时会带来非预期的结果。这并非 delay 实现的缺陷，而是 Scheme 语言设计哲学的一种体现。它要求我们，作为魔法的施法者，必须清楚地知道自己法术的边界。当需要“固化”状态时，我们必须亲手使用 let 咒语来创建一个不可变的副本，从而保证魔法效果的确定性。这种对控制权的明确要求，正是这门语言强大而迷人的一部分。\n后记 到此，本文就结束了。我们成功使用惰性求值将“创建一个无穷大的列表”这样不可能的魔法化作了现实。\n我们亲手实现了一种声明式的方法。流可以让我们声明并组合对于列表的种种操作，而无需手动管理中间临时列表。\n代码即思想，我们描述的是“是什么”，而不是“怎么算”，将逻辑与控制分离。\n（BTW，也许你会好奇用 C++ 如何作到这些。那么你可以看看这个：https://www.luogu.com.cn/article/jomps7w6，AI生成的代码，能够过编和运行，并且实现了和本文一样的 功能。）\n","permalink":"https://litjohn.github.io/posts/%E6%83%B0%E6%80%A7%E6%B1%82%E5%80%BC%E6%97%A0%E7%A9%B7%E6%B5%81%E4%B8%8E%E5%8F%91%E7%94%9F%E7%9A%84%E9%AD%94%E6%B3%95/","summary":"\u003cp\u003e光剑第二作！\u003c/p\u003e\n\u003ch2 id=\"前言什么是魔法\"\u003e前言：什么是魔法？\u003c/h2\u003e\n\u003cp\u003e（注：这个前言可以跳过。它是最终成果展示。感到迷惑很正常，请先阅读正文。）\u003c/p\u003e\n\u003cp\u003e什么是魔法？\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e 1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 6\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 7\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 8\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e 9\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e10\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e11\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e12\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e13\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e14\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e15\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e16\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e17\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e18\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e19\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e20\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e21\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e22\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e23\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e24\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e25\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e26\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e27\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e28\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e29\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e30\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e31\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e32\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e33\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e34\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e35\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e36\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e37\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e38\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e39\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-scheme\" data-lang=\"scheme\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine-syntax \u003c/span\u003e\u003cspan class=\"nv\"\u003edelay\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003esyntax-rules \u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"k\"\u003edelay \u003c/span\u003e\u003cspan class=\"nv\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elambda \u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"nv\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003elazy-variable\u003c/span\u003e \u003cspan class=\"nv\"\u003ethunk\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003econs \u003c/span\u003e\u003cspan class=\"no\"\u003e#f\u003c/span\u003e \u003cspan class=\"nv\"\u003ethunk\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003eis-calculated?\u003c/span\u003e \u003cspan class=\"nv\"\u003evariable\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecar \u003c/span\u003e\u003cspan class=\"nv\"\u003evariable\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eforce \u003c/span\u003e\u003cspan class=\"nv\"\u003evariable\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eif \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003eis-calculated?\u003c/span\u003e \u003cspan class=\"nv\"\u003evariable\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecdr \u003c/span\u003e\u003cspan class=\"nv\"\u003evariable\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003ebegin\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eset-car! \u003c/span\u003e\u003cspan class=\"nv\"\u003evariable\u003c/span\u003e \u003cspan class=\"no\"\u003e#t\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eset-cdr! \u003c/span\u003e\u003cspan class=\"nv\"\u003evariable\u003c/span\u003e \u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"nb\"\u003ecdr \u003c/span\u003e\u003cspan class=\"nv\"\u003evariable\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecdr \u003c/span\u003e\u003cspan class=\"nv\"\u003evariable\u003c/span\u003e\u003cspan class=\"p\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine-syntax \u003c/span\u003e\u003cspan class=\"nv\"\u003estream-cons\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003esyntax-rules \u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"nf\"\u003estream-cons\u003c/span\u003e \u003cspan class=\"nv\"\u003ea\u003c/span\u003e \u003cspan class=\"nv\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e     \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003econs\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e       \u003cspan class=\"nv\"\u003ea\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e       \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003elazy-variable\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e         \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edelay \u003c/span\u003e\u003cspan class=\"nv\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e))))))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003estream-car\u003c/span\u003e \u003cspan class=\"nv\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecar \u003c/span\u003e\u003cspan class=\"nv\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003estream-cdr\u003c/span\u003e \u003cspan class=\"nv\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eforce \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecdr \u003c/span\u003e\u003cspan class=\"nv\"\u003ex\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine \u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003eint-from\u003c/span\u003e \u003cspan class=\"nv\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e  \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003estream-cons\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"nv\"\u003en\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003eint-from\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e      \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e+ \u003c/span\u003e\u003cspan class=\"nv\"\u003en\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e))))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine \u003c/span\u003e\u003cspan class=\"nv\"\u003enature-numbers\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nf\"\u003eint-from\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e真成四十行代码了。感兴趣的读者可以数一数，刚好 39 行。\u003c/p\u003e","title":"惰性求值、无穷流与发生的魔法"},{"content":"致谢 Gemini 2.5 Pro 0325 \u0026amp;\u0026amp; 0506：文本润色、事实正确性审查，以及帮助我学习、理解和回忆这些内容。\nmyster1ous： 给予我巨大的启发，帮助我构建出 prev 函数。\n前言 本文是光剑系列的第一作，又名《lambda 演算，邱奇编码与优雅的计算模型》。\n本文的目的是带领大家踏上一段奇妙的旅程：我们将使用 λ 演算（Lambda Calculus）这一极简的计算模型，并通过丘奇编码（Church Encoding）这一巧妙的技术，一步步构建出我们日常编程中熟悉和依赖的计算体系，例如数字、布尔逻辑乃至更复杂的数据结构。\n为了方便演示和实践，本文中的所有代码示例都将使用 Scheme 语言。Scheme 是 Lisp 家族的一员，它的语法是 S-表达式 (Symbolic Expressions)。S-表达式不仅简洁优雅，而且其结构与 λ 演算的表达方式惊人地契合。\n在我们开始之前，让我们先快速了解一下 S-表达式：\n核心是列表 (List)： S-表达式的基本形式是由圆括号 () 包围起来的列表。 结构：(操作符 参数1 参数2 ...)： 列表中的第一个元素通常是操作符（即要应用的函数），其余元素则是传递给该操作符的参数。 原子 (Atom) 与嵌套： 列表中的元素可以是原子（如数字 123、符号 x、+），也可以是另一个 S-表达式。这种嵌套能力使得 S-表达式可以表示复杂的树状结构。 例如，表达式 (+ 1 (* 2 3)) 在 Scheme 中表示数学上的 1 + (2 * 3)。 这里：\n最外层的 (+ 1 (* 2 3)) 是一个 S-表达式。+ 是操作符，1 和 (* 2 3) 是它的参数。 (* 2 3) 本身也是一个 S-表达式。* 是操作符，2 和 3 是它的参数。执行它会得到 6。 所以整个表达式 (+ 1 6) 最终会计算得到 7。 理解了 S-表达式，我们就可以更顺畅地进入 λ 演算的世界了。\nλ 演算：计算的本质 λ 演算（Lambda Calculus）由阿隆佐·丘奇在 20 世纪 30 年代提出，它是一个极其简洁却具有图灵完备计算能力的数学形式系统。这意味着任何可计算的函数都可以用 λ 演算来表达和计算。\nλ 演算的核心要素出奇地少，主要包括：\n变量 (Variables): 如 x, y, f 等，用作参数名或函数本身的占位符。 函数抽象 (Function Abstraction): 这是定义一个新（通常是匿名的）函数的过程。 函数应用 (Function Application): 这是将一个函数作用于其参数（即调用函数）的过程。 让我们逐一来看。\n1. 函数抽象 (定义函数) 在传统的数学或 λ 演算表示法中，一个接受参数 x 并返回表达式 E 的函数可以写为 $\\lambda x.E$。 在 Scheme (以及本文的 S-表达式) 中，我们这样表示：\n1 (lambda (x) E) 这里的 lambda 是一个特殊的关键字，表示我们正在定义一个匿名函数。(x) 是参数列表（这里只有一个参数 x），而 E 是函数体，代表函数要执行的计算并返回的结果。\n例如，一个接受参数 x 并简单返回 x 本身的函数 (称为恒等函数)：\n1 (lambda (x) x) 这是一个非常基础但重要的函数。\n再举一个例子，一个接受参数 x 并期望返回 x+1 的函数：\n1 (lambda (x) (+ x 1)) 请注意： 在这个例子中，我们暂时借用了 Scheme 中预定义的 + 操作符和数字 1。这有助于我们直观地理解函数定义。然而，在纯粹的 λ 演算中，并不存在预定义的数字或算术运算符。一切——包括数字、布尔值和运算——都需要从最基本的函数抽象和应用来构建。这正是我们稍后将通过“丘奇编码”来实现的迷人之处！现在，请将注意力集中在 lambda 如何定义一个接受输入、进行处理、然后输出结果的“黑盒子”。\n这些用 lambda 定义的函数都是匿名函数，它们没有名字。\n2. 函数应用 (调用函数) 定义了函数，我们自然需要调用它。在传统表示法中，将函数 $f$ 应用于参数 $a$ 通常写作 $f(a)$ 或 $f\\;a$。 在 S-表达式中，函数应用的形式非常统一：\n1 (f a) 其中 f 是要应用的函数，a 是传递给函数的参数。\n如果我们想直接应用一个匿名函数，可以这样做：\n1 ((lambda (x) (+ x 1)) 5) 这个表达式的含义是：将匿名函数 (lambda (x) (+ x 1)) 应用于参数 5。计算过程（我们稍后会详细讨论其规则）会得到 6。\n虽然纯粹的 λ 演算主要处理匿名函数，但在像 Scheme 这样的编程语言中，为了代码的清晰和可重用性，我们通常会给函数命名。这可以通过 define 实现：\n1 (define inc (lambda (x) (+ x 1))) 这里，我们将前面定义的“加一”函数命名为 inc。现在，我们可以通过名字来调用它：\n1 2 (inc 5) ; 这将返回 6 (inc 10) ; 这将返回 11 需要强调的是，define 并不是 λ 演算本身的一部分，它是 Scheme 提供的用于绑定名称到值的便利工具。在 λ 演算的理论探讨中，我们更多关注匿名函数及其组合。\n3. 万物皆函数：λ 演算的核心思想 λ 演算最令人着迷的一点或许是它的极简主义哲学：在纯粹的 λ 演算中，一切皆是函数。 我们通常认为理所当然存在的数字 (0, 1, 2\u0026hellip;)、布尔值 (真/假)、条件判断 (if-then-else)、数据结构 (如列表) 等等，在 λ 演算的宇宙中，都是通过巧妙地组合和嵌套函数来表达的。\n这意味着，理论上我们只需要“定义函数”和“应用函数”这两个基本操作，就能构建出整个可计算的世界。这听起来可能有些抽象和不可思议，但别担心，本文的后半部分将通过丘奇编码来具体展示如何用函数来表示数字和布尔值，并在此基础上进行运算。\nλ 演算的运算法则 λ 演算有几条基本的变换规则，它们定义了表达式如何被“计算”或“简化”。最重要的规则有：\na. α-变换 (Alpha Conversion / α-renaming) α-变换指的是，在不改变函数行为的前提下，可以对函数定义中的绑定变量（即参数名）进行重命名。\n例如，以下两个函数定义是完全等价的：\n1 (lambda (x) (+ x 1)) 和\n1 (lambda (y) (+ y 1)) （用传统符号表示即 $\\lambda x.x+1$ 等价于 $\\lambda y.y+1$）\n只要新的参数名不与函数体内的自由变量（即那些不是由当前 lambda 定义的参数，而是来自外部作用域的变量）冲突，这种重命名就是有效的。α-变换告诉我们，参数的具体名字是什么并不重要，重要的是函数的结构和行为。\nb. β-规约 (Beta Reduction) β-规约是 λ 演算的“引擎”，它描述了函数应用（调用）是如何执行的，其本质就是代入 (substitution)。\n当一个形如 ((lambda (v) E_body) E_arg) 的表达式出现时（即一个 lambda 函数紧接着被一个参数应用），β-规约允许我们将函数体 E_body 中所有出现的绑定变量 v 都替换成实际参数 E_arg 的（经过求值的）副本。\n例如，对于表达式：\n1 ((lambda (x) (+ x 1)) 5) 根据 β-规约：\n找到 lambda 的参数 x 和函数体 (+ x 1)。 找到实际传入的参数 5。 将函数体 (+ x 1) 中的所有（自由出现的）x 替换为 5。 得到新的表达式：(+ 5 1)。 在 Scheme 环境下，这个表达式 (+ 5 1) 会被进一步求值为 6。β-规约是实现计算的核心步骤。\nc. η-变换 (Eta Conversion / η-reduction) η-变换表达了函数外延性的概念：如果两个函数对于所有可能的输入都产生相同的结果，那么它们就是等价的。\n形式上，如果 F 是一个函数，且变量 x 在 F 中不是自由变量 (not free in F)，那么： (lambda (x) (F x)) 等价于 F。 （用传统符号表示即 $\\lambda x.(F\\;x)$ 等价于 $F$，如果 $x \\notin FV(F)$）\n这意味着，如果一个函数的唯一作用就是将其参数传递给另一个函数 F 并返回结果，那么这个外层包裹的函数实际上就是 F 本身。\n例如，如果我们有函数 inc (定义为 (lambda (z) (+ z 1)))，那么： (lambda (y) (inc y)) 就 η-等价于 inc 本身。\nα-变换、β-规约和（可选的）η-变换共同构成了 λ 演算的计算基础。对于构建我们的计算体系而言，β-规约是最直接相关的“执行”规则。\n柯里化 (Currying)：用一元函数模拟多元函数 你可能已经注意到，在纯粹的 λ 演算定义中，函数抽象（lambda）一次只绑定一个参数。例如我们前面看到的 (lambda (x) x)（$\\lambda x.x$）或 (lambda (x) (+ x 1))（$\\lambda x.x+1$）。那么，我们如何表示需要多个参数的函数呢，比如一个计算两数之积的函数，直觉上可能会写成类似 (lambda (x y) (* x y))（或 $\\lambda xy. x \\times y$）的形式？\n在纯粹的 λ 演算中，函数严格来说只接受一个参数。但是，通过一种称为柯里化 (Currying) 的巧妙技巧（以逻辑学家哈斯凯尔·柯里命名），我们可以用这些一元函数来优雅地实现多元函数的效果。\n这里的关键在于 λ 演算中的一个核心特性：函数是“一等公民”。这意味着函数可以作为参数传递给其他函数，也可以作为其他函数的返回值。能够接受函数作为参数或返回函数的函数，我们称之为高阶函数 (Higher-Order Functions)。\n柯里化的思想很简单： 要模拟一个接受多个参数（比如 n 个）的函数，我们可以：\n定义一个一元函数，它接受第一个参数。 这个函数返回一个新的一元函数，这个新函数接受第二个参数。 这个新函数又返回一个更新的一元函数，接受第三个参数\u0026hellip; 如此往复，直到所有 n 个参数都被逐个接受。最后一个返回的函数才会最终计算并返回结果。 让我们看一个例子。假设我们想实现一个两数相乘的函数 multiply(x, y)。通过柯里化，它可以表示为：\n$\\lambda x . (\\lambda y . x \\times y)$\n在 Scheme 中，这对应于：\n1 2 3 (lambda (x) (lambda (y) (* x y))) 这个表达式做了什么？\n它首先定义了一个匿名函数，接受参数 x。 当这个函数被调用（比如传入 3）时，它并不会立即计算乘积，而是返回另一个新的匿名函数。这个新的函数“记住”了 x 的值（比如 3），并且它接受一个参数 y。 当这个返回的新函数被调用（比如传入 4）并传入 y 的值时，它才会执行 (* x y)（即 (* 3 4)），返回最终结果 12。 我们如何使用这个柯里化的乘法函数呢？\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 ; 定义柯里化的乘法函数 (define curried-mult (lambda (x) (lambda (y) (* x y)))) ; 应用第一个参数 (define times-three (curried-mult 3)) ; (curried-mult 3) 返回的是 (lambda (y) (* 3 y)) ; times-three 现在就是这个新函数 ; 应用第二个参数 (display (times-three 5)) ; 输出 15 ; 或者一步到位地调用 (display ((curried-mult 3) 5)) ; 输出 15 通过柯里化，我们成功地用一系列只接受单个参数的函数模拟了多参数函数的功能。这在 λ 演算的理论框架中至关重要，因为它表明仅用一元函数就足以表达所有计算。在很多函数式编程语言中，虽然它们可能提供了直接定义多参数函数的语法，但其底层有时就是通过柯里化来实现或解释的，或者柯里化本身就是一种推荐的编程范式。\n一层又一层抽象：构建复杂性的阶梯 计算机科学与工程的伟大之处，很大程度上在于其精妙的抽象分层 (Layers of Abstraction)。我们从最底层的物理现象开始：\n我们抽象晶体管的行为，得到逻辑门（与门、或门、非门）。 我们抽象逻辑门的组合，得到算术逻辑单元 (ALU)、存储单元等。 我们抽象这些硬件组件的协同工作，得到完整的计算机体系结构。 然后，我们抽象硬件的细节，得到机器语言。 我们进一步抽象机器语言，得到汇编语言和指令集架构 (ISA)。 再往上，我们抽象汇编指令，得到C、Java、Python等高级编程语言，它们提供了更接近人类思维的表达方式。 甚至在高级语言内部，我们也会构建库、框架，提供更高层次的抽象来解决特定领域的问题。 每一层都依赖于其下一层提供的功能，同时向上一层隐藏了不必要的复杂细节。这使得我们能够专注于当前层次的问题，而不必每次都从最原始的元素（比如电子的运动）开始思考。\n在本文探索 λ 演算和丘奇编码的旅程中，我们也将采用类似的方法。 一旦我们成功地用 λ 演算定义了一个概念（比如布尔值、数字或某个运算），在后续的构造中，我们就会把它当作一个已知的、可以直接使用的“基本构建块”或“新定义的原语 (primitive)”。 我们不会在每次使用时都将其完全展开回最原始的 lambda 表达式形态（除非为了阐释特定原理）。\n例如，一旦我们用 λ 表达式定义了数字 ZERO、ONE 和加法运算 ADD：\n在讨论乘法时，我们就可以直接写 (ADD ONE ONE) 来表示 1+1，而不需要把 ADD, ONE 都展开成它们底层的 lambda 定义。 这样做可以让我们保持思路清晰，逐步构建更复杂的系统，而不至于迷失在无尽的 lambda 嵌套中。\n现在，我们已经了解了 λ 演算的基本规则和柯里化这一重要技巧（它让我们能方便地处理多“参数”的函数），是时候开始用这些积木搭建我们计算世界的第一块基石了！\n构建数学与计算体系的开始：基本元素 正如我们之前讨论的，纯粹的 λ 演算只拥有函数抽象（定义函数）和函数应用（调用函数）这两个基本构建块。我们日常编程中习以为常的“数字”、“自然数”、“加法运算”，乃至“字符”、“布尔值”（真/假）等等，在 λ 演算的原始宇宙中并不直接存在。\n显然，如果缺少这些基本的数据类型和运算，我们很难用常规的思路来编写程序。\n然而，λ 演算的强大之处在于，我们可以完全利用其自身的体系来构造出这些常用的对象。换句话说，我们可以为这些概念找到它们在 λ 演算世界中的函数式对应物 (functional counterparts)。\n这个将数据类型和运算用纯函数来表达和实现的过程，正是丘奇编码 (Church Encoding) 的核心思想，由阿隆佐·丘奇本人开创。\n让我们从最基本、也可能是最简单的概念开始：布尔值 (Booleans)。\n布尔值 (Booleans) 与逻辑运算 布尔逻辑是计算的基石，它处理的是“真”与“假”这两个基本值。在丘奇编码中，这两个值被巧妙地定义为两个不同的选择函数：\ntrue 被定义为一个函数，它接受两个参数，并总是选择并返回第一个参数。 $$ true := \\lambda t . \\lambda f . t $$ 或者，使用我们之前约定的 Scheme 多参数函数抽象（内部通过柯里化实现）：\n1 (define true (lambda (t f) t)) false 被定义为一个函数，它接受两个参数，并总是选择并返回第二个参数。 $$ false := \\lambda t . \\lambda f . f $$ 1 (define false (lambda (t f) f)) 这两个定义的神奇之处在于，它们内在地编码了条件选择的行为，这正是 if-then-else 语句的核心！ 如果我们有一个丘奇布尔值 condition，以及两个表达式 then-expr 和 else-expr，那么： (condition then-expr else-expr) 这个表达式本身就会根据 condition 是 true 还是 false 来求值：\n如果 condition 是 true，例如 (true \u0026quot;苹果\u0026quot; \u0026quot;香蕉\u0026quot;)，它会返回 \u0026quot;苹果\u0026quot; (第一个参数)。 如果 condition 是 false，例如 (false \u0026quot;苹果\u0026quot; \u0026quot;香蕉\u0026quot;)，它会返回 \u0026quot;香蕉\u0026quot; (第二个参数)。 有了 true 和 false 这两个基本构建块，我们就可以定义出标准的逻辑运算符：\n逻辑非 (NOT): (not x) not 应该将 true 变为 false，将 false 变为 true。 我们可以这样定义 not：\n1 2 3 4 5 (define (not x) ; x 是一个选择函数，它会从后面两个参数中选一个 ; 如果 x 是 true, 它选择第一个参数 (false)。 ; 如果 x 是 false, 它选择第二个参数 (true)。 (x false true)) 验证：\n(not true) 会展开为 (true false true)，根据 true 的定义，返回 false。 (not false) 会展开为 (false false true)，根据 false 的定义，返回 true。 逻辑与 (AND): (and p q) p AND q 为真，当且仅当 p 和 q 都为真。\n1 2 3 4 (define (and p q) ; 如果 p 是 true，则 AND 的结果取决于 q (实际上是 q 本身) ; 如果 p 是 false，则 AND 的结果一定是 false (p q false)) ; 注：这里 q 必须也是一个丘奇布尔值 解释：\n如果 p 是 true：表达式变为 (true q false)。true 选择第一个参数，即 q。所以 (and true q) 的结果就是 q。 若 q 是 true，结果是 true。 若 q 是 false，结果是 false。 如果 p 是 false：表达式变为 (false q false)。false 选择第二个参数，即 false。所以 (and false q) 的结果总是 false。 这完全符合 AND 的逻辑。 (你原文中的 (p (q true false) false) 也是完全正确的，它更明确地将 q 的结果约束在 true 或 false 上，如果 q 本身已经是丘奇布尔值， (q true false) 就等价于 q。) 逻辑或 (OR): (or p q) p OR q 为真，只要 p 或 q 中至少一个为真。\n1 2 3 4 (define (or p q) ; 如果 p 是 true，则 OR 的结果一定是 true ; 如果 p 是 false，则 OR 的结果取决于 q (实际上是 q 本身) (p true q)) ; 注：这里 q 必须也是一个丘奇布尔值 解释：\n如果 p 是 true：表达式变为 (true true q)。true 选择第一个参数，即 true。所以 (or true q) 的结果总是 true。 如果 p 是 false：表达式变为 (false true q)。false 选择第二个参数，即 q。所以 (or false q) 的结果就是 q。 若 q 是 true，结果是 true。 若 q 是 false，结果是 false。 这完美符合 OR 的逻辑。 (同样，你原文的 (p true (q true false)) 也是正确的。) 阿隆佐·丘奇选择用“选择函数”来代表布尔值，这无疑是一个天才般的洞察。“选择”这一行为完美地概括了我们通常使用布尔值所做的核心操作——基于条件做出决策——这也使得后续逻辑运算的定义变得异常简洁和优雅。我们仅仅通过函数定义和应用，就凭空创造出了逻辑系统！\n小扩展：更直观的 if 结构 既然我们的丘奇布尔值 true 和 false 本身就是选择函数，我们自然可以定义一个更符合我们日常编程直觉的 if 控制结构。这个 if 函数将接受三个参数：一个条件 (丘奇布尔值)，一个“then”分支的表达式，以及一个“else”分支的表达式。\n1 2 (define (if-then-else condition then-branch else-branch) (condition then-branch else-branch)) 你可能会问，这和直接写 (condition then-branch else-branch) 有什么本质区别呢？确实，通过我们前面讨论过的 η-变换 (Eta Conversion)，(lambda (c t e) (c t e)) 其实就等价于一个直接接受 c, t, e 并应用的结构（在Scheme中，多参数函数可以看作是柯里化的一种语法糖）。 然而，定义这样一个 if-then-else 函数的好处在于：\n可读性： (if-then-else hungry? (eat food) (sleep)) 比 (hungry? (eat food) (sleep)) 更明确地表达了条件判断的意图，尤其是当 hungry? 本身也是一个复杂表达式时。 抽象的体现： 它再次强调了我们可以通过函数封装来构建我们熟悉的编程构造。这更像是一种“语法糖”，它向我们展示了如何将底层的函数式构造包装成更易读、更符合特定编程范式的形式。 这再次提醒我们，λ 演算的表达能力是灵活的，我们可以基于核心规则构建出我们需要的抽象层次。\n自然数 (Natural Numbers)：函数的重复应用 继布尔值之后，下一个重要的基石是自然数 (Natural Numbers)，如 0, 1, 2, \u0026hellip; 与布尔值通过“选择”来定义不同，自然数的丘奇编码抓住的是“重复”或“迭代”这一核心概念。\n阿隆佐·丘奇的天才之处在于他意识到，数字可以被表示为高阶函数，其含义是“一个函数被应用的次数”。\n具体来说，一个丘奇数 n 是一个函数，它接受两个参数：\n一个函数 f (代表要被重复应用的操作)。 一个初始值 x (代表该操作的起点，或者说被操作的对象)。 这个丘奇数 n 会将 f 应用到 x 上恰好 n 次。\n“重复应用 n 次”如何用纯函数定义呢？ 我们没有循环语句，也没有内置的计数器。 答案在于巧妙地利用函数本身的结构，类似于数学中从 0 和后继操作构建自然数的皮亚诺公理 (Peano Axioms)。\n数字 零 (ZERO) 数字 零 (ZERO) 就代表“将函数 f 应用零次”。这意味着无论 f 是什么，初始值 x 都原封不动地返回。 其定义如下： $$ ZERO := \\lambda f . \\lambda x . x $$ 在 Scheme 中：\n1 2 3 4 (define ZERO (lambda (f) ; ZERO 接受一个函数 f (lambda (x) ; 并返回一个新的函数，这个新函数接受 x x))) ; 然后直接返回 x (f 应用了0次) 这里的 ZERO 是一个柯里化的函数。它首先接受一个函数 f，然后返回另一个函数。这个内部函数接受初始值 x 并直接返回 x，完美体现了 f 被应用了零次。\n例如，如果我们有一个函数 inc (加一) 和一个值 10： ((ZERO inc) 10)\n(ZERO inc) 会返回 (lambda (x) x) （因为 f 是 inc，但没有被使用）。 然后 ((lambda (x) x) 10) 会返回 10。 这正是我们期望的“对 10 加一 0 次”的结果。 后继函数 (Successor Function, S) 有了 ZERO，我们如何得到其他数字呢？我们需要一个后继函数 (Successor Function)，通常表示为 S。S 接受一个丘奇数 n 作为输入，并返回代表 n+1 的丘奇数。\n如果丘奇数 n 代表“将 f 应用 n 次”，那么 (S n)（即 n+1）就应该代表“将 f 应用 n+1 次”。 这可以这样理解：要将 f 应用 n+1 次到 x 上，我们可以先将 f 应用 n 次到 x 上得到一个中间结果，然后再对这个中间结果额外应用一次 f。\n形式化地，后继函数 S 定义为： $$ S := \\lambda n . \\lambda f . \\lambda x . f ( (n f) x ) $$ 在 Scheme 中：\n1 2 3 4 5 6 (define S (lambda (n) ; S 接受一个丘奇数 n (lambda (f) ; 返回一个新函数 (代表 n+1)，它接受 f (lambda (x) ; 再返回一个新函数，它接受 x (f ; 将 f 应用于... ((n f) x)))))) ; ...n 将 f 应用于 x 的结果 让我们仔细解读一下 S 的定义：\nS 接受一个丘奇数 n (例如 ZERO)。 它返回一个新的函数，这个函数就是代表 n+1 的丘奇数。这个新函数也遵循丘奇数的规范，所以它也期望接受一个函数 f 和一个值 x。 当这个代表 n+1 的函数被 f 和 x 调用时，它的行为是 (f ((n f) x))： (n f): 首先，我们将输入的丘奇数 n 应用于 f。回忆一下，丘奇数 n 本身是 (lambda (f_inner) (lambda (x_inner) ...)) 的形式。所以 (n f) 会返回一个“准备好对某个 x_inner 应用 f_inner（这里是 f）n 次”的函数。 ((n f) x): 接着，我们将上面返回的函数应用于 x。这就完成了 f 在 x 上的 n 次应用。 (f ((n f) x)): 最后，我们将 f 再额外应用一次到 ((n f) x) 的结果上。这就构成了 f 的 n+1 次应用。 这种从 ZERO 和后继函数 S 出发来构造所有自然数的方法，其思想与数学中的皮亚诺公理 (Peano Axioms) 定义自然数的方式高度相似（皮亚诺公理：① 0 是自然数；② 每个自然数 a 都有一个后继数 S(a)；\u0026hellip;）。\n现在，我们可以定义其他数字了：\nONE 就是 (S ZERO) TWO 就是 (S ONE)，也就是 (S (S ZERO)) THREE 就是 (S TWO)，也就是 (S (S (S ZERO)))\n等等。 例如，ONE 的展开会是：\n1 2 3 4 5 6 7 8 9 (define ONE (S ZERO)) ;; ONE 展开为： ;; (lambda (f) ;; (lambda (x) ;; (f ((ZERO f) x)))) ;; 由于 ((ZERO f) x) 会返回 x，所以 ONE 进一步简化为： ;; (lambda (f) ;; (lambda (x) ;; (f x))) 这完美符合“将 f 应用一次到 x”的定义。\n同样，TWO 会展开为 (lambda (f) (lambda (x) (f (f x))))，即 f 应用两次。\n通过 ZERO 和 S，我们已经用纯粹的函数构建了整个自然数体系的“骨架”！下一步，我们将探索如何在这些丘奇数上进行算术运算，比如加法和乘法。\n算术运算 (Arithmetic Operations): 加法与乘法 有了代表自然数的丘奇编码，我们自然想在它们之上定义算术运算，比如加法和乘法。\n熟悉皮亚诺公理 (Peano Axioms) 的朋友可能还记得它们是如何递归定义加法和乘法的：\n加法: 对于任意自然数 $m$, $m + 0 = m$ 对于任意自然数 $m$ 和 $n$, $m + S(n) = S(m+n)$ (其中 $S(n)$ 是 $n$ 的后继，即 $n+1$) 乘法: 对于任意自然数 $m$, $m \\times 0 = 0$ 对于任意自然数 $m$ 和 $n$, $m \\times S(n) = (m \\times n) + m$ 直接将这些递归定义转换为纯 λ 演算（尤其是没有显式递归操作符如 Y 组合子的情况下）会有些棘手，特别是处理像 $S(n)$ 这样需要“分解”参数的模式，或者找到一个数的前驱。\n幸运的是，丘奇编码的本质——“将一个函数应用特定次数”——为我们提供了一条更直接、更优雅的路径。\n加法 (Addition): m + n 思考一下加法 m + n 的含义：它可以被看作是从数字 m 开始，连续应用“加一”（即后继函数 S）操作 n 次。\n这完美契合了丘奇数 n 的定义！回忆一下，丘奇数 n 是一个函数 (lambda (f) (lambda (x) ...))，它会将 f 应用到 x 上 n 次。\n我们想要应用的操作是“后继”函数 S。 我们想要应用这个操作的起点是丘奇数 m。 我们想要应用它的次数是 n 次。 所以，m + n 可以通过将丘奇数 n 应用于后继函数 S 和初始值 m 来实现： ((n S) m)\n因此，我们可以定义一个柯里化的加法函数 PLUS (或者叫 ADD)： $$ PLUS := \\lambda m . \\lambda n . ( (n S) m ) $$ 在 Scheme 中：\n1 2 3 4 (define PLUS (lambda (m) ; PLUS 接受第一个加数 m (lambda (n) ; 返回一个函数，该函数接受第二个加数 n ((n S) m)))) ; 将 S 应用到 m 上 n 次 让我们来验证一下 (PLUS ONE TWO) 是否等于 THREE：\nPLUS 应用于 ONE：(PLUS ONE) 返回 (lambda (n) ((n S) ONE))。 将此结果应用于 TWO：(((lambda (n) ((n S) ONE)) TWO)) 这会进行 β-规约，得到 ((TWO S) ONE)。 现在我们展开 TWO。TWO 是 (lambda (f) (lambda (x) (f (f x))))。 所以 (TWO S) 返回 (lambda (x) (S (S x)))。 最后，((lambda (x) (S (S x))) ONE) 应用于 ONE： 这得到 (S (S ONE))。 根据后继函数的定义，这正是 THREE！ 加法的定义就是如此简洁！它直接利用了丘奇数 n 作为“迭代器”的特性。\n乘法 (Multiplication): m × n 乘法 m × n 又如何用类似的思想表达呢？ 它可以被看作是将“加 m”这个操作，应用 n 次，并且从 ZERO 开始累加。 也就是说： $m \\times n = \\underbrace{m + m + \\dots + m}_{n \\text{ times}}$。\n我们想要重复应用的操作是 “将 m 加到某个数上”。这个操作本身可以用我们刚定义的 PLUS 来表示：(PLUS m)。回忆一下，(PLUS m) 是一个函数，它接受一个参数 k 并返回 m+k (即 ((k S) m))。 我们想要应用这个操作的起点是 ZERO。 我们想要应用它的次数是 n 次。 所以，m × n 可以通过将丘奇数 n 应用于“加 m”这个函数 (PLUS m) 和初始值 ZERO 来实现： ((n (PLUS m)) ZERO)\n因此，柯里化的乘法函数 TIMES (或者叫 MULTIPLY) 定义为： $$ TIMES := \\lambda m . \\lambda n . ( (n (PLUS \\ m)) ZERO ) $$ 在 Scheme 中：\n1 2 3 4 5 (define TIMES (lambda (m) ; TIMES 接受第一个乘数 m (lambda (n) ; 返回一个函数，该函数接受第二个乘数 n ((n (PLUS m)) ; 将 (PLUS m) 这个“加m”的函数... ZERO)))) ; ...应用 n 次到 ZERO 上 这里的 (PLUS m) 是一个函数，它等待另一个参数 k 来计算 m+k。丘奇数 n 正好可以将这个“加 m”的函数重复作用。\n例如，思考 (TIMES TWO THREE):\n(TIMES TWO) 返回 (lambda (n) ((n (PLUS TWO)) ZERO))。 将其应用于 THREE： ((THREE (PLUS TWO)) ZERO)。 THREE 会将 (PLUS TWO) 这个函数应用 3 次到 ZERO 上： 第一次：((PLUS TWO) ZERO) 结果是 TWO (0 + 2 = 2) 第二次：((PLUS TWO) TWO) 结果是 FOUR (2 + 2 = 4) (假设我们已经定义了 FOUR) 第三次：((PLUS TWO) FOUR) 结果是 SIX (4 + 2 = 6) (假设我们已经定义了 SIX) 这正是 $2 \\times 3 = 6$。 通过这些定义，我们看到丘奇编码不仅能表示数字，还能以一种非常优雅和本质的方式来定义它们之间的运算，这一切都仅仅建立在函数抽象和应用之上！\n进入更深层次的构造：比较与减法 我们已经成功地用纯函数定义了布尔逻辑、自然数以及基本的加法和乘法运算。这本身已经是一个了不起的成就，展示了 $\\lambda$ 演算惊人的表达能力。现在，我们将继续沿着这条道路前进，构建更复杂的计算工具，首当其冲的是如何比较两个数字，以及如何定义减法。\n正如你可能预料到的，这些操作的定义会比加法和乘法稍微复杂一些，它们需要我们更深入地挖掘丘奇编码的潜力，并引入一些新的辅助函数。\n减法 · 引入 按照四则运算的顺序，接下来我们要构造的就是减法，它是加法的逆运算。\n面对这个问题，你第一时间的想法是什么？很有可能你会想到“前驱函数”（即找到 $n-1$），然后思考“如何从 $n$ 次函数应用中去除一次”。\n这听起来似乎直接，例如通过求反函数。然而，并非所有函数都拥有反函数，且求取反函数本身也相当复杂。我们需要另辟蹊径。\n从“加法的逆运算”这个角度思考 $n-m$：我们是否可以枚举一个数 $k$ (从 $0$ 到 $n$)，检查 $k+m$ 是否等于 $n$？如果相等，则 $k$ 就是 $n-m$ 的值。如果找不到这样的 $k$，则 $n-m$ 在自然数内无解。\n然而，这又引入了一个新问题：我们如何判断两个丘奇数是否“相等”？这是一个我们尚未定义的关键谓词。\n有人可能会说：“如果 $n-m=0$，那么 $n$ 不就等于 $m$ 了吗？”或者“如果 $n \\ge m$ 且 $n \\le m$，那么 $n=m$。” 但这又会使我们陷入对减法或比较运算的循环定义中。\n别担心，我们将逐步解决这些问题。\n判断是否为零 (ZERO?)：一个重要的边界条件 要判断任意两个自然数是否相等，或者进行更复杂的算术运算，我们至少需要能够判断一个数是否为零。这是许多递归定义和条件判断的基础。\n我们可以通过以下方式巧妙地定义 ZERO? 谓词： $$ \\text{ZERO? predicated} := \\lambda n . (n \\ (\\lambda x . \\text{FALSE})) \\ \\text{TRUE} $$ 在 Scheme 中：\n1 2 3 (define ZERO? (lambda (n) ((n (lambda (x) FALSE)) TRUE))) 这个定义的巧妙之处在于它利用了丘奇数自身的特性：\n回忆一下，丘奇数 ZERO 定义为 $ \\lambda f . \\lambda x . x $。\n如果参数 n 是 ZERO，那么 (ZERO (lambda (x) FALSE)) 会忽略掉 (lambda (x) FALSE) 这个函数，直接返回一个恒等函数 $ \\lambda y . y $。\n于是整个表达式 (ZERO? ZERO) 变为 ((lambda (y) y) TRUE)，其结果自然是 TRUE。\n如果参数 n 是一个非零的丘奇数（比如 ONE, TWO, \u0026hellip;），它代表将第一个参数（一个函数）应用若干（非零）次。\n那么 (n (lambda (x) FALSE)) 意味着将 (lambda (x) FALSE) 这个“无论输入是什么都返回 FALSE”的函数至少应用一次到某个初始值上。其最终效果是得到一个“总是返回 FALSE”的函数（可以认为是 $ \\lambda y . \\text{FALSE} $）。\n于是整个表达式 (ZERO? n)（当 n 非零时）变为 ((\\lambda y . FALSE) TRUE)，其结果便是 FALSE。\n这样，我们就得到了一个可靠的 ZERO? 测试。\n构造数据结构的基础——丘奇对 (Church Pairs) 在定义更复杂的操作（如前驱函数）之前，我们需要一种方式来将两个值组合成一个单一的复合数据单元。丘奇对 (Church Pairs) 提供了这样的机制，它类似于许多编程语言中的 pair 或二元元组。\n一个丘奇对通过一个高阶函数来表示，这个高阶函数接受一个“选择器”函数作为参数。当我们用两个值 a 和 b 构造一个序对时，这个序对函数会“包裹”住 a 和 b。当它被一个选择器函数 s 调用时，它会将 a 和 b 传递给 s，即执行 (s a b)。\n构造序对的函数 CONS 定义如下： $$ \\text{CONS} := \\lambda a . \\lambda b . \\lambda s . (s \\ a \\ b) $$ 在 Scheme 中：\n1 2 3 4 5 (define CONS (lambda (first-element) (lambda (second-element) (lambda (selector-function) (selector-function first-element second-element))))) 要从序对中提取元素，我们需要合适的选择器。丘奇布尔值 TRUE ($\\lambda t . \\lambda f . t$) 和 FALSE ($\\lambda t . \\lambda f . f$) 正好可以胜任：\nCAR (获取第一个元素): $$ \\text{CAR} := \\lambda p . (p \\ \\text{TRUE}) $$ 1 2 3 (define CAR (lambda (a-church-pair) (a-church-pair TRUE))) CDR (获取第二个元素): $$ \\text{CDR} := \\lambda p . (p \\ \\text{FALSE}) $$ 1 2 3 (define CDR (lambda (a-church-pair) (a-church-pair FALSE))) 丘奇对是构建更复杂数据结构（如列表）和实现某些算法（如下文的前驱函数）的关键。\n前驱函数 (PRED)：寻找 $n-1$ 前驱函数 PRED 的目标是计算 $n-1$。对于丘奇数 ZERO，其前驱仍然是 ZERO (即 $ \\text{PRED ZERO} = \\text{ZERO} $ )。\n直接从丘奇数“减去”一次函数应用是困难的。但我们有一个巧妙的思路：考虑一个序列，例如 $ (0, 0, 1, 2, 3, \\dots) $。如果我们能通过某种方式定位到这个序列的第 $n$ 项（0-indexed），那么这一项的值恰好是 $n$ 的前驱（当 $n=0$ 时为 $0$，当 $n=1$ 时为 $0$，当 $n=2$ 时为 $1$，以此类推）。\n我们不必实际构造一个无穷列表。关键在于定义一个状态转换函数，该函数接受当前状态（一个序对），并返回序列中的下一个状态。丘奇数 $n$ 可以将这个状态转换函数应用 $n$ 次。\n我们将状态表示为一个序对 (current-predecessor-value, flag):\ncurrent-predecessor-value：表示当前计算到的前驱值。 flag：一个状态标记。ZERO 表示这是迭代的初始步骤（对应输入数字 0 或 1 的情况），ONE 表示是后续的常规步骤。 初始状态为 (CONS ZERO ZERO)。 状态转换函数 PHI_PRED_STEP 定义为： $$ \\Phi_{\\text{PRED\\_STEP}} := \\lambda p . (\\text{ZERO?} \\ (\\text{CDR}\\ p)) \\ (\\text{CONS}\\ \\text{ZERO}\\ \\text{ONE}) \\ (\\text{CONS}\\ (\\text{S}\\ (\\text{CAR}\\ p))\\ \\text{ONE}) $$ 在 Scheme 中：\n1 2 3 4 5 (define PHI_PRED_STEP (lambda (p) ; p 是形如 (current-predecessor-value, flag) 的序对 ((ZERO? (CDR p)) ; 检查 flag 是否为 ZERO (CONS ZERO ONE) ; 如果是，下一个状态是 (ZERO, ONE) (CONS (S (CAR p)) ONE)))) ; 否则，下一个状态是 (S current-predecessor-value, ONE) 这个转换逻辑是：\n如果 flag 是 ZERO（初始状态，意味着我们正在处理输入为 ZERO 或 ONE 的情况的“第一步迭代”）：下一个状态的 current-predecessor-value 保持 ZERO，并将 flag 置为 ONE。 如果 flag 是 ONE（后续状态）：下一个状态的 current-predecessor-value 是前一个值的后继 (S (CAR p))，flag 保持 ONE。 有了初始状态和转换函数，PRED n 就是将 PHI_PRED_STEP 应用 $n$ 次到初始状态 (CONS ZERO ZERO) 上，然后取结果序对的第一个元素： $$ \\text{PRED} := \\lambda n . \\text{CAR} \\ (n \\ \\Phi_{\\text{PRED\\_STEP}} \\ (\\text{CONS ZERO ZERO})) $$ 在 Scheme 中：\n1 2 3 (define PRED (lambda (n) (CAR ((n PHI_PRED_STEP) (CONS ZERO ZERO))))) 让我们验证一下：\n(PRED ZERO): PHI_PRED_STEP 应用 0 次，结果是 (CAR (CONS ZERO ZERO)) 即 ZERO。 (PRED ONE): 初始状态 p0 = (CONS ZERO ZERO)。 应用一次 PHI_PRED_STEP: (PHI_PRED_STEP p0)。因为 (CDR p0) 是 ZERO，所以结果是 p1 = (CONS ZERO ONE)。 (CAR p1) 是 ZERO。所以 (PRED ONE) 是 ZERO。 (PRED TWO): p0 = (CONS ZERO ZERO)。 第一次应用得到 p1 = (CONS ZERO ONE)。 第二次应用 (PHI_PRED_STEP p1)。因为 (CDR p1) 是 ONE (非 ZERO)，所以结果是 p2 = (CONS (S (CAR p1)) ONE) = (CONS (S ZERO) ONE) = (CONS ONE ONE)。 (CAR p2) 是 ONE。所以 (PRED TWO) 是 ONE。 这完美地实现了前驱函数的功能。\n减法 · 截断减法 (SUB) 有了前驱函数 PRED，定义减法就变得直接了。我们要实现的是截断减法 (Truncating Subtraction)，即 $m-n$。如果 $m \\ge n$，结果是 $m-n$；如果 $m \u003c n$，结果是 $0$（因为我们只处理自然数）。\n$m-n$ 可以看作是对 $m$ 重复应用 PRED 函数 $n$ 次。 $$ \\text{SUB} := \\lambda m . \\lambda n . (n \\ \\text{PRED} \\ m) $$ 在 Scheme 中：\n1 2 3 4 (define SUB (lambda (m) (lambda (n) ((n PRED) m)))) ; 计算 m - n 例如 (SUB FIVE TWO) 会将 PRED 应用 2 次到 FIVE 上，得到 THREE。而 (SUB TWO FIVE) 会得到 ZERO。\n关系运算符 基于 SUB 和 ZERO?，我们可以构建各种关系运算符：\n小于或等于 (IS_LEQ?): $m \\le n$ 当且仅当 $m-n = 0$ (在截断减法中)。 $$ \\text{IS\\_LEQ?} := \\lambda m . \\lambda n . \\text{ZERO?} \\ (\\text{SUB}\\ m \\ n) $$ 1 2 3 4 (define IS_LEQ? (lambda (m) (lambda (n) (ZERO? (SUB m n))))) 大于 (IS_GT?): $m \u003e n$ 当且仅当 $m-n \\neq 0$ (且 $m-n \u003e 0$)，也即 $m \\not\\le n$。 $$ \\text{IS\\_GT?} := \\lambda m . \\lambda n . \\text{NOT} \\ (\\text{IS\\_LEQ?}\\ m \\ n) $$ 或者，更直接地：$m \u003e n$ 当且仅当 $m-n$ 的结果不是 $ZERO$ (在我们的自然数和截断减法定义下，这意味着 $m-n$ 是一个正数)。 $$ \\text{IS\\_GT?}_{\\text{alt}} := \\lambda m . \\lambda n . \\text{NOT} \\ (\\text{ZERO?} \\ (\\text{SUB}\\ m \\ n)) $$ (注：使用 $\\text{IS\\_GT?}_{\\text{alt}}$ 定义，则 $m\u003en$ 为真。若 $m \\le n$, $\\text{SUB}\\ m\\ n$ 为 $\\text{ZERO}$, $ZERO?$ 为 $\\text{TRUE}$, $\\text{NOT}$ 为 $\\text{FALSE}$)\n等于 (IS_EQ?): $m = n$ 当且仅当 $m \\le n$ 并且 $n \\le m$。 $$ \\text{IS\\_EQ?} := \\lambda m . \\lambda n . \\text{AND} \\ (\\text{IS\\_LEQ?}\\ m \\ n) \\ (\\text{IS\\_LEQ?}\\ n \\ m) $$ 1 2 3 4 (define IS_EQ? (lambda (m) (lambda (n) (AND (IS_LEQ? m n) (IS_LEQ? n m))))) 另一种思路是：$m=n$ 当且仅当 $m-n=0$ 且 $n-m=0$。所以 $(\\text{SUB } m n)$ 和 $(\\text{SUB } n m)$ 都必须是 ZERO。\n小于 (IS_LT?): $m \u003c n$ 当且仅当 $n \u003e m$。 $$ \\text{IS\\_LT?} := \\lambda m . \\lambda n . \\text{IS\\_GT?}\\ n \\ m $$ 或者 $m \u003c n$ 当且仅当 $m \\not\\ge n$ (即 $\\neg(n \\le m)$)。 $$ \\text{IS\\_LT?}_{\\text{alt}} := \\lambda m . \\lambda n . \\text{NOT} \\ (\\text{IS\\_LEQ?}\\ n \\ m) $$ 大于或等于 (IS_GEQ?): $m \\ge n$ 当且仅当 $n \\le m$。 $$ \\text{IS\\_GEQ?} := \\lambda m . \\lambda n . \\text{IS\\_LEQ?}\\ n \\ m $$ 通过这些定义，我们已经构建了一套完整的基于丘奇编码的自然数关系运算。\n一点关于时间复杂度分析与计算模型的声明 我们发现，刚刚实现的算术运算（尤其是乘法、前驱、减法）的过程，如果完全展开成 $\\beta$-规约，其步骤数会相当可观，效率较低。但是，$\\lambda$ 演算主要是一个用于研究计算理论、证明计算完备性的数学工具，其直接实现的效率并非首要考量。在实际编程中，我们当然会使用硬件直接支持的、高度优化的原生数字类型和运算。\n如果追求“高效的算术”，我们可以探索例如二进制表示的丘奇数。不过，这会引入显著的复杂性，超出了本文旨在演示如何用 $\\lambda$ 演算构建一个完备计算体系的目标。\n与此相对，我们将采取另一种视角。正如我们在前文“一层又一层抽象”中所讨论的，为了能够清晰地构建和分析更复杂的算法，我们将把这些已经定义的丘奇编码实体（如 ZERO, PLUS, IF-THEN-ELSE, PRED, SUB, IS_LEQ? 等）视为我们新的抽象原语 (abstract primitives)。\n在后续的算法讨论和复杂度分析中，除非特别指出，我们将假设对这些抽象原语的一次调用（例如，执行一次 (PLUS church_num1 church_num2) 或一次 (IS_LEQ? church_num1 church_num2))) 构成一个基本计算步骤，其开销计为常数时间 $O(1)$（或者说，我们统计的是这些高级原语被调用的次数）。\n这样做使我们能够专注于算法本身的逻辑和结构，而不必每次都回溯到底层的 $\\lambda$-规约。这与我们在高级编程语言中分析算法时，将整数加法或比较视为 $O(1)$ 操作的做法是相通的。\n我们还缺乏一种重要的算术运算：除法。但是它的实现比较复杂，需要一些额外的工具。在下一节中，我们将引入这些必要的工具。\n递归：让函数调用自身 到目前为止，我们已经用 λ 演算构建了布尔逻辑、自然数、算术运算乃至简单的数据结构（丘奇对）。然而，你可能已经敏锐地注意到，我们似乎还缺少一个在编程中至关重要的工具：循环或迭代。我们用丘奇数 n 实现了将某个操作重复 n 次，但这更像是一个固定次数的 for 循环。对于更一般的情况，比如“当条件满足时重复执行某个操作”（类似 while 循环），或者像阶乘那样需要根据输入值决定计算深度的场景，我们目前的工具还不够。\n在大多数编程语言中，这类重复性的任务通常通过递归（函数调用自身）或循环结构（for, while）来解决。循环结构本质上也可以看作是递归的一种特定模式或语法糖。因此，关键在于如何在 λ 演算这个纯粹的函数世界中实现递归。\n让我们先看看在 Scheme 中，递归是如何轻易实现的。比如，计算阶乘的函数：\n1 2 3 4 5 6 (define (factorial n) (if (= n 0) 1 (* n (factorial (- n 1))))) (factorial 5) ; 计算结果为 120 在这里，define 允许我们将函数命名为 factorial，然后在 factorial 的函数体内部，我们可以再次通过这个名字 factorial 来调用它自身。\n但问题来了：在纯粹的 λ 演算中，函数通常是匿名的。回忆一下，我们定义的 TRUE、ZERO、PLUS 等都是 (lambda (...) ...) 这样的匿名函数，只是为了方便讨论，我们才用 define 给它们起了名字。如果一个函数没有名字，它如何在自己的定义中引用自己呢？这就好比写一封匿名信，却想在信的内容里提及“写这封信的我”——我们该如何指代这个匿名的“我”？\n这正是 λ 演算实现递归所面临的核心挑战。我们需要一种方法，让一个匿名函数能够获得对自身的引用。\n“手动”实现递归：将函数作为参数传递 一种直观的想法是：如果一个函数 g 需要调用自身，我们可以修改 g 的定义，让它多接受一个参数，这个参数就是 g 自身（或者一个行为与 g 等同的函数）。 让我们尝试为一个“准阶乘函数”almost-factorial 这样做。这个 almost-factorial 期望接收一个 self 参数（代表它自己）和一个数字 n：\n1 2 3 4 5 (define almost-factorial (lambda (self n) ; self 是期望中的递归调用 (if (= n 0) 1 (* n (self self (- n 1)))))) ; 注意这里：用 (self self ...) 来进行递归调用 要使用它，我们需要某种方式把 almost-factorial 这个函数本身传递给它自己的第一个参数 self：\n1 (almost-factorial almost-factorial 5) ; 结果是 120 这种模式 (f f x) 有一个专门的名字，叫做 U 组合子（或模拟 U 组合子的行为），即 U f = f f。我们通过 (almost-factorial almost-factorial ...) 使得 almost-factorial 的第一个参数 self 确实是 almost-factorial 本身。在 almost-factorial 内部，当它需要递归调用时，它就调用 (self self (- n 1))，这实际上又变回了 (almost-factorial almost-factorial (- n 1))，递归得以实现！\n这种“将函数自身作为参数传递给自身”的技巧虽然可行，但每次调用时都需要重复写 (f f x) 这样的结构，显得有些笨拙。我们更希望有一个“魔法函数”，能够自动帮我们处理这种“自我引用”的传递。\n不动点组合子：Y 组合子与 Z 组合子 这个“魔法函数”就是不动点组合子 (Fixed-Point Combinator)。在数学中，函数 f 的一个不动点 x 是指满足 f(x) = x 的点。在计算理论中，递归函数可以被看作是某个高阶函数的不动点。\n假设我们有一个函数生成器 G。G 接受一个函数 h（代表递归调用）作为参数，并返回一个新的函数，这个新函数就是我们想要定义的递归函数的“单步版本”。例如，对于阶乘，G 可以这样定义（这里暂时借用 Scheme 的数字和运算以便理解）：\n1 2 3 4 5 6 (define G-factorial (lambda (h) ; h 是用于递归调用的函数 (即阶乘函数本身) (lambda (n) ; 返回的是阶乘函数的一步 (if (= n 0) 1 (* n (h (- n 1))))))) ; 这里用 h 来进行递归调用 我们希望找到一个函数 factorial，使得 factorial 等价于 (G-factorial factorial)。也就是说，factorial 是 G-factorial 这个高阶函数的不动点。\nY 组合子正是这样一个神奇的函数，它能为任何给定的函数生成器 G 找到其不动点。即 (Y G) 会产生一个函数 f_rec，这个 f_rec 满足 f_rec = (G f_rec)。 Y 组合子的经典定义是： $$ Y := \\lambda g . (\\lambda x . g (x \\ x)) (\\lambda x . g (x \\ x)) $$ 在 Scheme 中表示为：\n1 2 3 4 (define Y (lambda (g) ((lambda (x) (g (x x))) (lambda (x) (g (x x)))))) 于是， (Y G-factorial) 就会是上面我们用 define 直接定义的那个 factorial 函数！我们不再需要在调用时手动传递 factorial 给自身了，Y 组合子帮我们完成了这个绑定。\n补充：Y 组合子如何工作：不动点属性的推导\nY 组合子的神奇之处在于它如何构造出这个不动点。让我们手动展开 (Y G) 的求值过程（使用 β-规约）来看看它是如何工作的。\n回顾 Y 组合子的定义：\n1 2 3 4 (define Y (lambda (g) ((lambda (x) (g (x x))) ; 我们将这个内部的 (lambda (x) ...) 称为 omega-maker (lambda (x) (g (x x)))))) ; 这是传递给 omega-maker 的参数，形式与 omega-maker 自身相同 为了方便推导，我们定义一个辅助函数 omega_g (或者叫 make-omega-for-g)，它依赖于 g： omega_g := (lambda (x) (g (x x)))\n那么，Y 组合子可以看作是： Y := (lambda (g) (omega_g omega_g))\n现在，我们将 Y 应用于我们的函数生成器 G： (Y G) 根据 Y 的定义，这会进行一次 β-规约，将 G 替换掉 Y 定义中的 g： (Y G) evaluates-to (omega_G omega_G) 这里 omega_G 就是 (lambda (x) (G (x x))) (即把 g 换成了具体的 G)。\n接下来，我们来看 (omega_G omega_G) 是什么： (omega_G omega_G) = ((lambda (x) (G (x x))) omega_G) (将第一个 omega_G 展开)\n现在，我们再次进行 β-规约：将 omega_G 这个实际参数替换掉 (lambda (x) ...) 中的形式参数 x。 ((lambda (x) (G (x x))) omega_G) evaluates-to (G (omega_G omega_G))\n我们得到了：\n(Y G) = (omega_G omega_G) (omega_G omega_G) = (G (omega_G omega_G)) 综合这两步，我们可以通过代换得到： (Y G) = (G (omega_G omega_G))\n现在，注意到等式右边的 (omega_G omega_G) 正是我们在第一步中定义的 (Y G)！ 所以，我们可以将 (Y G) 代换回去： (Y G) = (G (Y G))\n这正是我们期望的不动点属性！ (Y G) 这个表达式本身（我们称之为 f_rec）等于将 G 应用于 (Y G)（即 (G f_rec)）。Y 组合子通过这种巧妙的自我应用结构，成功地为一个“期望接收自身作为参数”的函数生成器 G 创造了一个可以直接调用的递归函数 (Y G)，而这个递归函数 (Y G) 确实是 G 的不动点。\n这就是为什么 Y 组合子能够在纯 λ 演算中实现递归的魔力所在。它构建了一个表达式，该表达式在求值时会“展开”成将生成器 G 应用于该表达式自身的形式。\n然而，Y 组合子的这个经典定义在严格求值/应用序求值（Applicative Order Evaluation，即函数参数在函数体执行前就被完全求值）的语言（如 Scheme）中直接使用时会遇到问题：(x x) 这一部分会导致无限递归求值，从而使程序无法终止。\n为了解决这个问题，在应用序求值语言中，我们通常使用 Z 组合子，它是 Y 组合子的一个变体，通过引入一个额外的 lambda 来延迟 (x x) 的求值： $$ Z := \\lambda g . (\\lambda x . g (\\lambda v . ((x \\ x) v))) (\\lambda x . g (\\lambda v . ((x \\ x) v))) $$ 在 Scheme 中：\n1 2 3 4 (define Z (lambda (g) ((lambda (x) (g (lambda (v) ((x x) v)))) (lambda (x) (g (lambda (v) ((x x) v))))))) 现在，我们可以用 Z 组合子和我们之前定义的 G-factorial 来构造阶乘函数：\n1 2 (define factorial-via-Z (Z G-factorial)) (factorial-via-Z 5) ; 计算结果为 120 这里，factorial-via-Z 就是一个完全由 λ 演算（加上 Z 组合子）构造出来的递归阶乘函数。在纯 λ 演算的语境下，G-factorial 中的 if、=、0、1、*、- 当然也需要用我们之前讨论过的丘奇编码来定义。\n不动点组合子（如 Y 或 Z）是 λ 演算中一个深刻而强大的概念。它们揭示了即使在这样一个极简的系统中，我们也能通过纯粹的函数抽象和应用来构建出递归这一复杂的控制结构。这为 λ 演算的图灵完备性提供了关键的一环，也意味着我们几乎拥有了构建任何可计算过程所需的所有理论工具。\n有了递归，我们的 λ 演算工具箱才算真正强大起来，能够去定义和执行那些需要自我参照和重复计算的复杂算法了。\n我们很快就会看到它们的威力。在下一节中，我们将应用它们来构造之前我们暂时搁置的算术逻辑：除法。\n更进一步的算术：除法 (DIV) 在构建了加法、减法和乘法之后，自然会想到四则运算的最后一个基本操作：除法。我们将在这里实现整数除法，即计算 $m \\div n$ 的商 $q$。\n与加法和乘法不同，除法的计算过程（重复从被除数中减去约数，直到余数小于约数）通常不依赖于一个固定的、由输入数字直接决定的迭代次数。这暗示了我们需要使用递归来实现它。\n除法的核心逻辑：重复减法与递归 整数除法 $m \\div n$ 的商 $q$ 可以通过以下递归过程找到：\n基本情况：如果 $m \u003c n$，那么我们无法再从中减去 $n$ 了，此时累积的商就是最终结果。 递归步骤：如果 $m \\ge n$，那么我们可以从 $m$ 中减去一个 $n$，然后对新的 $m' = m-n$ 和原始的 $n$ 再次进行除法过程，同时将累积的商加一。 我们需要一个辅助的递归函数，它会跟踪当前的被除数、原始的除数以及到目前为止累积的商。\n构造除法的递归辅助函数生成器 (G_DIV_LOOP) 让我们定义一个函数生成器 G_DIV_LOOP。它接受一个参数 self_div_loop（代表递归调用自身），并返回一个执行单步除法逻辑的函数。这个单步函数接受三个参数：\ncurrent_m：当前的被除数。 original_n：原始的（保持不变的）除数。 current_q：到目前为止累积的商。 $$ \\begin{aligned} \\text{G\\_DIV\\_LOOP} := \\lambda \\text{self\\_div\\_loop} . \\lambda \\text{current\\_m} . \\lambda \\text{original\\_n} . \\lambda \\text{current\\_q} . \\\\ \\quad (\\text{IS\\_LT?} \\ \\text{current\\_m} \\ \\text{original\\_n}) \\\\ \\quad \\quad \\text{current\\_q} \\\\ \\quad \\quad (\\text{self\\_div\\_loop} \\ (\\text{SUB} \\ \\text{current\\_m} \\ \\text{original\\_n}) \\ \\text{original\\_n} \\ (\\text{S} \\ \\text{current\\_q})) \\end{aligned} $$ 在 Scheme 中（使用我们之前定义的 IF-THEN-ELSE 的等价结构，即丘奇布尔值直接作为选择器）：\n1 2 3 4 5 6 7 8 9 10 (define G_DIV_LOOP (lambda (self_div_loop) (lambda (current_m) (lambda (original_n) (lambda (current_q) ((IS_LT? current_m original_n) ; If current_m \u0026lt; original_n current_q ; Then: return current_q (self_div_loop (SUB current_m original_n) ; Else: recurse original_n (S current_q)))))))) 这里我们使用了之前定义的 IS_LT? (小于)，SUB (截断减法)，和 S (后继函数)。\n使用 Z 组合子实现递归循环 现在，我们可以使用 Z 组合子来从 G_DIV_LOOP 生成实际的递归辅助函数 DIV_LOOP： $$ \\text{DIV\\_LOOP} := \\text{Z} \\ \\text{G\\_DIV\\_LOOP} $$ 1 (define DIV_LOOP (Z G_DIV_LOOP)) DIV_LOOP 现在是一个柯里化的函数，它接受 current_m、original_n 和 current_q，并递归地计算直到 current_m \u0026lt; original_n。\n定义主除法函数 DIV 主除法函数 DIV 将接受两个参数：被除数 m 和除数 n。它会调用 DIV_LOOP，并将初始商设为 ZERO。 $$ \\text{DIV} := \\lambda m . \\lambda n . (\\text{DIV\\_LOOP} \\ m \\ n \\ \\text{ZERO}) $$ 在 Scheme 中：\n1 2 3 4 (define DIV (lambda (m) (lambda (n) (DIV_LOOP m n ZERO)))) 注意： 此定义假设除数 n 不为 ZERO。如果 n 是 ZERO (且 m 非 ZERO)， (IS_LT? current_m ZERO) 永远为假，而 (SUB current_m ZERO) 结果仍是 current_m，这将导致无限递归（不终止）。\n示例 让我们尝试计算 (DIV SIX TWO)（假设 SIX 是丘奇数 6，TWO 是丘奇数 2）：\n(DIV_LOOP SIX TWO ZERO) IS_LT? SIX TWO 为 FALSE。 递归调用 (DIV_LOOP (SUB SIX TWO) TWO (S ZERO)) 即 (DIV_LOOP FOUR TWO ONE)。 (DIV_LOOP FOUR TWO ONE) IS_LT? FOUR TWO 为 FALSE。 递归调用 (DIV_LOOP (SUB FOUR TWO) TWO (S ONE)) 即 (DIV_LOOP TWO TWO TWO)。 (DIV_LOOP TWO TWO TWO) IS_LT? TWO TWO 为 FALSE (因为 TWO 不小于 TWO)。 递归调用 (DIV_LOOP (SUB TWO TWO) TWO (S TWO)) 即 (DIV_LOOP ZERO TWO THREE)。 (DIV_LOOP ZERO TWO THREE) IS_LT? ZERO TWO 为 TRUE。 返回当前的商 THREE。 因此，(DIV SIX TWO) 的结果是 THREE，这符合预期。\n同样，(DIV SEVEN THREE) 会返回 TWO。\n获取余数 (Remainder) (可选扩展) 上面的 DIV 函数只返回商。如果我们也想得到余数，该怎么办呢？ 余数其实就是在递归的基本情况下（即当 current_m \u0026lt; original_n 时）的 current_m 的值。\n我们可以修改 G_DIV_LOOP，使其返回一个包含商和余数的丘奇对 (CONS quotient remainder)。\n$$ \\begin{aligned} \\text{G\\_DIV\\_REM\\_LOOP} := \\lambda \\text{self\\_div\\_loop} . \\lambda \\text{current\\_m} . \\lambda \\text{original\\_n} . \\lambda \\text{current\\_q} . \\\\ \\quad (\\text{IS\\_LT?} \\ \\text{current\\_m} \\ \\text{original\\_n}) \\\\ \\quad \\quad (\\text{CONS} \\ \\text{current\\_q} \\ \\text{current\\_m}) \\\\ \\quad \\quad (\\text{self\\_div\\_loop} \\ (\\text{SUB} \\ \\text{current\\_m} \\ \\text{original\\_n}) \\ \\text{original\\_n} \\ (\\text{S} \\ \\text{current\\_q})) \\end{aligned} $$ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 (define G_DIV_REM_LOOP (lambda (self_div_loop) (lambda (current_m) (lambda (original_n) (lambda (current_q) ((IS_LT? current_m original_n) (CONS current_q current_m) ; 返回 (商, 余数) (self_div_loop (SUB current_m original_n) original_n (S current_q)))))))) (define DIV_REM_LOOP (Z G_DIV_REM_LOOP)) (define DIV_AND_REMAINDER (lambda (m) (lambda (n) (DIV_REM_LOOP m n ZERO)))) 然后，我们可以定义分别获取商和余数的函数： $$ \\text{QUOTIENT} := \\lambda m . \\lambda n . \\text{CAR} \\ (\\text{DIV\\_AND\\_REMAINDER} \\ m \\ n) $$ $$ \\text{REMAINDER} := \\lambda m . \\lambda n . \\text{CDR} \\ (\\text{DIV\\_AND\\_REMAINDER} \\ m \\ n) $$ 1 2 3 4 5 6 7 8 9 (define QUOTIENT (lambda (m) (lambda (n) (CAR (DIV_AND_REMAINDER m n))))) (define REMAINDER (lambda (m) (lambda (n) (CDR (DIV_AND_REMAINDER m n))))) 例如，(DIV_AND_REMAINDER SEVEN THREE) 会返回一个序对，其中 CAR 是 TWO (商)，CDR 是 ONE (余数)。\n通过这种方式，我们利用递归和之前构建的算术及逻辑原语，成功地扩展了我们的 $\\lambda$ 演算计算体系，使其包含了基本的除法运算。这进一步展示了该计算模型的图灵完备性。\n结语 在上文中，我们已经成功地用 λ 演算构建了基本的计算逻辑、自然数算术以及强大的递归机制。这为我们打开了通往更广阔计算世界的大门。\n在实际的编程中，除了原始的数据类型和运算，我们还需要各种数据结构来有效地组织和管理信息，例如链表、栈、队列、树、图、哈希表等等。没有这些，许多复杂的算法都将无从谈起。\n利用我们已经掌握的丘奇对 (可以看作是构造其他数据结构的基础单元) 和递归思想，我们完全有能力在纯 λ 演算的框架内逐步构建出这些复杂的数据结构。\n例如，链表 (Linked List) 作为最基础也最常用的数据结构之一，它与 λ 演算的递归特性天然契合。我们可以设想用嵌套的丘奇对来表示链表节点，其中每个节点包含一个数据元素和一个指向下一个节点的“指针”（即另一个链表或代表列表末尾的特殊值）。\n1 2 3 4 5 6 7 (define MY-NIL (lambda (f) (lambda (x) x))) ; 例如，用 ZERO 或一个特定的选择函数代表空列表 (define MY-CONS CONS) ; 丘奇对就是我们的 cons (define MY-CAR CAR) (define MY-CDR CDR) ; 一个包含 1, 2, 3 的列表可以表示为： ; (MY-CONS ONE (MY-CONS TWO (MY-CONS THREE MY-NIL))) 对这些数据结构的操作（如插入、删除、查找、遍历）也都可以通过定义相应的 λ 函数来实现，这些函数通常会利用递归来处理链表的递归定义。\n由于篇幅和精力的限制，本文不再详细展开这些数据结构的具体实现。但我们强烈鼓励充满好奇心的读者，以本文介绍的原理和方法为基础，亲自动手尝试去构建它们。这将会是一段极具启发性和挑战性的旅程，能让你更深刻地理解计算的构造性和 λ 演算的强大威力。\n同样，对于数系的扩展，例如从自然数到整数（如何表示负数？）、再到有理数（如何表示分数并进行运算？），甚至是实数的某些计算特性，也都是值得探索的领域。\n希望本文能为你打开一扇窗，让你窥见计算世界最纯粹、最本源的构造之美。\n","permalink":"https://litjohn.github.io/posts/lets-build-our-mathematics-by-using-lambda-calculus--church-encoding/","summary":"\u003ch3 id=\"致谢\"\u003e致谢\u003c/h3\u003e\n\u003cp\u003eGemini 2.5 Pro 0325 \u0026amp;\u0026amp; 0506：文本润色、事实正确性审查，以及帮助我学习、理解和回忆这些内容。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://www.luogu.com.cn/user/528472\"\u003emyster1ous\u003c/a\u003e： 给予我巨大的启发，帮助我构建出 prev 函数。\u003c/p\u003e\n\u003ch2 id=\"前言\"\u003e前言\u003c/h2\u003e\n\u003cp\u003e本文是光剑系列的第一作，又名《lambda 演算，邱奇编码与优雅的计算模型》。\u003c/p\u003e\n\u003cp\u003e本文的目的是带领大家踏上一段奇妙的旅程：我们将使用 λ 演算（Lambda Calculus）这一极简的计算模型，并通过丘奇编码（Church Encoding）这一巧妙的技术，一步步构建出我们日常编程中熟悉和依赖的计算体系，例如数字、布尔逻辑乃至更复杂的数据结构。\u003c/p\u003e\n\u003cp\u003e为了方便演示和实践，本文中的所有代码示例都将使用 Scheme 语言。Scheme 是 Lisp 家族的一员，它的语法是 \u003cstrong\u003eS-表达式 (Symbolic Expressions)\u003c/strong\u003e。S-表达式不仅简洁优雅，而且其结构与 λ 演算的表达方式惊人地契合。\u003c/p\u003e\n\u003cp\u003e在我们开始之前，让我们先快速了解一下 S-表达式：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e核心是列表 (List)：\u003c/strong\u003e S-表达式的基本形式是由圆括号 \u003ccode\u003e()\u003c/code\u003e 包围起来的列表。\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e结构：\u003ccode\u003e(操作符 参数1 参数2 ...)\u003c/code\u003e：\u003c/strong\u003e 列表中的第一个元素通常是\u003cstrong\u003e操作符\u003c/strong\u003e（即要应用的函数），其余元素则是传递给该操作符的\u003cstrong\u003e参数\u003c/strong\u003e。\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e原子 (Atom) 与嵌套：\u003c/strong\u003e 列表中的元素可以是\u003cstrong\u003e原子\u003c/strong\u003e（如数字 \u003ccode\u003e123\u003c/code\u003e、符号 \u003ccode\u003ex\u003c/code\u003e、\u003ccode\u003e+\u003c/code\u003e），也可以是另一个 S-表达式。这种嵌套能力使得 S-表达式可以表示复杂的树状结构。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e例如，表达式 \u003ccode\u003e(+ 1 (* 2 3))\u003c/code\u003e 在 Scheme 中表示数学上的 \u003ccode\u003e1 + (2 * 3)\u003c/code\u003e。\n这里：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e最外层的 \u003ccode\u003e(+ 1 (* 2 3))\u003c/code\u003e 是一个 S-表达式。\u003ccode\u003e+\u003c/code\u003e 是操作符，\u003ccode\u003e1\u003c/code\u003e 和 \u003ccode\u003e(* 2 3)\u003c/code\u003e 是它的参数。\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e(* 2 3)\u003c/code\u003e 本身也是一个 S-表达式。\u003ccode\u003e*\u003c/code\u003e 是操作符，\u003ccode\u003e2\u003c/code\u003e 和 \u003ccode\u003e3\u003c/code\u003e 是它的参数。执行它会得到 \u003ccode\u003e6\u003c/code\u003e。\u003c/li\u003e\n\u003cli\u003e所以整个表达式 \u003ccode\u003e(+ 1 6)\u003c/code\u003e 最终会计算得到 \u003ccode\u003e7\u003c/code\u003e。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e理解了 S-表达式，我们就可以更顺畅地进入 λ 演算的世界了。\u003c/p\u003e","title":"Let's Build Our Mathematics by Using Lambda Calculus \u0026\u0026 Church Encoding!"},{"content":"光剑系列的第七作！\n前六作：\n第一篇：Let\u0026rsquo;s build our mathematics by using lambda calculus \u0026amp;\u0026amp; church encoding! 第二篇：惰性求值、无穷流与发生的魔法 第三篇：协程、生成器与 call/cc 的控制流 第四篇：动态作用域、词法作用域与表达式求值的环境模型 第五篇：基于环境模型的解释器 第六篇：调用栈、de bruijn 索引与堆栈的内存模型 朱约（juyo）/瓦帕德（vaapad）是光剑七式的最后一技。很高兴我们的“光剑”终于抵达了这里！不过也许会有续集。\n[此处应有温杜的图片]\n一点说明 我更新了工具，本文使用 racket（scheme 的一种实现和变体）完成。这些代码大多可以直接挪用在 scheme 中，但是 match 除外，请使用自己的模式匹配库。我也转载了一个简单的模式匹配库：https://www.luogu.com.cn/article/4kw6oewn\n注意使用 #lang racket。\n发现有不少 racket 的在线环境，懒得下 racket 的话可以直接用。给一个：https://onecompiler.com/racket\n引子 在前作中，我们提到过“call/cc”也即“call-with-current-continuation”的存在。它可以捕获当前的“续延”（coutinuation）并将它作为一个一等公民值。\n续延代表程序的“计算上下文”，也即“我们接下来要做什么？”调用一个续延，可以让我们瞬间跳回续延被捕获的那个时间点，还原环境（包括堆和栈，不过那是具体的内存模型。环境是更抽象的“数据上下文”。）以及更重要的，“计算”。\n看上去真是神秘又强大（事实上，从 call/cc 和条件判断，我们可以造出其余的所有控制流。）。我们的第五作实现了一个 scheme 子集的解释器，但是也没有实现这个功能。\n那么，这个操作是如何实现的呢？“剩下的计算”是如何被表示的呢？这就是我们今天要探讨的话题。\nCPS 变换 一个例子 先看下面这段代码：\n1 2 3 4 5 6 (define (fact-cps n k) (if (= n 0) (k 1) (fact-cps (- n 1) (lambda (v) (k (* v n)))))) 从名字就可以看出，这是一个计算阶乘的函数。不过它看上去非常的不同寻常。\n那个叫做“k”的参数是什么东西？它在干什么？\n事实上，这个“k”就是一个外部传入的续延。它代表“当前函数执行完毕后，还要进行哪些操作”。\n现在让我们来看看代码。条件判断很寻常。\n递归终止条件是第一个用到 k 的地方。这里，我们向 k 传递了一个参数 1.\n在正常的代码中，这里本来应该是向上层返回 1. 那么，(k 1) 是什么意思呢？\n自然是“返回 1”。不过这里不是隐式的返回，而是显式的续延调用。我们向续延 k 传递了一个值，表示当前函数的返回值。\n第二个分支是另一个用到续延的地方。这里其实纯粹是对第一个分支的适配：在正常的递归阶乘中，我们应当“返回 (* n (fact (- n 1)))”，但是在这个特殊的阶乘函数中，我们会将计算结果传递给一个续延。\n那么我们要做的是什么？是“计算出 n-1 的阶乘的值，然后乘以 n，再传递给续延”。\n第一步是算出 n-1 的阶乘。这可以通过一个对 fact-cps 的递归调用搞定。不过这次调用需要给出续延。所以我们来需要确定续延是什么。\n在算出 n-1 的阶乘之后，我们需要将它乘以 n，然后传递给外层续延 k 来返回。所以，“接下来要做的事情”就是“乘以 n，然后传递给 k”。写成代码，就是 (lambda (v) (k (* n v)))，也就是 fact-cps 做的。这样我们就理解了这个代码。\n我们在干什么 上面的代码，正如它的名称，是“CPS”（coutinuation passing style）的。这是一种特殊的代码风格，我们不再使用隐式的函数返回等控制流，而是显式的调用续延。函数不再返回。\n它有什么用？ CPS 将控制流显式化了，变成了一个普通的函数“续延”。这就使得 call/cc 一类的对续延的操作成为可能。事实上，call/cc 只需要直接捕获当前续延即可。\nCPS 将控制流显式化之后，可以方便很多控制流上的分析和优化的进行。它是各种 FP 语言编译器广泛使用的 IR。\n同时，CPS 之后的代码全都是尾调用的，这可以避免栈溢出（不过注意，调用栈被作为控制流的一部分存储到了续延里，所以会消耗堆内存）。\n在理论上，将“控制上下文”显式的提取出来，是一个很优雅的东西。这展示了过程和数据的等价性。环境是数据的上下文，可以被显式提取，续延就是计算的上下文，也可以被提取。\n自动 CPS 变换 没有自己动手的光剑是没有灵魂的！让我们来写一些东西，对接收到的代码片段自动进行 CPS 变换。\n让我们从最简单的地方入手：lambda calculus。只有函数抽象和函数应用两种语法，函数都有且仅有一个参数。\n这样我们只需要处理函数抽象表达式，函数应用表达式和标识符原子三种情况。\n提示：下面的内容请尽量自己动手完成而不是仅仅看我的说明。动手得到的理解远比观摩更加深刻。我用了好几个小时才写出了正确的代码，这个习题没有那么简单。\n进行一些分类讨论。首先考虑函数应用。\n(f a) 应当怎样处理呢？\n首先，我们应该先对 a 进行 CPS 变换。不过，这里需要提供续延，我们要知道算出来 a 之后要干什么。\n要干什么？要将 f 应用于 a，然后返回。返回等价于调用外部续延 k。所以，a 的续延就是 (lambda (v) (k (f v))。但这里的 f 也需要进行 CPS 变换。它的续延是什么呢？什么都不是。我们拿到 f 的值之后仅仅是用它造出 a 的续延罢了。所以我用了一个占位符 identity 代表恒等变换（这个函数在 racket 里是有定义的）\n这样可能产生一些冗余的恒等变换，所以我们写了 wrap 函数，多加了一些逻辑来去掉它们。\n第二个 case 是函数抽象。这里请注意不要犯唐：lambda 是函数抽象，它最终的返回值不能直接传递给它定义处的续延！否则，每次调用这个函数都会直接跳回它定义的时间点，这简直不堪设想。\n正确的做法是，在函数后面多加一个参数代表续延，在调用时把调用时的续延传进去，然后在里面用这个续延。\n另一个问题：lambda 的抽象得到的是一个值。它就像其他普通的值一样，需要被传递给当前续延。不要忘记这点。\n第三个 case 是原子（标识符）。这个应该随便写。不用我说了。\n大功告成！\n……等等。\n真的吗？\n似乎有什么东西不对。\n想想函数应用的过程？\n我们把参数传进了一个包含操作符的续延中。\n这会有什么问题？\n求值顺序。求值顺序反了。续延作为一个函数会延迟求值。于是，参数就会比操作符先求值。\n在纯的 lambda 中，这问题不大。但是，如果引入副作用，这就不好弄了。\n于是你可能会尝试修正。不过先别急，如果你修正之后的代码里面出现了形如 ((lambda (f1) (k (f1 x))) f) 这样的东西，那么恭喜你，你又掉进了一个大坑。\n这个坑很简单：上面的代码根本不是 CPS 形式！\nCPS 要求所有函数调用都是尾调用，一个隐含的要求是，函数参数必须都是原子。因为如果一个函数调用被放在参数上，根据应用序求值的规则，它就会在主调用之前先求值，并将返回值递给主调用。这里，“返回值”是重点，它是我们不希望的隐式控制流。\n而上面，我们正是“计算 (f1 x) 的返回值，然后传递给 k”，而不是由 f1 自己调用 k。\n正确的做法是什么呢？想想我们上面的 fact-cps 函数。它多了一个接受续延的参数。并且在函数内部需要返回时由函数自己（而不是隐式控制流）调用续延。\n那么可能就比较好做了。(f a) 的正确变换形式是 (f a k)。\n于是我们修正代码。我们该做什么呢？首先对 f 进行 CPS 变换，将 k 作为续延加一个参数进去。然后对 a 进行 CPS，续延是 identity（原封不动返回），传递给 (lambda (v1) (f v1 k)) 这样的表达式。\n似乎很对，也能正确处理 ((f g) a)。\n不过很可惜。你会发现 (f (g a)) 的变换中出现了 (g a identity) 这样的东西！\n为什么！我们都在 wrap 中去掉了 identity，为什么它会出现！\n原因很简单，因为这个 identity 并不是被包裹上去的，而是作为续延加进参数里的，它根本就没有经过 wrap 的过程。\n你可能会想我们把上面的过程反一下就行了。但事实上你反过来之后 ((f g) a) 又会出问题。这两个形式你只能写对一个。\n让问题暴露的更明显些。\n试试这个：(cps '((f g) (r h)) 'k)\n问题在于“续延的循环定义”！(f g) 这个值，对它进行 CPS 时要知道它“接下来要做的事”。而这个事是“应用于 (r h) 的 CPS 形式，并以 k 作为续延”。这就要对 (r h) 进行 CPS，又要知道 (r h) 的续延，这个续延又要用到 (f g) 的变换结果。\n怎么办？我们似乎陷入了死胡同。\n为了解决这个问题，我们首先需要知道正确的变换是什么。\n1 2 3 4 5 6 7 8 9 10 ((lambda (v1151) ((lambda (v1152) (v1151 v1152 (lambda (v1147) ((lambda (v1149) ((lambda (v1150) (v1149 v1150 (lambda (v1148) (v1147 v1148 k)))) h)) r)))) g)) f) 看上去很难绷，但实际上很容易理解。它先进行了 (f g) 这一步，然后将一个东西（(lambda (v1147) ...)）扔进去作为续延，捕获返回值（绑定在 v1147 上），然后再算 (r h)，用一个续延捕获返回值，最后计算 ((f g) (r h))，并传入 k 作为续延，收集返回值。\n上面的代码由自动变换器生成，带有一些冗余。进行一些 beta reduction 能看得更清楚：\n1 (f g (lambda (v0) (r h (lambda (v1) (v0 v1 k))))) 知道了正确的变换形式，那么如何修正程序的错误呢？\n其实错误的本质很简单：就是 identity 占位符的问题。我们企图用它“原封不动地返回一个表达式变换后的形式”，然后构建新代码，但这一步里其实已经用到了“返回”这个隐式控制流。\n但是表达式变换后的值不捕获是不行的。如何捕获？\n很简单，利用续延。就像 call/cc 的形式是“包裹一个表达式，将捕获的续延作为参数传递进去”一样，我们也在续延中构建一个 lambda，将表达式作为它的参数捕获，之后再搞事情。\n那么正确的代码就很简单了：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 #lang racket (define (atom? x) (not (pair? x))) (define wrap list) (define (cps exp k) (match exp [`(lambda (,bind) ,body) (let ([res (let ([c (gensym \u0026#39;k)]) `(lambda (,bind ,c) ,(cps body c)))]) (wrap k res))] [`(,exp1 ,exp2) (let ([c1 (gensym \u0026#39;v)] [c2 (gensym \u0026#39;v)]) (let ([res (cps exp1 `(lambda (,c1) ,(cps exp2 `(lambda (,c2) (,c1 ,c2 ,k)))))]) res))] [x #:when (atom? x) (wrap k x)])) （由于不再使用 identity 占位符，wrap 可以直接定义为 list 而省去多余的检查）\n当然，它生成的代码还有冗余。就像上面那个例子一样，出现了好多个不需要的 lambda。其实等价于 let（let 脱糖之后就是那个样子），也就是说我们给一些变量起了不必要的别名。\n下一步就是去除这些冗余。\n我们发现，所有的冗余都是在函数应用这一步产生的。它产生了一些可以被 beta-reducation 消除的类似于 let 的模式。\n为什么呢？因为我们给什么东西都传了一个续延进去用来捕获它的“返回值”。对于函数应用的模式，这是必要的。但是对于函数抽象和原子值，就会变成无用的别名（因为它们是自求值的）。这时可以直接用 identity 捕获它们的值，然后嵌入进去，就相当于一个 beta-reducation。\n变换之后做规约也是可以的，但是会变得更麻烦。不如在变换途中解决掉。\n这里我们需要分类讨论 exp1 和 exp2 是否是自求值的。于是就有 4 种情况，需要复制粘贴 4 份极其类似的代码（终于理解于梓文说的“接下来会有很多重复的代码”是什么意思了，果然实践出真知）\n并且由于代码太过冗长，我们构造了一些过程抽象。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 #lang racket (define (atom? x) (not (pair? x))) (define (wrap k exp) (if (eq? k \u0026#39;identity) exp (list k exp))) (define (is-app-exp? exp) (match exp [`(,exp1 ,exp2) #t] [else #f])) (define (calc-res exp1 exp2 c1 c2 k) (if (is-app-exp? exp1) (if (is-app-exp? exp2) (cps exp1 `(lambda (,c1) ,(cps exp2 `(lambda (,c2) (,c1 ,c2 ,k))))) (cps exp1 `(lambda (,c1) (,c1 ,(cps exp2 \u0026#39;identity) ,k)))) (if (is-app-exp? exp2) (cps exp2 `(lambda (,c2) (,(cps exp1 \u0026#39;identity) c2 k))) `(,(cps exp1 \u0026#39;identity) ,(cps exp2 \u0026#39;identity) ,k)))) (define (cps exp k) (match exp [`(lambda (,bind) ,body) (let ([res (let ([c (gensym \u0026#39;k)]) `(lambda (,bind ,c) ,(cps body c)))]) (wrap k res))] [`(,exp1 ,exp2) (let ([c1 (gensym \u0026#39;v)] [c2 (gensym \u0026#39;v)]) (calc-res exp1 exp2 c1 c2 k))] [x #:when (atom? x) (wrap k x)])) #| \u0026gt; (displayln (cps \u0026#39;((f g) (r h)) \u0026#39;k)) (f g (lambda (v1149) (r h (lambda (v1150) (v1149 v1150 k))))) \u0026gt; (displayln (cps \u0026#39;(lambda (f) (lambda (g) ((f g) (r h)))) \u0026#39;k)) (k (lambda (f k1147) (k1147 (lambda (g k1148) (f g (lambda (v1149) (r h (lambda (v1150) (v1149 v1150 k1148))))))))) |# 生成的代码可读性感觉好多了。\n这样，我们就成功的造出了 lc-exp 的 CPS 变换器。接下来，我们可以为它添加更多功能：define，多参数 lambda，原生数据类型，内建函数，等等。\n我们先从多参 lambda 入手。这是一个具有挑战的特性：我们之前的函数调用相当于人肉特判了控制流，现在我们要找到通解。\n一开始就去掉冗余有点困难，所以我们先从最原始的，有冗余的版本入手。\n多参函数应用怎么做呢？\n1 2 (cps `(,r0 ,r1 ,r2 ...) k) = (cps r0 `(lambda (,v0) ,(cps r1 `(lambda (,v1) ...)))) 简单来说，“从左到右，对操作符和各操作数依次求值，最后应用”。不过现在是用续延实现。\n看上去不是很好实现。人肉做不太现实，考虑递归。 边界：一个操作数。我们维护一个环境，代表之前遇到的一切参数名。\n这时把所有参数名依次放进列表里，再加上续延 k 就行了。\n1 2 3 4 5 (cps `(,r0 . ,rest) k env) = (cps r0 `(lambda (,v0) ,(cps rest k (cons v0 env)))) (cps `(,f) k env) = (cps f `(lambda (,v) ,(reverse (cons k (cons v env)) \u0026#39;()) 伪代码大概就是上面那样。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 #lang racket (define (atom? x) (not (pair? x))) (define wrap list) (define (cps1 exp k env) (match exp [`(lambda ,bind ,body) (let ([res (let ([c (gensym \u0026#39;k)]) `(lambda ,(append bind (list c)) ,(cps1 body c \u0026#39;())))]) (wrap k res))] [`(,exp) (let ([c1 (gensym \u0026#39;v)]) (cps1 exp `(lambda (,c1) ,(reverse (cons k (cons c1 env)))) \u0026#39;()))] [`(,exp1 . ,rest) #:when (not (null? rest)) (let ([c1 (gensym \u0026#39;v)]) (cps1 exp1 `(lambda (,c1) ,(cps1 rest k (cons c1 env))) \u0026#39;()))] [x #:when (atom? x) (wrap k x)])) (define (cps exp) (cps1 exp \u0026#39;ctx0 \u0026#39;())) 实现出来就是这样。\n下一步考虑复现去冗余。这里不再需要分 4 类讨论了，只需要分 2 类即可：当前处理的参数是否是一个函数应用。如果不是，就内联进去而不使用续延绑定。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 #lang racket (define (atom? x) (not (pair? x))) (define (wrap k exp) (if (eq? k \u0026#39;identity) exp (list k exp))) (define keywords \u0026#39;(lambda)) (define (is-app-exp? exp) (not (or (atom? exp) (member (car exp) keywords)))) (define (cps1 exp k env) (match exp [`(lambda ,bind ,body) (let ([res (let ([c (gensym \u0026#39;k)]) `(lambda ,(append bind (list c)) ,(cps1 body c \u0026#39;())))]) (wrap k res))] [`(,exp) (let ([c1 (gensym \u0026#39;v)]) (if (is-app-exp? exp) (cps1 exp `(lambda (,c1) ,(reverse (cons k (cons c1 env)))) \u0026#39;()) (reverse (cons k (cons (cps1 exp \u0026#39;identity \u0026#39;()) env)))))] [`(,exp1 . ,rest) #:when (not (null? rest)) (let ([c1 (gensym \u0026#39;v)]) (if (is-app-exp? exp1) (cps1 exp1 `(lambda (,c1) ,(cps1 rest k (cons c1 env))) \u0026#39;()) (cps1 rest k (cons (cps1 exp1 \u0026#39;identity \u0026#39;()) env))))] [x #:when (atom? x) (wrap k x)])) (define (cps exp) (cps1 exp \u0026#39;ctx0 \u0026#39;())) 真成四十行代码了\n这是一个不错的成果。接下来，让我们考虑加入对 define 语法的支持。\n这不难。一个 define 语句不返回任何值，所以它内部不会调用外部的续延。所以，只需要对要绑定的值进行 CPS 变换（续延为 identity）即可。\n也就是在模式匹配中加入这个分支：\n1 2 [`(define ,id ,exp) `(define ,id ,(cps1 exp \u0026#39;identity \u0026#39;()))] 但是你发现了吗？控制流在这里又断掉了。define 很特殊，它不返回任何值，也不是一个有函数调用的动作。它只不过是创建一个绑定，实在不应该出现在控制流里。\n我没有什么好办法来修复它。不过用一个 begin 把 define 和续延调用包起来有用。\n1 2 [`(define ,id ,exp) `(begin (define ,id ,(cps1 exp \u0026#39;identity \u0026#39;())) (,k #f))] 为了统一 define 和其他表达式的处理，我们给续延传递了一个没有任何意义的值充当占位符。\n完整代码：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 #lang racket (define (atom? x) (not (pair? x))) (define (wrap k exp) (if (eq? k \u0026#39;identity) exp (list k exp))) (define keywords \u0026#39;(lambda define)) (define (is-app-exp? exp) (not (or (atom? exp) (member (car exp) keywords)))) (define (cps1 exp k env) (match exp [`(define ,id ,exp) `(begin (define ,id ,(cps1 exp \u0026#39;identity \u0026#39;())) (,k #f))] [`(lambda ,bind ,body) (let ([res (let ([c (gensym \u0026#39;k)]) `(lambda ,(append bind (list c)) ,(cps1 body c \u0026#39;())))]) (wrap k res))] [`(,exp) (let ([c1 (gensym \u0026#39;v)]) (if (is-app-exp? exp) (cps1 exp `(lambda (,c1) ,(reverse (cons k (cons c1 env)))) \u0026#39;()) (reverse (cons k (cons (cps1 exp \u0026#39;identity \u0026#39;()) env)))))] [`(,exp1 . ,rest) #:when (not (null? rest)) (let ([c1 (gensym \u0026#39;v)]) (if (is-app-exp? exp1) (cps1 exp1 `(lambda (,c1) ,(cps1 rest k (cons c1 env))) \u0026#39;()) (cps1 rest k (cons (cps1 exp1 \u0026#39;identity \u0026#39;()) env))))] [x #:when (atom? x) (wrap k x)])) (define (cps exp) (cps1 exp \u0026#39;ctx0 \u0026#39;())) 我们的 CPS 变换器还有一个严重的限制：整个程序只能有一个函数，整个函数只能有一个表达式作为函数体。这是非常不好的。\n解决这个限制，我们只需要引入 begin 特殊形式。\nbegin 特殊形式和普通的函数调用几乎一模一样。不过，它不会将操作符求值之后应用于操作数，而是保留最后一个表达式的值，将前面其他表达式的返回值都丢弃。\n这样就可以处理有多个表达式的函数体。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 #lang racket (define (atom? x) (not (pair? x))) (define (wrap k exp) (if (eq? k \u0026#39;identity) exp (list k exp))) (define keywords \u0026#39;(lambda define begin)) (define (is-app-exp? exp) (not (or (atom? exp) (member (car exp) keywords)))) (define (cps1 exp k arg-acc) (match exp [`(define ,id ,exp) `(begin (define ,id ,(cps1 exp \u0026#39;identity \u0026#39;())) (,k #f))] [`(lambda ,bind . ,body) (let ([res (let ([c (gensym \u0026#39;k)]) `(lambda ,(append bind (list c)) ,(cps1 (cons \u0026#39;begin body) c \u0026#39;())))]) (wrap k res))] [`(begin ,exp) (cps1 exp k \u0026#39;())] [`(begin ,exp . ,rest) #:when (not (null? rest)) (let ([c1 (gensym \u0026#39;v)]) (cps1 exp `(lambda (,c1) ,(cps1 (cons \u0026#39;begin rest) k \u0026#39;())) \u0026#39;()))] [`(,exp) (let ([c1 (gensym \u0026#39;v)]) (if (is-app-exp? exp) (cps1 exp `(lambda (,c1) ,(reverse (cons k (cons c1 arg-acc)))) \u0026#39;()) (reverse (cons k (cons (cps1 exp \u0026#39;identity \u0026#39;()) arg-acc)))))] [`(,exp1 . ,rest) #:when (not (null? rest)) (let ([c1 (gensym \u0026#39;v)]) (if (is-app-exp? exp1) (cps1 exp1 `(lambda (,c1) ,(cps1 rest k (cons c1 arg-acc))) \u0026#39;()) (cps1 rest k (cons (cps1 exp1 \u0026#39;identity \u0026#39;()) arg-acc))))] [x #:when (atom? x) (wrap k x)])) (define (cps exp) (cps1 exp \u0026#39;ctx0 \u0026#39;())) 你注意到它在处理 begin 时会产生一些看似可以约减的代码（比如 ((lambda (x) y) z)）。但是那些代码约减不了，约减之后某些变量就不会出现了，它们代表的副作用就不会被执行，进而我们的 begin 就没用了。\n当然你会说单个符号没有副作用。然而谁会闲的没事把它们放进 begin 去呢？保证 begin 中没有无用的东西不是转换器的责任，而是程序员的义务。\n下一步，支持内建函数。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 #lang racket (define (atom? x) (not (pair? x))) (define intrinsics (hash \u0026#39;+ #t \u0026#39;- #t \u0026#39;* #t \u0026#39;/ #t \u0026#39;cons #t \u0026#39;car #t \u0026#39;cdr #t)) ; 内建函数列表，可以自行添加 (define (is-intrinsic? op) (hash-has-key? intrinsics op)) (define (wrap k exp) (if (eq? k \u0026#39;identity) exp (list k exp))) (define keywords \u0026#39;(lambda define begin)) (define (is-app-exp? exp) (not (or (atom? exp) (member (car exp) keywords)))) (define (cps1 exp k arg-acc) (match exp [`(define ,id ,exp) `(begin (define ,id ,(cps1 exp \u0026#39;identity \u0026#39;())) (,k #f))] [`(lambda ,bind . ,body) (let ([res (let ([c (gensym \u0026#39;k)]) `(lambda ,(append bind (list c)) ,(cps1 (cons \u0026#39;begin body) c \u0026#39;())))]) (wrap k res))] [`(begin ,exp) (cps1 exp k \u0026#39;())] [`(begin ,exp . ,rest) #:when (not (null? rest)) (let ([c1 (gensym \u0026#39;v)]) (cps1 exp `(lambda (,c1) ,(cps1 (cons \u0026#39;begin rest) k \u0026#39;())) \u0026#39;()))] [`(,intrin . ,rest) #:when (is-intrinsic? intrin) (wrap k (cons intrin (map (lambda (x) (cps1 x \u0026#39;identity \u0026#39;())) rest)))] [`(,exp) (let ([c1 (gensym \u0026#39;v)]) (if (is-app-exp? exp) (cps1 exp `(lambda (,c1) ,(reverse (cons k (cons c1 arg-acc)))) \u0026#39;()) (reverse (cons k (cons (cps1 exp \u0026#39;identity \u0026#39;()) arg-acc)))))] [`(,exp1 . ,rest) #:when (not (null? rest)) (let ([c1 (gensym \u0026#39;v)]) (if (is-app-exp? exp1) (cps1 exp1 `(lambda (,c1) ,(cps1 rest k (cons c1 arg-acc))) \u0026#39;()) (cps1 rest k (cons (cps1 exp1 \u0026#39;identity \u0026#39;()) arg-acc))))] [x #:when (atom? x) (wrap k x)])) (define (cps exp) (cps1 exp \u0026#39;ctx0 \u0026#39;())) 加入 if 和 quote。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 #lang racket (define (atom? x) (not (pair? x))) (define intrinsics (hash \u0026#39;+ #t \u0026#39;- #t \u0026#39;* #t \u0026#39;/ #t \u0026#39;cons #t \u0026#39;car #t \u0026#39;cdr #t \u0026#39;null? #t \u0026#39;= #t \u0026#39;\u0026lt; #t \u0026#39;\u0026gt; #t \u0026#39;\u0026lt;= #t \u0026#39;\u0026gt;= #t)) (define (is-intrinsic? op) (hash-has-key? intrinsics op)) (define (wrap k exp) (if (eq? k \u0026#39;identity) exp (list k exp))) (define keywords \u0026#39;(lambda define begin quote)) (define (is-app-exp? exp) (not (or (atom? exp) (member (car exp) keywords) (is-intrinsic? (car exp))))) (define (cps1 exp k arg-acc #:intr? [flag-intr #f]) (match exp [`(define ,id ,exp) `(begin (define ,id ,(cps1 exp \u0026#39;identity \u0026#39;())) (,k #f))] [`(lambda ,bind . ,body) (let ([res (let ([c (gensym \u0026#39;k)]) `(lambda ,(append bind (list c)) ,(cps1 (cons \u0026#39;begin body) c \u0026#39;())))]) (wrap k res))] [`(begin ,exp) (cps1 exp k \u0026#39;())] [`(begin ,exp . ,rest) #:when (not (null? rest)) (let ([c1 (gensym \u0026#39;v)]) (cps1 exp `(lambda (,c1) ,(cps1 (cons \u0026#39;begin rest) k \u0026#39;())) \u0026#39;()))] [`(if ,condition ,then-c ,else-c) (let ([c (gensym \u0026#39;v)]) (if (is-app-exp? condition) (cps1 condition `(lambda (,c) (if ,c ,(cps1 then-c k \u0026#39;()) ,(cps1 else-c k \u0026#39;()))) \u0026#39;()) `(if ,(cps1 condition \u0026#39;identity \u0026#39;()) ,(cps1 then-c k \u0026#39;()) ,(cps1 else-c k \u0026#39;()))))] [`(,intrin . ,rest) #:when (is-intrinsic? intrin) (cps1 rest k \u0026#39;() #:intr? intrin)] [`(,exp) #:when flag-intr (let ([c1 (gensym \u0026#39;v)]) (if (is-app-exp? exp) (cps1 exp `(lambda (,c1) ,(wrap k (cons flag-intr (reverse (cons c1 arg-acc))))) \u0026#39;()) (wrap k (cons flag-intr (reverse (cons (cps1 exp \u0026#39;identity \u0026#39;()) arg-acc))))))] [`(,exp1 . ,rest) #:when (and flag-intr (not (null? rest))) (let ([c1 (gensym \u0026#39;v)]) (if (is-app-exp? exp1) (cps1 exp1 `(lambda (,c1) ,(cps1 rest k (cons c1 arg-acc) #:intr? flag-intr)) \u0026#39;()) (cps1 rest k (cons (cps1 exp1 \u0026#39;identity \u0026#39;()) arg-acc) #:intr? flag-intr)))] [`(,exp) #:when (is-app-exp? (list exp)) (let ([c1 (gensym \u0026#39;v)]) (if (is-app-exp? exp) (cps1 exp `(lambda (,c1) ,(reverse (cons k (cons c1 arg-acc)))) \u0026#39;()) (reverse (cons k (cons (cps1 exp \u0026#39;identity \u0026#39;()) arg-acc)))))] [`(,exp1 . ,rest) #:when (and (is-app-exp? exp) (not (null? rest))) (let ([c1 (gensym \u0026#39;v)]) (if (is-app-exp? exp1) (cps1 exp1 `(lambda (,c1) ,(cps1 rest k (cons c1 arg-acc))) \u0026#39;()) (cps1 rest k (cons (cps1 exp1 \u0026#39;identity \u0026#39;()) arg-acc))))] [x #:when (or (atom? x) (eq? (car x) \u0026#39;quote)) (wrap k x)])) (define (cps exp) (cps1 exp \u0026#39;ctx0 \u0026#39;())) 这样我们的变换器终于可以对开头的那个例子工作了。\n1 2 3 4 5 6 7 8 \u0026gt; (displayln (cps \u0026#39;(define fact (lambda (n) (if (= n 0) 1 (* n (fact (- n 1)))))))) (begin (define fact (lambda (n k1211) (if (= n 0) (k1211 1) (fact (- n 1) (lambda (v1216) (k1211 (* n v1216))))))) (ctx0 #f)) （生成的代码基本上已经是人类可读的了。和开头给出的手工代码几乎一样）\n如果你对 (define (fact n) ...) 变换，变换器会出错。因为我们没有让它支持函数定义的这个语法糖。但是将 lambda 绑定到变量也是等价的。\n你也许注意到了，这版代码里面多出了许多奇怪的东西。其实这些东西不属于这版代码，它们是在修上版代码留下的 BUG：上一版代码引入 intrinsics 时，对它们与普通函数调用的适配做的有问题，变换出来的代码不是 CPS 形式。看上去像这样：\n1 2 3 4 5 6 7 8 9 10 11 (begin (define fact (lambda (n k1207) ((lambda (v1208) (if v1208 (k1207 1) (k1207 (* n ((lambda (v1210) (fact v1210 identity)) (- n 1)))))) (= n 0)))) (ctx0 #f)) 有问题的地方在 (k1207 (* n ((lambda (v1210) (fact v1210 identity))，也就是原始代码的 (* (fact (- n 1))) 这一行。出的问题和我们最早处理普通函数应用时遇到的如出一辙。解决方案也一模一样，几乎就是复制了普通函数应用的代码。\n从这些经历我们发现，似乎只要一试图用 identity 捕获一个表达式的“原始值”，变换器就会出锅（产生非 CPS 形式的代码）。真是个深刻的教训。\n我们的旅程就到这里结束了。最后的彩蛋是 call/cc：\n1 [`(call/cc ,exp) (list exp k)] 在模式匹配中加入这个分支即可。原理自行思考。\n（BTW，我的 racket 代码用洛谷的 cpp 的高亮都比用 racket 高亮好看。洛谷根本没有（不支持）racket 高亮。）\n","permalink":"https://litjohn.github.io/posts/cps%E6%8E%A7%E5%88%B6%E4%B8%8A%E4%B8%8B%E6%96%87%E4%B8%8E%E5%9B%9B%E5%8D%81%E8%A1%8C%E4%BB%A3%E7%A0%81%E7%9A%84%E4%BC%A0%E8%AF%B4/","summary":"\u003cp\u003e光剑系列的第七作！\u003c/p\u003e\n\u003cp\u003e前六作：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e第一篇：\u003ca href=\"https://www.luogu.com.cn/article/cr6hfiut\"\u003eLet\u0026rsquo;s build our mathematics by using lambda calculus \u0026amp;\u0026amp; church encoding!\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e第二篇：\u003ca href=\"https://www.luogu.com.cn/article/uhume1ou\"\u003e惰性求值、无穷流与发生的魔法\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e第三篇：\u003ca href=\"https://www.luogu.com.cn/article/ygxlqlsn\"\u003e协程、生成器与 call/cc 的控制流\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e第四篇：\u003ca href=\"https://www.luogu.com.cn/article/0hxig3i4\"\u003e动态作用域、词法作用域与表达式求值的环境模型\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e第五篇：\u003ca href=\"https://www.luogu.com.cn/article/h0g9paih\"\u003e基于环境模型的解释器\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e第六篇：\u003ca href=\"https://www.luogu.com.cn/article/xwkg9lt3\"\u003e调用栈、de bruijn 索引与堆栈的内存模型\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e朱约（juyo）/瓦帕德（vaapad）是光剑七式的最后一技。很高兴我们的“光剑”终于抵达了这里！不过也许会有续集。\u003c/p\u003e\n\u003cp\u003e[此处应有温杜的图片]\u003c/p\u003e\n\u003ch3 id=\"一点说明\"\u003e一点说明\u003c/h3\u003e\n\u003cp\u003e我更新了工具，本文使用 racket（scheme 的一种实现和变体）完成。这些代码大多可以直接挪用在 scheme 中，但是 match 除外，请使用自己的模式匹配库。我也转载了一个简单的模式匹配库：https://www.luogu.com.cn/article/4kw6oewn\u003c/p\u003e\n\u003cp\u003e注意使用 \u003ccode\u003e#lang racket\u003c/code\u003e。\u003c/p\u003e\n\u003cp\u003e发现有不少 racket 的在线环境，懒得下 racket 的话可以直接用。给一个：https://onecompiler.com/racket\u003c/p\u003e\n\u003ch3 id=\"引子\"\u003e引子\u003c/h3\u003e\n\u003cp\u003e在前作中，我们提到过“call/cc”也即“call-with-current-continuation”的存在。它可以捕获当前的“续延”（coutinuation）并将它作为一个一等公民值。\u003c/p\u003e\n\u003cp\u003e续延代表程序的“计算上下文”，也即“我们接下来要做什么？”调用一个续延，可以让我们瞬间跳回续延被捕获的那个时间点，还原环境（包括堆和栈，不过那是具体的内存模型。环境是更抽象的“数据上下文”。）以及更重要的，“计算”。\u003c/p\u003e\n\u003cp\u003e看上去真是神秘又强大（事实上，从 call/cc 和条件判断，我们可以造出其余的所有控制流。）。我们的第五作实现了一个 scheme 子集的解释器，但是也没有实现这个功能。\u003c/p\u003e\n\u003cp\u003e那么，这个操作是如何实现的呢？“剩下的计算”是如何被表示的呢？这就是我们今天要探讨的话题。\u003c/p\u003e\n\u003ch2 id=\"cps-变换\"\u003eCPS 变换\u003c/h2\u003e\n\u003ch3 id=\"一个例子\"\u003e一个例子\u003c/h3\u003e\n\u003cp\u003e先看下面这段代码：\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cdiv class=\"chroma\"\u003e\n\u003ctable class=\"lntable\"\u003e\u003ctr\u003e\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode\u003e\u003cspan class=\"lnt\"\u003e1\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e2\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e3\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e4\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e5\n\u003c/span\u003e\u003cspan class=\"lnt\"\u003e6\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\n\u003ctd class=\"lntd\"\u003e\n\u003cpre tabindex=\"0\" class=\"chroma\"\u003e\u003ccode class=\"language-racket\" data-lang=\"racket\"\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003edefine\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efact-cps\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"n\"\u003ek\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e    \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e        \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efact-cps\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"cl\"\u003e            \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003elambda\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ek\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003e*\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e))))))\u003c/span\u003e\u003cspan class=\"err\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\u003cp\u003e从名字就可以看出，这是一个计算阶乘的函数。不过它看上去非常的不同寻常。\u003c/p\u003e\n\u003cp\u003e那个叫做“k”的参数是什么东西？它在干什么？\u003c/p\u003e\n\u003cp\u003e事实上，这个“k”就是一个外部传入的续延。它代表“当前函数执行完毕后，还要进行哪些操作”。\u003c/p\u003e\n\u003cp\u003e现在让我们来看看代码。条件判断很寻常。\u003c/p\u003e","title":"CPS，控制上下文与四十行代码的传说"},{"content":"算法 trick 的记录。\n系列前作：https://www.luogu.com.cn/article/yc9w22em\n拆贡献！拆贡献！交换维度！交换维度！时间逆流！时间逆流！操作顺序反演！操作顺序反演！递推！递推！分离常量！分离常量！不同的项分开算！\n优化一些代数式计算的复杂度时，最简单常用的技巧就是试着拆开，然后分离常量和变量，将不同类项分开处理。而当你推不出一些式子时，可以放弃推式子而使用递推。交换求和顺序/交换 DP 转移顺序/维度是破解循环依赖，找到好的计算顺序的方法，这和拆贡献是相关的：拆贡献其实就是变换了统计的第一维度。从按照整体的统计变成按照单个元素统计。\n双指针就是“在不合法和不优之间的境界线上游走”，同时也是“一种扫描线”，并且是“在复杂度允许的情况下，枚举一定量信息以确定更多条件”的体现。\n而“枚举一定量信息”在 DP 中也很常用。DP 的经典套路就是随便乱设状态，加入信息直到能够转移为止，然后利用种种洞察和优化去掉一部分维度，优化转移直到时空复杂度达标。\n在做任何题的时候，第一步考虑性质刻画。无论是操作的性质还是维护信息的性质。性质就是限制，能够帮你找出正解。\n一个好的性质刻画也很重要。一个愚蠢的性质刻画会极大地妨碍你做题。所以如果你觉得性质刻画太笨，就试着简化。\n“信息学”的本质就是对于信息的处理。算法对于复杂度的优化本质上是减少不必要的对信息的处理（计算）。所以当你试图确定复杂度或者优化复杂度时，不妨思考一下“这个题，至少需要处理哪些信息？如何避免处理不必要的信息？”\n信息即向量，操作即矩阵。\n写了线性代数大学习，你应当能知道这点。有许多操作都是线性/仿射的，可以写成矩阵。从而拥有结合性，可以用快速幂或者线段树等方法处理。\n孤链压缩权值线段树/01 trie。线性空间复杂度，从此整数可重集再也不用平衡树。\n线性筛线性预处理积性数论函数。要点在于筛 n = i * p 时用到的 p 和 i 满足 p 不大于 i 的最小质因子。比埃筛更好写。\n以后再也不要 naive 地 $O(n \\log n)$ 算 d(i) 了。\n利用单调性等等贪心性质简化问题。\n有交不优 =\u0026gt; 钦定末尾。\n有时二维问题按第一维排序，而后第二维更小就一定更优所以无脑排除一些。剩下的就满足二维偏序（相当于利用贪心性质额外制造了一个维度上的单调性。这里的贪心性质是“a 被 b 包含 =\u0026gt; b 的所有解都不劣于 a 的对应解/a 能干的所有 b 都能干”）\n两种证明贪心的策略：\n局部上，交换论证/调整法：调整一定能导出不劣的解。 整体上，必要性 =\u0026gt; 充分性：我们至少需要多少操作，然后让这些操作发挥最大的效益。 增量更新并不要求旧的答案一定是新的答案。在旧答案总数很小时，可以暴力枚举它们判断它们是否是新的答案。或者，如果容易确定哪些不是新的答案，排除它们即可。\n对于一些非常复杂的操作，可以考虑寻找不变量。常见的不变量常常和奇偶性或者两类元素的差有关。因为总和是容易变的，但是有时对于两类东西的作用是相同的，就可以被作差消去。\n当操作是对两个相邻元素（或者类似的，一个元素附近的几个元素）时，这样的关于奇偶性或者奇偶下标的元素的差的不变量比较容易出现。\n不变量和另一种思想紧密相关，即状态而非过程。在很多贪心或者博弈论的题中，常常有复杂的流程模拟，直接陷进去就做不出来了。\n这时可以考虑最终状态或者解的性质，有时能够得到非常简洁优雅的结果。就像解方程一样。\n一些看似具有对称性的问题/贪心策略，其实是不对称的。\n这种不对称常常是因为一些题目操作的性质引起的，比如说字典序的比较是从前往后的，这就导致有时你必须逆向贪心。或者一个操作操作了“从当前位置开始，长度为 k 的区间”，这也是一种不对称性，常常导致你需要逆向贪心。\n多源 bfs 或 dijkstra/01 bfs 是求出一个点到一组关键点的距离的利器。\n来自 CSP-S 2025 的教训：记得测试极限数据。记得检查大样例强度。仔细查看题面，不要想当然由于 t1!=t2 以为 s1!=s2 等等。记得数组不要开小，想清楚数组要有多大。有时本地的越界等会因为神秘原因而不 re，这时使用 sanitizer 是好的。\n在对“本质不同的 (x, y) 有序对”计数时，常常考虑枚举 x（或者类似的枚举一维）。但是在对本质不同的 x（单个元素）计数时，这样的做法就行不通了。\n常用的方法是把每个元素都映射到一种能够体现它本质的构型上，满足以下几个条件：\n相同元素映射到相同构型 不同元素映射到不同构型 构型易于处理，容易进行相等性比较/排序/去重等。 性质刻画有时不要魔怔。你可能会发现刻画走进了死胡同，但是某些力大砖飞的做法反而可行。那么不管什么做法只要能通过就行。\n以上两点有例题 CF1849C。\n边点互化是图论建模的经典方法。我已经因为不会这个吃了很多亏了。\n陷阱：我们一般情况下容易陷入思维定势，认为“物品”一定是点，而“关系”一定是边。但是，边的本质特征是只与两个点有关。所以如果关系是多元的（与多个物品有关）而物品的性质反而是二元的，那么应该考虑边点互化。\n例题：电阻网络求解。ABC434E。\nbitset 优化高维偏序是一种常用技巧。具体而言，高维偏序是若干一维偏序的逻辑与，也即交集关系。bitset 优化求交集即可。\n在面对区间操作时，我们常常利用差分将其转化为单点操作。然而有时，相反的转化（即考虑前缀和）也是有效的。例题：CF1775E。\n将排列对应的置换分解为轮换是常用的技巧。\n与之配套的有函数图的经典结论：\n我们知道交换一个环上的两个点可以将环分裂，交换不同环的点会将两个环合并到一起。\n证明：\n考虑 $i, j$ 是同一个环上的两个点。设前驱分别为 $v_i, v_j$。交换 $i$ 和 $j$ 本质上相当于让 $v_i$ 指向 $j$ 而 $v_j$ 指向 $i$。\n那么，就变成了 $v_i \\to j \\to p_j \\to \\dots$，注意到原本这也是一个环，也就是说那串省略号最后会绕回 $v_i$，这就成了一个环。而另一边同理，并且你会发现两个环没有交集。\n对于 $i$ 与 $j$ 不在同一个环上的情形，那串省略号不再通向 $v_i$，而是通向 $v_j$，又从 $v_j$ 绕到 $i$，所以两个环就并成了一个。\n例题：CF1768D 和 ABC436E。更详细的题解\nABC437F.\n这里涉及到曼哈顿距离与切比雪夫距离互化的经典 trick。\n公式：\n$$(x, y) \\rightarrow (x+y, x-y)$$这个变换后，原图中的曼哈顿距离就变为切比雪夫距离。\n逆变换：\n$$(x, y) \\rightarrow (\\frac{x+y}{2}, \\frac{x-y}{2})$$ 可以将切比雪夫距离转为曼哈顿距离。\n为了避免小数，在处理后者时常常将坐标放大二倍。\n两个变换的原理是 $|x| = \\max(x, -x)$。\n这个 trick 的作用在于，将加法和 max 两种操作互相转化。在例题 ABC437F 中，我们需要处理外层是 max，内层是加法的区间查询，直接做需要带修莫队或者复杂的多层树套树/高维偏序。利用曼哈顿距离转切比雪夫距离，我们得以将问题转化为只与 max 有关的区间查询，从而拥有结合性，能够利用线段树简单维护。\n这个 trick 之前也偶然见过，不过在场上却没能追忆起来，而是陷入了带修莫队（不会）和高维树套树的死胡同里。。警钟长鸣。\n背包合并是一个有用的技巧。注意它的复杂度是 $O(V^2)$，但在背包仅处理计数/可行性而不是最大值时能够直接使用 FFT/NTT 做到 $O(V \\log V)$。\n背包合并可以用于背包的区间查询等。可以用线段树或猫树（二区间合并）维护（背包合并证明背包具有结合律）。\n例题：ABC426G\n有时我们不需要算出完整的背包，只需要一些特征信息。这时可能可以做到 $O(V \\log V)$ 或 $O(V)$。\n例题：ARC070B\n","permalink":"https://litjohn.github.io/posts/algorithms-summary/","summary":"\u003cp\u003e算法 trick 的记录。\u003c/p\u003e\n\u003cp\u003e系列前作：\u003ca href=\"https://www.luogu.com.cn/article/yc9w22em\"\u003ehttps://www.luogu.com.cn/article/yc9w22em\u003c/a\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e拆贡献！拆贡献！交换维度！交换维度！时间逆流！时间逆流！操作顺序反演！操作顺序反演！递推！递推！分离常量！分离常量！不同的项分开算！\u003c/p\u003e\n\u003cp\u003e优化一些代数式计算的复杂度时，最简单常用的技巧就是试着拆开，然后分离常量和变量，将不同类项分开处理。而当你推不出一些式子时，可以放弃推式子而使用递推。交换求和顺序/交换 DP 转移顺序/维度是破解循环依赖，找到好的计算顺序的方法，这和拆贡献是相关的：拆贡献其实就是变换了统计的第一维度。从按照整体的统计变成按照单个元素统计。\u003c/p\u003e\n\u003cp\u003e双指针就是“在不合法和不优之间的境界线上游走”，同时也是“一种扫描线”，并且是“在复杂度允许的情况下，枚举一定量信息以确定更多条件”的体现。\u003c/p\u003e\n\u003cp\u003e而“枚举一定量信息”在 DP 中也很常用。DP 的经典套路就是随便乱设状态，加入信息直到能够转移为止，然后利用种种洞察和优化去掉一部分维度，优化转移直到时空复杂度达标。\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e在做任何题的时候，第一步考虑性质刻画。无论是操作的性质还是维护信息的性质。性质就是限制，能够帮你找出正解。\u003c/p\u003e\n\u003cp\u003e一个好的性质刻画也很重要。一个愚蠢的性质刻画会极大地妨碍你做题。所以如果你觉得性质刻画太笨，就试着简化。\u003c/p\u003e\n\u003cp\u003e“信息学”的本质就是对于信息的处理。算法对于复杂度的优化本质上是减少不必要的对信息的处理（计算）。所以当你试图确定复杂度或者优化复杂度时，不妨思考一下“这个题，至少需要处理哪些信息？如何避免处理不必要的信息？”\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e信息即向量，操作即矩阵。\u003c/p\u003e\n\u003cp\u003e写了线性代数大学习，你应当能知道这点。有许多操作都是线性/仿射的，可以写成矩阵。从而拥有结合性，可以用快速幂或者线段树等方法处理。\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e孤链压缩权值线段树/01 trie。线性空间复杂度，从此整数可重集再也不用平衡树。\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e线性筛线性预处理积性数论函数。要点在于筛 n = i * p 时用到的 p 和 i 满足 p 不大于 i 的最小质因子。比埃筛更好写。\u003c/p\u003e\n\u003cp\u003e以后再也不要 naive 地 $O(n \\log n)$ 算 d(i) 了。\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e利用单调性等等贪心性质简化问题。\u003c/p\u003e\n\u003cp\u003e有交不优 =\u0026gt; 钦定末尾。\u003c/p\u003e\n\u003cp\u003e有时二维问题按第一维排序，而后第二维更小就一定更优所以无脑排除一些。剩下的就满足二维偏序（相当于利用贪心性质额外制造了一个维度上的单调性。这里的贪心性质是“a 被 b 包含 =\u0026gt; b 的所有解都不劣于 a 的对应解/a 能干的所有 b 都能干”）\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e两种证明贪心的策略：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e局部上，交换论证/调整法：调整一定能导出不劣的解。\u003c/li\u003e\n\u003cli\u003e整体上，必要性 =\u0026gt; 充分性：我们至少需要多少操作，然后让这些操作发挥最大的效益。\u003c/li\u003e\n\u003c/ol\u003e\n\u003chr\u003e\n\u003cp\u003e增量更新并不要求旧的答案一定是新的答案。在旧答案总数很小时，可以暴力枚举它们判断它们是否是新的答案。或者，如果容易确定哪些不是新的答案，排除它们即可。\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e对于一些非常复杂的操作，可以考虑寻找不变量。常见的不变量常常和奇偶性或者两类元素的差有关。因为总和是容易变的，但是有时对于两类东西的作用是相同的，就可以被作差消去。\u003c/p\u003e\n\u003cp\u003e当操作是对两个相邻元素（或者类似的，一个元素附近的几个元素）时，这样的关于奇偶性或者奇偶下标的元素的差的不变量比较容易出现。\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e不变量和另一种思想紧密相关，即状态而非过程。在很多贪心或者博弈论的题中，常常有复杂的流程模拟，直接陷进去就做不出来了。\u003c/p\u003e\n\u003cp\u003e这时可以考虑最终状态或者解的性质，有时能够得到非常简洁优雅的结果。就像解方程一样。\u003c/p\u003e","title":"Algorithms Summary"}]